!function($){var ROOT="stext/",COMMON="common/",CAPTURE="capture/",BGM="bgm/",SE="se/",scenario_code,scenario_data,enabled_jobs,flags_map={},enemies_map={},items_map={},results_map={},bgms_map={},save_data,global_save_data,GLOBAL_SAVE_DATA_KEY="sorcerian_text",target,dialog_elem={},debug_mode=!1,bgm,bgm_name,storage=localStorage,dice=[1,1],tweet_message,Common={male_name:["ボブ","デュエル","ゴルカス","ジェノバン","グーラン","ジャンビエ","グログス","コル","フロニアス","グーリム","カザミィ","ソロン","ゼン","ヴォル","マルス","レイザー","ミリオン","エリック","ジロ","ソード","ディル","ガタビア","ラウア","ハルビン","グドン","ジャミル","ディカン","ダート","タットワ5世","ディカン","ホド","ゲプラー","コクマー","グレアム","ロウポー","ラッツ","ソルト","ランブル","ネイル","ルシアン","ギム","チェイサー","ルワン","ゾーク","オルム","テュモー","バロン","カメロン","トード","グンダ","フラジオレ","ファン＝フレディ","ファネッサ3世","クリフト4世","クォール","ディオン","ホゼア","ロラッド","バルナ","ティゲロ","テト","ニフト","オーサー","ゲディス","レオン","アンドリュー","キリー","トーマス","エディ","ノーマス","ギルデン","ノーネーム","ユイター","デュオン","ペトス","フェリス","スラン","アルフレッド","ソクラム","アルモス","ログレック","ラルーゴ","キッド","ドレイク","ウォルトス","レスター","テリー","グラハン","ラドール","ウェステル","フェスタ","バンブー","ゲルフス","ドン・コサック","ベオグラード","ピエール","タルフ","エヴァン","ドゥール","バルガス","アーサー","ガッシュ","エルウッド","ヘルナー","エリック","ジャグラー","アラン","ロニアス","アスタル","ボルックス","ラドナー","ギルバレス","ジャレス","ルー","スズキ","ジロサ","サントリーニ","ルルイエ","コーラル","ボマード","ナルシス","マーヴァル","クール","ヨシュア","エヴァム","ジャンク","ボイド","ヘクター","デンキブラウン","バイアス","ブロイム","ディンギル","リグ","バド","ジード","ラルザス","ガイキナ","ロッド","ケイン","ルーミス","タジート","ブレイス","ディンクス","マーク","ホホホ","テシター","J.B","ジン","マック","リラ","ジバ","バーラン","ポジティル","ネガティル","ファルカス","ファウネス","ファルカス","チェン","パズス12世","タムタム","リーク・ディオン","タウラー","ラルディ","ノーマス","アドロン","ロカルノ","ゲラン","シュヴェーリン","ローラン","ウェッジ","アントロノフ","キム","ヤン","デフ","ミケロ","クール","ティエンルン","コウ","マルク","オーエン","トート","グート","マウアー","ザンダー","バルダ","キーリエ","マルス","セム","ターバ","グロス","クルトン","ザムル","エルフィン","グラハン","ガウェイン","アドル","ゴーバン","ドギ","ルタ","ダレス","ダルク＝ファクト","クーブラ＝カーン","ガルシウス","クロノス","カイロス","ディアルド","チッタ","カズン","ルイス","セネリー","ライネル","エス","カリー","ドレイク","ダニー","ドリー","ケイリス","ノートン","クラウド","ウォーリー","レイモンド","サザール","メテオロイド","ナッシュ","ルロイ","ライトル","カディアン","ブラウン","シュナイダー","セシル","グレンザー","ゴイル","ビル","グリメルム","ガルベス","ジルドバ","アレクシウスX世","ピエール","ジェラルド","ロベルト","エティス","アル＝ファルコ","ラシーン","ロデム","J.D.マックス","パーム","シド"],female_name:["エスター","クリスティ","アイリーン","フェルディナン","リタ","トーヤ","ノルン","ウィンディーネ","プリム","ピアナ","エメラーダ","エレア","エヴァ","リム","ビナー","ティファレト","ミラドゥ","パナシェ","ミモザ","リューズ","エレーナ","リーア","キアラ","オルアラ","クオレ","セーナ","リーザ","セリナ","リリィ","ピピ","ビヌス","アンナ","リュシエル","フィレン","カレン","エリン","ローラ","マーベラ","ジョセフィーヌ","アネリーナ","リオナ","ジョアンナ","レニッサ","ジェニス","グリンダ","マティナ","ローナ","コッキー","チェルシー","ネリス","アリーナ","フェリッサ","マリエル","ベララ","ジョゼフ","ニッカ","テキーラ","ソルティ","パイン","ウィズ","カンニバル","ミント","リーン","ミル","ディアンナ","レティア","サフィス","エミス","ヴァムリー","サリア","ナイジェス","ミューリア","エミリア","シャル","バーバラ","オビア","スチュアート","ベーラ","サマリーヌ","フィアネ","レナ","ソル","ネイラ","セレーネ","アルバ","ラン","ルー・パズス","シルフィ","ミレット","レフィーナ","モスマ","チブル","鈴鈴","明明","ティキ","サリア","ミュール","ダール","ミンナ","レーシャ","エレイア","レア","フィーナ","ジャネット","ナリス","ソチ","ポーラス","ロキア","フリージ","エスメレー","エレナ","アルティ","エビオラ","フィナ"],title:["武器屋の親父","ペンタウァの長老","トラベラーズインの宿主","人と上手に話したい","ペンタウァ近衛隊長","タリスマンの見張り","瞑想中","砂漠の飯炊き","狂戦士","エレベーターの管理人","盗賊の頭領","暗き沼の魔法使い","ロマンシア国王","アゾルバ国王","ペンタウァ国王","蚕職人","妖精王","暗黒の魔導士","クイーンマリー号船長","キタブ・アル・アジフの持ち主","メデューサハンターの弟子","ファルコムマン","戦士の亡霊","海賊の子孫","いけにえの神官","東の村の村長","麻薬中毒者","ヴァネルバの王","銀の竪琴屋","近衛隊長","復讐の呪術師","ラフォーヌの森の管理人","リドニア王国の元兵士","姫の教育係","大魔王","紫ウニの王子","ベララの家族","時計塔の番人","時計塔の魔女","ナルキッソス号船長","ディンギル王国の3神官","バドティビラ工場の指揮官","シュメール国王","サンサーラの山賊","南村の村長","アイテム屋WIZの店主","旅の吟遊詩人","古代イスマリアの王","時の神殿の書記官","闇の王","ランドル村長","魔法学校の校長","魔法学校の用務員","マリオネットの王","ペンタウァの近衛兵","陽の中の闇人","赤毛の冒険者","光の王","イリアスンの執政官","魔の下僕","メデューサハンター","邪神教徒","邪神教々祖","砂漠の王","鍵の番人","ローデシア辺境司令官","宇宙からの訪問者","黒竜仙人","猿大聖","極楽寺の僧兵","ジャグラー族","迷宮建築の第一人者","フリース村の村長","ペンタウァ一の科学者アンド予言者","暴れザル","魔法学校の校長","人魚３姉妹の長女","マリオネットの王","探求の学徒","旅芸人の一座","猛獣使い","流れの傭兵","氷の魔女","パペッテの人形遣い","バーテンダー","宮仕えのシャーマン","薬草亭の主人","水門の管理人"],pc_init:[["FIGHTER","MALE",85,55,7,3,6,4],["FIGHTER","FEMALE",80,60,6,4,6,4],["WIZARD","MALE",55,85,4,8,5,3],["WIZARD","FEMALE",50,90,3,8,5,4],["DWARF","MALE",90,50,8,2,8,2],["DWARF","FEMALE",85,55,7,3,8,2],["ELF","MALE",65,75,4,6,5,5],["ELF","FEMALE",60,80,2,7,5,6]],magic:{HEAL:[0,0,0,1,0,1,0,"HPを15回復"],PEACE:[0,0,1,0,1,0,0,"MPを10回復"],CURE:[0,0,0,0,1,0,1,"毒回復"],MELT:[0,1,0,0,1,1,1,"凍結を回復"],"STONE-FLESH":[0,0,0,1,1,1,1,"石化を回復"],"UN-CURCE":[2,0,1,0,0,1,0,"呪いを回復"],"AIR-HAND":[1,0,1,0,1,0,1,"見えない拳の衝撃で、忘却を回復"],RESURRECT:[0,0,0,1,3,0,1,"HP/MP半分で復活（但し、冒険に一度だけ）"],"REDUCE-LIFE":[0,1,1,0,1,1,0,"体力を犠牲に（HP-25）、すべての状態異常を回復"],REJUVENATE:[0,2,0,1,0,0,1,"時の流れを巻き戻し（現在の判定をやり直し）"],PROTECT:[1,0,0,1,1,0,1,"HPダメージを半減（1ターンのみ）"],"HOLY-WATER":[0,0,2,2,0,0,0,"MPダメージを半減（1ターンのみ）"],"CHANGE-AIR":[1,0,0,1,1,1,0,"戦闘を回避（アイテムは得られない）"],"GIVE-VIGOR":[1,1,1,0,0,1,0,"敵の攻撃力が2倍＆取得アイテム2倍"],EXPLOSION:[0,1,0,1,0,1,2,"地属性の敵を全滅"],DELUGE:[4,0,0,0,0,1,0,"火属性の敵を全滅"],FREEZE:[0,2,0,0,0,1,2,"水属性の敵を全滅"],"DESTROY-A":[1,0,4,0,0,0,0,"風属性の敵を全滅"],"LIGHT-CROSS":[0,2,0,2,0,1,0,"霊属性の敵を全滅"],"NOILA-TEM":[1,1,1,1,1,1,1,"すべての属性の敵を全滅"]},jobs:{"のうふ":["FWDE","MF","YAO"],"れんきんじゅつ":["W","M","YAO"],"ようへい":["FDE","M","YA"],"うらないし":["WE","MF","YAO"],"こうふ":["FD","M","YA"],"どろぼう":["FWDE","MF","YAO"],"そうりょ":["W","MF","YAO"],"しょうにん":["FWE","MF","YAO"],"せんいん":["FD","M","YA"],"とうし":["FDE","MF","Y"],"どうけし":["WE","MF","YAO"],"かじや":["FD","M","YAO"],"きこり":["FD","M","YA"],"かりうど":["FDE","M","YAO"],"きとうし":["WE","M","YAO"],"あくまばらい":["W","M","YAO"],"せんきょうし":["W","MF","YAO"],"いしゃ":["WE","M","AO"],"かんごふ":["FWE","F","YAO"],"ぱんや":["FWE","MF","YAO"],"りょうし":["FD","MF","YA"],"だいく":["FD","M","YAO"],"ちょうこくか":["FWDE","MF","O"],"おりこ":["WDE","F","YAO"],"すみやき":["FD","MF","YAO"],"コック":["WE","MF","YAO"],"スパイ":["FWE","M","YA"],"ぼくどう":["FWDE","MF","Y"],"ようじんぼう":["FDE","M","Y"],"ぎんゆうしじん":["WE","M","YAO"],"ぎょしゃ":["FD","MF","YAO"],"はかもり":["FWDE","M","O"],"しゃほん":["WE","M","O"],"こなひき":["FD","MF","YA"],"かせいふ":["FWDE","F","YAO"],"おどりこ":["E","F","Y"],"はなや":["FWE","F","YAO"],"いしく":["D","MF","YA"],"かみゆい":["FWDE","F","AO"],"したてや":["WDE","F","YAO"],"いとつむぎ":["D","F","YAO"],"うたうたい":["FWE","F","YA"],"かみすき":["WD","MF","O"],"つうやく":["DE","MF","YAO"],"やくざいし":["FWE","MF","AO"],"ほねさいくし":["D","MF","O"],"わたしもり":["FW","M","YA"],"やくそうとり":["WE","MF","YAO"],"そうぎや":["FW","M","O"],"ワインづくり":["FWDE","MF","YA"],"こじき":["FWDE","MF","YAO"],"ちょうきょうし":["DE","MF","A"],"ほうせきさいくし":["D","MF","O"],"かごづくり":["FD","MF","O"],"かぎや":["D","MF","AO"],"くつし":["FDE","MF","O"],"はくせいづくり":["FD","MF","O"],"ゆみし":["FE","MF","O"],"チーズづくり":["FD","F","YAO"],"さんば":["FW","F","AO"]},global_items:{happy:{gi01:{name:"金の卵",desc:"月の欠片を5個所有した状態で冒険を開始する"},gi02:{name:"ガラティーン",desc:"火星の欠片を5個所有した状態で冒険を開始する"},gi03:{name:"五元素のマント",desc:"水星の欠片を5個所有した状態で冒険を開始する"},gi04:{name:"アマゾンの剣",desc:"木星の欠片を5個所有した状態で冒険を開始する"},gi05:{name:"幸福のコイン",desc:"金星の欠片を5個所有した状態で冒険を開始する"},gi06:{name:"ムラサメブレード",desc:"土星の欠片を5個所有した状態で冒険を開始する"},gi07:{name:"G・スレイヤー",desc:"太陽の欠片を5個所有した状態で冒険を開始する"},gi08:{name:"水晶の剣",desc:"30％の確率でシーンごとにHPを1回復する",type:"status"},gi09:{name:"王様の杖",desc:"30％の確率でシーンごとにMPを1回復する",type:"status"},gi10:{name:"ブルーリボン",desc:"冒険開始時にSTRを1加算する"},gi11:{name:"王家のダイヤモンド",desc:"冒険開始時にINTを1加算する"},gi12:{name:"不老長寿の水",desc:"冒険中に一度だけHPを半分回復しても良い",type:"status"},gi13:{name:"タリスマン",desc:"冒険中に一度だけMPを半分回復しても良い",type:"status"},gi14:{name:"鏡の盾",desc:"戦闘時のHPダメージが1減算される",type:"battle"},gi15:{name:"銀の竪琴",desc:"戦闘時のMPダメージが1減算される",type:"battle"},gi16:{name:"パンドラの箱",desc:"右サイコロが4以上の時、戦闘を回避しても良い（ただし、アイテムは入手できない）",type:"battle"},gi17:{name:"魔法の絨毯",desc:"右サイコロが6の時、戦闘を回避できる（アイテムも入手可）",type:"battle"},gi18:{name:"中和剤",desc:"毒耐性",type:"status"},gi19:{name:"聖水",desc:"呪い耐性",type:"status"},gi20:{name:"チルドの実",desc:"凍結耐性",type:"status"},gi21:{name:"銀のハーモニカ",desc:"石化耐性",type:"status"},gi22:{name:"真実の鏡",desc:"忘却耐性",type:"status"},gi23:{name:"D・スレイヤー",desc:"すべての星を1個所有した状態で冒険を開始する"}},bad:{bgi01:{name:"塩酸",desc:"シーンごとに30％の確率でHP1ダメージ、40％の確率でMPを1回復する",type:"status"},bgi02:{name:"紅玉",desc:"シーンごとに30％の確率でMP1ダメージ、40％の確率でHPを1回復する",type:"status"},bgi03:{name:"血まみれの斧",desc:"冒険開始時に呪い。ただし、解除後に3回まで星消費せず攻撃魔法を利用できる",type:"magic"},bgi04:{name:"トリカブト",desc:"冒険開始時に毒。ただし、解除まで魔法ダメージを半減できる",type:"battle"},bgi05:{name:"ギャルのパンティー",desc:"冒険開始時に忘却。ただし、解除時に0になっていたステータスを+1できる",type:"status"}}},star_names:{mon:"月",tue:"火星",wed:"水星",thu:"木星",fri:"金星",sat:"土星",sun:"太陽","":null},state_names:{"":"正常",poison:"毒",frozen:"凍結",stone:"石化",curse:"呪い",forget:"忘却",physics:"物理",magic:"魔法",both:"物理／魔法",free1:"FREE1",free2:"FREE2",free3:"FREE3"},element_names:{earth:"地",fire:"火",water:"水",wind:"風",spirit:"霊"}};toastr.options.closeButton=!0,toastr.options.positionClass="toast-bottom-left",toastr.options.showDuration=300,toastr.options.hideDuration=1e3,toastr.options.timeOut=5e3;let SeAudio={play(name,common=!1){if(global_save_data.bgm){let a;a=common?new Audio(`${ROOT}${COMMON}${SE}${name}.mp3`):new Audio(`${ROOT}${scenario_code}/${BGM}${SE}${name}.mp3`),a.volume=.9,a.loop=!1,a.play()}},playBgm(path){bgm&&bgm.pause(),(bgm=new Audio(path)).volume=.2,bgm.loop=!0,global_save_data.bgm&&bgm.play()}},Cache={setItem(name,value,expires){Cookies.set(`stext_cache_${name}`,value,{expires:expires,path:""})},getItem:name=>Cookies.get(`stext_cache_${name}`)},Bonus={showBonusMessage(){let msg;save_data.bonus&&(msg=0===save_data.bonus.indexOf("bgi")?Common.global_items.bad[save_data.bonus]:Common.global_items.happy[save_data.bonus],toastr.info(msg.desc,`BONUS（${msg.name}）`)),this.setBonusMessage()},initBonusStatus(){switch(save_data.bonus){case"gi01":Util.updateStarById("mon",5);break;case"gi02":Util.updateStarById("tue",5);break;case"gi03":Util.updateStarById("wed",5);break;case"gi04":Util.updateStarById("thu",5);break;case"gi05":Util.updateStarById("fri",5);break;case"gi06":Util.updateStarById("sat",5);break;case"gi07":Util.updateStarById("sun",5);break;case"gi10":Util.updateStr2Krm(1,0,0,0);break;case"gi11":Util.updateStr2Krm(0,1,0,0);break;case"gi23":Util.updateStarById("mon",1),Util.updateStarById("tue",1),Util.updateStarById("wed",1),Util.updateStarById("thu",1),Util.updateStarById("fri",1),Util.updateStarById("sat",1),Util.updateStarById("sun",1);break;case"bgi03":Util.updateState("curse");break;case"bgi04":Util.updateState("poison");break;case"bgi05":Util.updateState("forget")}},setBonusMessage(){let b=Util.getBonusItem(save_data.bonus);b&&b.type&&$(`#sidr_${b.type}_bonus`).text(`BONUS APPLYING： ${b.desc}`)},updateStatusByBonus(){switch(save_data.bonus){case"gi08":Util.processByWeight([.3],(function(){Util.updateHpMp(1,0)}));break;case"gi09":Util.processByWeight([.3],(function(){Util.updateHpMp(0,1)}));break;case"bgi01":Util.processByWeight([.3,.4],(function(){Util.updateHpMp(-1,0)}),(function(){Util.updateHpMp(0,1)}));break;case"bgi02":Util.processByWeight([.3,.4],(function(){Util.updateHpMp(0,-1)}),(function(){Util.updateHpMp(1,0)}))}},adjustBattleDamage(damage,type){switch(save_data.bonus){case"gi14":"hp"===type&&damage--;break;case"gi15":"mp"===type&&damage--}return damage},guardState(state){let data;return state!=={gi18:"poison",gi19:"curse",gi20:"frozen",gi21:"stone",gi22:"forget"}[save_data.bonus]}},PlayerRank={LEVEL_POINTS:[100,150,170,180,200],RANK_INFO:[{pt:50,en:"Novice Adventurer",jp:"駆け出し"},{pt:100,en:"Initiate",jp:"新参者"},{pt:200,en:"Aspirant",jp:"大志を抱く者"},{pt:300,en:"Battler",jp:"戦人（いくさびと）"},{pt:500,en:"Adept",jp:"熟練者"},{pt:700,en:"Chevalier",jp:"義侠の者"},{pt:1e3,en:"Conjurer",jp:"奇術師"},{pt:1300,en:"Theurgist",jp:"神々に祈る者"},{pt:1600,en:"Warrior",jp:"古つわもの"},{pt:2e3,en:"Enchanter",jp:"魅了する者"},{pt:2500,en:"Warlock",jp:"七つの塔の魔術師"},{pt:3e3,en:"Sorcerer",jp:"ソーサリアン"},{pt:3500,en:"Necromancer",jp:"死者と語る者"},{pt:4e3,en:"Illusionist",jp:"幻惑を魅せる者"},{pt:5e3,en:"Master Lord",jp:"偉大なる領主"},{pt:99999,en:"Dragon Slayer",jp:"ドラゴンスレイヤー"}],scena_count:0,scena_all:0,bonus_count:0,bonus_all:0,scena_infos:{},scena_results_count:0,scena_results_all:0,exp_count:0,exp_all:0,init(){let that=this,g_save;localStorage.sorcerian_text&&(g_save=JSON.parse(localStorage.sorcerian_text),this.bonus_count=g_save.items.length),this.bonus_all=Object.keys(Common.global_items.happy).length+Object.keys(Common.global_items.bad).length,$.get(ROOT+"stext.xml").done((function(data){let scenas=$("scenario > work",data);that.scena_all=scenas.length,$("scenario > work",data).each((function(i){let id=$(this).attr("id"),results_count=0,is_cleared=!1;if(g_save){let results=g_save.results[id];if(results){results_count=results.length;let clears=$(this).attr("clears");if(clears){clears=clears.split(",");for(var j=0;j<clears.length;j++)if(-1!==results.indexOf(clears[j])){that.scena_count++,is_cleared=!0;break}}}}that.scena_infos[id]={level:Number($(this).attr("level")),title:$(this).attr("title"),is_cleared:is_cleared,results_count:results_count,results_all:Number($(this).attr("results"))},that.scena_results_all+=Number($(this).attr("results"))})),that.calculateExp()}))},calculateExp(){this.exp_count=10*this.bonus_count,this.exp_all=10*this.bonus_all;let results_sum=0;for(let k of Object.keys(this.scena_infos)){let info=this.scena_infos[k];info.is_cleared&&(this.exp_count+=this.LEVEL_POINTS[Number(info.level)-1]),this.exp_all+=this.LEVEL_POINTS[Number(info.level)-1],results_sum+=info.results_count}this.exp_count+=2*results_sum,this.scena_results_count=results_sum},incrementResult(code){this.scena_infos[code].results_count++,this.calculateExp()},getRank(){for(let i=0;i<this.RANK_INFO.length;i++){let rank=this.RANK_INFO[i];if(this.exp_count<rank.pt)return{level:i,en:rank.en,jp:rank.jp}}}},SideBar={isFirstOpenBattleSheet:!0,cube:function(num){void 0===num&&(num=1);var html="";for(let i=0;i<num;i++)dice[i]=Util.random(1,6),html+=`<img src="${ROOT}${COMMON}cube${dice[i]}.png" class="dice" />`;return html},incrementValue(e){let prev=$(this).prev();prev.val(Number(prev.val())+1)},decrementValue(e){let next=$(this).next();next.val(Number(next.val())-1)},setStateStyle(){let hp=$("#sidr_status_hp"),str=$("#sidr_status_str"),int=$("#sidr_status_int"),dex=$("#sidr_status_dex"),krm=$("#sidr_status_krm"),magic=$("#sidr_magic_magic"),poison=$('[name="sidr_status_state"][value="poison"]').prop("checked");var frozen=$('[name="sidr_status_state"][value="frozen"]').prop("checked"),stone=$('[name="sidr_status_state"][value="stone"]').prop("checked"),curse=$('[name="sidr_status_state"][value="curse"]').prop("checked"),forget=$('[name="sidr_status_state"][value="forget"]').prop("checked"),clazz="dialog_poison dialog_frozen dialog_stone dialog_curse dialog_forget";hp.removeClass(clazz),str.removeClass(clazz),int.removeClass(clazz),dex.removeClass(clazz),krm.removeClass(clazz),magic.removeClass(clazz),poison?hp.addClass("dialog_poison"):frozen?(str.addClass("dialog_frozen"),int.addClass("dialog_frozen"),dex.addClass("dialog_frozen"),krm.addClass("dialog_frozen")):stone?(str.addClass("dialog_stone"),int.addClass("dialog_stone"),dex.addClass("dialog_stone"),krm.addClass("dialog_stone")):curse?magic.addClass("dialog_curse"):forget&&(save_data.chara.str<save_data.chara.int?int.addClass("dialog_forget"):str.addClass("dialog_forget"))},deltaStatus:function(state){let result;switch(state){case"frozen":result={state_desc:"すべてのステータスを-2",str_d:-2,int_d:-2,dex_d:-2,krm_d:-2};break;case"stone":result={state_desc:"すべてのステータスを-1（30scene経過で死亡）",str_d:-1,int_d:-1,dex_d:-1,krm_d:-1};break;case"forget":result={state_desc:"STR／INTのうち、高い方が0に（20scene経過で解除）",dex_d:0,krm_d:0},save_data.chara.str<save_data.chara.int?(result.str_d=0,result.int_d=-1*save_data.chara.int):(result.str_d=-1*save_data.chara.str,result.int_d=0);break;case"poison":result={state_desc:"シーン経過ごとにHPを-1",str_d:0,int_d:0,dex_d:0,krm_d:0};break;case"curse":result={state_desc:"魔法の利用が不可（UN-CURSEを除く）",str_d:0,int_d:0,dex_d:0,krm_d:0};break;default:result={state_desc:"－",str_d:0,int_d:0,dex_d:0,krm_d:0}}return result},showSimpleStatus(){$("#sidr_battle #simple_status_hp").text(save_data.chara.hp),$("#sidr_battle #simple_status_mp").text(save_data.chara.mp),$("#sidr_battle #simple_status_str").text(save_data.chara.str),$("#sidr_battle #simple_status_int").text(save_data.chara.int),$("#sidr_battle #simple_status_dex").text(save_data.chara.dex),$("#sidr_battle #simple_status_krm").text(save_data.chara.krm),0!==$("init > label",scenario_data).length?($("#sidr_battle #simple_status_frees").show(),$("#sidr_battle #simple_status_f1").text(save_data.chara.free1),$("#sidr_battle #simple_status_f2").text(save_data.chara.free2),$("#sidr_battle #simple_status_f3").text(save_data.chara.free3)):$("#sidr_battle #simple_status_frees").hide();let state=$("#sidr_battle #simple_status_state");state.text(Common.state_names[save_data.chara.state]).removeClass("status_poison status_frozen status_stone status_curse status_forget"),save_data.chara.state?(state.addClass(`status_${save_data.chara.state}`),target.addClass("main_bad")):target.removeClass("main_bad")},runMagic(magic_id){let msg;switch(magic_id){case"HEAL":Util.updateHpMp("15",void 0),msg="HPが15回復した！";break;case"PEACE":Util.updateHpMp(void 0,"10"),msg="MPが10回復した！";break;case"CURE":Util.updateState("-poison"),msg="毒を解除した！";break;case"MELT":Util.updateState("-frozen"),msg="凍結を解除した！";break;case"STONE-FLESH":Util.updateState("-stone"),msg="石化を解除した！";break;case"UN-CURCE":Util.updateState("-curse"),msg="呪いを解除した！";break;case"AIR-HAND":Util.updateState("-forget"),msg="忘却を解除した！";break;case"RESURRECT":Util.updateHpMp("half","half"),msg="復活に成功した！ただし、HP/MPともに上限の半分となった。";break;case"REDUCE-LIFE":Util.updateHpMp("-25",void 0),Util.updateState("-all"),msg="状態異常を解除した。";break;case"REJUVENATE":msg="直前の判定を一度だけリトライしても良い。";break;case"PROTECT":msg="物理ダメージを半減できる。ダメージ式上のボックスを「1/2」に設定せよ。";break;case"HOLY-WATER":msg="魔法ダメージを半減できる。ダメージ式上のボックスを「x1/2」に設定せよ。";break;case"CHANGE-AIR":msg="本シーンの戦闘をすべて回避できる（ボス戦闘を除く）。";break;case"GIVE-VIGOR":msg="敵の攻撃力が2倍になる。ダメージ式上のボックスを「x2」に設定せよ。また、勝利時はドロップアイテムボタンを2回押すこと。";break;case"EXPLOSION":msg="地属性の敵は全滅した。ダメージボタンを押さずに、ドロップアイテムボタンを押して良い。";break;case"DELUGE":msg="火属性の敵は全滅した。ダメージボタンを押さずに、ドロップアイテムボタンを押して良い。";break;case"FREEZE":msg="水属性の敵は全滅した。ダメージボタンを押さずに、ドロップアイテムボタンを押して良い。";break;case"DESTROY-A":msg="風属性の敵は全滅した。ダメージボタンを押さずに、ドロップアイテムボタンを押して良い。";break;case"LIGHT-CROSS":msg="霊属性の敵は全滅した。ダメージボタンを押さずに、ドロップアイテムボタンを押して良い。";break;case"NOILA-TEM":msg="全属性の敵が全滅した。ダメージボタンを押さずに、ドロップアイテムボタンを押して良い。";break;default:throw new Error("魔法の指定が間違っています。")}toastr.success(msg,"魔法の行使"),Util.saveStorage()},openSideBar(base){$.sidr("open",`sidr_${base}`)},createSideBar(base,template,onOpen,onSubmit){let s_name=`sidr_${base}`;$(template).insertBefore(target),$(`#menu_${base}`).sidr({name:s_name,displace:!1,onOpen:onOpen}),target.parent().on("click",`#${s_name}_submit`,(function(){onSubmit(),$.sidr("close",s_name)})),target.parent().on("click",`#${s_name}_close`,(function(){$.sidr("close",s_name)}))},createBattleSheet(){let that=this,template=$('<div id="sidr_battle">\n        <p id="sidr_battle_bonus" class="bonus_msg"></p>\n        <table class="enemy">\n        <thead>\n        <tr class="enemy_title">\n          <th id="check_cell"></th>\n          <th>名前／属性</th>\n          <th><span id="hp_cell">HP</span></th>\n          <th>攻撃</th>\n          <th title="現在のダイス値に従って、ダメージを反映させます。">\n            ダメージ \n            <select id="damage_delta">\n              <option value="2">x2</option>\' + \n              <option value="1" selected>x1</option>\n              <option value="0.5">x1/2</option>\n              <option value="0.25">x1/4</option>\n            </select>\n          </th>\n          <th title="記載されたドロップアイテムをステータスに反映させます。">戦利品</th>\n          </tr>\n          </thead>\n          <tbody>\n          </tbody>\n        </table>\n        <center id="cubes"></center>\n        <div id="simple_status">\n          HP:<span id="simple_status_hp" class="status_v"></span>　\n          MP:<span id="simple_status_mp" class="status_v"></span>　|　\n          STR:<span id="simple_status_str" class="status_v"></span>　\n          INT:<span id="simple_status_int" class="status_v"></span>　\n          DEX:<span id="simple_status_dex" class="status_v"></span>　\n          KRM:<span id="simple_status_krm" class="status_v"></span>　｜　\n          <span id="simple_status_frees">\n            <br />\n            F1:<span id="simple_status_f1" class="status_v"></span>　\n            F2:<span id="simple_status_f2" class="status_v"></span>　\n            F3:<span id="simple_status_f3" class="status_v"></span>　｜　\n          </span>\n          <span id="simple_status_state" class="status_v"></span>　\n        </div>\n\n        <div id="sidr_battle_close" class="sidr_close">閉じる</div>\n        <div id="common_rule"></div>\n      </div>'),rotate_count;target.parent().on("click","#sidr_battle tr.enemy_row",(function(e){let enemy=enemies_map[$(this).nsAttr("data-enemy")];toastr.options.timeOut=5e3,toastr.info(enemy.desc,enemy.name)})),target.parent().on("click","#sidr_battle input.enemy_check",(function(e){e.stopImmediatePropagation()})),target.parent().on("click","#sidr_battle .enemy_hp",(function(e){e.stopImmediatePropagation();let hp=Number($(this).val()),func_opp=$(this).nsAttr("data-func_opp"),damage=Util.computeDamage(func_opp);hp-=damage,hp<=0&&(hp=0),$(this).val(hp),toastr.success(`${damage} Hit!`,"敵へのダメージ")})),target.parent().on("click","#sidr_battle .enemy_func",(function(e){e.stopImmediatePropagation(),toastr.options.timeOut=5e3;let func=$(this).nsAttr("data-func"),attack=$(this).nsAttr("data-attack");if(-1!==["poison","frozen","stone","curse","forget"].indexOf(attack)){let cond=func.split(/([<>])/),l_damage=Util.computeDamage(cond[0]),r_damage=Util.computeDamage(cond[2]),canEscape;canEscape="<"===cond[1]?l_damage<r_damage:l_damage>r_damage,canEscape?(SeAudio.play("guard",!0),toastr.info("回避に成功した。","状態異常")):Util.updateState(attack)&&(SeAudio.play("state",!0),toastr.error("「"+Common.state_names[attack]+"」を受けた！","状態異常"))}else{let damage=Util.computeDamage(func),h_damage=Bonus.adjustBattleDamage(damage,"hp"),m_damage=Bonus.adjustBattleDamage(damage,"mp"),t_msg;damage<0&&(damage=0),h_damage<0&&(h_damage=0),m_damage<0&&(m_damage=0);let is_damaged=!1;switch(attack){case"physics":h_damage>0&&(is_damaged=!0),save_data.chara.hp=Number(save_data.chara.hp)-h_damage,t_msg=`HPに${h_damage}のダメージ！（現在値：${save_data.chara.hp}）`;break;case"magic":m_damage>0&&(is_damaged=!0),save_data.chara.mp=Number(save_data.chara.mp)-m_damage,t_msg=`MPに${m_damage}のダメージ！（現在値：${save_data.chara.mp}）`;break;case"both":(h_damage>0||m_damage>0)&&(is_damaged=!0),save_data.chara.hp=Number(save_data.chara.hp)-h_damage,save_data.chara.mp=Number(save_data.chara.mp)-m_damage,t_msg=`HP/MPに${h_damage}/${m_damage}のダブルダメージ！（現在値hp/mp：${save_data.chara.hp}/${save_data.chara.mp}）`;break;case"free1":damage>0&&(is_damaged=!0),save_data.chara.free1=Number(save_data.chara.free1)-damage,t_msg=`FREE1に${damage}のダメージ！（現在値：${save_data.chara.free1}）`;break;case"free2":damage>0&&(is_damaged=!0),save_data.chara.free2=Number(save_data.chara.free2)-damage,t_msg=`FREE2に${damage}のダメージ！（現在値：${save_data.chara.free2}）`;break;case"free3":damage>0&&(is_damaged=!0),save_data.chara.free3=Number(save_data.chara.free3)-damage,t_msg=`FREE3に${damage}のダメージ！（現在値：${save_data.chara.free3}）`}is_damaged?(SeAudio.play("damage",!0),toastr.error(t_msg,"被ダメージ")):(t_msg="敵の攻撃を防ぎきった！",SeAudio.play("guard",!0),toastr.info(t_msg,"被ダメージ"))}Util.saveStorage(),that.showSimpleStatus()})),target.parent().on("click","#sidr_battle input.enemy_drop",(function(e){e.stopImmediatePropagation();let drops=$(this).nsAttr("data-drop").split("/");if(2===drops.length)Util.updateStarById(drops[0],drops[1]),toastr.options.timeOut=5e3,toastr.info(`${Common.star_names[drops[0]]}の欠片を${drops[1]}個取得しました。`,"アイテム獲得");else{let at_free1="free1"===drops[0]?drops[1]:0,at_free2="free2"===drops[0]?drops[1]:0,at_free3="free3"===drops[0]?drops[1]:0;Util.updateFrees(at_free1,at_free2,at_free3),toastr.options.timeOut=5e3,toastr.info(`${drops[2]}を取得しました。`,"アイテム獲得")}SeAudio.play("drop",!0),Util.saveStorage(),that.showSimpleStatus()}));let rotateCube=function(){rotate_count++,$("#sidr_battle #cubes").html(that.cube(2)),rotate_count>20||setTimeout(rotateCube,50)};target.parent().on("click","#sidr_battle #cubes",(function(e){SeAudio.play("dice",!0),rotate_count=1,rotateCube()})),this.createSideBar("battle",template,(function(){let current_scene=$(`scene[id=${save_data.scene}]`,scenario_data);if($("#sidr_battle #cubes").html(that.cube(2)),that.showSimpleStatus(),Util.showRuleText(current_scene.nsAttr("rule")),!SideBar.isFirstOpenBattleSheet)return;SideBar.isFirstOpenBattleSheet=!1;let enemy_list=$("#sidr_battle .enemy tbody");enemy_list.empty();let at_enemies=current_scene.nsAttr("enemies");if(at_enemies){let show_hp=!1,enemies=at_enemies.split(",");for(let key of enemies){let enemy=enemies_map[key],atk=Common.state_names[enemy.attack],row=$(`<tr class="enemy_row" data-enemy="${key}">\n                <td>\n                  <input type="checkbox" class="enemy_check" />\n                </td>\n                <th>\n                  <img class="enemy_elem" />　\n                  ${enemy.name}\n                </th>\n                <td class="hp_cell">\n                  <input type="button" class="enemy_hp" />\n                </td>\n                <td>\n                  <img class="enemy_attack" />　\n                  <span class="enemy_attack_old"></span>\n                </td>\n                <td>\n                  <div class="enemy_func"></div>\n                  <span class="enemy_func_old"></span>\n                </td>\n                <td>\n                  <input type="button" class="enemy_drop" />\n                  <span class="enemy_drop_old"></span>\n                </td>\n              </tr>`);if(1===enemies.length&&$(".enemy_check",row).hide(),enemy.element?$(".enemy_elem",row).attr({src:`${ROOT}${COMMON}attr_${enemy.element}.png`,title:Common.element_names[enemy.element]}):$(".enemy_elem",row).attr({src:`${ROOT}${COMMON}attr_none.png`,title:"無"}),enemy.hp?($(".enemy_hp",row).attr("data-func_opp",enemy.func_opp).val(enemy.hp),show_hp=!0):$(".enemy_hp",row).hide(),atk?($(".enemy_attack",row).attr({src:`${ROOT}${COMMON}atk_${enemy.attack}.png`,title:atk}),$(".enemy_attack_old",row).hide()):($(".enemy_attack",row).hide(),$(".enemy_attack_old",row).text(enemy.attack)),enemy.func)if(0===enemy.func.indexOf("*"))$(".enemy_func",row).hide(),$(".enemy_func_old",row).text(Util.selectFunc(enemy.func.substring(1)));else{let tmp_func=Util.selectFunc(enemy.func);$(".enemy_func",row).attr({"data-func":tmp_func,"data-attack":enemy.attack}).text(tmp_func),$(".enemy_func_old",row).hide()}else $(".enemy_func",row).hide(),$(".enemy_func_old",row).hide();let tmp_d=Util.dropItem(enemy);tmp_d.name?($(".enemy_drop",row).val(tmp_d.name).attr("data-drop",tmp_d.drop),$(".enemy_drop_old",row).hide()):$(".enemy_drop",row).hide(),enemy_list.append(row)}show_hp||$("#sidr_battle #hp_cell").hide(),$("#sidr_battle table.enemy").show()}else $("#sidr_battle table.enemy").hide()}),(function(){}))},createPlayerRankInfo(){this.createSideBar("rank",'<div id="sidr_rank" class="sidr_info">\n          <table id="sidr_rank_summary" class="sidr_list_noline">\n            <tr>\n            <td colspan="4">\n              <img id="rank_pic" src="" align="left" />\n              <div>\n                PLAYER LV. <span id="rank_lv"></span>\n                <h3>\n                <span id="rank_en"></span>\n                <span id="rank_jp"></span>\n                </h3>\n              </div>\n            </td>\n            </tr>\n            <tr>\n              <th>CLEAR</th>\n              <td id="rank_clear"></td>\n              <th>RESULT</th>\n              <td id="rank_result"></td>\n            </tr>\n            <tr>\n              <th>BONUS</th>\n              <td id="rank_bonus"></td>\n              <th>EXP.</th>\n              <td id="rank_exp"></td>\n            </tr>\n          </table>\n          <table id="sidr_rank_list" class="sidr_list">\n            <thead>\n            <tr>\n              <th>No.</th>\n              <th>Title</th>\n              <th>Clear</th>\n              <th>Result Rate</th>\n            </tr>\n            <thead>\n            <tbody></tbody>\n          </table>\n          <div id="sidr_rank_close" class="sidr_close">閉じる</div>\n        </div>',(function(){let rank=PlayerRank.getRank();$("#sidr_rank #rank_pic").attr("src",`${ROOT}${COMMON}/rank/rank${rank.level}.png`),$("#sidr_rank #rank_jp").text(rank.jp),$("#sidr_rank #rank_en").text(`"${rank.en}"`),$("#sidr_rank #rank_lv").text(rank.level),$("#sidr_rank #rank_clear").text(`${PlayerRank.scena_count}/${PlayerRank.scena_all}`),$("#sidr_rank #rank_result").text(`${PlayerRank.scena_results_count}/${PlayerRank.scena_results_all}`),$("#sidr_rank #rank_bonus").text(`${PlayerRank.bonus_count}/${PlayerRank.bonus_all}`),$("#sidr_rank #rank_exp").text(`${PlayerRank.exp_count}/${PlayerRank.exp_all}`);let b=$("#sidr_rank #sidr_rank_list tbody");b.empty();let i=1;for(let key in PlayerRank.scena_infos){let inf=PlayerRank.scena_infos[key];b.append(`<tr>\n              <td>${i++}</td>\n              <td>${inf.title}</td>\n              <td>${inf.is_cleared?"○":""}</td>\n              <td>${Math.floor(inf.results_count/inf.results_all*100)}%（${inf.results_count}/${inf.results_all}）</td>\n            </tr>`)}}),(function(){}))},createBasicInfo(){let template=$('<div id="sidr_basic" class="sidr_info">\n        <img id="sidr_basic_chara_face" align="right" />\n        <h2>\n          "<span id="sidr_basic_title"></span>"\n          <span id="sidr_basic_name"></span>\n        </h2>\n        <i>\n          <span id="sidr_basic_ellapsed_scene"></span>\n        </i>\n        <table class="sidr_list_noline sidr_basic_table">\n        <tr>\n          <th>CLASS：</th>\n          <td>\n            <span id="sidr_basic_race"></span>　\n            <span id="sidr_basic_sex"></span>\n          </td>\n        </tr>\n        <tr>\n          <th>AGE：</th>\n          <td><span id="sidr_basic_age"></span></td>\n        </tr>\n        <tr>\n          <th>JOB：</th>\n          <td><select id="sidr_basic_job"></select></td>\n        </tr>\n        </table>\n        <hr />\n        <textarea id="sidr_basic_memos" placeholder="君は冒険中のメモをここに記録しておいても構わないし、脳裏に留めておいても構わない。"></textarea>\n        <div id="sidr_basic_submit" class="sidr_submit">確定</div>\n        <div id="sidr_basic_close" class="sidr_close">閉じる</div>\n      </div>');$("#sidr_basic_chara_face",template).attr("src",ROOT+COMMON+String(save_data.chara.sex).toLowerCase()+"_"+String(save_data.chara.age).toLowerCase()+"_"+String(save_data.chara.race).toLowerCase()+".png"),$("#sidr_basic_name",template).text(save_data.chara.name),$("#sidr_basic_title",template).text(save_data.chara.title),$("#sidr_basic_ellapsed_scene",template).text(`${save_data.ellapsed_scene} scene`),$("#sidr_basic_race",template).text(save_data.chara.race),$("#sidr_basic_sex",template).text(save_data.chara.sex),$("#sidr_basic_age",template).text(save_data.chara.age);let job_box=$("#sidr_basic_job",template);job_box.empty();for(let job of enabled_jobs)$("<option></option>").attr("value",job).text(job).appendTo(job_box);this.createSideBar("basic",template,(function(){$("#sidr_basic #sidr_basic_ellapsed_scene").text(`${save_data.ellapsed_scene} scene`),$("#sidr_basic #sidr_basic_job").val(save_data.chara.job),$("#sidr_basic #sidr_basic_memos").val(save_data.memos)}),(function(){save_data.chara.job=$("#sidr_basic #sidr_basic_job").val(),save_data.memos=$("#sidr_basic #sidr_basic_memos").val(),Util.saveStorage()}))},createItemFlagInfo(){this.createSideBar("item",`<div id="sidr_item" class="sidr_info">\n          <h2><img src="${ROOT}${COMMON}side/items_flags.png" alt="Items & Flags" /></h2>\n          <div>\n            ITEMS：<br/>\n            <textarea id="sidr_item_item"></textarea>\n          </div>\n          <div>\n            FLAGS：<br />\n            <textarea id="sidr_item_flag"></textarea>\n          </div>\n         <div id="sidr_item_close" class="sidr_close">閉じる</div>\n       </div>`,(function(){let items=[];for(let key of save_data.items){let item=items_map[key];items.push(`・${item.name}（${item.desc}）`)}$("#sidr_item #sidr_item_item").text(items.join("\r"));let flags=[];for(let key of save_data.flags){let f_text=flags_map[key];0!==f_text.indexOf("*")&&flags.push(`・${f_text}`)}$("#sidr_item #sidr_item_flag").text(flags.join("\r"))}),(function(){}))},createStatusSheet(){let that=this,template=$(`<div id="sidr_status" class="sidr_info">\n        <h2><img src="${ROOT}${COMMON}side/status.png" alt="Status" /></h2>\n        <p id="sidr_status_bonus" class="bonus_msg"></p>\n        <table id="sidr_status_list">\n          <tr>\n          <td>\n            <div>\n            <span id="sidr_status_str_label">HP</span><br />\n            <input type="button" class="spinner_down" value="-" />\n            <input id="sidr_status_hp" type="number" />\n            <input type="button" class="spinner_up" value="+" />\n            ／\x3c!--<span id="sidr_status_hp_m"></span>--\x3e\n              <input id="sidr_status_hp_m" type="number" />\n            </div>\n            <div>\n            <span id="sidr_status_mp_label">MP</span><br />\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_status_mp" />\n            <input type="button" class="spinner_up" value="+" />\n            ／\x3c!--<span id="sidr_status_mp_m"></span>--\x3e\n              <input type="number" id="sidr_status_mp_m" />\n            </div>\n            <div>\n            <span id="sidr_status_state_label">STATE</span><br />\n            <label><input type="radio" name="sidr_status_state" value="" />正常</label>\n            <label><input type="radio" name="sidr_status_state" value="poison" />毒</label>\n            <label><input type="radio" name="sidr_status_state" value="frozen" />凍結</label>\n            <label><input type="radio" name="sidr_status_state" value="stone" />石化\n            (<span id="sidr_status_stone_scene">0</span>)</label>\n            <label><input type="radio" name="sidr_status_state" value="curse" />呪い</label>\n            <label><input type="radio" name="sidr_status_state" value="forget" />忘却\n            (<span id="sidr_status_forget_scene">0</span>)</label>\n            <div id="sidr_status_state_desc">－－－</div>\n            </div>\n          </td>\n          <td>\n            <div>\n            <span id="sidr_status_str_label">STR</span><br />\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_status_str" />\n            <input type="button" class="spinner_up" value="+" />\n            \x3c!--／<span id="sidr_status_str_i"></span>\n               <input type="number" id="sidr_status_str_i" />--\x3e\n            </div>\n            <div>\n            <span id="sidr_status_int_label">INT</span><br />\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_status_int" />\n            <input type="button" class="spinner_up" value="+" />\n            \x3c!--／<span id="sidr_status_int_i"></span>\n              <input type="number" id="sidr_status_int_i" />--\x3e\n            </div>\n            <div>\n            <span id="sidr_status_dex_label">DEX</span><br />\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_status_dex" />\n            <input type="button" class="spinner_up" value="+" />\n            \x3c!--／<span id="sidr_status_dex_i"></span>\n              <input type="number" id="sidr_status_dex_i" />--\x3e\n            </div>\n            <div>\n            <span id="sidr_status_krm_label">KRM</span><br />\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_status_krm" />\n            <input type="button" class="spinner_up" value="+" />\n            \x3c!--／<span id="sidr_status_krm_i"></span>\n              <input type="number" id="sidr_status_krm_i" />--\x3e\n            </div>\n          </td>\n          </tr>\n        </table>\n        <div>\n          <table id="sidr_status_free_list">\n          <tr>\n            <td><span id="sidr_status_free1_label">FREE1</span></td>\n            <td><span id="sidr_status_free2_label">FREE2</span></td>\n            <td><span id="sidr_status_free3_label">FREE3</span></td>\n          </tr>\n          <tr>\n            <td>\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_status_free1" />\n            <input type="button" class="spinner_up" value="+" />・ \n            </td>\n            <td>\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_status_free2" />\n            <input type="button" class="spinner_up" value="+" />・ \n            </td>\n            <td>\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_status_free3" />\n            <input type="button" class="spinner_up" value="+" /> \n            </td>\n          </tr>\n          </table>\n\n          \x3c!--\n          <label class="entry">FREE：</label><br />\n          <table id="sidr_status_free_list">\n          <tr>\n          <td>\n          <input type="button" class="spinner_down" value="-" />\n          <input type="number" id="sidr_status_free1" />\n          <input type="button" class="spinner_up" value="+" />・\n          <span class="free-label">\n          <br />\n          <span id="sidr_status_free_label1"></span>\n          </span>\n          </td>\n          <td>\n          <input type="button" class="spinner_down" value="-" />\n          <input type="number" id="sidr_status_free2" />\n          <input type="button" class="spinner_up" value="+" />・\n          <span class="free-label">\n            <br />\n            <span id="sidr_status_free_label2"></span>\n          </span>\n          </td>\n          <td>\n          <input type="button" class="spinner_down" value="-" />\n          <input type="number" id="sidr_status_free3" />\n          <input type="button" class="spinner_up" value="+" />\n          <span class="free-label">\n            <br />\n            <span id="sidr_status_free_label3"></span>\n          </span>\n          </td>\n          </tr>\n          </table>\n          --\x3e\n        </div>\n        <div id="sidr_status_submit" class="sidr_submit">確定</div>\n        <div id="sidr_status_close" class="sidr_close">閉じる</div>\n      </div>`);target.parent().on("click",'[name="sidr_status_state"]',(function(e){let delta=that.deltaStatus($(this).val());$("#sidr_status #sidr_status_state_desc").text(delta.state_desc),that.setStateStyle()})),target.parent().on("click","#sidr_status .spinner_up",this.incrementValue),target.parent().on("click","#sidr_status .spinner_down",this.decrementValue),this.createSideBar("status",template,(function(){$("#sidr_status #sidr_status_hp").val(save_data.chara.hp),$("#sidr_status #sidr_status_mp").val(save_data.chara.mp),$("#sidr_status #sidr_status_hp_m").val(save_data.chara.hp_m),$("#sidr_status #sidr_status_mp_m").val(save_data.chara.mp_m),$("#sidr_status #sidr_status_str_i").val(save_data.chara.str_i),$("#sidr_status #sidr_status_int_i").val(save_data.chara.int_i),$("#sidr_status #sidr_status_dex_i").val(save_data.chara.dex_i),$("#sidr_status #sidr_status_krm_i").val(save_data.chara.krm_i),$('#sidr_status [name="sidr_status_state"]').each((function(){var state;$(this).nsAttr("value")===save_data.chara.state?$(this).prop("checked",!0):$(this).prop("checked",!1)})),$("#sidr_status #sidr_status_stone_scene").text(save_data.chara.stone_scene),$("#sidr_status #sidr_status_forget_scene").text(save_data.chara.forget_scene),that.setStateStyle();let delta=that.deltaStatus($('[name="sidr_status_state"]:checked').val());$("#sidr_status #sidr_status_state_desc").text(delta.state_desc),$("#sidr_status #sidr_status_free1").val(save_data.chara.free1),$("#sidr_status #sidr_status_free2").val(save_data.chara.free2),$("#sidr_status #sidr_status_free3").val(save_data.chara.free3);let flabel=$("init > label",scenario_data);if(flabel){let setLabel=function(name){let tmp=flabel.nsAttr(name);tmp&&$(`#sidr_status #sidr_status_${name}_label`).text(tmp)};setLabel("hp"),setLabel("mp"),setLabel("state"),setLabel("str"),setLabel("int"),setLabel("dex"),setLabel("krm"),setLabel("free1"),setLabel("free2"),setLabel("free3")}$("#sidr_status #sidr_status_str").val(save_data.chara.str),$("#sidr_status #sidr_status_int").val(save_data.chara.int),$("#sidr_status #sidr_status_dex").val(save_data.chara.dex),$("#sidr_status #sidr_status_krm").val(save_data.chara.krm)}),(function(){save_data.chara.hp=$("#sidr_status #sidr_status_hp").val(),save_data.chara.mp=$("#sidr_status #sidr_status_mp").val(),save_data.chara.hp_m=$("#sidr_status #sidr_status_hp_m").val(),save_data.chara.mp_m=$("#sidr_status #sidr_status_mp_m").val(),save_data.chara.free1=$("#sidr_status #sidr_status_free1").val(),save_data.chara.free2=$("#sidr_status #sidr_status_free2").val(),save_data.chara.free3=$("#sidr_status #sidr_status_free3").val(),save_data.chara.str_i=$("#sidr_status #sidr_status_str_i").val(),save_data.chara.int_i=$("#sidr_status #sidr_status_int_i").val(),save_data.chara.dex_i=$("#sidr_status #sidr_status_dex_i").val(),save_data.chara.krm_i=$("#sidr_status #sidr_status_krm_i").val(),save_data.chara.str=$("#sidr_status #sidr_status_str").val(),save_data.chara.int=$("#sidr_status #sidr_status_int").val(),save_data.chara.dex=$("#sidr_status #sidr_status_dex").val(),save_data.chara.krm=$("#sidr_status #sidr_status_krm").val(),Util.updateState($('#sidr_status [name="sidr_status_state"]:checked').val()),Util.saveStorage(),that.showSimpleStatus()}))},createMagicSheet(){let that=this,useStar=function(magic,index,name){if(magic[index]>0){let e_star=$(`#sidr_magic #sidr_magic_${name}`),num=Number(e_star.val());e_star.val(num-magic[index])}},template=$(`<div id="sidr_magic" class="sidr_info">\n      <h2><img src="${ROOT}${COMMON}side/magic.png" alt="Magic & STARS" /></h2>\n      <p id="sidr_magic_bonus" class="bonus_msg"></p>\n      <div>\n        <select id="sidr_magic_magic"></select>\n        <input type="button" id="sidr_magic_run" value="Shoot" />\n      </div>\n      <table id="sidr_magic_list">\n        <tr>\n          <td>\n            <div>\n            月\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_magic_mon" />\n            <input type="button" class="spinner_up" value="+" />\n            </div>\n            <div>\n            火\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_magic_tue" />\n            <input type="button" class="spinner_up" value="+" />\n            </div>\n            <div>\n            水\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_magic_wed" />\n            <input type="button" class="spinner_up" value="+" />\n            </div>\n            <div>\n            木\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_magic_thu" />\n            <input type="button" class="spinner_up" value="+" />  \n            </div>  \n          </td>\n          <td>\n            <div>\n            金\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_magic_fri" />\n            <input type="button" class="spinner_up" value="+" />\n            </div>\n            <div>\n            土\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_magic_sat" />\n            <input type="button" class="spinner_up" value="+" />\n            </div>\n            <div>\n            太\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_magic_sun" />\n            <input type="button" class="spinner_up" value="+" />\n            </div>\n          </td>\n        </tr>\n      </table>\n      <div id="sidr_magic_submit" class="sidr_submit">確定</div>\n      <div id="sidr_magic_close" class="sidr_close">閉じる</div>\n      </div>`);target.parent().on("click","#sidr_magic .spinner_up",this.incrementValue),target.parent().on("click","#sidr_magic .spinner_down",this.decrementValue),$("#sidr_magic_run",template).click((function(e){e.preventDefault();let magic_id=$("#sidr_magic #sidr_magic_magic").val();if("curse"===save_data.chara.state&&"UN-CURCE"!==magic_id)return toastr.warning("魔法を詠唱できない！君は呪われている！！","状態異常"),!1;let magic=Common.magic[magic_id];magic&&($("#sidr_magic #sidr_magic_mon").val()<magic[0]||$("#sidr_magic #sidr_magic_tue").val()<magic[1]||$("#sidr_magic #sidr_magic_wed").val()<magic[2]||$("#sidr_magic #sidr_magic_thu").val()<magic[3]||$("#sidr_magic #sidr_magic_fri").val()<magic[4]||$("#sidr_magic #sidr_magic_sat").val()<magic[5]||$("#sidr_magic #sidr_magic_sun").val()<magic[6]?window.alert("星が不足しているため、魔法を発動できません！"):(useStar(magic,0,"mon"),useStar(magic,1,"tue"),useStar(magic,2,"wed"),useStar(magic,3,"thu"),useStar(magic,4,"fri"),useStar(magic,5,"sat"),useStar(magic,6,"sun"),that.runMagic(magic_id),SeAudio.play("magic",!0),$("#sidr_magic #sidr_magic_submit").click(),that.showSimpleStatus()))})),$(".spinner_up",template).click(this.incrementValue()),this.createSideBar("magic",template,(function(){"curse"===save_data.chara.state?$("#sidr_magic_magic").addClass("dialog_curse"):$("#sidr_magic_magic").removeClass("dialog_curse");let magic_box=$("#sidr_magic #sidr_magic_magic");magic_box.empty();for(let key in Common.magic){let magic=Common.magic[key],option=$("<option></option>").attr("value",key).attr("title",magic[8]).text(`${key}（${magic[7]}）`);Util.canUseMagic(magic,key)||option.attr("disabled","disabled"),option.appendTo(magic_box)}$("#sidr_magic #sidr_magic_mon").val(save_data.stars[0]),$("#sidr_magic #sidr_magic_tue").val(save_data.stars[1]),$("#sidr_magic #sidr_magic_wed").val(save_data.stars[2]),$("#sidr_magic #sidr_magic_thu").val(save_data.stars[3]),$("#sidr_magic #sidr_magic_fri").val(save_data.stars[4]),$("#sidr_magic #sidr_magic_sat").val(save_data.stars[5]),$("#sidr_magic #sidr_magic_sun").val(save_data.stars[6])}),(function(){save_data.stars[0]=$("#sidr_magic #sidr_magic_mon").val(),save_data.stars[1]=$("#sidr_magic #sidr_magic_tue").val(),save_data.stars[2]=$("#sidr_magic #sidr_magic_wed").val(),save_data.stars[3]=$("#sidr_magic #sidr_magic_thu").val(),save_data.stars[4]=$("#sidr_magic #sidr_magic_fri").val(),save_data.stars[5]=$("#sidr_magic #sidr_magic_sat").val(),save_data.stars[6]=$("#sidr_magic #sidr_magic_sun").val(),Util.saveStorage()}))},createBonusInfo(){let template=$(`<div id="sidr_bonus" class="sidr_info">\n        <h2><img src="${ROOT}${COMMON}side/bonus.png" alt="Bonus" /></h2>\n        <ul id="sidr_bonus_list">\n          <li><img id="gi01" /></li>\n          <li><img id="gi02" /></li>\n          <li><img id="gi03" /></li>\n          <li><img id="gi04" /></li>\n          <li><img id="gi05" /></li>\n          <li><img id="gi06" /></li>\n          <li><img id="gi07" /></li>\n          <li><img id="gi08" /></li>\n          <li><img id="gi09" /></li>\n          <li><img id="gi10" /></li>\n          <li><img id="gi11" /></li>\n          <li><img id="gi12" /></li>\n          <li><img id="gi13" /></li>\n          <li><img id="gi14" /></li>\n          <li><img id="gi15" /></li>\n          <li><img id="gi16" /></li>\n          <li><img id="gi17" /></li>\n          <li><img id="gi18" /></li>\n          <li><img id="gi19" /></li>\n          <li><img id="gi20" /></li>\n          <li><img id="gi21" /></li>\n          <li><img id="gi22" /></li>\n          <li><img id="gi23" /></li>\n          <li><img id="bgi01" /></li>\n          <li><img id="bgi02" /></li>\n          <li><img id="bgi03" /></li>\n          <li><img id="bgi04" /></li>\n          <li><img id="bgi05" /></li>\n        </ul>\n        <div id="sidr_bonus_close" class="sidr_close">閉じる</div>\n      </div>`),addItemList=function(count,prefix){let num;for(let i=1;i<=count;i++){num=i<10?`0${i}`:i,num=`${prefix}${num}`;let img=$(`#${num}`,template);-1!==$.inArray(num,global_save_data.items)?img.attr("src",`${ROOT}${COMMON}${num}.png`).attr("class","bonus_item"):img.attr("src",`${ROOT}${COMMON}gi99.png`),save_data.bonus===num&&img.parent().css("background-color","#7fffd4")}};addItemList(Object.keys(Common.global_items.happy).length,"gi"),addItemList(Object.keys(Common.global_items.bad).length,"bgi"),target.parent().on("click","#sidr_bonus_list img.bonus_item",(function(e){let id=e.target.id,o_bonus_item;o_bonus_item=id.startsWith("gi")?Common.global_items.happy[id]:Common.global_items.bad[id],toastr.success(o_bonus_item.desc,o_bonus_item.name)})),this.createSideBar("bonus",template,(function(){}),(function(){}))},createResultInfo(){this.createSideBar("result",`<div id="sidr_result" class="sidr_info">\n          <h2><img src="${ROOT}${COMMON}side/results.png" alt="Results" /></h2>\n          <div id="sidr_result_rate">Rate: 0.0%</div>\n          <table id="sidr_result_list">\n          </table>\n          <div id="sidr_result_close" class="sidr_close">閉じる</div>\n        </div>`,(function(){let result_count=0,get_result=0,trophy=["","ノーマル","ブロンズ","シルバー","ゴールド","プラチナ"],list=$("#sidr_result #sidr_result_list");list.empty(),Object.keys(results_map).forEach((function(key){let row;result_count++,void 0!==global_save_data.results[scenario_code]&&-1!==global_save_data.results[scenario_code].indexOf(key)?(get_result++,row=`<tr>\n                <td>\n                  <img src="${ROOT}${COMMON}trophy${results_map[key].level}.png"\n                    title="${trophy[results_map[key].level]}" />\n                </td>\n                <td>\n                  <h3>${results_map[key].name}\n                  （Lv.${results_map[key].level}）</h3>\n                  <p>${results_map[key].desc}</p>\n                </td>\n              </tr>`):row=`<tr>\n                <td>\n                  <img src="${ROOT}${COMMON}trophy0.png"\n                    title="実績未達" />\n                </td>\n                <td>\n                  <h3>???????????????</h3>\n                  <p>???????????????</p>\n                </td>\n              </tr>`,list.append(row)}));let result_rate=(get_result/result_count*100).toFixed(1);$("#sidr_result #sidr_result_rate").text(`Rate:${result_rate}%`)}),(function(){}))},createAll(){this.createBasicInfo(),this.createStatusSheet(),this.createMagicSheet(),this.createItemFlagInfo(),this.createResultInfo(),this.createBonusInfo(),this.createPlayerRankInfo(),this.createBattleSheet()},closeAll(){let bases=["basic","status","magic","item","result","bonus","rank","battle"];for(let base of bases)$.sidr("close",`sidr_${base}`)}},ControlPanel={init(){let mainmenu;$('<nav class="main-nav" role="navigation">\n        \x3c!-- Mobile menu toggle button (hamburger/x icon) --\x3e\n        <input id="main-menu-state" type="checkbox" />\n        <label class="main-menu-btn" for="main-menu-state">\n          <span class="main-menu-btn-icon"></span> Toggle main menu visibility\n        </label>\n        \n        <h2 class="nav-brand"><a href="./">\n          <img src="./stext/common/gamebook_header_text.png"/>\n          <span class="pconly" style="vertical-align: top;">SORCERIAN Text</span>\n        </a></h2>\n        \n        \x3c!-- Sample menu definition --\x3e\n        <ul id="main-menu" class="sm sm-blue">\n          <li><a id="menu_status" href="#">Status</a></li>\n          <li><a id="menu_magic" href="#">Magic</a></li>\n          <li><a href="#">Info</a>\n            <ul>\n              <li><a id="menu_basic">Character</a></li>\n              <li><a id="menu_item">Items & Flags</a></li>\n              <li><a id="menu_result">Result</a></li>\n              <li><a id="menu_bonus">Bonus</a></li>\n              <li><a id="menu_rank">Player Rank</a></li>\n            </ul>\n          </li>\n          <li><a href="#">System</a>\n            <ul>\n              <li><a id="menu_backup">Backup</a></li>\n              <li><a id="menu_restore">Restore</a><input id="menu_restore_select" type="file" accept=".stext" /></li>\n              <li><a href="https://sorcerian.hateblo.jp/entries/2017/12/20">Help</a></li>\n              <li><a href="./">Exit</a></li>\n            </ul>\n          </li>\n          <li>\n            <a id="menu_audio">\n              <img src="./stext/common/menu_audio_on.png" />\n            </a>\n          </li>\n        </ul>\n      </nav>').insertBefore(target),$("#main-menu").smartmenus({noMouseOver:!0,subMenusSubOffsetX:1,subMenusSubOffsetY:-8});let $mainMenuState=$("#main-menu-state");$mainMenuState.length&&(target.parent().on("change","#main-menu-state",(function(e){let $menu=$("#main-menu");this.checked?$menu.hide().slideDown(250,(function(){$menu.css("display","")})):$menu.show().slideUp(250,(function(){$menu.css("display","")}))})),$(window).bind("beforeunload unload",(function(){$mainMenuState[0].checked&&$mainMenuState[0].click()}))),$('<div id="menu_battle">Battle Sheet</div>').insertBefore(target),target.parent().on("click","#menu_backup",(function(){Util.downloadSavedata(scenario_code,storage[scenario_code])})),target.parent().on("click","#menu_restore",(function(){$("#menu_restore_select").click()})),target.parent().on("change","#menu_restore_select",(function(){scenario_code===this.files[0].name.split("-")[0]?Util.restoreSaveData(this,(function(){window.alert("リストアに成功しました。\nゲームを再起動します。"),location.reload()})):window.alert("失敗：現在のシナリオ以外のバックアップはUtilityページからリストアしてください。")})),$("#menu_audio > img").attr("src",`${ROOT}${COMMON}menu_audio_${global_save_data.bgm?"on":"off"}.png`),target.parent().on("click","#menu_audio",(function(e){bgm&&(global_save_data.bgm?(global_save_data.bgm=!1,$("img",this).attr("src",`${ROOT}${COMMON}menu_audio_off.png`),bgm.pause()):(global_save_data.bgm=!0,$("img",this).attr("src",`${ROOT}${COMMON}menu_audio_on.png`),bgm.play()),Util.saveStorageGlobal())}))}};var Util={random:function(min,max){return Math.floor(Math.random()*(max-min+1))+min},minMaxGuard:function(num){return num<0?0:num>10?10:num},randomArray:function(data){return data[Math.floor(Math.random()*data.length)]},pushUnique:function(data,value){return-1===data.indexOf(value)&&(data.push(value),!0)},shiftUnique:function(data,value){return data.filter((function(elem){return elem!==value}))},ltrim:function(str){return str.substr(1)},deepCopyObject:function(obj){var tmp_obj=JSON.stringify(obj);return JSON.parse(tmp_obj)},processByWeight(weights,...funcs){let num=0,rand=Math.random();for(let i=0;i<weights.length;i++)if(num+=weights[i],rand<num)return void funcs[i]()},saveStorage:function(){storage[scenario_code]=JSON.stringify(save_data)},loadStorage:function(){save_data=JSON.parse(storage[scenario_code])},saveStorageGlobal:function(){storage[GLOBAL_SAVE_DATA_KEY]=JSON.stringify(global_save_data)},loadStorageGlobal:function(){global_save_data=JSON.parse(storage[GLOBAL_SAVE_DATA_KEY])},initSavedata:function(){var constraint=$("init > constraint",scenario_data),init_races,init_sex,init_ages;if(constraint){var init_races;(init_races=constraint.nsAttr("race"))&&(init_races=init_races.split(","));var init_sex=constraint.nsAttr("sex"),init_ages;(init_ages=constraint.nsAttr("age"))&&(init_ages=init_ages.split(","))}var pc_base=this.randomArray(Common.pc_init.filter((function(value){return!init_races||init_races.includes(value[0])})).filter((function(value){return!init_sex||init_sex===value[1]}))),hp_m=this.random(pc_base[2],pc_base[2]+10),mp_m=this.random(pc_base[3],pc_base[3]+10),str_i=this.minMaxGuard(this.random(pc_base[4],pc_base[4]+2)),int_i=this.minMaxGuard(this.random(pc_base[5],pc_base[5]+2)),dex_i=this.minMaxGuard(this.random(pc_base[6],pc_base[6]+2)),krm_i=this.minMaxGuard(this.random(pc_base[7],pc_base[7]+2)),old_data=storage[scenario_code],old_memo="";old_data&&(old_memo=(old_data=JSON.parse(old_data)).memos),save_data={chara:{name:"MALE"===pc_base[1]?this.randomArray(Common.male_name):this.randomArray(Common.female_name),title:this.randomArray(Common.title),race:pc_base[0],sex:pc_base[1],age:this.randomArray(["YOUNG","ADULT","OLD"].filter((function(value){return!init_ages||init_ages.includes(value)}))),job:"",state:"",stone_scene:0,forget_scene:0,hp_m:hp_m,hp:hp_m,mp_m:mp_m,mp:mp_m,str_i:str_i,str:str_i,int_i:int_i,int:int_i,dex_i:dex_i,dex:dex_i,krm_i:krm_i,krm:krm_i,free1:0,free2:0,free3:0},stars:[0,0,0,0,0,0,0],items:[],flags:[],memos:old_memo,scene:0,ellapsed_scene:0,bgm:"",bonus:this.randomArray(global_save_data.items),isEnded:!1},this.initJobs(),save_data.chara.job=this.randomArray(enabled_jobs),this.saveStorage()},initGlobalSaveData:function(){global_save_data={items:[],results:{},bgm:!0,panel:!0},this.saveStorageGlobal(GLOBAL_SAVE_DATA_KEY)},initJobs:function(){enabled_jobs=Object.keys(Common.jobs).filter((function(name){var cond=Common.jobs[name];return-1!==cond[0].indexOf(save_data.chara.race.charAt(0))&&-1!==cond[1].indexOf(save_data.chara.sex.charAt(0))&&-1!==cond[2].indexOf(save_data.chara.age.charAt(0))}))},downloadSavedata:function(scena_id,data){var ua=navigator.userAgent.toLowerCase();if(-1!==ua.indexOf("safari")&&-1===ua.indexOf("chrome")&&-1===ua.indexOf("edge"))window.open("./stext/download.php?id="+scena_id+"&data="+data);else{var blob=new Blob([data],{type:"application/octet-stream"}),anchor=document.createElement("a");anchor.href=window.URL.createObjectURL(blob),anchor.download=scena_id+"-"+(new Date).getTime()+".stext",document.body.appendChild(anchor),anchor.click(),document.body.removeChild(anchor)}},restoreSaveData:function(el,done){var input=el.files[0],fname=input.name.split("-")[0],reader=new FileReader;$(reader).on("load",(function(){if("all"===fname)for(var data=reader.result.split("\n"),key="",value="",i=0;i<data.length;i++)i%2==0?key=data[i]:(value=data[i])&&(storage[key]=value);else storage[fname]=reader.result;done()})),reader.readAsText(input,"UTF-8")},buildBgmPath:function(base){return""===base&&(base=bgms_map.main),0===base.indexOf("@")?ROOT+COMMON+BGM+base.substring(1)+".mp3":ROOT+scenario_code+"/"+BGM+base+".mp3"},validateScenario:function(){var error_messages=[],tmp_scenes=[],checkId=function(org,value,scene_id){if(void 0!==value&&""!==value){var ids=value.trim().split(","),keys=Object.keys(org);ids.forEach((function(id){id=id.replace("-",""),-1===keys.indexOf(id)&&error_messages.push({scene_id:scene_id,message:id.startsWith("i")?"アイテムコード"+id+"が未登録です。":id.startsWith("f")?"フラグコード"+id+"が未登録です。":id.startsWith("m")?"敵コード"+id+"が未登録です。":"実績コード"+id+"が未登録です。"})}))}};return $("scene",scenario_data).each((function(index,scene){var tmp_s=$(scene);-1===tmp_scenes.indexOf(tmp_s.nsAttr("id"))?tmp_scenes.push(tmp_s.nsAttr("id")):error_messages.push({scene_id:tmp_s.nsAttr("id"),message:"scene－idが重複しています。"}),checkId(items_map,tmp_s.nsAttr("items"),tmp_s.nsAttr("id")),checkId(flags_map,tmp_s.nsAttr("flags"),tmp_s.nsAttr("id")),checkId(enemies_map,tmp_s.nsAttr("enemies"),tmp_s.nsAttr("id")),checkId(results_map,tmp_s.nsAttr("result"),tmp_s.nsAttr("id"))})),error_messages},getRandomLinkNumber(dest){if(-1!==dest.indexOf(",")){let tmp=dest.split(";"),result=Util.randomArray(tmp[0].split(",")).trim();if(tmp[1]){let name=`random_${scenario_code}${save_data.scene}`;cval=Cache.getItem(name),cval?result=cval:Cache.setItem(name,result,Number(tmp[1]))}return result}return dest},canUseMagic:function(magic,key){return!(save_data.stars[0]<magic[0]||save_data.stars[1]<magic[1]||save_data.stars[2]<magic[2]||save_data.stars[3]<magic[3]||save_data.stars[4]<magic[4]||save_data.stars[5]<magic[5]||save_data.stars[6]<magic[6])&&("curse"!==save_data.chara.state||"UN-CURCE"===key)},canUseMagicByName:function(name){return 0===name.indexOf("m")&&Util.canUseMagic(Common.magic[name.substring(1)])},ifStatus:function(cond){if(0===cond.indexOf("o")){var cond_set=cond.match(/o(hp|mp|str|int|dex|krm|freei|freeii|freeiii)\s*(\d{1,})(\+|-)\s*/i);cond_set[1]=cond_set[1].toLowerCase(),cond_set[1]=cond_set[1].replace("freeiii","free3"),cond_set[1]=cond_set[1].replace("freeii","free2"),cond_set[1]=cond_set[1].replace("freei","free1");var current_value=save_data.chara[cond_set[1]];return"-"===cond_set[3]?current_value<Number(cond_set[2]):current_value>Number(cond_set[2])}return!1},isCharaState:function(state){var tmp_state;return 0===state.indexOf("x")&&-1!==[save_data.chara.race,save_data.chara.sex,save_data.chara.age,save_data.chara.state.toUpperCase(),save_data.chara.job].indexOf(state.substring(1).toUpperCase())},hasStars:function(at_stars){if(0===at_stars.indexOf("s")){var stars=save_data.stars;if(-1!==at_stars.indexOf(":")){at_stars=at_stars.substring(1).split(":");for(var i=0;i<at_stars.length;i++)if(Number(stars[i])<at_stars[i])return!1}else{at_stars=Number(at_stars.substring(1));for(var star_sum=0,i=0;i<7;i++)star_sum+=Number(stars[i]);if(star_sum<at_stars)return!1}return!0}return!1},hasResult:function(result){if(0===result.indexOf("r")){var results=result.split(":"),info=global_save_data.results[results[1].trim()];if(void 0!==info)return-1!==info.indexOf(results[0].trim())}return!1},updateItems:function(at_items){if(at_items){for(var items=save_data.items,at_items=at_items.split(","),i=0;i<at_items.length;i++){var item=at_items[i].trim();0===item.indexOf("-")?(item=this.ltrim(item),items=this.shiftUnique(items,item)):this.pushUnique(items,item)}save_data.items=items}},updateFlags:function(at_flags){if(at_flags){for(var flags=save_data.flags,at_flags=at_flags.split(","),i=0;i<at_flags.length;i++){var flag=at_flags[i].trim();0===flag.indexOf("-")?(flag=this.ltrim(flag),0===flags_map[flag].indexOf("*")?flags=this.shiftUnique(flags,flag):console.log(flag+"：隠しフラグ以外は削除できません。")):this.pushUnique(flags,flag)}save_data.flags=flags}},updateStates:function(){"poison"===save_data.chara.state?(save_data.chara.hp-=1,save_data.chara.stone_scene=0,save_data.chara.poison_scene=0):"stone"===save_data.chara.state?(save_data.chara.stone_scene+=1,save_data.chara.forget_scene=0,30===save_data.chara.stone_scene&&toastr.error("原因：石化より30Sceneが経過したため","あなたは死んでしまった")):"forget"===save_data.chara.state?(save_data.chara.forget_scene+=1,save_data.chara.stone_scene=0,20===save_data.chara.forget_scene&&(toastr.success("20Scene経過で忘却が解消された！","忘却解除"),Util.updateState("-forget"))):(save_data.chara.stone_scene=0,save_data.chara.forget_scene=0)},updateStars:function(at_stars){if(at_stars){var stars=save_data.stars;if(-1!==at_stars.indexOf(",")){at_stars=at_stars.split(",");for(var i=0;i<at_stars.length;i++)stars[i]=Number(stars[i])+Number(at_stars[i].trim()),stars[i]<0&&(stars[i]=0)}else if(0===at_stars.indexOf("div")){at_stars=at_stars.substring(3);for(var i=0;i<7;i++)stars[i]=Math.floor(Number(stars[i])/Number(at_stars))}save_data.stars=stars}},updateStarsByMagic:function(cond){if(void 0===cond||0===cond.indexOf("-"))return!0;for(var stars=save_data.stars.concat(),useStar=function(magic){for(var i=0;i<stars.length;i++)if(stars[i]-=magic[i],stars[i]<0)return!1;return!0},conds=cond.split(",").filter((function(value){return 0===value.indexOf("m")})),i=0;i<conds.length;i++){var magic=Common.magic[conds[i].substring(1)];if(!magic)return;if(!Util.canUseMagic(magic))return!1;if(!useStar(magic))return!1}return save_data.stars=stars,Util.saveStorage(),!0},updateStarById:function(star,value){var num=Object.keys(Common.star_names).indexOf(star);save_data.stars[num]=Number(save_data.stars[num])+Number(value)},updateHp2KrmMax:function(at_obj){let props=["hp_m","mp_m","str_i","int_i","dex_i","krm_i"];for(prop of props)if(at_obj[prop]){let v=at_obj[prop].split("..");v[1]&&(v[0]=Util.random(Number(v[0]),Number(v[1]))),save_data.chara[prop]=Number(save_data.chara[prop])+Number(v[0])}},updateHpMp:function(at_hp,at_mp){if(at_hp)if("full"===at_hp)save_data.chara.hp=save_data.chara.hp_m;else if("half"===at_hp)save_data.chara.hp=Math.floor(save_data.chara.hp_m/2);else{var hp=String(at_hp).split("..");hp[1]&&(hp[0]=Util.random(Number(hp[0]),Number(hp[1]))),save_data.chara.hp=Number(save_data.chara.hp)+Number(hp[0]),save_data.chara.hp>save_data.chara.hp_m&&(save_data.chara.hp=save_data.chara.hp_m)}if(at_mp)if("full"===at_mp)save_data.chara.mp=save_data.chara.mp_m;else if("half"===at_mp)save_data.chara.mp=Math.floor(save_data.chara.mp_m/2);else{var mp=String(at_mp).split("..");mp[1]&&(mp[0]=Util.random(Number(mp[0]),Number(mp[1]))),save_data.chara.mp=Number(save_data.chara.mp)+Number(mp[0]),save_data.chara.mp>save_data.chara.mp_m&&(save_data.chara.mp=save_data.chara.mp_m)}},updateStr2Krm:function(at_str,at_int,at_dex,at_krm){at_str&&("full"===at_str?save_data.chara.str=save_data.chara.str_i:0===String(at_str).indexOf("@")?save_data.chara.str=Number(at_str.substring(1)):save_data.chara.str=Number(save_data.chara.str)+Number(at_str)),at_int&&("full"===at_int?save_data.chara.int=save_data.chara.int_i:0===String(at_int).indexOf("@")?save_data.chara.int=Number(at_int.substring(1)):save_data.chara.int=Number(save_data.chara.int)+Number(at_int)),at_dex&&("full"===at_dex?save_data.chara.dex=save_data.chara.dex_i:0===String(at_dex).indexOf("@")?save_data.chara.dex=Number(at_dex.substring(1)):save_data.chara.dex=Number(save_data.chara.dex)+Number(at_dex)),at_krm&&("full"===at_krm?save_data.chara.krm=save_data.chara.krm_i:0===String(at_krm).indexOf("@")?save_data.chara.krm=Number(at_krm.substring(1)):save_data.chara.krm=Number(save_data.chara.krm)+Number(at_krm))},updateFrees:function(at_free1,at_free2,at_free3){let range=function(input){var output=String(input).split("..");return output[1]&&(output[0]=Util.random(Number(output[0]),Number(output[1]))),Number(output[0])};at_free1&&(0===at_free1.indexOf("@")?save_data.chara.free1=Number(at_free1.substring(1)):save_data.chara.free1=Number(save_data.chara.free1)+range(at_free1)),at_free2&&(0===at_free2.indexOf("@")?save_data.chara.free2=Number(at_free2.substring(1)):save_data.chara.free2=Number(save_data.chara.free2)+range(at_free2)),at_free3&&(0===at_free3.indexOf("@")?save_data.chara.free3=Number(at_free3.substring(1)):save_data.chara.free3=Number(save_data.chara.free3)+range(at_free3))},updateState:function(at_state){if(void 0!==at_state){if(0===at_state.indexOf("-")){let state=at_state.substring(1);"all"===state?save_data.chara.state="":save_data.chara.state===state&&(save_data.chara.state="")}else{if(!Bonus.guardState(at_state)){let name=Common.state_names[at_state];return toastr.warning(`${name}耐性が作動！${name}を防いだ！！`,"シナリオボーナス"),!1}save_data.chara.state=at_state}return!0}},updateResults:function(at_result){if(at_result){void 0===global_save_data.results&&(global_save_data.results={});var results=global_save_data.results;void 0===results[scenario_code]&&0!==scenario_code.indexOf("<")&&(results[scenario_code]=[]),!0===this.pushUnique(results[scenario_code],at_result)&&(toastr.options.timeOut=5e3,toastr.success(results_map[at_result].name,"実績獲得")),this.saveStorageGlobal()}},dropItem:function(enemy){if(enemy.drop){var drops=enemy.drop.split("/"),star_name=Common.star_names[drops[0]];if(star_name){var num="1"===drops[1]?"":"×"+drops[1];return{drop:enemy.drop,name:star_name+num}}return{drop:enemy.drop,name:drops[2]}}if(!enemy.element)return{name:null};var drop={earth:["thu","tue","sat","",""],fire:["tue","sun","tue","",""],water:["wed","mon","fri","",""],wind:["fri","wed","mon","",""],spirit:["sat","sun","mon","",""]},tmp_d=Util.randomArray(drop[enemy.element]);return{drop:tmp_d?tmp_d+"/1":"",name:Common.star_names[tmp_d]}},computeDamage:function(func){for(var damage=0,func_re=/([\+\-]?)(\d*)(R|L|STR|INT|DEX|KRM|FREE1|FREE2|FREE3)?]?/gi,result;null!=(result=func_re.exec(func));){var sign=1,num=1,param=1;if(""===result[0])break;"-"===result[1]&&(sign=-1),result[2]&&(num=Number(result[2]));var tmp_status={str:Number(save_data.chara.str),int:Number(save_data.chara.int),dex:Number(save_data.chara.dex),krm:Number(save_data.chara.krm)};switch(save_data.chara.state){case"frozen":tmp_status.str-=2,tmp_status.int-=2,tmp_status.dex-=2,tmp_status.krm-=2;break;case"stone":tmp_status.str-=1,tmp_status.int-=1,tmp_status.dex-=1,tmp_status.krm-=1;break;case"forget":tmp_status.str<tmp_status.int?tmp_status.int=0:tmp_status.str=0}switch(result[3]){case"L":param=dice[0];break;case"R":param=dice[1];break;case"STR":case"INT":case"DEX":case"KRM":param=tmp_status[result[3].toLowerCase()];break;case"FREE1":case"FREE2":case"FREE3":param=save_data.chara[result[3].toLowerCase()];break;default:param=1}damage+=sign*num*param}return damage*=Number($("#damage_delta").val()),Math.floor(damage)},selectFunc:function(func){return Util.randomArray(func.split(",")).trim()},getBonusItem:function(bonus){if(bonus)return 0===bonus.indexOf("bgi")?Common.global_items.bad[bonus]:Common.global_items.happy[bonus]},initView(){ControlPanel.init(),Util.createCommonTweet(),PlayerRank.init(),SideBar.createAll(),Bonus.showBonusMessage()},initScenario:function(){Util.initSavedata(),Util.initView(),Bonus.initBonusStatus(),Util.createScene(0),SideBar.openSideBar("basic"),toastr.options.timeOut=5e3,toastr.info("ステータスは画面右クリックで確認できます。","キャラが作成されました。")},copyNextScenario:function(nexts){var c_save=Util.deepCopyObject(save_data);c_save.items=c_save.items.filter((function(id){return void 0!==items_map[id].shared})),c_save.flags=[],c_save.scene=0,c_save.ellapsed_scene=0,c_save.bgm="",c_save.isEnded=!1;for(var i=0;i<nexts.length;i++)localStorage[nexts[i].trim()]=JSON.stringify(c_save)},endScenario:function(result,next,changeBgm){if(result){save_data.isEnded=!0,Util.saveStorage(),next&&Util.copyNextScenario(next.split(",")),console.log("***********Licence Info.***********");var tmp_licence={bgm:"音楽",picture:"画像"},bonus_item,o_bonus_item,audio_path;switch($("licence > work",scenario_data).each((function(){var licence_url=$(this).nsAttr("url");console.log($(this).nsAttr("name")+"("+tmp_licence[$(this).nsAttr("category")]+"): "+$(this).nsAttr("creator")+" "+(void 0!==licence_url?licence_url:""))})),console.log("***********Licence Info.***********"),"bad"===result?$('<p><a href="#" id="end_reload" class="scenebtn">最初から冒険に挑戦する</a></p>').appendTo(target):"happy"===result&&$('<p><a href="#" id="end_exit" class="scenebtn">ペンタウァに帰還する</a></p>').appendTo(target),result){case"happy":bonus_item=Util.randomArray(Object.keys(Common.global_items.happy)),o_bonus_item=Common.global_items.happy[bonus_item],audio_path=Util.buildBgmPath(bgms_map.happy);break;case"bad":Util.random(0,100)<20&&(bonus_item=Util.randomArray(Object.keys(Common.global_items.bad)),o_bonus_item=Common.global_items.bad[bonus_item]),audio_path=Util.buildBgmPath(bgms_map.bad)}changeBgm&&SeAudio.playBgm(audio_path),bonus_item&&(Util.pushUnique(global_save_data.items,bonus_item),Util.saveStorageGlobal(),$.get("stext/common/dialog_bonus.html").then((function(data){var bonus_dialog=$(data);$("#bonus_img",bonus_dialog).attr("src",ROOT+COMMON+bonus_item+".png"),$("#bonus_item",bonus_dialog).text(o_bonus_item.name),$("#bonus_item_desc",bonus_dialog).text(o_bonus_item.desc),setTimeout((function(){$.zoombox.html(bonus_dialog.html(),{width:480,height:200})}),2e3)})))}},canSceneMove:function(scene_num,allow_num){return-1!==allow_num.split(",").indexOf(scene_num)},showRuleText:function(rule){void 0===rule&&(rule="99999"),$("#common_rule").html(Util.decorateText($("scene#"+rule,scenario_data).text())).markdown()},interpolation:function(match,sub){var tmp_sub=sub.split("?"),m_var=tmp_sub[0];if(tmp_sub[1])var m_params=tmp_sub[1].split(":");switch(m_var){case"name":return save_data.chara.name;case"title":return save_data.chara.title;case"hp":return save_data.chara.hp;case"mp":return save_data.chara.mp;case"str":return save_data.chara.str;case"int":return save_data.chara.int;case"dex":return save_data.chara.dex;case"krm":return save_data.chara.krm;case"free1":return save_data.chara.free1;case"free2":return save_data.chara.free2;case"free3":return save_data.chara.free3;case"race":switch(save_data.chara.race){case"FIGHTER":return m_params[0];case"WIZARD":return m_params[1];case"DWARF":return m_params[2];case"ELF":return m_params[3];default:return"Unknown Race"}case"sex":switch(save_data.chara.sex){case"MALE":return m_params[0];case"FEMALE":return m_params[1];default:return"Unknown Sex"}case"age":switch(save_data.chara.age){case"YOUNG":return m_params[0];case"ADULT":return m_params[1];case"OLD":return m_params[2];default:return"Unknown Age"}case"state":switch(save_data.chara.state){case"":return m_params[0];case"poison":return m_params[1];case"frozen":return m_params[2];case"stone":return m_params[3];case"curse":return m_params[4];case"forget":return m_params[5];default:return"Unknown State"}case"rand":return Util.random(Number(m_params[0]),Number(m_params[1]));case"msg":return Util.randomArray(m_params);case"input":return'<input type="button" class="spinner_down sgml" value="-" /><input type="number" class="sgml" value="'+m_params[0]+'" /><input type="button" class="spinner_up sgml" value="+" />';default:return match}},conditionSingle:function(cond){return cond=cond.trim(),-1!==save_data.flags.indexOf(cond)||-1!==save_data.items.indexOf(cond)||Util.canUseMagicByName(cond)||Util.ifStatus(cond)||Util.isCharaState(cond)||Util.hasStars(cond)||Util.hasResult(cond)},conditionAllTrue:function(org_cond){for(var result=!0,conds=org_cond.split(","),i=0;i<conds.length;i++)if(!Util.conditionSingle(conds[i])){result=!1;break}return result},conditionFull:function(org_cond){for(var eval_str="",ope=/([\&\|\!\(\)]{1,2})/,conds=org_cond.split(ope),i=0;i<conds.length;i++){var c=conds[i];c&&(ope.test(c)?eval_str+=c:0!==c.indexOf("-")?eval_str+=Util.conditionSingle(c):eval_str+=!Util.conditionSingle(c.substring(1)))}return eval(eval_str)},judgeMultiCondition:function(org_cond){return org_cond=(org_cond=(org_cond=(org_cond=(org_cond=org_cond.split("#NOT#").join("!")).split("#AND#").join("&")).split("#OR#").join("|")).split("#L#").join("(")).split("#R#").join(")"),/([\&\|\!\(\)]{1})/.test(org_cond)?Util.conditionFull(org_cond):0!==org_cond.indexOf("-")?Util.conditionAllTrue(org_cond):!Util.conditionAllTrue(org_cond.substring(1))},showSceneButton:function(){var scene_button;$("a[title]",target).hide(),$("a[title]",target).each((function(index,elem){Util.judgeMultiCondition($(elem).nsAttr("title"))&&$(elem).show()}))},importText:function(match,id){return $("scene#"+id,scenario_data).text()},ifCondition:function(match,cond,body){return Util.judgeMultiCondition(cond)?body:""},parseTweet:function(match,body){return tweet_message=body,body},createTweet:function(type,msg,cache){if(msg||(msg="原作30周年記念企画「SORCERIAN Text」ユーザー参加型のゲームブック版ソーサリアン"),"custom"===type)var show=$(".socialbtn.twitter_custom"),hide=$(".socialbtn.twitter");else var show=$(".socialbtn.twitter"),hide=$(".socialbtn.twitter_custom");cache||(show.empty(),show.append($('<a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-lang="ja" data-url="https://www.web-deli.com/sorcerian/text/" data-via="snext1220" data-related="snext1220" data-hashtags="falcom,stext">Tweet</a>').attr("data-text",msg)).append('<script src="https://platform.twitter.com/widgets.js" charset="UTF-8"><\/script>')),show.show(),hide.hide()},createCommonTweet:function(){Util.createTweet("common",$("init > intro",scenario_data).nsAttr("description"))},decorateText:function(tmp_scene){return tmp_scene=(tmp_scene=(tmp_scene=(tmp_scene=(tmp_scene=(tmp_scene=(tmp_scene=(tmp_scene=(tmp_scene=tmp_scene.replace(/\${import[\s]+(.+?)}/gi,this.importText)).replace(/(\[.+?\]\([\d,]{1,} ")(.+?)("\))/gi,(function(match,sub1,sub2,sub3){return sub1+(sub2=(sub2=(sub2=(sub2=(sub2=sub2.split("!").join("#NOT#")).split("&").join("#AND#")).split("|").join("#OR#")).split("(").join("#L#")).split(")").join("#R#"))+sub3}))).replace(/%(blue|red|purple|white)%/gi,'&nbsp;<span style="color:$1">')).replace(/%\/%/gi,"</span>&nbsp;")).replace(/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?/gi,'<a href="$&" data-link="auto" target="_blank">$&</a>')).replace(/\${if[\s]+(.+?)}([\s\S]+?)\${\/if}/gi,this.ifCondition)).replace(/\${tweet}([\s\S]+?)\${\/tweet}/gi,this.parseTweet)).replace(/\${(.+?)}/gi,this.interpolation)).replace(/\${(.+?)\|(.+?)}/gi,"<ruby>$1<rp>（</rp><rt>$2</rt><rp>）</rp></ruby>")},createScene:function(scene_num,options){if(void 0===options&&(options={}),SideBar.isFirstOpenBattleSheet=!0,tweet_message=null,SideBar.closeAll(),save_data.isEnded)location.reload(!0);else{if(!Util.updateStarsByMagic(options.conditions))return toastr.options.timeOut=4e3,void toastr.warning("星が不足しているようだ。");$(window).scrollTop(0);var scene=$('scene[id="'+scene_num+'"]',scenario_data);options.reverse?options.restore&&history.pushState(save_data,"Scene "+scene_num):(Util.updateItems(scene.nsAttr("items")),Util.updateFlags(scene.nsAttr("flags")),Util.updateStars(scene.nsAttr("stars")),Util.updateHp2KrmMax({hp_m:scene.nsAttr("hp_max"),mp_m:scene.nsAttr("mp_max"),str_i:scene.nsAttr("str_max"),int_i:scene.nsAttr("int_max"),dex_i:scene.nsAttr("dex_max"),krm_i:scene.nsAttr("krm_max")}),Util.updateHpMp(scene.nsAttr("hp"),scene.nsAttr("mp")),Util.updateStr2Krm(scene.nsAttr("str"),scene.nsAttr("int"),scene.nsAttr("dex"),scene.nsAttr("krm")),Util.updateFrees(scene.nsAttr("free1"),scene.nsAttr("free2"),scene.nsAttr("free3")),Util.updateState(scene.nsAttr("state")),Util.updateStates(),Util.updateResults(scene.nsAttr("result")),Bonus.updateStatusByBonus(),save_data.scene=scene_num,save_data.ellapsed_scene++,Util.saveStorage(),history.pushState(save_data,"Scene "+scene_num)),target.html(Util.decorateText(scene.text())),target.markdown(),tweet_message?Util.createTweet("custom",tweet_message):Util.createTweet("common",null,!0),$('<h5 id="scenario_title">'+$("scenario",scenario_data).nsAttr("title")+"【"+scene_num+"】</span></h5>").prependTo(target),scene.nsAttr("enemies")?$("#menu_battle").css("background-color","Red"):$("#menu_battle").css("background-color","Black"),SideBar.showSimpleStatus(),debug_mode&&($('<div id="debug_panel">\n          <form>\n            <label>Scene：<input id="debug_id" type="text" size="5" /></label>　\n            <label>Items：<input id="debug_items" type="text" size="7" /></label>　\n            <label>Flags：<input id="debug_flags" type="text" size="7" /></label>　\n            <input id="debug_reload" type="button" value="Reload" />\n          </form>\n        </div>').prependTo(target),$("#debug_panel #debug_id").val(scene_num),$("#debug_panel #debug_items").val(save_data.items.join(",")),$("#debug_panel #debug_flags").val(save_data.flags.join(",")),$("#debug_panel #debug_reload").click((function(e){var debug_items=$("#debug_panel #debug_items").val().trim(),debug_flags=$("#debug_panel #debug_flags").val().trim();save_data.items=""!==debug_items?debug_items.split(","):[],save_data.flags=""!==debug_flags?debug_flags.split(","):[],Util.saveStorage(),Util.createScene($("#debug_panel #debug_id").val())}))),$("a",target).addClass("scenebtn"),$('a[data-link="auto"]',target).removeClass("scenebtn");var tmp_move=$('a[href="X"]',target);tmp_move.removeClass("scenebtn").addClass("scene_move").attr("data-allow",tmp_move.text()).text("移動する").before('<input type="number" id="toscene" class="scene_move" />').add("#toscene").wrapAll('<div class="xbtn"></div>');var tmp_strinput=$('a[href="Q"]',target),a_img;tmp_strinput.removeClass("scenebtn").addClass("quest_str").attr("data-yesno",tmp_strinput.text()).text("回答する").before('<input type="text" id="stranswer" class="quest_str" />').add("#stranswer").wrapAll('<div class="xbtn"></div>'),$("a:has(img)",target).each((function(index,elem){var img_path=ROOT+scenario_code+"/"+CAPTURE+$(elem).attr("href");$(elem).attr("href",img_path).removeClass("scenebtn").addClass("scenepic").find("img").attr("src",img_path)})),$("a.scenepic").zoombox(),Util.showSceneButton(),$(".scenebtn:hidden + br",target).remove(),$("a[title]:hidden",target).remove();var at_bgm=scene.nsAttr("bgm"),new_bgm=save_data.bgm;void 0!==at_bgm&&(new_bgm=at_bgm),new_bgm!==bgm_name&&(SeAudio.playBgm(Util.buildBgmPath(new_bgm)),bgm_name=new_bgm,save_data.bgm=new_bgm,Util.saveStorage(),history.replaceState(save_data,"Scene "+scene_num)),scene.nsAttr("se")&&SeAudio.play(scene.nsAttr("se")),Util.endScenario(scene.nsAttr("end"),scene.nsAttr("nexts"),void 0===scene.nsAttr("bgm"))}}};$.fn.extend({startGame:function(code,debug){scenario_code=code,dialog_elem.main=target=this,debug||(debug=!1),debug_mode=debug,target.addClass("main_back"),target.off(),target.parent().off(),$(document).off("click","#dialog_list img.bonus_item"),$(window).off("popstate"),target.on("click","a.scenebtn",(function(e){if("end_reload"!==e.target.id)if("end_exit"!==e.target.id){var num=$(this).nsAttr("href"),cond=$(this).nsAttr("title");num=Util.getRandomLinkNumber(num),Util.createScene(num,{conditions:cond}),bgm&&bgm.paused&&global_save_data.bgm&&bgm.play(),e.preventDefault()}else location.href="https://www.web-deli.com/sorcerian/text/"})),target.on("click","#end_reload",(function(e){e.preventDefault(),e.stopImmediatePropagation(),("playground"!==scenario_code||confirm("ページをリロードしても宜しいですか？\nリロード時には、エディター上の編集内容も削除されます。シナリオ編集中の場合は、内容を保存してください。"))&&location.reload(!0)})),target.on("click","a.scene_move",(function(e){var num=$("#toscene").val(),allow_num=$(this).nsAttr("data-allow");Util.canSceneMove(num,allow_num)?Util.createScene(num):(toastr.options.timeOut=4e3,toastr.warning("指定された番号には移動できないようだ")),e.preventDefault()})),target.on("click","a.quest_str",(function(e){var answer=$("#stranswer").val(),yn=$(this).nsAttr("data-yesno").split(",");if(answer===yn[0])var to_move=yn[1];else var to_move=yn[2];Util.createScene(to_move),e.preventDefault()})),target.on("contextmenu",(function(e){$.sidr("open","sidr_status"),e.preventDefault()})),$(window).on("popstate",(function(e){save_data.isEnded||null!=e.originalEvent.state&&(save_data=e.originalEvent.state,Util.saveStorage(),Util.createScene(e.originalEvent.state.scene,{reverse:!0}))})),target.on("click","#restart #tmp_init",(function(e){Util.initScenario()})),target.on("click","#restart #tmp_continue",(function(e){Util.initJobs(),Util.initView();var num=save_data.scene;Util.createScene(num,{reverse:!0,restore:!0})})),storage[GLOBAL_SAVE_DATA_KEY]?Util.loadStorageGlobal():Util.initGlobalSaveData();var done_read=function(result){for(var key in scenario_data=result,Common.magic){for(var magic=Common.magic[key],stars="",star_names=["月","火","水","木","金","土","太"],i=0;i<7;i++)magic[i]>0&&(stars+=star_names[i]+magic[i]+" ");magic.push(stars)}flags_map={},$("flags > flag",scenario_data).each((function(){flags_map[$(this).nsAttr("id")]=$(this).text().trim()})),enemies_map={},$("enemies > enemy",scenario_data).each((function(){enemies_map[$(this).nsAttr("id")]={name:$(this).nsAttr("name"),element:$(this).nsAttr("element"),hp:$(this).nsAttr("hp"),attack:$(this).nsAttr("attack"),func:$(this).nsAttr("func"),func_opp:$(this).nsAttr("func_opp"),drop:$(this).nsAttr("drop"),desc:$(this).text().trim()}})),items_map={},$("items > item",scenario_data).each((function(){items_map[$(this).nsAttr("id")]={name:$(this).nsAttr("name"),shared:$(this).nsAttr("shared"),desc:$(this).text().trim()}})),results_map={},$("results > result",scenario_data).each((function(){results_map[$(this).nsAttr("id")]={name:$(this).attr("name"),level:$(this).nsAttr("level"),desc:$(this).text().trim()}}));var init_bgms=$("init > bgm",scenario_data),i_main=init_bgms.nsAttr("main"),i_happy=init_bgms.nsAttr("happy"),i_bad=init_bgms.nsAttr("bad");if(bgms_map={main:void 0===i_main?"main":i_main,happy:void 0===i_happy?"happy":i_happy,bad:void 0===i_bad?"bad":i_bad},!0===debug_mode){var errors=Util.validateScenario();if(0!==errors.length){var msgs="<h3>scenario.xmlでエラーが検出されました。</h3>";return msgs+='<ul class="errorlist">',errors.forEach((function(err){msgs+="<li>Scene "+err.scene_id+": "+err.message+"</li>"})),msgs+="</ul>",void target.html(msgs)}}if(!storage[scenario_code]||(Util.loadStorage(),save_data.isEnded))Util.initScenario();else{var msg='<div id="restart"><h3>Welcome to SORCERIAN Text!!</h3><p>以前のデータが残っています。<br />続きから開始しますか？</p><button id="tmp_continue">続きから</button> <button id="tmp_init">最初から</button></div>';target.html(msg)}};if(0===(scenario_code=scenario_code.trim()).indexOf("<")){var parser,tmp_data=(new DOMParser).parseFromString(scenario_code,"text/xml");scenario_code="playground",global_save_data.results.playground=[],Util.saveStorageGlobal(),done_read(tmp_data)}else $.get(ROOT+scenario_code+"/scenario.xml").done(done_read).fail((function(xhr,status,error){throw new Error("scenario code is invalid.")}))},gbat2stext:function(callback){$(this).change((function(e){var file_num=0,result=$('<scenario xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://www.web-deli.com/sorcerian/next/stext/common/sgml.xsd">\n</scenario>'),inits=$("<init>\n</init>"),items=$("<items>\n</items>"),flags=$("<flags>\n</flags>"),enemies=$("<enemies>\n</enemies>"),results=$("<results>\n</results>"),license=$("<licence>\n</licence>"),readFile=function(e){var gbat=$(this.result),title_author=$("title",gbat).text().trim().split("@");if(result.attr("title")||(result.attr("title",title_author[0]),result.attr("author",title_author[1])),$("section",gbat).each((function(i,section){var header_on=!1,attrs={};if(attrs.id=Number($("number",section).text()),1===attrs.id&&(attrs.id=0),"link"===$("> summary",section).text().toLowerCase())return!0;var body="\n";$("> text p",section).each((function(j,para){var tmp_para=$(para).text();if("@@"===tmp_para.trim())return header_on=!header_on,!0;if(header_on){if(!tmp_para)return!0;if(0===tmp_para.indexOf("pc")){var pc=tmp_para.split(":"),cons=$("<constraint></constraint>");pc[1]&&cons.attr("race",pc[1]),pc[2]&&cons.attr("sex",pc[2]),pc[3]&&cons.attr("age",pc[3]),cons.appendTo(inits)}else if(0===tmp_para.indexOf("bgm")){var bgm=tmp_para.split(":"),initBgm=$("<bgm></bgm>");bgm[1]&&initBgm.attr("main",bgm[1]),bgm[2]&&initBgm.attr("happy",bgm[2]),bgm[3]&&initBgm.attr("bad",bgm[3]),initBgm.appendTo(inits)}else if(0===tmp_para.indexOf("label")){var label=tmp_para.split(":"),initLabel=$("<label></label>");label[1]&&initLabel.attr("free1",label[1]),label[2]&&initLabel.attr("free2",label[2]),label[3]&&initLabel.attr("free3",label[3]),initLabel.appendTo(inits)}else if(0===tmp_para.indexOf("intro")){var intro=tmp_para.split(":"),initIntro=$("<intro></intro>");intro[1]&&initIntro.attr("description",intro[1]),initIntro.appendTo(inits)}else if(0===tmp_para.indexOf("i")){var item=tmp_para.split(":");$("<item></item>").attr("id",item[0]).attr("name",item[1]).text(item[2]).appendTo(items)}else if(0===tmp_para.indexOf("f")){var flag=tmp_para.split(":");$("<flag></flag>").attr("id",flag[0]).text(flag[1]).appendTo(flags)}else if(0===tmp_para.indexOf("m")){var enemy=tmp_para.split(":");$("<enemy></enemy>").attr("id",enemy[0]).attr("name",enemy[1]).attr("element",enemy[2]).attr("attack",enemy[3]).attr("func",enemy[4]).attr("drop",enemy[5]).text(enemy[6]).appendTo(enemies)}else if(0===tmp_para.indexOf("r")){var result=tmp_para.split(":");$("<result></result>").attr("id",result[0]).attr("name",result[1]).attr("level",result[2]).text(result[3]).appendTo(results)}else if(0===tmp_para.indexOf("w")){var work=tmp_para.split(":");$("<work></work>").attr("name",work[1]).attr("category",work[2]).attr("creator",work[3]).attr("url",work[4]?"//"+work[4]:"").appendTo(license)}else if(0===tmp_para.indexOf("@")){var attr=tmp_para.substring(1).split(":");void 0===attr[1]&&(attr[1]=""),attrs[attr[0]]=attr[1]}}else body+=tmp_para+"\n"})),body+="\n",$("choices choice",section).each((function(k,cho){var caption=$("text p",cho).text().trim().split("@"),dest=$("destination",cho).text();if("999"===dest){var tmp="[";tmp+=caption[0],tmp+="](X)\n"}else if("998"===dest){var tmp="[";tmp+=caption[0],tmp+="](Q)\n"}else{var tmp="[";tmp+=caption[0],tmp+="](",tmp+=dest,caption[2]&&(tmp+=","+caption[2]),caption[1]&&(tmp+=' "'+caption[1]+'"'),tmp+=")\n"}body+=tmp}));var scene=$("<scene></scene>\n").attr("id",attrs.id).text(body);void 0!==attrs.items&&scene.attr("items",attrs.items),void 0!==attrs.flags&&scene.attr("flags",attrs.flags),void 0!==attrs.enemies&&scene.attr("enemies",attrs.enemies),void 0!==attrs.stars&&scene.attr("stars",attrs.stars),void 0!==attrs.hp&&scene.attr("hp",attrs.hp),void 0!==attrs.mp&&scene.attr("mp",attrs.mp),void 0!==attrs.free1&&scene.attr("free1",attrs.free1),void 0!==attrs.free2&&scene.attr("free2",attrs.free2),void 0!==attrs.free3&&scene.attr("free3",attrs.free3),void 0!==attrs.bgm&&scene.attr("bgm",attrs.bgm),void 0!==attrs.se&&scene.attr("se",attrs.se),void 0!==attrs.result&&scene.attr("result",attrs.result),void 0!==attrs.end&&scene.attr("end",attrs.end),scene.appendTo(result)})),license.prependTo(result),results.prependTo(result),enemies.prependTo(result),flags.prependTo(result),items.prependTo(result),inits.prependTo(result),++file_num>=inputs.length)if(callback)callback(result);else{var content=vkbeautify.xml('<?xml version="1.0" encoding="utf-8"?>\n'+result.get(0).outerHTML),blob=new Blob([content],{type:"application/octet-stream"}),anchor=document.createElement("a");anchor.href=window.URL.createObjectURL(blob),anchor.download="scenario.xml",anchor.click()}else reader.readAsText(inputs[file_num],"UTF-8")},inputs=$(this).get(0).files,reader=new FileReader;$(reader).on("load",readFile),reader.readAsText(inputs[file_num],"UTF-8")}))},backupData:function(selector){$(this).click((function(){var content="",storage=localStorage,scenario=$(selector).val();if("all"===scenario)$.get(ROOT+"stext.xml").done((function(data){var ids=[GLOBAL_SAVE_DATA_KEY];$("work[id]:not([unpublished])",data).each((function(i,elm){ids.push($(elm).attr("id"))}));for(var i=0;i<ids.length;i++){var tmp_data=storage[ids[i]];tmp_data&&(content+=ids[i]+"\n",content+=tmp_data+"\n")}Util.downloadSavedata(scenario,content)}));else{if(!(content=storage[scenario]))return void window.alert("データが存在しません！");Util.downloadSavedata(scenario,content)}}))},restoreData:function(){$(this).change((function(){Util.restoreSaveData(this,(function(){window.alert("リストアが完了しました。\r（起動している場合は）ゲーム画面をリロードしてください。")}))}))},nsAttr:function(name){var v=$(this).attr(name);if(void 0!==v)return v.replace(/\s+/g,"")}})}(jQuery);