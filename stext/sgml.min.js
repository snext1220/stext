(function($){var ROOT="stext/",COMMON="common/",CAPTURE="capture/",BGM="bgm/",SE="se/",scenario_code,scenario_data,enabled_jobs,flags_map={},enemies_map={},items_map={},results_map={},bgms_map={},save_data,global_save_data,GLOBAL_SAVE_DATA_KEY="sorcerian_text",target,dialog_elem={},debug_mode=!1,bgm,bgm_name,storage=localStorage,dice=[1,1],tweet_message,Common={male_name:["ボブ","デュエル","ゴルカス","ジェノバン","グーラン","ジャンビエ","グログス","コル","フロニアス","グーリム","カザミィ","ソロン","ゼン","ヴォル","マルス","レイザー","ミリオン","エリック","ジロ","ソード","ディル","ガタビア","ラウア","ハルビン","グドン","ジャミル","ディカン","ダート","タットワ5世","ディカン","ホド","ゲプラー","コクマー","グレアム","ロウポー","ラッツ","ソルト","ランブル","ネイル","ルシアン","ギム","チェイサー","ルワン","ゾーク","オルム","テュモー","バロン","カメロン","トード","グンダ","フラジオレ","ファン＝フレディ","ファネッサ3世","クリフト4世","クォール","ディオン","ホゼア","ロラッド","バルナ","ティゲロ","テト","ニフト","オーサー","ゲディス","レオン","アンドリュー","キリー","トーマス","エディ","ノーマス","ギルデン","ノーネーム","ユイター","デュオン","ペトス","フェリス","スラン","アルフレッド","ソクラム","アルモス","ログレック","ラルーゴ","キッド","ドレイク","ウォルトス","レスター","テリー","グラハン","ラドール","ウェステル","フェスタ","バンブー","ゲルフス","ドン・コサック","ベオグラード","ピエール","タルフ","エヴァン","ドゥール","バルガス","アーサー","ガッシュ","エルウッド","ヘルナー","エリック","ジャグラー","アラン","ロニアス","アスタル","ボルックス","ラドナー","ギルバレス","ジャレス","ルー","スズキ","ジロサ","サントリーニ","ルルイエ","コーラル","ボマード","ナルシス","マーヴァル","クール","ヨシュア","エヴァム","ジャンク","ボイド","ヘクター","デンキブラウン","バイアス","ブロイム","ディンギル","リグ","バド","ジード","ラルザス","ガイキナ","ロッド","ケイン","ルーミス","タジート","ブレイス","ディンクス","マーク","ホホホ","テシター","J.B","ジン","マック","リラ","ジバ","バーラン","ポジティル","ネガティル","ファルカス","ファウネス","ファルカス","チェン","パズス12世","タムタム","リーク・ディオン","タウラー","ラルディ","ノーマス","アドロン","ロカルノ","ゲラン","シュヴェーリン","ローラン","ウェッジ","アントロノフ","キム","ヤン","デフ","ミケロ","クール","ティエンルン","コウ","マルク","オーエン","トート","グート","マウアー","ザンダー","バルダ","キーリエ","マルス","セム","ターバ","グロス","クルトン","ザムル","エルフィン","グラハン","ガウェイン","アドル","ゴーバン","ドギ","ルタ","ダレス","ダルク＝ファクト","クーブラ＝カーン","ガルシウス","クロノス","カイロス","ディアルド","チッタ","カズン","ルイス","セネリー","ライネル","エス","カリー","ドレイク","ダニー","ドリー","ケイリス","ノートン","クラウド","ウォーリー","レイモンド","サザール","メテオロイド","ナッシュ","ルロイ","ライトル","カディアン","ブラウン","シュナイダー","セシル","グレンザー","ゴイル","ビル","グリメルム","ガルベス","ジルドバ","アレクシウスX世","ピエール","ジェラルド","ロベルト","エティス","アル＝ファルコ","ラシーン","ロデム","J.D.マックス","パーム","シド"],female_name:["エスター","クリスティ","アイリーン","フェルディナン","リタ","トーヤ","ノルン","ウィンディーネ","プリム","ピアナ","エメラーダ","エレア","エヴァ","リム","ビナー","ティファレト","ミラドゥ","パナシェ","ミモザ","リューズ","エレーナ","リーア","キアラ","オルアラ","クオレ","セーナ","リーザ","セリナ","リリィ","ピピ","ビヌス","アンナ","リュシエル","フィレン","カレン","エリン","ローラ","マーベラ","ジョセフィーヌ","アネリーナ","リオナ","ジョアンナ","レニッサ","ジェニス","グリンダ","マティナ","ローナ","コッキー","チェルシー","ネリス","アリーナ","フェリッサ","マリエル","ベララ","ジョゼフ","ニッカ","テキーラ","ソルティ","パイン","ウィズ","カンニバル","ミント","リーン","ミル","ディアンナ","レティア","サフィス","エミス","ヴァムリー","サリア","ナイジェス","ミューリア","エミリア","シャル","バーバラ","オビア","スチュアート","ベーラ","サマリーヌ","フィアネ","レナ","ソル","ネイラ","セレーネ","アルバ","ラン","ルー・パズス","シルフィ","ミレット","レフィーナ","モスマ","チブル","鈴鈴","明明","ティキ","サリア","ミュール","ダール","ミンナ","レーシャ","エレイア","レア","フィーナ","ジャネット","ナリス","ソチ","ポーラス","ロキア","フリージ","エスメレー","エレナ","アルティ","エビオラ","フィナ"],title:["武器屋の親父","ペンタウァの長老","トラベラーズインの宿主","人と上手に話したい","ペンタウァ近衛隊長","タリスマンの見張り","瞑想中","砂漠の飯炊き","狂戦士","エレベーターの管理人","盗賊の頭領","暗き沼の魔法使い","ロマンシア国王","アゾルバ国王","ペンタウァ国王","蚕職人","妖精王","暗黒の魔導士","クイーンマリー号船長","キタブ・アル・アジフの持ち主","メデューサハンターの弟子","ファルコムマン","戦士の亡霊","海賊の子孫","いけにえの神官","東の村の村長","麻薬中毒者","ヴァネルバの王","銀の竪琴屋","近衛隊長","復讐の呪術師","ラフォーヌの森の管理人","リドニア王国の元兵士","姫の教育係","大魔王","紫ウニの王子","ベララの家族","時計塔の番人","時計塔の魔女","ナルキッソス号船長","ディンギル王国の3神官","バドティビラ工場の指揮官","シュメール国王","サンサーラの山賊","南村の村長","アイテム屋WIZの店主","旅の吟遊詩人","古代イスマリアの王","時の神殿の書記官","闇の王","ランドル村長","魔法学校の校長","魔法学校の用務員","マリオネットの王","ペンタウァの近衛兵","陽の中の闇人","赤毛の冒険者","光の王","イリアスンの執政官","魔の下僕","メデューサハンター","邪神教徒","邪神教々祖","砂漠の王","鍵の番人","ローデシア辺境司令官","宇宙からの訪問者","黒竜仙人","猿大聖","極楽寺の僧兵","ジャグラー族","迷宮建築の第一人者","フリース村の村長","ペンタウァ一の科学者アンド予言者","暴れザル","魔法学校の校長","人魚３姉妹の長女","マリオネットの王","探求の学徒","旅芸人の一座","猛獣使い","流れの傭兵","氷の魔女","パペッテの人形遣い","バーテンダー","宮仕えのシャーマン","薬草亭の主人","水門の管理人"],pc_init:[["FIGHTER","MALE",85,55,7,3,6,4],["FIGHTER","FEMALE",80,60,6,4,6,4],["WIZARD","MALE",55,85,4,8,5,3],["WIZARD","FEMALE",50,90,3,8,5,4],["DWARF","MALE",90,50,8,2,8,2],["DWARF","FEMALE",85,55,7,3,8,2],["ELF","MALE",65,75,4,6,5,5],["ELF","FEMALE",60,80,2,7,5,6]],magic:{HEAL:[0,0,0,1,0,1,0,"HPを15回復"],PEACE:[0,0,1,0,1,0,0,"MPを10回復"],CURE:[0,0,0,0,1,0,1,"毒回復"],MELT:[0,1,0,0,1,1,1,"凍結を回復"],"STONE-FLESH":[0,0,0,1,1,1,1,"石化を回復"],"UN-CURCE":[2,0,1,0,0,1,0,"呪いを回復"],"AIR-HAND":[1,0,1,0,1,0,1,"見えない拳の衝撃で、忘却を回復"],RESURRECT:[0,0,0,1,3,0,1,"HP/MP半分で復活（但し、冒険に一度だけ）"],"REDUCE-LIFE":[0,1,1,0,1,1,0,"体力を犠牲に（HP-25）、すべての状態異常を回復"],REJUVENATE:[0,2,0,1,0,0,1,"時の流れを巻き戻し（現在の判定をやり直し）"],PROTECT:[1,0,0,1,1,0,1,"HPダメージを半減（1ターンのみ）"],"HOLY-WATER":[0,0,2,2,0,0,0,"MPダメージを半減（1ターンのみ）"],"CHANGE-AIR":[1,0,0,1,1,1,0,"戦闘を回避（アイテムは得られない）"],"GIVE-VIGOR":[1,1,1,0,0,1,0,"敵の攻撃力が2倍＆取得アイテム2倍"],EXPLOSION:[0,1,0,1,0,1,2,"地属性の敵を全滅"],DELUGE:[4,0,0,0,0,1,0,"火属性の敵を全滅"],FREEZE:[0,2,0,0,0,1,2,"水属性の敵を全滅"],"DESTROY-A":[1,0,4,0,0,0,0,"風属性の敵を全滅"],"LIGHT-CROSS":[0,2,0,2,0,1,0,"霊属性の敵を全滅"],"NOILA-TEM":[1,1,1,1,1,1,1,"すべての属性の敵を全滅"]},jobs:{"のうふ":["FWDE","MF","YAO"],"れんきんじゅつ":["W","M","YAO"],"ようへい":["FDE","M","YA"],"うらないし":["WE","MF","YAO"],"こうふ":["FD","M","YA"],"どろぼう":["FWDE","MF","YAO"],"そうりょ":["W","MF","YAO"],"しょうにん":["FWE","MF","YAO"],"せんいん":["FD","M","YA"],"とうし":["FDE","MF","Y"],"どうけし":["WE","MF","YAO"],"かじや":["FD","M","YAO"],"きこり":["FD","M","YA"],"かりうど":["FDE","M","YAO"],"きとうし":["WE","M","YAO"],"あくまばらい":["W","M","YAO"],"せんきょうし":["W","MF","YAO"],"いしゃ":["WE","M","AO"],"かんごふ":["FWE","F","YAO"],"ぱんや":["FWE","MF","YAO"],"りょうし":["FD","MF","YA"],"だいく":["FD","M","YAO"],"ちょうこくか":["FWDE","MF","O"],"おりこ":["WDE","F","YAO"],"すみやき":["FD","MF","YAO"],"コック":["WE","MF","YAO"],"スパイ":["FWE","M","YA"],"ぼくどう":["FWDE","MF","Y"],"ようじんぼう":["FDE","M","Y"],"ぎんゆうしじん":["WE","M","YAO"],"ぎょしゃ":["FD","MF","YAO"],"はかもり":["FWDE","M","O"],"しゃほん":["WE","M","O"],"こなひき":["FD","MF","YA"],"かせいふ":["FWDE","F","YAO"],"おどりこ":["E","F","Y"],"はなや":["FWE","F","YAO"],"いしく":["D","MF","YA"],"かみゆい":["FWDE","F","AO"],"したてや":["WDE","F","YAO"],"いとつむぎ":["D","F","YAO"],"うたうたい":["FWE","F","YA"],"かみすき":["WD","MF","O"],"つうやく":["DE","MF","YAO"],"やくざいし":["FWE","MF","AO"],"ほねさいくし":["D","MF","O"],"わたしもり":["FW","M","YA"],"やくそうとり":["WE","MF","YAO"],"そうぎや":["FW","M","O"],"ワインづくり":["FWDE","MF","YA"],"こじき":["FWDE","MF","YAO"],"ちょうきょうし":["DE","MF","A"],"ほうせきさいくし":["D","MF","O"],"かごづくり":["FD","MF","O"],"かぎや":["D","MF","AO"],"くつし":["FDE","MF","O"],"はくせいづくり":["FD","MF","O"],"ゆみし":["FE","MF","O"],"チーズづくり":["FD","F","YAO"],"さんば":["FW","F","AO"]},global_items:{happy:{gi01:{name:"金の卵",desc:"月の欠片を5個所有した状態で冒険を開始する"},gi02:{name:"ガラティーン",desc:"火星の欠片を5個所有した状態で冒険を開始する"},gi03:{name:"五元素のマント",desc:"水星の欠片を5個所有した状態で冒険を開始する"},gi04:{name:"アマゾンの剣",desc:"木星の欠片を5個所有した状態で冒険を開始する"},gi05:{name:"幸福のコイン",desc:"金星の欠片を5個所有した状態で冒険を開始する"},gi06:{name:"ムラサメブレード",desc:"土星の欠片を5個所有した状態で冒険を開始する"},gi07:{name:"G・スレイヤー",desc:"太陽の欠片を5個所有した状態で冒険を開始する"},gi08:{name:"水晶の剣",desc:"30％の確率でシーンごとにHPを1回復する",type:"status"},gi09:{name:"王様の杖",desc:"30％の確率でシーンごとにMPを1回復する",type:"status"},gi10:{name:"ブルーリボン",desc:"冒険開始時にSTRを1加算する"},gi11:{name:"王家のダイヤモンド",desc:"冒険開始時にINTを1加算する"},gi12:{name:"不老長寿の水",desc:"冒険中に一度だけHPを半分回復しても良い",type:"status"},gi13:{name:"タリスマン",desc:"冒険中に一度だけMPを半分回復しても良い",type:"status"},gi14:{name:"鏡の盾",desc:"戦闘時のHPダメージが1減算される",type:"battle"},gi15:{name:"銀の竪琴",desc:"戦闘時のMPダメージが1減算される",type:"battle"},gi16:{name:"パンドラの箱",desc:"右サイコロが4以上の時、戦闘を回避しても良い（ただし、アイテムは入手できない）",type:"battle"},gi17:{name:"魔法の絨毯",desc:"右サイコロが6の時、戦闘を回避できる（アイテムも入手可）",type:"battle"},gi18:{name:"中和剤",desc:"毒耐性",type:"status"},gi19:{name:"聖水",desc:"呪い耐性",type:"status"},gi20:{name:"チルドの実",desc:"凍結耐性",type:"status"},gi21:{name:"銀のハーモニカ",desc:"石化耐性",type:"status"},gi22:{name:"真実の鏡",desc:"忘却耐性",type:"status"},gi23:{name:"D・スレイヤー",desc:"すべての星を1個所有した状態で冒険を開始する"}},bad:{bgi01:{name:"塩酸",desc:"シーンごとに30％の確率でHP1ダメージ、40％の確率でMPを1回復する",type:"status"},bgi02:{name:"紅玉",desc:"シーンごとに30％の確率でMP1ダメージ、40％の確率でHPを1回復する",type:"status"},bgi03:{name:"血まみれの斧",desc:"冒険開始時に呪い。ただし、解除後に3回まで星消費せず攻撃魔法を利用できる",type:"magic"},bgi04:{name:"トリカブト",desc:"冒険開始時に毒。ただし、解除まで魔法ダメージを半減できる",type:"battle"},bgi05:{name:"ギャルのパンティー",desc:"冒険開始時に忘却。ただし、解除時に0になっていたステータスを+1できる",type:"status"}}},star_names:{mon:"月",tue:"火星",wed:"水星",thu:"木星",fri:"金星",sat:"土星",sun:"太陽","":null},state_names:{"":"正常",poison:"毒",frozen:"凍結",stone:"石化",curse:"呪い",forget:"忘却",physics:"物理",magic:"魔法",both:"物理／魔法",free1:"FREE1",free2:"FREE2",free3:"FREE3"},element_names:{earth:"地",fire:"火",water:"水",wind:"風",spirit:"霊"}};toastr.options.closeButton=!0,toastr.options.positionClass="toast-bottom-left",toastr.options.showDuration=300,toastr.options.hideDuration=1e3,toastr.options.timeOut=5e3;let Bonus={showBonusMessage(){let t;save_data.bonus&&(t=0===save_data.bonus.indexOf("bgi")?Common.global_items.bad[save_data.bonus]:Common.global_items.happy[save_data.bonus],toastr.info(t.desc,`BONUS（${t.name}）`)),this.setBonusMessage()},initBonusStatus(){switch(save_data.bonus){case"gi01":Util.updateStarById("mon",5);break;case"gi02":Util.updateStarById("tue",5);break;case"gi03":Util.updateStarById("wed",5);break;case"gi04":Util.updateStarById("thu",5);break;case"gi05":Util.updateStarById("fri",5);break;case"gi06":Util.updateStarById("sat",5);break;case"gi07":Util.updateStarById("sun",5);break;case"gi10":Util.updateStr2Krm(1,0,0,0);break;case"gi11":Util.updateStr2Krm(0,1,0,0);break;case"gi23":Util.updateStarById("mon",1),Util.updateStarById("tue",1),Util.updateStarById("wed",1),Util.updateStarById("thu",1),Util.updateStarById("fri",1),Util.updateStarById("sat",1),Util.updateStarById("sun",1);break;case"bgi03":Util.updateState("curse");break;case"bgi04":Util.updateState("poison");break;case"bgi05":Util.updateState("forget")}},setBonusMessage(){let t=Util.getBonusItem(save_data.bonus);t&&t.type&&$(`#sidr_${t.type}_bonus`).text(`BONUS APPLYING： ${t.desc}`)},updateStatusByBonus(){switch(save_data.bonus){case"gi08":Util.processByWeight([.3],function(){Util.updateHpMp(1,0)});break;case"gi09":Util.processByWeight([.3],function(){Util.updateHpMp(0,1)});break;case"bgi01":Util.processByWeight([.3,.4],function(){Util.updateHpMp(-1,0)},function(){Util.updateHpMp(0,1)});break;case"bgi02":Util.processByWeight([.3,.4],function(){Util.updateHpMp(0,-1)},function(){Util.updateHpMp(1,0)})}},adjustBattleDamage(t,e){switch(save_data.bonus){case"gi14":case"gi15":"hp"===e&&t--}return t},guardState(t){let e={gi18:"poison",gi19:"curse",gi20:"frozen",gi21:"stone",gi22:"forget"};return t!==e[save_data.bonus]}},PlayerRank={LEVEL_POINTS:[100,150,170,180,200],RANK_INFO:[{pt:50,en:"Novice Adventurer",jp:"駆け出し"},{pt:100,en:"Initiate",jp:"新参者"},{pt:200,en:"Aspirant",jp:"大志を抱く者"},{pt:300,en:"Battler",jp:"戦人（いくさびと）"},{pt:500,en:"Adept",jp:"熟練者"},{pt:700,en:"Chevalier",jp:"義侠の者"},{pt:1e3,en:"Conjurer",jp:"奇術師"},{pt:1300,en:"Theurgist",jp:"神々に祈る者"},{pt:1600,en:"Warrior",jp:"古つわもの"},{pt:2e3,en:"Enchanter",jp:"魅了する者"},{pt:2500,en:"Warlock",jp:"七つの塔の魔術師"},{pt:3e3,en:"Sorcerer",jp:"ソーサリアン"},{pt:3500,en:"Necromancer",jp:"死者と語る者"},{pt:4e3,en:"Illusionist",jp:"幻惑を魅せる者"},{pt:5e3,en:"Master Load",jp:"偉大なる領主"},{pt:99999,en:"Dragon Slayer",jp:"ドラゴンスレイヤー"}],scena_count:0,scena_all:0,bonus_count:0,bonus_all:0,scena_infos:{},scena_results_count:0,scena_results_all:0,exp_count:0,exp_all:0,init(){let t,e=this;localStorage.sorcerian_text&&(t=JSON.parse(localStorage.sorcerian_text),this.bonus_count=t.items.length),this.bonus_all=Object.keys(Common.global_items.happy).length+Object.keys(Common.global_items.bad).length,$.get(ROOT+"stext.xml").done(function(a){let s=$("scenario > work",a);e.scena_all=s.length,$("scenario > work",a).each(function(a){let s=$(this).attr("id"),i=0,n=!1;if(t){let a=t.results[s];if(a){i=a.length;let t=$(this).attr("clears");if(t){t=t.split(",");for(var r=0;r<t.length;r++)if(-1!==a.indexOf(t[r])){e.scena_count++,n=!0;break}}}}e.scena_infos[s]={level:Number($(this).attr("level")),title:$(this).attr("title"),is_cleared:n,results_count:i,results_all:Number($(this).attr("results"))},e.scena_results_all+=Number($(this).attr("results"))}),e.calculateExp()})},calculateExp(){this.exp_count=10*this.bonus_count,this.exp_all=10*this.bonus_all;let t=0;for(let e of Object.keys(this.scena_infos)){let a=this.scena_infos[e];a.is_cleared&&(this.exp_count+=this.LEVEL_POINTS[Number(a.level)-1]),this.exp_all+=this.LEVEL_POINTS[Number(a.level)-1],t+=a.results_count}this.exp_count+=2*t,this.scena_results_count=t},incrementResult(t){this.scena_infos[t].results_count++,this.calculateExp()},getRank(){for(let t=0;t<this.RANK_INFO.length;t++){let e=this.RANK_INFO[t];if(this.exp_count<e.pt)return{level:t,en:e.en,jp:e.jp}}}},SideBar={cube:function(t){void 0===t&&(t=1);var e="";for(let a=0;a<t;a++)dice[a]=Util.random(1,6),e+=`<img src="${ROOT}${COMMON}cube${dice[a]}.png" class="dice" />`;return e},incrementValue(t){let e=$(this).prev();e.val(Number(e.val())+1)},decrementValue(t){let e=$(this).next();e.val(Number(e.val())-1)},setStateStyle(){let t=$("#sidr_status_hp"),e=$("#sidr_status_str"),a=$("#sidr_status_int"),s=$("#sidr_status_dex"),i=$("#sidr_status_krm"),n=$("#sidr_magic_magic"),r=$('[name="sidr_status_state"][value="poison"]').prop("checked");var d=$('[name="sidr_status_state"][value="frozen"]').prop("checked"),l=$('[name="sidr_status_state"][value="stone"]').prop("checked"),o=$('[name="sidr_status_state"][value="curse"]').prop("checked"),c=$('[name="sidr_status_state"][value="forget"]').prop("checked"),_="dialog_poison dialog_frozen dialog_stone dialog_curse dialog_forget";t.removeClass(_),e.removeClass(_),a.removeClass(_),s.removeClass(_),i.removeClass(_),n.removeClass(_),r?t.addClass("dialog_poison"):d?(e.addClass("dialog_frozen"),a.addClass("dialog_frozen"),s.addClass("dialog_frozen"),i.addClass("dialog_frozen")):l?(e.addClass("dialog_stone"),a.addClass("dialog_stone"),s.addClass("dialog_stone"),i.addClass("dialog_stone")):o?n.addClass("dialog_curse"):c&&(save_data.chara.str<save_data.chara.int?a.addClass("dialog_forget"):e.addClass("dialog_forget"))},deltaStatus:function(t){let e;switch(t){case"frozen":e={state_desc:"すべてのステータスを-2",str_d:-2,int_d:-2,dex_d:-2,krm_d:-2};break;case"stone":e={state_desc:"すべてのステータスを-1（30scene経過で死亡）",str_d:-1,int_d:-1,dex_d:-1,krm_d:-1};break;case"forget":e={state_desc:"STR／INTのうち、高い方が0に（20scene経過で解除）",dex_d:0,krm_d:0},save_data.chara.str<save_data.chara.int?(e.str_d=0,e.int_d=-1*save_data.chara.int):(e.str_d=-1*save_data.chara.str,e.int_d=0);break;case"poison":e={state_desc:"シーン経過ごとにHPを-1",str_d:0,int_d:0,dex_d:0,krm_d:0};break;case"curse":e={state_desc:"魔法の利用が不可（UN-CURSEを除く）",str_d:0,int_d:0,dex_d:0,krm_d:0};break;default:e={state_desc:"－",str_d:0,int_d:0,dex_d:0,krm_d:0}}return e},showSimpleStatus(){$("#sidr_battle #simple_status_hp").text(save_data.chara.hp),$("#sidr_battle #simple_status_mp").text(save_data.chara.mp),$("#sidr_battle #simple_status_str").text(save_data.chara.str),$("#sidr_battle #simple_status_int").text(save_data.chara.int),$("#sidr_battle #simple_status_dex").text(save_data.chara.dex),$("#sidr_battle #simple_status_krm").text(save_data.chara.krm),0!==$("init > label",scenario_data).length?($("#sidr_battle #simple_status_frees").show(),$("#sidr_battle #simple_status_f1").text(save_data.chara.free1),$("#sidr_battle #simple_status_f2").text(save_data.chara.free2),$("#sidr_battle #simple_status_f3").text(save_data.chara.free3)):$("#sidr_battle #simple_status_frees").hide();let t=$("#sidr_battle #simple_status_state");t.text(Common.state_names[save_data.chara.state]).removeClass("status_poison status_frozen status_stone status_curse status_forget"),save_data.chara.state?(t.addClass(`status_${save_data.chara.state}`),target.addClass("main_bad")):target.removeClass("main_bad")},runMagic(t){let e;switch(t){case"HEAL":Util.updateHpMp("15",void 0),e="HPが15回復した！";break;case"PEACE":Util.updateHpMp(void 0,"10"),e="MPが10回復した！";break;case"CURE":Util.updateState("-poison"),e="毒を解除した！";break;case"MELT":Util.updateState("-frozen"),e="凍結を解除した！";break;case"STONE-FLESH":Util.updateState("-stone"),e="石化を解除した！";break;case"UN-CURCE":Util.updateState("-curse"),e="呪いを解除した！";break;case"AIR-HAND":Util.updateState("-forget"),e="忘却を解除した！";break;case"RESURRECT":Util.updateHpMp("half","half"),e="復活に成功した！ただし、HP/MPともに上限の半分となった。";break;case"REDUCE-LIFE":Util.updateHpMp("-25",void 0),Util.updateState("-all"),e="状態異常を解除した。";break;case"REJUVENATE":e="直前の判定を一度だけリトライしても良い。";break;case"PROTECT":e="物理ダメージを半減できる。ダメージ式上のボックスを「1/2」に設定せよ。";break;case"HOLY-WATER":e="魔法ダメージを半減できる。ダメージ式上のボックスを「x1/2」に設定せよ。";break;case"CHANGE-AIR":e="本シーンの戦闘をすべて回避できる（ボス戦闘を除く）。";break;case"GIVE-VIGOR":e="敵の攻撃力が2倍になる。ダメージ式上のボックスを「x2」に設定せよ。また、勝利時はドロップアイテムボタンを2回押すこと。";break;case"EXPLOSION":e="地属性の敵は全滅した。ダメージボタンを押さずに、ドロップアイテムボックスを押して良い。";break;case"DELUGE":e="火属性の敵は全滅した。ダメージボタンを押さずに、ドロップアイテムボックスを押して良い。";break;case"FREEZE":e="水属性の敵は全滅した。ダメージボタンを押さずに、ドロップアイテムボックスを押して良い。";break;case"DESTROY-A":e="風属性の敵は全滅した。ダメージボタンを押さずに、ドロップアイテムボックスを押して良い。";break;case"LIGHT-CROSS":e="霊属性の敵は全滅した。ダメージボタンを押さずに、ドロップアイテムボックスを押して良い。";break;case"NOILA-TEM":e="全属性の敵が全滅した。ダメージボタンを押さずに、ドロップアイテムボックスを押して良い。";break;default:throw new Error("魔法の指定が間違っています。")}toastr.success(e,"魔法の行使"),Util.saveStorage()},createSideBar(t,e,a,s){let i=`sidr_${t}`;$(e).insertBefore(target),$(`#menu_${t}`).sidr({name:i,displace:!1,onOpen:a}),target.parent().on("click",`#${i}_submit`,function(){s(),$.sidr("close",i)}),target.parent().on("click",`#${i}_close`,function(){$.sidr("close",i)})},createBattleSheet(){let t=this,e=$('<div id="sidr_battle">\n        <p id="sidr_battle_bonus" class="bonus_msg"></p>\n        <table class="enemy">\n        <thead>\n        <tr class="enemy_title">\n          <th id="check_cell"></th>\n          <th>名前／属性</th>\n          <th>攻撃</th>\n          <th title="現在のダイス値に従って、ダメージを反映させます。">\n            ダメージ \n            <select id="damage_delta">\n              <option value="2">x2</option>\' + \n              <option value="1" selected>x1</option>\n              <option value="0.5">x1/2</option>\n              <option value="0.25">x1/4</option>\n            </select>\n          </th>\n          <th title="記載されたドロップアイテムをステータスに反映させます。">戦利品</th>\n          </tr>\n          </thead>\n          <tbody>\n          </tbody>\n        </table>\n        <center id="cubes"></center>\n        <div id="simple_status">\n          HP:<span id="simple_status_hp" class="status_v"></span>　\n          MP:<span id="simple_status_mp" class="status_v"></span>　|　\n          STR:<span id="simple_status_str" class="status_v"></span>　\n          INT:<span id="simple_status_int" class="status_v"></span>　\n          DEX:<span id="simple_status_dex" class="status_v"></span>　\n          KRM:<span id="simple_status_krm" class="status_v"></span>　｜　\n          <span id="simple_status_frees">\n            <br />\n            F1:<span id="simple_status_f1" class="status_v"></span>　\n            F2:<span id="simple_status_f2" class="status_v"></span>　\n            F3:<span id="simple_status_f3" class="status_v"></span>　｜　\n          </span>\n          <span id="simple_status_state" class="status_v"></span>　\n        </div>\n\n        <div id="sidr_battle_close" class="sidr_close">閉じる</div>\n        <div id="common_rule"></div>\n      </div>');target.parent().on("click","#sidr_battle tr.enemy_row",function(t){let e=enemies_map[$(this).nsAttr("data-enemy")];toastr.options.timeOut=5e3,toastr.info(e.desc,e.name)}),target.parent().on("click","#sidr_battle input.enemy_check",function(t){t.stopImmediatePropagation()}),target.parent().on("click","#sidr_battle .enemy_func",function(e){e.stopImmediatePropagation(),toastr.options.timeOut=5e3;let a=$(this).nsAttr("data-func"),s=$(this).nsAttr("data-attack");if(-1!==["poison","frozen","stone","curse","forget"].indexOf(s)){let t,e=a.split(/([<>])/),i=Util.computeDamage(e[0]),n=Util.computeDamage(e[2]);t="<"===e[1]?i<n:i>n,t?toastr.info("回避に成功した。","状態異常"):Util.updateState(s)&&toastr.error("「"+Common.state_names[s]+"」を受けた！","状態異常")}else{let t,e=Util.computeDamage(a),i=Bonus.adjustBattleDamage(e,"hp"),n=Bonus.adjustBattleDamage(e,"mp");e<0&&(e=0),i<0&&(i=0),n<0&&(n=0);let r=!1;switch(s){case"physics":i>=0&&(r=!0),save_data.chara.hp=Number(save_data.chara.hp)-i,t=`HPに${i}のダメージ！（現在値：${save_data.chara.hp}）`;break;case"magic":n>=0&&(r=!0),save_data.chara.mp=Number(save_data.chara.mp)-n,t=`MPに${n}のダメージ！（現在値：${save_data.chara.mp}）`;break;case"both":(i>=0||n>=0)&&(r=!0),save_data.chara.hp=Number(save_data.chara.hp)-i,save_data.chara.mp=Number(save_data.chara.mp)-n,t=`HP/MPに${i}/${n}のダブルダメージ！（現在値hp/mp：${save_data.chara.hp}/${save_data.chara.mp}）`;break;case"free1":e>=0&&(r=!0),save_data.chara.free1=Number(save_data.chara.free1)-e,t=`FREE1に${e}のダメージ！（現在値：${save_data.chara.free1}）`;break;case"free2":e>=0&&(r=!0),save_data.chara.free2=Number(save_data.chara.free2)-e,t=`FREE2に${e}のダメージ！（現在値：${save_data.chara.free2}）`;break;case"free3":e>=0&&(r=!0),save_data.chara.free3=Number(save_data.chara.free3)-e,t=`FREE3に${e}のダメージ！（現在値：${save_data.chara.free3}）`}r?toastr.error(t,"被ダメージ"):(t="敵の攻撃を防ぎきった！",toastr.info(t,"被ダメージ"))}Util.saveStorage(),t.showSimpleStatus()}),target.parent().on("click","#sidr_battle input.enemy_drop",function(e){e.stopImmediatePropagation();let a=$(this).nsAttr("data-drop").split("/");if(2===a.length)Util.updateStarById(a[0],a[1]),toastr.options.timeOut=5e3,toastr.info(`${Common.star_names[a[0]]}の欠片を${a[1]}個取得しました。`,"アイテム獲得");else{let t="free1"===a[0]?a[1]:0,e="free2"===a[0]?a[1]:0,s="free3"===a[0]?a[1]:0;Util.updateFrees(t,e,s),toastr.options.timeOut=5e3,toastr.info(`${a[2]}を取得しました。`,"アイテム獲得")}Util.saveStorage(),t.showSimpleStatus()});let a,s=new Audio(ROOT+COMMON+"dice.mp3"),i=function(){a++,$("#sidr_battle #cubes").html(t.cube(2)),a>20||setTimeout(i,50)};target.parent().on("click","#sidr_battle #cubes",function(t){s.play(),a=1,i()}),this.createSideBar("battle",e,function(){let e=$(`scene[id=${save_data.scene}]`,scenario_data);$("#sidr_battle #cubes").html(t.cube(2)),t.showSimpleStatus(),Util.showRuleText(e.nsAttr("rule"));let a=$("#sidr_battle .enemy tbody");a.empty();let s=e.nsAttr("enemies");if(s){let t=s.split(",");for(let e of t){let s=enemies_map[e],i=Common.state_names[s.attack],n=$(`<tr class="enemy_row" data-enemy="${e}">\n                <td>\n                  <input type="checkbox" class="enemy_check" />\n                </td>\n                <th>\n                  <img class="enemy_elem" />　\n                  ${s.name}\n                </th>\n                <td>\n                  <img class="enemy_attack" />　\n                  <span class="enemy_attack_old"></span>\n                </td>\n                <td>\n                  <div class="enemy_func"></div>\n                  <span class="enemy_func_old"></span>\n                </td>\n                <td>\n                  <input type="button" class="enemy_drop" />\n                  <span class="enemy_drop_old"></span>\n                </td>\n              </tr>`);if(1===t.length&&$(".enemy_check",n).hide(),s.element?$(".enemy_elem",n).attr({src:`${ROOT}${COMMON}attr_${s.element}.png`,title:Common.element_names[s.element]}):$(".enemy_elem",n).attr({src:`${ROOT}${COMMON}attr_none.png`,title:"無"}),i?($(".enemy_attack",n).attr({src:`${ROOT}${COMMON}atk_${s.attack}.png`,title:i}),$(".enemy_attack_old",n).hide()):($(".enemy_attack",n).hide(),$(".enemy_attack_old",n).text(s.attack)),s.func)if(0===s.func.indexOf("*"))$(".enemy_func",n).hide(),$(".enemy_func_old",n).text(Util.selectFunc(s.func.substring(1)));else{let t=Util.selectFunc(s.func);$(".enemy_func",n).attr({"data-func":t,"data-attack":s.attack}).text(t),$(".enemy_func_old",n).hide()}else $(".enemy_func",n).hide(),$(".enemy_func_old",n).hide();let r=Util.dropItem(s);r.name?($(".enemy_drop",n).val(r.name).attr("data-drop",r.drop),$(".enemy_drop_old",n).hide()):$(".enemy_drop",n).hide(),a.append(n)}$("#sidr_battle table.enemy").show()}else $("#sidr_battle table.enemy").hide()},function(){})},createPlayerRankInfo(){this.createSideBar("rank",'<div id="sidr_rank" class="sidr_info">\n          <table id="sidr_rank_summary" class="sidr_list_noline">\n            <tr>\n            <td colspan="4">\n              <img id="rank_pic" src="" align="left" />\n              <div>\n                PLAYER LV. <span id="rank_lv"></span>\n                <h3>\n                <span id="rank_en"></span>\n                <span id="rank_jp"></span>\n                </h3>\n              </div>\n            </td>\n            </tr>\n            <tr>\n              <th>CLEAR</th>\n              <td id="rank_clear"></td>\n              <th>RESULT</th>\n              <td id="rank_result"></td>\n            </tr>\n            <tr>\n              <th>BONUS</th>\n              <td id="rank_bonus"></td>\n              <th>EXP.</th>\n              <td id="rank_exp"></td>\n            </tr>\n          </table>\n          <table id="sidr_rank_list" class="sidr_list">\n            <thead>\n            <tr>\n              <th>No.</th>\n              <th>Title</th>\n              <th>Clear</th>\n              <th>Result Rate</th>\n            </tr>\n            <thead>\n            <tbody></tbody>\n          </table>\n          <div id="sidr_rank_close" class="sidr_close">閉じる</div>\n        </div>',function(){let t=PlayerRank.getRank();$("#sidr_rank #rank_pic").attr("src",`${ROOT}${COMMON}/rank/rank${t.level}.png`),$("#sidr_rank #rank_jp").text(t.jp),$("#sidr_rank #rank_en").text(`"${t.en}"`),$("#sidr_rank #rank_lv").text(t.level),$("#sidr_rank #rank_clear").text(`${PlayerRank.scena_count}/${PlayerRank.scena_all}`),$("#sidr_rank #rank_result").text(`${PlayerRank.scena_results_count}/${PlayerRank.scena_results_all}`),$("#sidr_rank #rank_bonus").text(`${PlayerRank.bonus_count}/${PlayerRank.bonus_all}`),$("#sidr_rank #rank_exp").text(`${PlayerRank.exp_count}/${PlayerRank.exp_all}`);let e=$("#sidr_rank #sidr_rank_list tbody");e.empty();let a=1;for(let t in PlayerRank.scena_infos){let s=PlayerRank.scena_infos[t];e.append(`<tr>\n              <td>${a++}</td>\n              <td>${s.title}</td>\n              <td>${s.is_cleared?"○":""}</td>\n              <td>${Math.floor(s.results_count/s.results_all*100)}%（${s.results_count}/${s.results_all}）</td>\n            </tr>`)}},function(){})},createBasicInfo(){let t=$('<div id="sidr_basic" class="sidr_info">\n        <img id="sidr_basic_chara_face" align="right" />\n        <h2>\n          "<span id="sidr_basic_title"></span>"\n          <span id="sidr_basic_name"></span>\n        </h2>\n        <i>\n          <span id="sidr_basic_ellapsed_scene"></span>\n        </i>\n        <table class="sidr_list_noline sidr_basic_table">\n        <tr>\n          <th>CLASS：</th>\n          <td>\n            <span id="sidr_basic_race"></span>　\n            <span id="sidr_basic_sex"></span>\n          </td>\n        </tr>\n        <tr>\n          <th>AGE：</th>\n          <td><span id="sidr_basic_age"></span></td>\n        </tr>\n        <tr>\n          <th>JOB：</th>\n          <td><select id="sidr_basic_job"></select></td>\n        </tr>\n        </table>\n        <hr />\n        <textarea id="sidr_basic_memos" placeholder="君は冒険中のメモをここに記録しておいても構わないし、脳裏に留めておいても構わない。"></textarea>\n        <div id="sidr_basic_submit" class="sidr_submit">確定</div>\n        <div id="sidr_basic_close" class="sidr_close">閉じる</div>\n      </div>');$("#sidr_basic_chara_face",t).attr("src",ROOT+COMMON+String(save_data.chara.sex).toLowerCase()+"_"+String(save_data.chara.age).toLowerCase()+"_"+String(save_data.chara.race).toLowerCase()+".png"),$("#sidr_basic_name",t).text(save_data.chara.name),$("#sidr_basic_title",t).text(save_data.chara.title),$("#sidr_basic_ellapsed_scene",t).text(`${save_data.ellapsed_scene} scene`),$("#sidr_basic_race",t).text(save_data.chara.race),$("#sidr_basic_sex",t).text(save_data.chara.sex),$("#sidr_basic_age",t).text(save_data.chara.age);let e=$("#sidr_basic_job",t);e.empty();for(let t of enabled_jobs)$("<option></option>").attr("value",t).text(t).appendTo(e);this.createSideBar("basic",t,function(){$("#sidr_basic #sidr_basic_job").val(save_data.chara.job),$("#sidr_basic #sidr_basic_memos").val(save_data.memos)},function(){save_data.chara.job=$("#sidr_basic #sidr_basic_job").val(),save_data.memos=$("#sidr_basic #sidr_basic_memos").val(),Util.saveStorage()})},createItemFlagInfo(){this.createSideBar("item",'<div id="sidr_item" class="sidr_info">\n          <h2>Items & Flags</h2>\n          <div>\n            ITEMS：<br/>\n            <textarea id="sidr_item_item"></textarea>\n          </div>\n          <div>\n            FLAGS：<br />\n            <textarea id="sidr_item_flag"></textarea>\n          </div>\n         <div id="sidr_item_close" class="sidr_close">閉じる</div>\n       </div>',function(){let t=[];for(let e of save_data.items){let a=items_map[e];t.push(`・${a.name}（${a.desc}）`)}$("#sidr_item #sidr_item_item").text(t.join("\r"));let e=[];for(let t of save_data.flags)e.push(`・${flags_map[t]}`);$("#sidr_item #sidr_item_flag").text(e.join("\r"))},function(){})},createStatusSheet(){
let t=this,e=$('<div id="sidr_status" class="sidr_info">\n        <h2>Status</h2>\n        <p id="sidr_status_bonus" class="bonus_msg"></p>\n        <table id="sidr_status_list">\n          <tr>\n          <td>\n            <div>\n            <label class="entry">HP：</label><br />\n            <input type="button" class="spinner_down" value="-" />\n            <input id="sidr_status_hp" type="number" />\n            <input type="button" class="spinner_up" value="+" />\n            ／<span id="sidr_status_hp_m"></span>\n            </div>\n            <div>\n            <label class="entry">MP：</label><br />\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_status_mp" />\n            <input type="button" class="spinner_up" value="+" />\n            ／<span id="sidr_status_mp_m"></span>\n            <div>\n            <label class="entry">STATE：</label><br />\n            <label><input type="radio" name="sidr_status_state" value="" />正常</label>\n            <label><input type="radio" name="sidr_status_state" value="poison" />毒</label>\n            <label><input type="radio" name="sidr_status_state" value="frozen" />凍結</label>\n            <label><input type="radio" name="sidr_status_state" value="stone" />石化\n            (<span id="sidr_status_stone_scene">0</span>)</label>\n            <label><input type="radio" name="sidr_status_state" value="curse" />呪い</label>\n            <label><input type="radio" name="sidr_status_state" value="forget" />忘却\n            (<span id="sidr_status_forget_scene">0</span>)</label>\n            <div id="sidr_status_state_desc">－－－</div>\n            </div>\n          </td>\n          <td>\n            <div>\n            <label class="entry">STR：</label><br />\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_status_str" />\n            <input type="button" class="spinner_up" value="+" />\n            ／<span id="sidr_status_str_i"></span>\n            </div>\n            <div>\n            <label class="entry">INT：</label><br />\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_status_int" />\n            <input type="button" class="spinner_up" value="+" />\n            ／<span id="sidr_status_int_i"></span>\n            </div>\n            <div>\n            <label class="entry">DEX：</label><br />\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_status_dex" />\n            <input type="button" class="spinner_up" value="+" />\n            ／<span id="sidr_status_dex_i"></span>\n            </div>\n            <div>\n            <label class="entry">KRM：</label><br />\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_status_krm" />\n            <input type="button" class="spinner_up" value="+" />\n            ／<span id="sidr_status_krm_i"></span>\n            </div>\n          </td>\n          </tr>\n        </table>\n        <div>\n          <label class="entry">FREE：</label><br />\n          <table id="sidr_status_free_list">\n          <tr>\n          <td>\n          <input type="button" class="spinner_down" value="-" />\n          <input type="number" id="sidr_status_free1" />\n          <input type="button" class="spinner_up" value="+" />・\n          <span class="free-label">\n          <br />\n          <span id="sidr_status_free_label1"></span>\n          </span>\n          </td>\n          <td>\n          <input type="button" class="spinner_down" value="-" />\n          <input type="number" id="sidr_status_free2" />\n          <input type="button" class="spinner_up" value="+" />・\n          <span class="free-label">\n            <br />\n            <span id="sidr_status_free_label2"></span>\n          </span>\n          </td>\n          <td>\n          <input type="button" class="spinner_down" value="-" />\n          <input type="number" id="sidr_status_free3" />\n          <input type="button" class="spinner_up" value="+" />\n          <span class="free-label">\n            <br />\n            <span id="sidr_status_free_label3"></span>\n          </span>\n          </td>\n          </tr>\n          </table>\n        </div>\n        <div id="sidr_status_submit" class="sidr_submit">確定</div>\n        <div id="sidr_status_close" class="sidr_close">閉じる</div>\n      </div>');$("#sidr_status_hp_m",e).text(save_data.chara.hp_m),$("#sidr_status_mp_m",e).text(save_data.chara.mp_m),$("#sidr_status_str_i",e).text(save_data.chara.str_i),$("#sidr_status_int_i",e).text(save_data.chara.int_i),$("#sidr_status_dex_i",e).text(save_data.chara.dex_i),$("#sidr_status_krm_i",e).text(save_data.chara.krm_i),target.parent().on("click",'[name="sidr_status_state"]',function(e){let a=t.deltaStatus($(this).val());$("#sidr_status #sidr_status_state_desc").text(a.state_desc),t.setStateStyle()}),target.parent().on("click","#sidr_status .spinner_up",this.incrementValue),target.parent().on("click","#sidr_status .spinner_down",this.decrementValue),this.createSideBar("status",e,function(){$("#sidr_status #sidr_status_hp").val(save_data.chara.hp),$("#sidr_status #sidr_status_mp").val(save_data.chara.mp),$('#sidr_status [name="sidr_status_state"]').each(function(){var t=$(this).nsAttr("value");t===save_data.chara.state?$(this).prop("checked",!0):$(this).prop("checked",!1)}),$("#sidr_status #sidr_status_stone_scene").text(save_data.chara.stone_scene),$("#sidr_status #sidr_status_forget_scene").text(save_data.chara.forget_scene),t.setStateStyle();let e=t.deltaStatus($('[name="sidr_status_state"]:checked').val());$("#sidr_status #sidr_status_state_desc").text(e.state_desc),$("#sidr_status #sidr_status_free1").val(save_data.chara.free1),$("#sidr_status #sidr_status_free2").val(save_data.chara.free2),$("#sidr_status #sidr_status_free3").val(save_data.chara.free3);let a=$("init > label",scenario_data);a&&($("#sidr_status #sidr_status_free_label1").text(a.nsAttr("free1")),$("#sidr_status #sidr_status_free_label2").text(a.nsAttr("free2")),$("#sidr_status #sidr_status_free_label3").text(a.nsAttr("free3"))),$("#sidr_status #sidr_status_str").val(save_data.chara.str),$("#sidr_status #sidr_status_int").val(save_data.chara.int),$("#sidr_status #sidr_status_dex").val(save_data.chara.dex),$("#sidr_status #sidr_status_krm").val(save_data.chara.krm)},function(){save_data.chara.hp=$("#sidr_status #sidr_status_hp").val(),save_data.chara.mp=$("#sidr_status #sidr_status_mp").val(),save_data.chara.free1=$("#sidr_status #sidr_status_free1").val(),save_data.chara.free2=$("#sidr_status #sidr_status_free2").val(),save_data.chara.free3=$("#sidr_status #sidr_status_free3").val(),save_data.chara.str=$("#sidr_status #sidr_status_str").val(),save_data.chara.int=$("#sidr_status #sidr_status_int").val(),save_data.chara.dex=$("#sidr_status #sidr_status_dex").val(),save_data.chara.krm=$("#sidr_status #sidr_status_krm").val(),Util.updateState($('#sidr_status [name="sidr_status_state"]:checked').val()),Util.saveStorage(),t.showSimpleStatus()})},createMagicSheet(){let t=this,e=function(t,e,a){if(t[e]>0){let s=$(`#sidr_magic #sidr_magic_${a}`),i=Number(s.val());s.val(i-t[e])}},a=$('<div id="sidr_magic" class="sidr_info">\n      <h2>Magic & STARS</h2>\n      <p id="sidr_magic_bonus" class="bonus_msg"></p>\n      <div>\n        <select id="sidr_magic_magic"></select>\n        <input type="button" id="sidr_magic_run" value="Shoot" />\n      </div>\n      <table id="sidr_magic_list">\n        <tr>\n          <td>\n            <div>\n            月\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_magic_mon" />\n            <input type="button" class="spinner_up" value="+" />\n            </div>\n            <div>\n            火\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_magic_tue" />\n            <input type="button" class="spinner_up" value="+" />\n            </div>\n            <div>\n            水\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_magic_wed" />\n            <input type="button" class="spinner_up" value="+" />\n            </div>\n            <div>\n            木\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_magic_thu" />\n            <input type="button" class="spinner_up" value="+" />  \n            </div>  \n          </td>\n          <td>\n            <div>\n            金\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_magic_fri" />\n            <input type="button" class="spinner_up" value="+" />\n            </div>\n            <div>\n            土\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_magic_sat" />\n            <input type="button" class="spinner_up" value="+" />\n            </div>\n            <div>\n            太\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_magic_sun" />\n            <input type="button" class="spinner_up" value="+" />\n            </div>\n          </td>\n        </tr>\n      </table>\n      <div id="sidr_magic_submit" class="sidr_submit">確定</div>\n      <div id="sidr_magic_close" class="sidr_close">閉じる</div>\n      </div>');target.parent().on("click","#sidr_magic .spinner_up",this.incrementValue),target.parent().on("click","#sidr_magic .spinner_down",this.decrementValue),$("#sidr_magic_run",a).click(function(a){if(a.preventDefault(),"curse"===save_data.chara.state)return toastr.warning("魔法を詠唱できない！君は呪われている！！","状態異常"),!1;let s=$("#sidr_magic #sidr_magic_magic").val(),i=Common.magic[s];i&&($("#sidr_magic #sidr_magic_mon").val()<i[0]||$("#sidr_magic #sidr_magic_tue").val()<i[1]||$("#sidr_magic #sidr_magic_wed").val()<i[2]||$("#sidr_magic #sidr_magic_thu").val()<i[3]||$("#sidr_magic #sidr_magic_fri").val()<i[4]||$("#sidr_magic #sidr_magic_sat").val()<i[5]||$("#sidr_magic #sidr_magic_sun").val()<i[6]?window.alert("星が不足しているため、魔法を発動できません！"):(e(i,0,"mon"),e(i,1,"tue"),e(i,2,"wed"),e(i,3,"thu"),e(i,4,"fri"),e(i,5,"sat"),e(i,6,"sun"),t.runMagic(s),$("#sidr_magic #sidr_magic_submit").click(),t.showSimpleStatus()))}),$(".spinner_up",a).click(this.incrementValue()),this.createSideBar("magic",a,function(){let t=$("#sidr_magic #sidr_magic_magic");t.empty();for(let e in Common.magic){let a=Common.magic[e],s=$("<option></option>").attr("value",e).attr("title",a[8]).text(`${e}（${a[7]}）`);Util.canUseMagic(a)||s.attr("disabled","disabled"),s.appendTo(t)}$("#sidr_magic #sidr_magic_mon").val(save_data.stars[0]),$("#sidr_magic #sidr_magic_tue").val(save_data.stars[1]),$("#sidr_magic #sidr_magic_wed").val(save_data.stars[2]),$("#sidr_magic #sidr_magic_thu").val(save_data.stars[3]),$("#sidr_magic #sidr_magic_fri").val(save_data.stars[4]),$("#sidr_magic #sidr_magic_sat").val(save_data.stars[5]),$("#sidr_magic #sidr_magic_sun").val(save_data.stars[6])},function(){save_data.stars[0]=$("#sidr_magic #sidr_magic_mon").val(),save_data.stars[1]=$("#sidr_magic #sidr_magic_tue").val(),save_data.stars[2]=$("#sidr_magic #sidr_magic_wed").val(),save_data.stars[3]=$("#sidr_magic #sidr_magic_thu").val(),save_data.stars[4]=$("#sidr_magic #sidr_magic_fri").val(),save_data.stars[5]=$("#sidr_magic #sidr_magic_sat").val(),save_data.stars[6]=$("#sidr_magic #sidr_magic_sun").val(),Util.saveStorage()})},createBonusInfo(){let t=$('<div id="sidr_bonus" class="sidr_info">\n        <h2>Bonus</h2>\n        <ul id="sidr_bonus_list">\n          <li><img id="gi01" /></li>\n          <li><img id="gi02" /></li>\n          <li><img id="gi03" /></li>\n          <li><img id="gi04" /></li>\n          <li><img id="gi05" /></li>\n          <li><img id="gi06" /></li>\n          <li><img id="gi07" /></li>\n          <li><img id="gi08" /></li>\n          <li><img id="gi09" /></li>\n          <li><img id="gi10" /></li>\n          <li><img id="gi11" /></li>\n          <li><img id="gi12" /></li>\n          <li><img id="gi13" /></li>\n          <li><img id="gi14" /></li>\n          <li><img id="gi15" /></li>\n          <li><img id="gi16" /></li>\n          <li><img id="gi17" /></li>\n          <li><img id="gi18" /></li>\n          <li><img id="gi19" /></li>\n          <li><img id="gi20" /></li>\n          <li><img id="gi21" /></li>\n          <li><img id="gi22" /></li>\n          <li><img id="gi23" /></li>\n          <li><img id="bgi01" /></li>\n          <li><img id="bgi02" /></li>\n          <li><img id="bgi03" /></li>\n          <li><img id="bgi04" /></li>\n          <li><img id="bgi05" /></li>\n        </ul>\n        <div id="sidr_bonus_close" class="sidr_close">閉じる</div>\n      </div>'),e=function(e,a){let s;for(let i=1;i<=e;i++){s=i<10?`0${i}`:i,s=`${a}${s}`;let e=$(`#${s}`,t);-1!==$.inArray(s,global_save_data.items)?e.attr("src",`${ROOT}${COMMON}${s}.png`).attr("class","bonus_item"):e.attr("src",`${ROOT}${COMMON}gi99.png`),save_data.bonus===s&&e.parent().css("background-color","#7fffd4")}};e(Object.keys(Common.global_items.happy).length,"gi"),e(Object.keys(Common.global_items.bad).length,"bgi"),target.parent().on("click","#sidr_bonus_list img.bonus_item",function(t){let e,a=t.target.id;e=a.startsWith("gi")?Common.global_items.happy[a]:Common.global_items.bad[a],toastr.success(e.desc,e.name)}),this.createSideBar("bonus",t,function(){},function(){})},createResultInfo(){this.createSideBar("result",'<div id="sidr_result" class="sidr_info">\n          <h2>Results</h2>\n          <div id="sidr_result_rate">Rate: 0.0%</div>\n          <table id="sidr_result_list">\n          </table>\n          <div id="sidr_result_close" class="sidr_close">閉じる</div>\n        </div>',function(){let t=0,e=0,a=["","ノーマル","ブロンズ","シルバー","ゴールド","プラチナ"],s=$("#sidr_result #sidr_result_list");s.empty(),Object.keys(results_map).forEach(function(i){let n;t++,void 0!==global_save_data.results[scenario_code]&&-1!==global_save_data.results[scenario_code].indexOf(i)?(e++,n=`<tr>\n                <td>\n                  <img src="${ROOT}${COMMON}trophy${results_map[i].level}.png"\n                    title="${a[results_map[i].level]}" />\n                </td>\n                <td>\n                  <h3>${results_map[i].name}\n                  （Lv.${results_map[i].level}）</h3>\n                  <p>${results_map[i].desc}</p>\n                </td>\n              </tr>`):n=`<tr>\n                <td>\n                  <img src="${ROOT}${COMMON}trophy0.png"\n                    title="実績未達" />\n                </td>\n                <td>\n                  <h3>???????????????</h3>\n                  <p>???????????????</p>\n                </td>\n              </tr>`,s.append(n)});let i=(e/t*100).toFixed(1);$("#sidr_result #sidr_result_rate").text(`Rate:${i}%`)},function(){})},createAll(){this.createBasicInfo(),this.createStatusSheet(),this.createMagicSheet(),this.createItemFlagInfo(),this.createResultInfo(),this.createBonusInfo(),this.createPlayerRankInfo(),this.createBattleSheet()},closeAll(){let t=["basic","status","magic","item","result","bonus","rank","battle"];for(let e of t)$.sidr("close",`sidr_${e}`)}},ControlPanel={init(){$('<nav class="main-nav" role="navigation">\n        <!-- Mobile menu toggle button (hamburger/x icon) -->\n        <input id="main-menu-state" type="checkbox" />\n        <label class="main-menu-btn" for="main-menu-state">\n          <span class="main-menu-btn-icon"></span> Toggle main menu visibility\n        </label>\n        \n        <h2 class="nav-brand"><a href="./">\n          <img src="./stext/common/gamebook_header_text.png"/>\n          <span class="pconly" style="vertical-align: top;">SORCERIAN Text</span>\n        </a></h2>\n        \n        <!-- Sample menu definition -->\n        <ul id="main-menu" class="sm sm-blue">\n          <li><a id="menu_status" href="#">Status</a></li>\n          <li><a id="menu_magic" href="#">Magic</a></li>\n          <li><a href="#">Info</a>\n            <ul>\n              <li><a id="menu_basic">Basic</a></li>\n              <li><a id="menu_item">Item & Flag</a></li>\n              <li><a id="menu_result">Result</a></li>\n              <li><a id="menu_bonus">Bonus</a></li>\n              <li><a id="menu_rank">Player Rank</a></li>\n            </ul>\n          </li>\n          <li><a href="#">System</a>\n            <ul>\n              <li><a id="menu_backup">Backup</a></li>\n              <li><a id="menu_restore">Restore</a><input id="menu_restore_select" type="file" accept=".stext" /></li>\n              <li><a id="menu_audio">Sound</a></li>\n              <li><a href="https://sorcerian.hateblo.jp/entries/2017/12/20">Help</a></li>\n              <li><a href="./">Exit</a></li>\n            </ul>\n          </li>\n        </ul>\n      </nav>').insertBefore(target);let t=$("#main-menu");t.smartmenus({noMouseOver:!0,subMenusSubOffsetX:1,subMenusSubOffsetY:-8});let e=$("#main-menu-state");e.length&&(target.parent().on("change","#main-menu-state",function(t){let e=$("#main-menu");this.checked?e.hide().slideDown(250,function(){e.css("display","")}):e.show().slideUp(250,function(){e.css("display","")})}),$(window).bind("beforeunload unload",function(){e[0].checked&&e[0].click()})),$('<div id="menu_battle">Battle Sheet</div>').insertBefore(target),target.parent().on("click","#menu_backup",function(){Util.downloadSavedata(scenario_code,storage[scenario_code])}),target.parent().on("click","#menu_restore",function(){$("#menu_restore_select").click()}),target.parent().on("change","#menu_restore_select",function(){scenario_code===this.files[0].name.split("-")[0]?Util.restoreSaveData(this,function(){window.alert("リストアに成功しました。\nゲームを再起動します。"),location.reload()}):window.alert("失敗：現在のシナリオ以外のバックアップはUtilityページからリストアしてください。")}),$("#menu_audio").text(`Sound（${global_save_data.bgm?"On":"Off"}）`),target.parent().on("click","#menu_audio",function(t){bgm&&(global_save_data.bgm?(global_save_data.bgm=!1,$(this).text("Sound（Off）"),bgm.pause()):(global_save_data.bgm=!0,$(this).text("Sound（On）"),bgm.play()),Util.saveStorageGlobal())})}};var Util={random:function(t,e){return Math.floor(Math.random()*(e-t+1))+t},minMaxGuard:function(t){return t<0?0:t>10?10:t},randomArray:function(t){return t[Math.floor(Math.random()*t.length)]},pushUnique:function(t,e){return-1===t.indexOf(e)&&(t.push(e),!0)},shiftUnique:function(t,e){return t.filter(function(t){return t!==e})},ltrim:function(t){return t.substr(1)},deepCopyObject:function(t){var e=JSON.stringify(t);return JSON.parse(e)},processByWeight(t,...e){let a=0,s=Math.random();for(let i=0;i<t.length;i++)if(a+=t[i],s<a)return void e[i]()},saveStorage:function(){storage[scenario_code]=JSON.stringify(save_data)},loadStorage:function(){save_data=JSON.parse(storage[scenario_code])},saveStorageGlobal:function(){storage[GLOBAL_SAVE_DATA_KEY]=JSON.stringify(global_save_data)},loadStorageGlobal:function(){global_save_data=JSON.parse(storage[GLOBAL_SAVE_DATA_KEY])},initSavedata:function(){var t=$("init > constraint",scenario_data);if(t){var e=t.nsAttr("race");e&&(e=e.split(","));var a=t.nsAttr("sex"),s=t.nsAttr("age");s&&(s=s.split(","))}var i=this.randomArray(Common.pc_init.filter(function(t){return!e||e.includes(t[0])}).filter(function(t){return!a||a===t[1]})),n=this.random(i[2],i[2]+10),r=this.random(i[3],i[3]+10),d=this.minMaxGuard(this.random(i[4],i[4]+2)),l=this.minMaxGuard(this.random(i[5],i[5]+2)),o=this.minMaxGuard(this.random(i[6],i[6]+2)),c=this.minMaxGuard(this.random(i[7],i[7]+2)),_=storage[scenario_code],u="";_&&(_=JSON.parse(_),u=_.memos),save_data={chara:{name:"MALE"===i[1]?this.randomArray(Common.male_name):this.randomArray(Common.female_name),title:this.randomArray(Common.title),race:i[0],sex:i[1],age:this.randomArray(["YOUNG","ADULT","OLD"].filter(function(t){return!s||s.includes(t)})),job:"",state:"",stone_scene:0,forget_scene:0,hp_m:n,hp:n,mp_m:r,mp:r,str_i:d,str:d,int_i:l,int:l,dex_i:o,dex:o,krm_i:c,krm:c,free1:0,free2:0,free3:0},stars:[0,0,0,0,0,0,0],items:[],flags:[],memos:u,scene:0,ellapsed_scene:0,bgm:"",bonus:this.randomArray(global_save_data.items),isEnded:!1},this.initJobs(),save_data.chara.job=this.randomArray(enabled_jobs),this.saveStorage()},initGlobalSaveData:function(){global_save_data={items:[],results:{},bgm:!0,panel:!0},this.saveStorageGlobal(GLOBAL_SAVE_DATA_KEY)},initJobs:function(){enabled_jobs=Object.keys(Common.jobs).filter(function(t){var e=Common.jobs[t];return-1!==e[0].indexOf(save_data.chara.race.charAt(0))&&-1!==e[1].indexOf(save_data.chara.sex.charAt(0))&&-1!==e[2].indexOf(save_data.chara.age.charAt(0))})},downloadSavedata:function(t,e){var a=navigator.userAgent.toLowerCase();if(-1!==a.indexOf("safari")&&-1===a.indexOf("chrome")&&-1===a.indexOf("edge"))window.open("./stext/download.php?id="+t+"&data="+e);else{var s=new Blob([e],{type:"application/octet-stream"}),i=document.createElement("a");i.href=window.URL.createObjectURL(s),i.download=t+"-"+(new Date).getTime()+".stext",document.body.appendChild(i),i.click(),document.body.removeChild(i)}},restoreSaveData:function(t,e){var a=t.files[0],s=a.name.split("-")[0],i=new FileReader;$(i).on("load",function(){if("all"===s)for(var t=i.result.split("\n"),a="",n="",r=0;r<t.length;r++)r%2==0?a=t[r]:(n=t[r],n&&(storage[a]=n));else storage[s]=i.result;e()}),i.readAsText(a,"UTF-8")},buildBgmPath:function(t){return""===t&&(t=bgms_map.main),0===t.indexOf("@")?ROOT+COMMON+BGM+t.substring(1)+".mp3":ROOT+scenario_code+"/"+BGM+t+".mp3"},validateScenario:function(){var t=[],e=[],a=function(e,a,s){if(void 0!==a&&""!==a){var i=a.trim().split(","),n=Object.keys(e);i.forEach(function(e){e=e.replace("-",""),-1===n.indexOf(e)&&t.push({scene_id:s,message:e.startsWith("i")?"アイテムコード"+e+"が未登録です。":e.startsWith("f")?"フラグコード"+e+"が未登録です。":e.startsWith("m")?"敵コード"+e+"が未登録です。":"実績コード"+e+"が未登録です。"})})}};return $("scene",scenario_data).each(function(s,i){var n=$(i);-1===e.indexOf(n.nsAttr("id"))?e.push(n.nsAttr("id")):t.push({scene_id:n.nsAttr("id"),message:"scene－idが重複しています。"}),a(items_map,n.nsAttr("items"),n.nsAttr("id")),a(flags_map,n.nsAttr("flags"),n.nsAttr("id")),a(enemies_map,n.nsAttr("enemies"),n.nsAttr("id")),a(results_map,n.nsAttr("result"),n.nsAttr("id"))}),t},canUseMagic:function(t){return!(save_data.stars[0]<t[0]||save_data.stars[1]<t[1]||save_data.stars[2]<t[2]||save_data.stars[3]<t[3]||save_data.stars[4]<t[4]||save_data.stars[5]<t[5]||save_data.stars[6]<t[6])},canUseMagicByName:function(t){return 0===t.indexOf("m")&&Util.canUseMagic(Common.magic[t.substring(1)])},ifStatus:function(t){if(0===t.indexOf("o")){var e=t.match(/o(hp|mp|str|int|dex|krm|freei|freeii|freeiii)\s*(\d{1,})(\+|-)\s*/i);e[1]=e[1].toLowerCase(),e[1]=e[1].replace("freeiii","free3"),e[1]=e[1].replace("freeii","free2"),e[1]=e[1].replace("freei","free1");var a=save_data.chara[e[1]];return"-"===e[3]?a<Number(e[2]):a>Number(e[2])}return!1},isCharaState:function(t){if(0===t.indexOf("x")){var e=[save_data.chara.race,save_data.chara.sex,save_data.chara.age,save_data.chara.state.toUpperCase(),save_data.chara.job];return-1!==e.indexOf(t.substring(1).toUpperCase())}return!1},hasStars:function(t){if(0===t.indexOf("s")){var e=save_data.stars;if(-1!==t.indexOf(":")){t=t.substring(1).split(":");for(var a=0;a<t.length;a++)if(Number(e[a])<t[a])return!1}else{t=Number(t.substring(1));var s=0;for(a=0;a<7;a++)s+=Number(e[a]);if(s<t)return!1}return!0}return!1},hasResult:function(t){if(0===t.indexOf("r")){var e=t.split(":"),a=global_save_data.results[e[1].trim()];if(void 0!==a)return-1!==a.indexOf(e[0].trim())}return!1},updateItems:function(t){if(t){for(var e=save_data.items,a=(t=t.split(","),0);a<t.length;a++){var s=t[a].trim();0===s.indexOf("-")?(s=this.ltrim(s),e=this.shiftUnique(e,s)):this.pushUnique(e,s)}save_data.items=e}},updateFlags:function(t){if(t){for(var e=save_data.flags,a=(t=t.split(","),0);a<t.length;a++){var s=t[a].trim();0===s.indexOf("-")?(s=this.ltrim(s),0===flags_map[s].indexOf("*")?e=this.shiftUnique(e,s):console.log(s+"：隠しフラグ以外は削除できません。")):this.pushUnique(e,s)}save_data.flags=e}},updateStates:function(){"poison"===save_data.chara.state?(save_data.chara.hp-=1,save_data.chara.stone_scene=0,save_data.chara.poison_scene=0):"stone"===save_data.chara.state?(save_data.chara.stone_scene+=1,save_data.chara.forget_scene=0):"forget"===save_data.chara.state?(save_data.chara.forget_scene+=1,save_data.chara.stone_scene=0):(save_data.chara.stone_scene=0,save_data.chara.forget_scene=0)},updateStars:function(t){if(t){var e=save_data.stars;if(-1!==t.indexOf(",")){t=t.split(",");for(var a=0;a<t.length;a++)e[a]=Number(e[a])+Number(t[a].trim()),e[a]<0&&(e[a]=0)}else if(0===t.indexOf("div")){t=t.substring(3);for(a=0;a<7;a++)e[a]=Math.floor(Number(e[a])/Number(t))}save_data.stars=e}},updateStarsByMagic:function(t){if(void 0===t||0===t.indexOf("-"))return!0;for(var e=save_data.stars.concat(),a=function(t){for(var a=0;a<e.length;a++)if(e[a]-=t[a],e[a]<0)return!1;return!0},s=t.split(",").filter(function(t){return 0===t.indexOf("m")}),i=0;i<s.length;i++){var n=Common.magic[s[i].substring(1)];if(!n)return;if(!Util.canUseMagic(n))return!1;if(!a(n))return!1}return save_data.stars=e,Util.saveStorage(),!0},updateStarById:function(t,e){var a=Object.keys(Common.star_names).indexOf(t);save_data.stars[a]=Number(save_data.stars[a])+Number(e)},updateHpMp:function(t,e){if(t)if("full"===t)save_data.chara.hp=save_data.chara.hp_m;else if("half"===t)save_data.chara.hp=Math.floor(save_data.chara.hp_m/2);else{var a=String(t).split("..");a[1]&&(a[0]=Util.random(Number(a[0]),Number(a[1]))),save_data.chara.hp=Number(save_data.chara.hp)+Number(a[0]),save_data.chara.hp>save_data.chara.hp_m&&(save_data.chara.hp=save_data.chara.hp_m)}if(e)if("full"===e)save_data.chara.mp=save_data.chara.mp_m;else if("half"===e)save_data.chara.mp=Math.floor(save_data.chara.mp_m/2);else{var s=String(e).split("..");s[1]&&(s[0]=Util.random(Number(s[0]),Number(s[1]))),save_data.chara.mp=Number(save_data.chara.mp)+Number(s[0]),save_data.chara.mp>save_data.chara.mp_m&&(save_data.chara.mp=save_data.chara.mp_m)}},updateStr2Krm:function(t,e,a,s){t&&("full"===t?save_data.chara.str=save_data.chara.str_i:0===String(t).indexOf("@")?save_data.chara.str=Number(t.substring(1)):save_data.chara.str=Number(save_data.chara.str)+Number(t)),e&&("full"===e?save_data.chara.int=save_data.chara.int_i:0===String(e).indexOf("@")?save_data.chara.int=Number(e.substring(1)):save_data.chara.int=Number(save_data.chara.int)+Number(e)),a&&("full"===a?save_data.chara.dex=save_data.chara.dex_i:0===String(a).indexOf("@")?save_data.chara.dex=Number(a.substring(1)):save_data.chara.dex=Number(save_data.chara.dex)+Number(a)),s&&("full"===s?save_data.chara.krm=save_data.chara.krm_i:0===String(s).indexOf("@")?save_data.chara.krm=Number(s.substring(1)):save_data.chara.krm=Number(save_data.chara.krm)+Number(s))},updateFrees:function(t,e,a){t&&(0===t.indexOf("@")?save_data.chara.free1=Number(t.substring(1)):save_data.chara.free1=Number(save_data.chara.free1)+Number(t)),e&&(0===e.indexOf("@")?save_data.chara.free2=Number(e.substring(1)):save_data.chara.free2=Number(save_data.chara.free2)+Number(e)),a&&(0===a.indexOf("@")?save_data.chara.free3=Number(a.substring(1)):save_data.chara.free3=Number(save_data.chara.free3)+Number(a))},updateState:function(t){if(t){if(0===t.indexOf("-")){let e=t.substring(1);"all"===e?save_data.chara.state="":save_data.chara.state===e&&(save_data.chara.state="")}else{if(!Bonus.guardState(t)){let e=Common.state_names[t];return toastr.warning(`${e}耐性が作動！${e}を防いだ！！`,"シナリオボーナス"),!1}save_data.chara.state=t}return!0}},updateResults:function(t){if(t){void 0===global_save_data.results&&(global_save_data.results={});var e=global_save_data.results;void 0===e[scenario_code]&&0!==scenario_code.indexOf("<")&&(e[scenario_code]=[]),!0===this.pushUnique(e[scenario_code],t)&&(toastr.options.timeOut=5e3,toastr.success(results_map[t].name,"実績獲得")),this.saveStorageGlobal()}},dropItem:function(t){if(t.drop){var e=t.drop.split("/"),a=Common.star_names[e[0]];if(a){var s="1"===e[1]?"":"×"+e[1];return{drop:t.drop,name:a+s}}return{drop:t.drop,name:e[2]}}if(!t.element)return{name:null};var i={earth:["thu","tue","sat","",""],fire:["tue","sun","tue","",""],water:["wed","mon","fri","",""],wind:["fri","wed","mon","",""],spirit:["sat","sun","mon","",""]},n=Util.randomArray(i[t.element]);return{drop:n?n+"/1":"",name:Common.star_names[n]}},computeDamage:function(t){for(var e,a=0,s=/([\+\-]?)(\d*)(R|L|STR|INT|DEX|KRM|FREE1|FREE2|FREE3)?]?/gi;null!=(e=s.exec(t));){var i=1,n=1,r=1;if(""===e[0])break;"-"===e[1]&&(i=-1),e[2]&&(n=Number(e[2]));var d={str:Number(save_data.chara.str),int:Number(save_data.chara.int),dex:Number(save_data.chara.dex),krm:Number(save_data.chara.krm)};switch(save_data.chara.state){case"frozen":d.str-=2,d.int-=2,d.dex-=2,d.krm-=2;break;case"stone":d.str-=1,d.int-=1,d.dex-=1,d.krm-=1;break;case"forget":d.str<d.int?d.int=0:d.str=0}switch(e[3]){case"L":r=dice[0];break;case"R":r=dice[1];break;case"STR":case"INT":case"DEX":case"KRM":r=d[e[3].toLowerCase()];break;case"FREE1":case"FREE2":case"FREE3":r=save_data.chara[e[3].toLowerCase()];break;default:r=1}a+=i*n*r}return a*=Number($("#damage_delta").val()),Math.floor(a)},selectFunc:function(t){return Util.randomArray(t.split(",")).trim()},getBonusItem:function(t){if(t)return 0===t.indexOf("bgi")?Common.global_items.bad[t]:Common.global_items.happy[t]},initView(){ControlPanel.init(),Util.createCommonTweet(),PlayerRank.init(),SideBar.createAll(),Bonus.showBonusMessage()},initScenario:function(){Util.initSavedata(),Util.initView(),Bonus.initBonusStatus(),Util.createScene(0),window.alert("キャラが新規作成されました。\rステータスダイアログは画面右クリックで開くことができます。")},copyNextScenario:function(t){var e=Util.deepCopyObject(save_data);e.chara.state="",e.chara.stone_scene=0,e.chara.forget_scene=0,e.chara.free1=0,e.chara.free2=0,e.chara.free3=0,e.items=e.items.filter(function(t){return void 0!==items_map[t].shared}),e.flags=[],e.scene=0,e.ellapsed_scene=0,e.bgm="",e.isEnded=!1;for(var a=0;a<t.length;a++)localStorage[t[a].trim()]=JSON.stringify(e)},endScenario:function(t,e,a){if(t){e&&Util.copyNextScenario(e.split(",")),console.log("***********Licence Info.***********");var s,i,n,r={bgm:"音楽",picture:"画像"};switch($("licence > work",scenario_data).each(function(){var t=$(this).nsAttr("url");console.log($(this).nsAttr("name")+"("+r[$(this).nsAttr("category")]+"): "+$(this).nsAttr("creator")+" "+(void 0!==t?t:""))}),console.log("***********Licence Info.***********"),"bad"===t?$('<p><a href="#" id="end_reload" class="scenebtn">最初から冒険に挑戦する</a></p>').appendTo(target):"happy"===t&&$('<p><a href="#" id="end_exit" class="scenebtn">ペンタウァに帰還する</a></p>').appendTo(target),save_data.isEnded=!0,Util.saveStorage(),t){case"happy":s=Util.randomArray(Object.keys(Common.global_items.happy)),i=Common.global_items.happy[s],n=Util.buildBgmPath(bgms_map.happy);break;case"bad":Util.random(0,100)<20&&(s=Util.randomArray(Object.keys(Common.global_items.bad)),i=Common.global_items.bad[s]),n=Util.buildBgmPath(bgms_map.bad)}a&&(bgm&&bgm.pause(),bgm=new Audio(n),bgm.loop=!0,global_save_data.bgm&&bgm.play()),s&&(Util.pushUnique(global_save_data.items,s),Util.saveStorageGlobal(),$.get("stext/common/dialog_bonus.html").then(function(t){var e=$(t);$("#bonus_img",e).attr("src",ROOT+COMMON+s+".png"),$("#bonus_item",e).text(i.name),$("#bonus_item_desc",e).text(i.desc),setTimeout(function(){$.zoombox.html(e.html(),{width:480,height:200})},2e3)}))}},canSceneMove:function(t,e){return-1!==e.split(",").indexOf(t)},playBgm:function(t){bgm&&bgm.pause(),bgm=new Audio(t),bgm.loop=!0,global_save_data.bgm&&bgm.play()},showRuleText:function(t){void 0===t&&(t="99999"),$("#common_rule").html(Util.decorateText($("scene#"+t,scenario_data).text())).markdown()},interpolation:function(t,e){var a=e.split("?"),s=a[0];if(a[1])var i=a[1].split(":");switch(s){case"name":
return save_data.chara.name;case"title":return save_data.chara.title;case"race":switch(save_data.chara.race){case"FIGHTER":return i[0];case"WIZARD":return i[1];case"DWARF":return i[2];case"ELF":return i[3];default:return"Unknown Race"}case"sex":switch(save_data.chara.sex){case"MALE":return i[0];case"FEMALE":return i[1];default:return"Unknown Sex"}case"age":switch(save_data.chara.age){case"YOUNG":return i[0];case"ADULT":return i[1];case"OLD":return i[2];default:return"Unknown Age"}case"state":switch(save_data.chara.state){case"":return i[0];case"poison":return i[1];case"frozen":return i[2];case"stone":return i[3];case"curse":return i[4];case"forget":return i[5];default:return"Unknown State"}case"rand":return Util.random(Number(i[0]),Number(i[1]));case"msg":return Util.randomArray(i);case"input":return'<input type="button" class="spinner_down sgml" value="-" /><input type="number" class="sgml" value="'+i[0]+'" /><input type="button" class="spinner_up sgml" value="+" />';default:return e}},conditionSingle:function(t){return t=t.trim(),-1!==save_data.flags.indexOf(t)||-1!==save_data.items.indexOf(t)||Util.canUseMagicByName(t)||Util.ifStatus(t)||Util.isCharaState(t)||Util.hasStars(t)||Util.hasResult(t)},conditionAllTrue:function(t){for(var e=!0,a=t.split(","),s=0;s<a.length;s++)if(!Util.conditionSingle(a[s])){e=!1;break}return e},conditionFull:function(org_cond){for(var eval_str="",ope=/([\&\|\!\(\)]{1,2})/,conds=org_cond.split(ope),i=0;i<conds.length;i++){var c=conds[i];c&&(ope.test(c)?eval_str+=c:0!==c.indexOf("-")?eval_str+=Util.conditionSingle(c):eval_str+=!Util.conditionSingle(c.substring(1)))}return eval(eval_str)},judgeMultiCondition:function(t){return t=t.replace("#NOT#","!"),t=t.replace("#AND#","&"),t=t.replace("#OR#","|"),t=t.replace("#L#","("),t=t.replace("#R#",")"),/([\&\|\!\(\)]{1})/.test(t)?Util.conditionFull(t):0!==t.indexOf("-")?Util.conditionAllTrue(t):!Util.conditionAllTrue(t.substring(1))},showSceneButton:function(){$("a[title]",target).hide();var t=$("a[title]",target);t.each(function(t,e){Util.judgeMultiCondition($(e).nsAttr("title"))&&$(e).show()})},importText:function(t,e){return $("scene#"+e,scenario_data).text()},ifCondition:function(t,e,a){return Util.judgeMultiCondition(e)?a:""},parseTweet:function(t,e){return tweet_message=e,e},createTweet:function(t,e,a){if(e||(e="原作30周年記念企画「SORCERIAN Text」ユーザー参加型のゲームブック版ソーサリアン"),"custom"===t)var s=$(".socialbtn.twitter_custom"),i=$(".socialbtn.twitter");else s=$(".socialbtn.twitter"),i=$(".socialbtn.twitter_custom");a||(s.empty(),s.append($('<a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-lang="ja" data-url="https://www.web-deli.com/sorcerian/text/" data-via="snext1220" data-related="snext1220" data-hashtags="falcom,stext">Tweet</a>').attr("data-text",e)).append('<script src="https://platform.twitter.com/widgets.js" charset="UTF-8"></script>')),s.show(),i.hide()},createCommonTweet:function(){Util.createTweet("common",$("init > intro",scenario_data).nsAttr("description"))},decorateText:function(t){return t=t.replace(/\${import[\s]+(.+?)}/gi,this.importText),t=t.replace(/(\[.+?\]\([\d,]{1,} ")(.+?)("\))/gi,function(t,e,a,s){return a=a.split("!").join("#NOT#"),a=a.split("&").join("#AND#"),a=a.split("|").join("#OR#"),a=a.split("(").join("#L#"),a=a.split(")").join("#R#"),e+a+s}),t=t.replace(/%(blue|red|purple|white)%/gi,'&nbsp;<span style="color:$1">'),t=t.replace(/%\/%/gi,"</span>&nbsp;"),t=t.replace(/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?/gi,'<a href="$&" data-link="auto" target="_blank">$&</a>'),t=t.replace(/\${if[\s]+(.+?)}([\s\S]+?)\${\/if}/gi,this.ifCondition),t=t.replace(/\${(.+?)\|(.+?)}/gi,"<ruby>$1<rp>（</rp><rt>$2</rt><rp>）</rp></ruby>"),t=t.replace(/\${tweet}([\s\S]+?)\${\/tweet}/gi,this.parseTweet),t=t.replace(/\${(.+?)}/gi,this.interpolation),t},createScene:function(t,e){if(void 0===e&&(e={}),tweet_message=null,SideBar.closeAll(),save_data.isEnded)location.reload(!0);else{if(!Util.updateStarsByMagic(e.conditions))return toastr.options.timeOut=4e3,void toastr.warning("星が不足しているようだ。");$(window).scrollTop(0);var a=$('scene[id="'+t+'"]',scenario_data);e.reverse?e.restore&&history.pushState(save_data,"Scene "+t):(Util.updateItems(a.nsAttr("items")),Util.updateFlags(a.nsAttr("flags")),Util.updateStars(a.nsAttr("stars")),Util.updateHpMp(a.nsAttr("hp"),a.nsAttr("mp")),Util.updateStr2Krm(a.nsAttr("str"),a.nsAttr("int"),a.nsAttr("dex"),a.nsAttr("krm")),Util.updateFrees(a.nsAttr("free1"),a.nsAttr("free2"),a.nsAttr("free3")),Util.updateState(a.nsAttr("state")),Util.updateStates(),Util.updateResults(a.nsAttr("result")),Bonus.updateStatusByBonus(),save_data.scene=t,save_data.ellapsed_scene++,Util.saveStorage(),history.pushState(save_data,"Scene "+t)),target.html(Util.decorateText(a.text())),target.markdown(),tweet_message?Util.createTweet("custom",tweet_message):Util.createTweet("common",null,!0),$('<h5 id="scenario_title">'+$("scenario",scenario_data).nsAttr("title")+"【"+t+"】</span></h5>").prependTo(target),a.nsAttr("enemies")?$("#menu_battle").css("background-color","Red"):$("#menu_battle").css("background-color","Black"),SideBar.showSimpleStatus(),debug_mode&&($('<div id="debug_panel">\n          <form>\n            <label>Scene：<input id="debug_id" type="text" size="5" /></label>　\n            <label>Items：<input id="debug_items" type="text" size="7" /></label>　\n            <label>Flags：<input id="debug_flags" type="text" size="7" /></label>　\n            <input id="debug_reload" type="button" value="Reload" />\n          </form>\n        </div>').prependTo(target),$("#debug_panel #debug_id").val(t),$("#debug_panel #debug_items").val(save_data.items.join(",")),$("#debug_panel #debug_flags").val(save_data.flags.join(",")),$("#debug_panel #debug_reload").click(function(t){var e=$("#debug_panel #debug_items").val().trim(),a=$("#debug_panel #debug_flags").val().trim();save_data.items=""!==e?e.split(","):[],save_data.flags=""!==a?a.split(","):[],Util.saveStorage(),Util.createScene($("#debug_panel #debug_id").val())})),$("a",target).addClass("scenebtn"),$('a[data-link="auto"]',target).removeClass("scenebtn");var s=$('a[href="X"]',target);s.removeClass("scenebtn").addClass("scene_move").attr("data-allow",s.text()).text("移動する").before('<input type="number" id="toscene" class="scene_move" />').add("#toscene").wrapAll('<div class="xbtn"></div>');var i=$('a[href="Q"]',target);i.removeClass("scenebtn").addClass("quest_str").attr("data-yesno",i.text()).text("回答する").before('<input type="text" id="stranswer" class="quest_str" />').add("#stranswer").wrapAll('<div class="xbtn"></div>');var n=$("a:has(img)",target);n.each(function(t,e){var a=ROOT+scenario_code+"/"+CAPTURE+$(e).attr("href");$(e).attr("href",a).removeClass("scenebtn").addClass("scenepic").find("img").attr("src",a)}),$("a.scenepic").zoombox(),Util.showSceneButton(),$(".scenebtn:hidden + br",target).remove(),$("a[title]:hidden",target).remove();var r=a.nsAttr("bgm"),d=save_data.bgm;if(void 0!==r&&(d=r),d!==bgm_name&&(Util.playBgm(Util.buildBgmPath(d)),bgm_name=d,save_data.bgm=d,Util.saveStorage(),history.replaceState(save_data,"Scene "+t)),a.nsAttr("se")){var l=new Audio(ROOT+scenario_code+"/"+BGM+SE+a.nsAttr("se")+".mp3");l.loop=!1,l.play()}Util.endScenario(a.nsAttr("end"),a.nsAttr("nexts"),void 0===a.nsAttr("bgm"))}}};$.fn.extend({startGame:function(t,e){scenario_code=t,dialog_elem.main=target=this,e||(e=!1),debug_mode=e,target.addClass("main_back"),target.off(),target.parent().off(),$(document).off("click","#dialog_list img.bonus_item"),$(window).off("popstate"),target.on("click","a.scenebtn",function(t){if("end_reload"!==t.target.id)if("end_exit"!==t.target.id){var e=$(this).nsAttr("href"),a=$(this).nsAttr("title");-1!==e.indexOf(",")&&(e=Util.randomArray(e.split(",")).trim()),Util.createScene(e,{conditions:a}),bgm&&bgm.paused&&global_save_data.bgm&&bgm.play(),t.preventDefault()}else location.href="https://www.web-deli.com/sorcerian/text/"}),target.on("click","#end_reload",function(t){t.preventDefault(),t.stopImmediatePropagation(),("playground"!==scenario_code||confirm("ページをリロードしても宜しいですか？\nリロード時には、エディター上の編集内容も削除されます。シナリオ編集中の場合は、内容を保存してください。"))&&location.reload(!0)}),target.on("click","a.scene_move",function(t){var e=$("#toscene").val(),a=$(this).nsAttr("data-allow");Util.canSceneMove(e,a)?Util.createScene(e):(toastr.options.timeOut=4e3,toastr.warning("指定された番号には移動できないようだ")),t.preventDefault()}),target.on("click","a.quest_str",function(t){var e=$("#stranswer").val(),a=$(this).nsAttr("data-yesno").split(",");if(e===a[0])var s=a[1];else s=a[2];Util.createScene(s),t.preventDefault()}),target.on("contextmenu",function(t){$.sidr("open","sidr_status"),t.preventDefault()}),$(window).on("popstate",function(t){save_data.isEnded||null!=t.originalEvent.state&&(save_data=t.originalEvent.state,Util.saveStorage(),Util.createScene(t.originalEvent.state.scene,{reverse:!0}))}),target.on("click","#restart #tmp_init",function(t){Util.initScenario()}),target.on("click","#restart #tmp_continue",function(t){Util.initJobs(),Util.initView();var e=save_data.scene;Util.createScene(e,{reverse:!0,restore:!0})}),storage[GLOBAL_SAVE_DATA_KEY]?Util.loadStorageGlobal():Util.initGlobalSaveData();var a=function(t){for(var e in scenario_data=t,Common.magic){for(var a=Common.magic[e],s="",i=["月","火","水","木","金","土","太"],n=0;n<7;n++)a[n]>0&&(s+=i[n]+a[n]+" ");a.push(s)}flags_map={},$("flags > flag",scenario_data).each(function(){flags_map[$(this).nsAttr("id")]=$(this).text().trim()}),enemies_map={},$("enemies > enemy",scenario_data).each(function(){enemies_map[$(this).nsAttr("id")]={name:$(this).nsAttr("name"),element:$(this).nsAttr("element"),attack:$(this).nsAttr("attack"),func:$(this).nsAttr("func"),drop:$(this).nsAttr("drop"),desc:$(this).text().trim()}}),items_map={},$("items > item",scenario_data).each(function(){items_map[$(this).nsAttr("id")]={name:$(this).nsAttr("name"),shared:$(this).nsAttr("shared"),desc:$(this).text().trim()}}),results_map={},$("results > result",scenario_data).each(function(){results_map[$(this).nsAttr("id")]={name:$(this).attr("name"),level:$(this).nsAttr("level"),desc:$(this).text().trim()}});var r=$("init > bgm",scenario_data),d=r.nsAttr("main"),l=r.nsAttr("happy"),o=r.nsAttr("bad");if(bgms_map={main:void 0===d?"main":d,happy:void 0===l?"happy":l,bad:void 0===o?"bad":o},!0===debug_mode){var c=Util.validateScenario();if(0!==c.length){var _="<h3>scenario.xmlでエラーが検出されました。</h3>";return _+='<ul class="errorlist">',c.forEach(function(t){_+="<li>Scene "+t.scene_id+": "+t.message+"</li>"}),_+="</ul>",void target.html(_)}}if(!storage[scenario_code]||(Util.loadStorage(),save_data.isEnded))Util.initScenario();else{var u='<div id="restart"><h3>Welcome to SORCERIAN Text!!</h3><p>以前のデータが残っています。<br />続きから開始しますか？</p><button id="tmp_continue">続きから</button> <button id="tmp_init">最初から</button></div>';target.html(u)}};if(scenario_code=scenario_code.trim(),0===scenario_code.indexOf("<")){var s=new DOMParser,i=s.parseFromString(scenario_code,"text/xml");scenario_code="playground",global_save_data.results.playground=[],Util.saveStorageGlobal(),a(i)}else $.get(ROOT+scenario_code+"/scenario.xml").done(a).fail(function(t,e,a){throw new Error("scenario code is invalid.")})},gbat2stext:function(t){$(this).change(function(e){var a=0,s=$('<scenario xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://www.web-deli.com/sorcerian/next/stext/common/sgml.xsd">\n</scenario>'),i=$("<init>\n</init>"),n=$("<items>\n</items>"),r=$("<flags>\n</flags>"),d=$("<enemies>\n</enemies>"),l=$("<results>\n</results>"),o=$("<licence>\n</licence>"),c=function(e){var c=$(this.result),m=$("title",c).text().trim().split("@");if(s.attr("title")||(s.attr("title",m[0]),s.attr("author",m[1])),$("section",c).each(function(t,e){var a=!1,c={};if(c.id=Number($("number",e).text()),1===c.id&&(c.id=0),"link"===$("> summary",e).text().toLowerCase())return!0;var _="\n";$("> text p",e).each(function(t,e){var s=$(e).text();if("@@"===s.trim())return a=!a,!0;if(a){if(!s)return!0;if(0===s.indexOf("pc")){var u=s.split(":"),m=$("<constraint></constraint>");u[1]&&m.attr("race",u[1]),u[2]&&m.attr("sex",u[2]),u[3]&&m.attr("age",u[3]),m.appendTo(i)}else if(0===s.indexOf("bgm")){var p=s.split(":"),v=$("<bgm></bgm>");p[1]&&v.attr("main",p[1]),p[2]&&v.attr("happy",p[2]),p[3]&&v.attr("bad",p[3]),v.appendTo(i)}else if(0===s.indexOf("label")){var g=s.split(":"),h=$("<label></label>");g[1]&&h.attr("free1",g[1]),g[2]&&h.attr("free2",g[2]),g[3]&&h.attr("free3",g[3]),h.appendTo(i)}else if(0===s.indexOf("intro")){var f=s.split(":"),b=$("<intro></intro>");f[1]&&b.attr("description",f[1]),b.appendTo(i)}else if(0===s.indexOf("i")){var y=s.split(":");$("<item></item>").attr("id",y[0]).attr("name",y[1]).text(y[2]).appendTo(n)}else if(0===s.indexOf("f")){var x=s.split(":");$("<flag></flag>").attr("id",x[0]).text(x[1]).appendTo(r)}else if(0===s.indexOf("m")){var O=s.split(":");$("<enemy></enemy>").attr("id",O[0]).attr("name",O[1]).attr("element",O[2]).attr("attack",O[3]).attr("func",O[4]).attr("drop",O[5]).text(O[6]).appendTo(d)}else if(0===s.indexOf("r")){var S=s.split(":");$("<result></result>").attr("id",S[0]).attr("name",S[1]).attr("level",S[2]).text(S[3]).appendTo(l)}else if(0===s.indexOf("w")){var k=s.split(":");$("<work></work>").attr("name",k[1]).attr("category",k[2]).attr("creator",k[3]).attr("url",k[4]?"//"+k[4]:"").appendTo(o)}else if(0===s.indexOf("@")){var A=s.substring(1).split(":");void 0===A[1]&&(A[1]=""),c[A[0]]=A[1]}}else _+=s+"\n"}),_+="\n",$("choices choice",e).each(function(t,e){var a=$("text p",e).text().trim().split("@"),s=$("destination",e).text();if("999"===s){var i="[";i+=a[0],i+="](X)\n"}else if("998"===s){i="[";i+=a[0],i+="](Q)\n"}else{i="[";i+=a[0],i+="](",i+=s,a[2]&&(i+=","+a[2]),a[1]&&(i+=' "'+a[1]+'"'),i+=")\n"}_+=i});var u=$("<scene></scene>\n").attr("id",c.id).text(_);void 0!==c.items&&u.attr("items",c.items),void 0!==c.flags&&u.attr("flags",c.flags),void 0!==c.enemies&&u.attr("enemies",c.enemies),void 0!==c.stars&&u.attr("stars",c.stars),void 0!==c.hp&&u.attr("hp",c.hp),void 0!==c.mp&&u.attr("mp",c.mp),void 0!==c.free1&&u.attr("free1",c.free1),void 0!==c.free2&&u.attr("free2",c.free2),void 0!==c.free3&&u.attr("free3",c.free3),void 0!==c.bgm&&u.attr("bgm",c.bgm),void 0!==c.se&&u.attr("se",c.se),void 0!==c.result&&u.attr("result",c.result),void 0!==c.end&&u.attr("end",c.end),u.appendTo(s)}),o.prependTo(s),l.prependTo(s),d.prependTo(s),r.prependTo(s),n.prependTo(s),i.prependTo(s),a++,a>=_.length)if(t)t(s);else{var p=vkbeautify.xml('<?xml version="1.0" encoding="utf-8"?>\n'+s.get(0).outerHTML),v=new Blob([p],{type:"application/octet-stream"}),g=document.createElement("a");g.href=window.URL.createObjectURL(v),g.download="scenario.xml",g.click()}else u.readAsText(_[a],"UTF-8")},_=$(this).get(0).files,u=new FileReader;$(u).on("load",c),u.readAsText(_[a],"UTF-8")})},backupData:function(t){$(this).click(function(){var e="",a=localStorage,s=$(t).val();if("all"===s)$.get(ROOT+"stext.xml").done(function(t){var i=[GLOBAL_SAVE_DATA_KEY];$("work[id]:not([unpublished])",t).each(function(t,e){i.push($(e).attr("id"))});for(var n=0;n<i.length;n++){var r=a[i[n]];r&&(e+=i[n]+"\n",e+=r+"\n")}Util.downloadSavedata(s,e)});else{if(e=a[s],!e)return void window.alert("データが存在しません！");Util.downloadSavedata(s,e)}})},restoreData:function(){$(this).change(function(){Util.restoreSaveData(this,function(){window.alert("リストアが完了しました。\r（起動している場合は）ゲーム画面をリロードしてください。")})})},nsAttr:function(t){var e=$(this).attr(t);if(void 0!==e)return e.replace(/\s+/g,"")}})})(jQuery);