!function(e){var t="stext/",a="common/",i="capture/",n,s,r={},o={},l={},c={},d,m,u="sorcerian_text",g,h,p,f=!1,v,_,b={male_name:["ボブ","デュエル","ゴルカス","ジェノバン","グーラン","ジャンビエ","グログス","コル","フロニアス","グーリム","カザミィ","ソロン","ゼン","ヴォル","マルス","レイザー","ミリオン","エリック","ジロ","ソード","ディル","ガタビア","ラウア","ハルビン","グドン","ジャミル","ディカン","ダート","タットワ5世","ディカン","ホド","ゲプラー","コクマー","グレアム","ロウポー","ラッツ","ソルト","ランブル","ネイル","ルシアン","ギム","チェイサー","ルワン","ゾーク","オルム","テュモー","バロン","カメロン","トード","グンダ","フラジオレ","ファン＝フレディ","ファネッサ3世","クリフト4世","クォール","ディオン","ホゼア","ロラッド","バルナ","ティゲロ","テト","ニフト","オーサー","ゲディス","レオン","アンドリュー","キリー","トーマス","エディ","ノーマス","ギルデン","ノーネーム","ユイター","デュオン","ペトス","フェリス","スラン","アルフレッド","ソクラム","アルモス","ログレック","ラルーゴ","キッド","ドレイク","ウォルトス","レスター","テリー","グラハン","ラドール","ウェステル","フェスタ","バンブー","ゲルフス","ドン・コサック","ベオグラード","ピエール","タルフ","エヴァン","ドゥール","バルガス","アーサー","ガッシュ","エルウッド","ヘルナー","エリック","ジャグラー","アラン","ロニアス","アスタル","ボルックス","ラドナー","ギルバレス","ジャレス","ルー","スズキ","ジロサ","サントリーニ","ルルイエ","コーラル","ボマード","ナルシス","マーヴァル","クール","ヨシュア","エヴァム","ジャンク","ボイド","ヘクター","デンキブラウン","バイアス","ブロイム","ディンギル","リグ","バド","ジード","ラルザス","ガイキナ","ロッド","ケイン","ルーミス","タジート","ブレイス","ディンクス","マーク","ホホホ","テシター","J.B","ジン","マック","リラ","ジバ","バーラン","ポジティル","ネガティル","ファルカス","ファウネス","ファルカス","チェン","パズス12世","タムタム","リーク・ディオン","タウラー","ラルディ","ノーマス","アドロン","ロカルノ","ゲラン","シュヴェーリン","ローラン","ウェッジ","アントロノフ","キム","ヤン","デフ","ミケロ","クール","ティエンルン","コウ","マルク","オーエン","トート","グート","マウアー","ザンダー","バルダ","キーリエ","マルス","セム","ターバ","グロス","クルトン","ザムル","エルフィン","グラハン","ガウェイン","アドル","ゴーバン","ドギ","ルタ","ダレス","ダルク＝ファクト","クーブラ＝カーン","ガルシウス","クロノス","カイロス","ディアルド","チッタ","カズン","ルイス","セネリー","ライネル","エス","カリー","ドレイク","ダニー","ドリー","ケイリス","ノートン","クラウド","ウォーリー","レイモンド","サザール","メテオロイド","ナッシュ","ルロイ","ライトル","カディアン","ブラウン","シュナイダー","セシル","グレンザー","ゴイル","ビル","グリメルム","ガルベス","ジルドバ","アレクシウスX世","ピエール","ジェラルド","ロベルト","エティス","アル＝ファルコ","ラシーン","ロデム","J.D.マックス","パーム","シド"],female_name:["エスター","クリスティ","アイリーン","フェルディナン","リタ","トーヤ","ノルン","ウィンディーネ","プリム","ピアナ","エメラーダ","エレア","エヴァ","リム","ビナー","ティファレト","ミラドゥ","パナシェ","ミモザ","リューズ","エレーナ","リーア","キアラ","オルアラ","クオレ","セーナ","リーザ","セリナ","リリィ","ピピ","ビヌス","アンナ","リュシエル","フィレン","カレン","エリン","ローラ","マーベラ","ジョセフィーヌ","アネリーナ","リオナ","ジョアンナ","レニッサ","ジェニス","グリンダ","マティナ","ローナ","コッキー","チェルシー","ネリス","アリーナ","フェリッサ","マリエル","ベララ","ジョゼフ","ニッカ","テキーラ","ソルティ","パイン","ウィズ","カンニバル","ミント","リーン","ミル","ディアンナ","レティア","サフィス","エミス","ヴァムリー","サリア","ナイジェス","ミューリア","エミリア","シャル","バーバラ","オビア","スチュアート","ベーラ","サマリーヌ","フィアネ","レナ","ソル","ネイラ","セレーネ","アルバ","ラン","ルー・パズス","シルフィ","ミレット","レフィーナ","モスマ","チブル","鈴鈴","明明","ティキ","サリア","ミュール","ダール","ミンナ","レーシャ","エレイア","レア","フィーナ","ジャネット","ナリス","ソチ","ポーラス","ロキア","フリージ","エスメレー","エレナ","アルティ","エビオラ","フィナ"],title:["武器屋の親父","ペンタウァの長老","トラベラーズインの宿主","人と上手に話したい","ペンタウァ近衛隊長","","タリスマンの見張り","瞑想中","砂漠の飯炊き","狂戦士","エレベーターの管理人","盗賊の頭領","暗き沼の魔法使い","ロマンシア国王","アゾルバ国王","ペンタウァ国王","蚕職人","妖精王","暗黒の魔導士","クイーンマリー号船長","キタブ・アル・アジフの持ち主","メデューサハンターの弟子","ファルコムマン","戦士の亡霊","海賊の子孫","いけにえの神官","東の村の村長","麻薬中毒者","ヴァネルバの王","銀の竪琴屋","近衛隊長","復讐の呪術師","ラフォーヌの森の管理人","リドニア王国の元兵士","姫の教育係","大魔王","紫ウニの王子","ベララの家族","時計塔の番人","時計塔の魔女","ナルキッソス号船長","ディンギル王国の3神官","バドティビラ工場の指揮官","シュメール国王","サンサーラの山賊","南村の村長","アイテム屋WIZの店主","旅の吟遊詩人","古代イスマリアの王","時の神殿の書記官","闇の王","ランドル村長","魔法学校の校長","魔法学校の用務員","マリオネットの王","ペンタウァの近衛兵","陽の中の闇人","赤毛の冒険者","光の王","イリアスンの執政官","魔の下僕","メデューサハンター","邪神教徒","邪神教々祖","砂漠の王","鍵の番人","ローデシア辺境司令官","宇宙からの訪問者","黒竜仙人","猿大聖","極楽寺の僧兵","ジャグラー族","迷宮建築の第一人者","フリース村の村長","ペンタウァ一の科学者アンド予言者","暴れザル","魔法学校の校長","人魚３姉妹の長女","マリオネットの王","探求の学徒","旅芸人の一座","猛獣使い","流れの傭兵","氷の魔女","パペッテの人形遣い","バーテンダー","宮仕えのシャーマン","薬草亭の主人","水門の管理人"],pc_init:[["FIGHTER","MALE",85,55,7,3,6,4],["FIGHTER","FEMALE",80,60,6,4,6,4],["WIZARD","MALE",55,85,4,8,5,3],["WIZARD","FEMALE",50,90,3,8,5,4],["DWARF","MALE",90,50,8,2,8,2],["DWARF","FEMALE",85,55,7,3,8,2],["ELF","MALE",65,75,4,6,5,5],["ELF","FEMALE",60,80,2,7,5,6]],magic:{HEAL:[0,0,0,1,0,1,0,"HPを15回復"],PEACE:[0,0,1,0,1,0,0,"MPを10回復"],CURE:[0,0,0,0,1,0,1,"毒回復"],MELT:[0,1,0,0,1,1,1,"凍結を回復"],"STONE-FLESH":[0,0,0,1,1,1,1,"石化を回復"],"UN-CURCE":[2,0,1,0,0,1,0,"呪いを回復"],"AIR-HAND":[1,0,1,0,1,0,1,"見えない拳の衝撃で、忘却を回復"],RESURRECT:[0,0,0,1,3,0,1,"HP/MP半分で復活（但し、冒険に一度だけ）"],"REDUCE-LIFE":[0,1,1,0,1,1,0,"体力を犠牲に（HP-25）、すべての状態異常を回復"],REJUVENATE:[0,2,0,1,0,0,1,"時の流れを巻き戻し（現在の判定をやり直し）"],PROTECT:[1,0,0,1,1,0,1,"HPダメージを半減"],"HOLY-WATER":[0,0,2,2,0,0,0,"MPダメージを半減"],"CHANGE-AIR":[1,0,0,1,1,1,0,"戦闘を回避（アイテムは得られない）"],"GIVE-VIGOR":[1,1,1,0,0,1,0,"敵の攻撃力が2倍＆取得アイテム2倍"],EXPLOSION:[0,1,0,1,0,1,2,"地属性の敵を全滅"],DELUGE:[4,0,0,0,0,1,0,"火属性の敵を全滅"],FREEZE:[0,2,0,0,0,1,2,"水属性の敵を全滅"],"DESTROY-A":[1,0,4,0,0,0,0,"風属性の敵を全滅"],"LIGHT-CROSS":[0,2,0,2,0,1,0,"霊属性の敵を全滅"],"NOILA-TEM":[1,1,1,1,1,1,1,"すべての属性の敵を全滅"]},global_items:{happy:{gi01:{name:"金の卵",desc:"月の欠片を5個所有した状態で冒険を開始"},gi02:{name:"ガラティーン",desc:"火星の欠片を5個所有した状態で冒険を開始"},gi03:{name:"五元素のマント",desc:"水星の欠片を5個所有した状態で冒険を開始"},gi04:{name:"アマゾンの剣",desc:"木星の欠片を5個所有した状態で冒険を開始"},gi05:{name:"幸福のコイン",desc:"金星の欠片を5個所有した状態で冒険を開始"},gi06:{name:"ムラサメブレード",desc:"土星の欠片を5個所有した状態で冒険を開始"},gi07:{name:"G・スレイヤー",desc:"太陽の欠片を5個所有した状態で冒険を開始"},gi08:{name:"水晶の剣",desc:"左サイコロが5以上の時、そのシーンでHPを1回復"},gi09:{name:"王様の杖",desc:"左サイコロが5以上の時、そのシーンでMPを1回復"},gi10:{name:"ブルーリボン",desc:"戦闘ダメージを1減算"},gi11:{name:"王家のダイヤモンド",desc:"罠ダメージを1減算"},gi12:{name:"不老長寿の水",desc:"冒険中に一度だけHPを半分回復できる"},gi13:{name:"タリスマン",desc:"冒険中に一度だけMPを半分回復できる"},gi14:{name:"鏡の盾",desc:"HPダメージを1減算"},gi15:{name:"銀の竪琴",desc:"MPダメージを1減算"},gi16:{name:"パンドラの箱",desc:"右サイコロが4以上の時、戦闘回避が可能"},gi17:{name:"魔法の絨毯",desc:"右サイコロが5以上の時、罠回避"},gi18:{name:"中和剤",desc:"毒耐性"},gi19:{name:"聖水",desc:"呪い耐性"},gi20:{name:"チルドの実",desc:"凍結耐性"},gi21:{name:"銀のハーモニカ",desc:"石化耐性"},gi22:{name:"真実の鏡",desc:"忘却耐性"},gi23:{name:"D・スレイヤー",desc:"すべての星を1個所有した状態で冒険を開始"}},bad:{bgi01:{name:"塩酸",desc:"シーン毎にダイス合計が5未満でHPを1減算、5以上でMPを1回復"},bgi02:{name:"紅玉",desc:"シーン毎にダイス合計が5未満でMPを1減算、5以上でHPを1回復"},bgi03:{name:"血まみれの斧",desc:"冒険開始時に呪い。解除で3回まで星消費せず魔法発動可"},bgi04:{name:"トリカブト",desc:"冒険開始時に毒。但し、解除までシーン毎にMPを1回復"},bgi05:{name:"ギャルのパンティー",desc:"冒険開始時に忘却。但し、解除までSTR/INT0でない方を10"}}}},x={random:function(e,t){return Math.floor(Math.random()*(t-e+1))+e},minMaxGuard:function(e){return e<0?0:e>10?10:e},randomArray:function(e){return e[Math.floor(Math.random()*e.length)]},pushUnique:function(e,t){return-1===e.indexOf(t)&&(e.push(t),!0)},shiftUnique:function(e,t){return e.filter(function(e){return e!==t})},ltrim:function(e){return e.substr(1)},saveStorage:function(){localStorage[n]=JSON.stringify(d)},loadStorage:function(){d=JSON.parse(localStorage[n])},saveStorageGlobal:function(){localStorage.sorcerian_text=JSON.stringify(m)},loadStorageGlobal:function(){m=JSON.parse(localStorage.sorcerian_text)},initSavedata:function(){var e=this.randomArray(b.pc_init),t=this.random(e[2],e[2]+10),a=this.random(e[3],e[3]+10),i=this.minMaxGuard(this.random(e[4],e[4]+2)),s=this.minMaxGuard(this.random(e[5],e[5]+2)),r=this.minMaxGuard(this.random(e[6],e[6]+2)),o=this.minMaxGuard(this.random(e[7],e[7]+2)),l=localStorage[n],c="";l&&(c=(l=JSON.parse(l)).memos),d={chara:{name:"MALE"===e[1]?this.randomArray(b.male_name):this.randomArray(b.female_name),title:this.randomArray(b.title),race:e[0],sex:e[1],age:this.randomArray(["YOUNG","ADULT","OLD"]),state:"",hp_m:t,hp:t,mp_m:a,mp:a,str_i:i,str:i,int_i:s,int:s,dex_i:r,dex:r,krm_i:o,krm:o,free1:0,free2:0},stars:[0,0,0,0,0,0,0],items:[],flags:[],memos:c,scene:0,ellapsed_scene:0,bgm:"",bonus:this.randomArray(m.items),isEnded:!1},this.saveStorage()},initGlobalSaveData:function(){m={items:[],results:{},bgm:!0,panel:!0},this.saveStorageGlobal("sorcerian_text")},validateScenario:function(){var t=[],a=[],i=function(e,a,i){if(void 0!==a&&""!==a){var n=a.trim().split(","),s=Object.keys(e);n.forEach(function(e){e=e.replace("-",""),-1===s.indexOf(e)&&t.push({scene_id:i,message:e.startsWith("i")?"アイテムコード"+e+"が未登録です。":e.startsWith("f")?"フラグコード"+e+"が未登録です。":e.startsWith("m")?"敵コード"+e+"が未登録です。":"実績コード"+e+"が未登録です。"})})}};return e("scene",s).each(function(n,s){var d=e(s);-1===a.indexOf(d.attr("id"))?a.push(d.attr("id")):t.push({scene_id:d.attr("id"),message:"scene－idが重複しています。"}),i(l,d.attr("items"),d.attr("id")),i(r,d.attr("flags"),d.attr("id")),i(o,d.attr("enemies"),d.attr("id")),i(c,d.attr("result"),d.attr("id"))}),t},canUseMagic:function(e){return!(d.stars[0]<e[0]||d.stars[1]<e[1]||d.stars[2]<e[2]||d.stars[3]<e[3]||d.stars[4]<e[4]||d.stars[5]<e[5]||d.stars[6]<e[6])},updateItems:function(e){if(e){for(var t=d.items,e=e.split(","),a=0;a<e.length;a++){var i=e[a].trim();0===i.indexOf("-")?(i=this.ltrim(i),t=this.shiftUnique(t,i)):this.pushUnique(t,i)}d.items=t}},updateFlags:function(e){if(e)for(var t=d.flags,e=e.split(","),a=0;a<e.length;a++){var i=e[a].trim();this.pushUnique(t,i)}},updateResults:function(e){if(e){void 0===m.results&&(m.results={});var t=m.results;void 0===t[n]&&0!==n.indexOf("<")&&(t[n]=[]),!0===this.pushUnique(t[n],e)&&this.toast("実績「"+c[e].name+"」を獲得"),this.saveStorageGlobal()}},toast:function(t){e(".toast").remove(),e("body").append('<div class="toast">'+t+"</div>");var a=e("body").width()/2-e(".toast").outerWidth()/2;e(".toast").css("left",a).hide().fadeIn("fast"),setTimeout(function(){e(".toast").fadeOut("slow",function(){e(this).remove()})},4e3)},cube:function(e){void 0===e&&(e=1);for(var t="",a=0;a<e;a++)t+='<img src="stext/common/cube'+this.random(1,6)+'.png" class="dice" />';return t},dropItem:function(e){if(!e)return"";var t={"地":["木星","火星","土星","－","－"],"火":["火星","太陽","火星","－","－"],"水":["水星","月","金星","－","－"],"風":["金星","水星","月","－","－"],"霊":["土星","太陽","月","－","－"]};return this.randomArray(t[e])},selectFunc:function(e){return x.randomArray(e.split(",")).trim()},deltaStatus:function(e){switch(e){case"frozen":var t="すべてのステータスを-2",a=-2,i=-2,n=-2,s=-2;break;case"stone":var t="すべてのステータスを-1（30scene経過で死亡）",a=-1,i=-1,n=-1,s=-1;break;case"forget":var t="STR／INTのうち、高い方が0に（20scene経過で解除）";if(d.chara.str<d.chara.int)var a=0,i=-1*d.chara.int;else var a=-1*d.chara.str,i=0;var n=0,s=0;break;case"poison":var t="シーン経過ごとにHPを-1",a=0,i=0,n=0,s=0;break;case"curse":var t="魔法の利用が不可（UN-CURSEを除く）",a=0,i=0,n=0,s=0;break;default:var t="－",a=0,i=0,n=0,s=0}return[a,i,n,s,t]},getBonusItem:function(e){return 0===e.indexOf("bgi")?b.global_items.bad[e]:b.global_items.happy[e]},initScenario:function(){x.initSavedata(),x.initDialog(),x.createScene(0),history.pushState(0,"Scene 0")},initDialog:function(){e.get(t+a+"dialog.html").done(function(i){if(h=e(i),e("#name",h).text(d.chara.name),e("#title",h).text(d.chara.title),e("#race",h).text(d.chara.race),e("#sex",h).text(d.chara.sex),e("#hp_m",h).text(d.chara.hp_m),e("#mp_m",h).text(d.chara.mp_m),e("#str_i",h).text(d.chara.str_i),e("#int_i",h).text(d.chara.int_i),e("#dex_i",h).text(d.chara.dex_i),e("#krm_i",h).text(d.chara.krm_i),e("#age",h).text(d.chara.age),e("#chara_face",h).attr("src",t+a+String(d.chara.sex).toLowerCase()+"_"+String(d.chara.age).toLowerCase()+"_"+String(d.chara.race).toLowerCase()+".png"),d.bonus){var n=x.getBonusItem(d.bonus);e("#bonus",h).text(n.desc+"（"+n.name+"）")}h.insertBefore(g).hide()}),e.get(t+a+"dialog_list.html").done(function(i){p=e(i);for(var n=0;n<24;n++)num=n<10?"0"+n:n,num="gi"+num,-1!==e.inArray(num,m.items)?e("#"+num,p).attr("src",t+a+num+".png").attr("class","bonus_item"):e("#"+num,p).attr("src",t+a+"gi99.png");for(var n=1;n<6;n++)num=n<10?"0"+n:n,num="bgi"+num,-1!==e.inArray(num,m.items)?e("#"+num,p).attr("src",t+a+num+".png").attr("class","bonus_item"):e("#"+num,p).attr("src",t+a+"gi99.png")})},createDialog:function(){e("#hp",h).attr("value",d.chara.hp),e("#mp",h).attr("value",d.chara.mp),e('[name="state"]',h).each(function(){var t;e(this).attr("value")===d.chara.state?e(this).attr("checked","checked"):e(this).removeAttr("checked")}),e("#ellapsed_scene",h).text(d.ellapsed_scene+" scene"),e("#free1",h).attr("value",d.chara.free1),e("#free2",h).attr("value",d.chara.free2),e("#str",h).attr("value",d.chara.str),e("#int",h).attr("value",d.chara.int),e("#dex",h).attr("value",d.chara.dex),e("#krm",h).attr("value",d.chara.krm),e("#s_mon",h).attr("value",d.stars[0]),e("#s_tue",h).attr("value",d.stars[1]),e("#s_wed",h).attr("value",d.stars[2]),e("#s_thu",h).attr("value",d.stars[3]),e("#s_fri",h).attr("value",d.stars[4]),e("#s_sat",h).attr("value",d.stars[5]),e("#s_sun",h).attr("value",d.stars[6]);var t=this.deltaStatus(e('[name="state"][checked="checked"]',h).attr("value"));e("#str_d",h).text("（"+t[0]+"）"),e("#int_d",h).text("（"+t[1]+"）"),e("#dex_d",h).text("（"+t[2]+"）"),e("#krm_d",h).text("（"+t[3]+"）"),e("#state_desc",h).text(t[4]),e("#memos",h).text(d.memos);var a=e("#magic",h);for(var i in a.empty(),b.magic){var n=b.magic[i],s=e("<option></option>").attr("value",i).attr("title",n[8]).text(i+"（"+n[7]+"）");x.canUseMagic(n)||s.attr("disabled","disabled"),s.appendTo(a)}for(var o=[],c=0;c<d.items.length;c++){var m=l[d.items[c]];o.push("・"+m.name+"（"+m.desc+"）")}e("#items",h).text(o.join("\r"));var u=e("#flags",h);u.empty();for(var c=0;c<d.flags.length;c++){var p="<option ";c==d.flags.length-1&&(p+="selected"),p+=">・"+r[d.flags[c]]+"</option>",u.append(p)}h.slideDown(500),e("#status_change").val("Equipment"),e("#status_basic").show(),e("#status_equip").hide(),g.slideUp(500)},endScenario:function(i){if(i){var s,r,o;switch(e('<p><a href="#" onclick="location.reload(true)" class="scenebtn">最初から冒険に挑戦する</a></p>').insertBefore(e("#cubes",g)),d.isEnded=!0,localStorage.removeItem(n),i){case"happy":s=x.randomArray(Object.keys(b.global_items.happy)),r=b.global_items.happy[s],o=t+n+"/bgm_happy.mp3";break;case"bad":x.random(0,100)<20&&(s=x.randomArray(Object.keys(b.global_items.bad)),r=b.global_items.bad[s]),o=t+n+"/bgm_bad.mp3"}v&&v.pause(),(v=new Audio(o)).loop=!0,m.bgm&&v.play(),s&&(x.pushUnique(m.items,s),x.saveStorageGlobal(),e.get("stext/common/dialog_bonus.html").then(function(i){var n=e(i);e("#bonus_img",n).attr("src",t+a+s+".png"),e("#bonus_item",n).text(r.name),e("#bonus_item_desc",n).text(r.desc),setTimeout(function(){e.zoombox.html(n.html(),{width:480,height:200})},2e3)}))}},canSceneMove:function(t){var a;return 0!=e('scene[id="'+t+'"][allowMove]',s).length},playBgm:function(e){v&&v.pause(),(v=new Audio(e)).loop=!0,m.bgm&&v.play()},createScene:function(r){if(d.isEnded)location.reload(!0);else{e(window).scrollTop(0);var l=e('scene[id="'+r+'"]',s),c=l.text(),u;if(c=(c=c.replace(/%(blue|red|purple)%/gi,'&nbsp;<span style="color:$1">')).replace(/%\/%/gi,"</span>&nbsp;"),g.html(c),g.markdown(),e('<h5 id="scenario_title"><img id="ctrl_show" src="stext/common/ctrl_show.png" /></a> '+e("scenario",s).attr("title")+"【"+r+'】</span></h5><div id="control_panel"><img id="ctrl_home" src="'+t+a+'ctrl_home.png" /></a>　<img id="status_open" src="'+t+a+'ctrl_status.png" />　<img id="item_list" src="'+t+a+'ctrl_bonus.png" />　<img id="audio_onoff" src="'+t+a+"ctrl_audio_"+(m.bgm?"on":"off")+'.png" />　<img id="ctrl_reload" src="'+t+a+'ctrl_results.png" />　<img id="ctrl_help" src="'+t+a+'ctrl_help.png" /></div>').prependTo(g),m.panel||e("#control_panel").hide(),console.log("debug:"+f),f&&(e('<div id="debug_panel"><form><label>Scene：<input id="debug_id" type="text" size="5" /></label>　<label>Items：<input id="debug_items" type="text" size="7" /></label>　<label>Flags：<input id="debug_flags" type="text" size="7" /></label>　<input id="debug_reload" type="button" value="Reload" /></form></div>').prependTo(g),e("#debug_panel #debug_id").val(r),e("#debug_panel #debug_items").val(d.items.join(",")),e("#debug_panel #debug_flags").val(d.flags.join(",")),e("#debug_panel #debug_reload").click(function(t){var a=e("#debug_panel #debug_items").val().trim(),i=e("#debug_panel #debug_flags").val().trim();""!==a&&(d.items=a.split(",")),""!==i&&(d.flags=i.split(",")),x.saveStorage(),x.createScene(e("#debug_panel #debug_id").val())})),g.append('<center id="cubes">'+x.cube(2)+"</center>"),e("a",g).addClass("scenebtn"),e('a[href="X"]',g).removeClass("scenebtn").addClass("scene_move").text("移動する").before('<input type="number" id="toscene" class="scene_move" />').add("#toscene").wrapAll("<div></div>"),e("a:has(img)",g).each(function(a,s){var r=t+n+"/"+i+e(s).attr("href");e(s).attr("href",r).removeClass("scenebtn").addClass("scenepic").find("img").attr("src",r)}),e("a.scenepic").zoombox(),l.attr("enemies")){for(var h=e('<table class="enemy">'),p=l.attr("enemies").split(","),_=0;_<p.length;_++){var y=o[p[_]],S="<tr><th>"+y.name;y.element&&(S+="（"+y.element+"）"),S+="</th><td>"+y.attack+"</td><td>",y.func&&(S+=x.selectFunc(y.func)),S+="</td><td>"+this.dropItem(y.element),S+="</td><td>"+y.desc+"</td></tr>",h.append(S)}h.insertBefore("a.scenebtn:first")}var w=d.flags,k=d.items,E;e("a[title]",g).hide(),e('a[title^="-"]',g).show();for(var _=0;_<w.length;_++)e('a[title="'+w[_]+'"]',g).show(),e('a[title="-'+w[_]+'"]',g).hide();e('a[title*=","]',g).each(function(t,a){var i=e(a).attr("title");if(0!==i.indexOf("-")){for(var n=!0,s=i.split(","),r=0;r<s.length;r++)if(-1===w.indexOf(s[r].trim())){n=!1;break}n&&e(a).show()}else{for(var o=!0,s=i.substring(1).split(","),r=0;r<s.length;r++)if(-1===w.indexOf(s[r].trim())){o=!1;break}o&&e(a).hide()}});for(var _=0;_<k.length;_++)e('a[title="'+k[_]+'"]',g).show();for(var A in b.magic)x.canUseMagic(b.magic[A])&&e('a[title="m'+A+'"]',g).show();var M="",T=l.attr("bgm");M=d.bgm?"/bgm_"+d.bgm+".mp3":"/bgm.mp3",void 0!==T&&(M=""===T?"/bgm.mp3":"/bgm_"+T+".mp3");var O=t+n+M;if((!v||v&&void 0!==T&&T!==d.bgm)&&(x.playBgm(O),d.bgm=void 0===T?"":T),l.attr("se")){var L=new Audio(t+n+"/"+l.attr("se")+".mp3");L.loop=!1,L.play()}x.updateItems(l.attr("items")),x.updateFlags(l.attr("flags")),x.updateResults(l.attr("result")),d.scene=r,d.ellapsed_scene++,x.saveStorage(),x.endScenario(l.attr("end")),console.log(d)}}};e.fn.extend({startGame:function(i,u){n=i,g=this,u||(u=!1),f=u,g.on("click","a.scenebtn",function(t){var a=e(this).attr("href");history.pushState(a,"Scene "+a),x.createScene(a),t.preventDefault()}),g.on("click","a.scene_move",function(t){var a=e("#toscene").val();x.canSceneMove(a)?(history.pushState(a,"Scene "+a),x.createScene(a)):window.alert("その番号には移動できません。"),t.preventDefault()});var _=new Audio(t+a+"dice.mp3"),y,S=function(){y++,e("#cubes").html(x.cube(2)),y>20||setTimeout(S,50)};g.on("click","#cubes",function(e){_.play(),y=1,S(this)}),g.on("click","#status_open",function(e){x.createDialog(),e.preventDefault()}),g.on("contextmenu",function(e){x.createDialog(),e.preventDefault()}),g.on("click","#audio_onoff",function(i){v&&(m.bgm?(m.bgm=!1,e(this).attr("src",t+a+"ctrl_audio_off.png"),v.pause()):(m.bgm=!0,e(this).attr("src",t+a+"ctrl_audio_on.png"),v.play()),x.saveStorageGlobal())}),e(document).on("click","#dialog_body #status_save",function(t){d.chara.hp=e("#dialog_body #hp").val(),d.chara.mp=e("#dialog_body #mp").val(),d.chara.free1=e("#dialog_body #free1").val(),d.chara.free2=e("#dialog_body #free2").val(),d.chara.str=e("#dialog_body #str").val(),d.chara.int=e("#dialog_body #int").val(),d.chara.dex=e("#dialog_body #dex").val(),d.chara.krm=e("#dialog_body #krm").val(),d.chara.state=e('#dialog_body [name="state"]:checked').val(),d.stars[0]=e("#dialog_body #s_mon").val(),d.stars[1]=e("#dialog_body #s_tue").val(),d.stars[2]=e("#dialog_body #s_wed").val(),d.stars[3]=e("#dialog_body #s_thu").val(),d.stars[4]=e("#dialog_body #s_fri").val(),d.stars[5]=e("#dialog_body #s_sat").val(),d.stars[6]=e("#dialog_body #s_sun").val(),d.memos=e("#dialog_body #memos").val(),x.saveStorage(),h.slideUp(500),g.slideDown(500)}),e(document).on("click","#dialog_body #status_close",function(e){h.slideUp(500),g.slideDown(500)}),e(document).on("click",'#dialog_body [name="state"]',function(t){var a=x.deltaStatus(e(this).val());e("#dialog_body #str_d").text("（"+a[0]+"）"),e("#dialog_body #int_d").text("（"+a[1]+"）"),e("#dialog_body #dex_d").text("（"+a[2]+"）"),e("#dialog_body #krm_d").text("（"+a[3]+"）"),e("#dialog_body #state_desc").text(a[4])});var w=function(t,a,i){if(t[a]>0){var n=e("#dialog_body "+i).val();e("#dialog_body "+i).val(n-t[a])}};e(document).on("click","#dialog_body #magic_run",function(t){t.preventDefault();var a=b.magic[e("#dialog_body #magic option:selected").val()];a&&(e("#dialog_body #s_mon").val()<a[0]||e("#dialog_body #s_tue").val()<a[1]||e("#dialog_body #s_wed").val()<a[2]||e("#dialog_body #s_thu").val()<a[3]||e("#dialog_body #s_fri").val()<a[4]||e("#dialog_body #s_sat").val()<a[5]||e("#dialog_body #s_sun").val()<a[6]?window.alert("星が不足しているため、魔法を発動できません！"):(w(a,0,"#s_mon"),w(a,1,"#s_tue"),w(a,2,"#s_wed"),w(a,3,"#s_thu"),w(a,4,"#s_fri"),w(a,5,"#s_sat"),w(a,6,"#s_sun")))}),e(document).on("click","#dialog_body #status_change",function(t){var a;"none"===e("#status_basic").css("display")?(e("#status_change").val("Equipment"),e("#status_basic").show(),e("#status_equip").hide()):(e("#status_change").val("Basic Status"),e("#status_basic").hide(),e("#status_equip").show())}),e(document).on("click","#dialog_body .spinner_up",function(t){var a=e(this).prev();a.val(Number(a.val())+1)}),e(document).on("click","#dialog_body .spinner_down",function(t){var a=e(this).next();a.val(Number(a.val())-1)}),g.on("click","#item_list",function(t){e.zoombox.html(p.html(),{width:650,height:450})}),e(document).on("click","#dialog_list img.bonus_item",function(t){var a=t.target.id,i;i=a.startsWith("gi")?b.global_items.happy[a]:b.global_items.bad[a],e("#dialog_list #bonus_msg").text(i.name+"（"+i.desc+"）")}),g.on("click","#ctrl_home",function(e){location.href="http://www.web-deli.com/sorcerian/next/stext.aspx"}),g.on("click","#ctrl_reload",function(i){e.get(t+a+"dialog_result.html").done(function(t){var a=0,i=0,s=["","ノーマル","ブロンズ","シルバー","ゴールド","プラチナ"],r=e(t);Object.keys(c).forEach(function(t){if(a++,void 0!==m.results[n]&&-1!==m.results[n].indexOf(t)){i++;var o='<tr><td><img src="stext/common/trophy'+c[t].level+'.png" title="'+s[c[t].level]+'" /></td><td><h3>'+c[t].name+"（Lv."+c[t].level+"）</h3><p>"+c[t].desc+"</p></td></tr>"}else var o='<tr><td><img src="stext/common/trophy0.png" title="実績未達" /></td><td><h3>???????????????</h3><p>???????????????</p></td></tr>';e(".result_list",r).append(o)});var o=(i/a*100).toFixed(1);e("#result_rate",r).text("Rate:"+o+"%"),e.zoombox.html(r.html(),{width:480,height:200})})}),g.on("click","#ctrl_help",function(e){window.open("http://d.hatena.ne.jp/sorcerian/20171220")}),g.on("click","#scenario_title",function(t){var a;"none"===e("#control_panel").css("display")?(e("#control_panel").slideDown(),m.panel=!0):(e("#control_panel").slideUp(),m.panel=!1),x.saveStorageGlobal()}),e(window).on("popstate",function(e){x.createScene(e.originalEvent.state)}),e(document).on("touchstart",".zoombox_mask",function(){m.bgm&&v.paused&&v.play()}),localStorage.sorcerian_text?x.loadStorageGlobal():x.initGlobalSaveData(),e.zoombox.open(t+a+"title.png",{duration:400});var k=function(t){for(var a in s=t,b.magic){for(var i=b.magic[a],m="",u=["月","火","水","木","金","土","太"],h=0;h<7;h++)i[h]>0&&(m+=u[h]+i[h]+" ");i.push(m)}if(r={},e("flags > flag",s).each(function(){r[e(this).attr("id")]=e(this).text().trim()}),o={},e("enemies > enemy",s).each(function(){o[e(this).attr("id")]={name:e(this).attr("name"),element:e(this).attr("element"),attack:e(this).attr("attack"),func:e(this).attr("func"),desc:e(this).text()}}),l={},e("items > item",s).each(function(){l[e(this).attr("id")]={name:e(this).attr("name"),desc:e(this).text().trim()}}),c={},e("results > result",s).each(function(){c[e(this).attr("id")]={name:e(this).attr("name"),level:e(this).attr("level"),desc:e(this).text().trim()}}),!0===f){var p=x.validateScenario();if(console.log("検証結果"+p),0!==p.length){var v="<h3>scenario.xmlでエラーが検出されました。</h3>";return v+='<ul class="errorlist">',p.forEach(function(e){v+="<li>Scene "+e.scene_id+": "+e.message+"</li>"}),v+="</ul>",void g.html(v)}}if(localStorage[n]&&confirm("以前のデータが残っています。\r続きから開始しますか？")){x.loadStorage(),x.initDialog(),d.ellapsed_scene--;var _=d.scene;return x.createScene(_),void history.pushState(_,"Scene "+_)}x.initScenario(),window.alert("キャラが新規作成されました。\rステータスダイアログは画面右クリックで開くことができます。")};if(0===(n=n.trim()).indexOf("<")){var E=e(n);n="playground",k(E)}else e.get(t+n+"/scenario.xml").done(k).fail(function(e,t,a){throw new Error("scenario code is invalid.")})},gbat2stext:function(t){e(this).change(function(a){var i=0,n=e('<scenario xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://www.web-deli.com/sorcerian/next/stext/common/sgml.xsd">\n</scenario>'),s=e("<items>\n</items>"),r=e("<flags>\n</flags>"),o=e("<enemies>\n</enemies>"),l=e("<results>\n</results>"),c=e("<license>\n</license>"),d=function(a){var d=e(this.result),g=e("title",d).text().trim().split("@");if(n.attr("title")||(n.attr("title",g[0]),n.attr("author",g[1])),e("section",d).each(function(t,a){var i=!1,d={};d.id=Number(e("number",a).text()),1===d.id&&(d.id=0);var m="\n";e("> text p",a).each(function(t,a){var n=e(a).text();if("@@"===n.trim())return i=!i,!0;if(i){if(!n)return!0;if(0===n.indexOf("i")){var u=n.split(":");e("<item></item>").attr("id",u[0]).attr("name",u[1]).text(u[2]).appendTo(s)}else if(0===n.indexOf("f")){var g=n.split(":");e("<flag></flag>").attr("id",g[0]).text(g[1]).appendTo(r)}else if(0===n.indexOf("m")){var h=n.split(":");e("<enemy></enemy>").attr("id",h[0]).attr("name",h[1]).attr("element",h[2]).attr("attack",h[3]).attr("func",h[4]).text(h[5]).appendTo(o)}else if(0===n.indexOf("r")){var p=n.split(":");e("<result></result>").attr("id",p[0]).attr("name",p[1]).attr("level",p[2]).text(p[3]).appendTo(l)}else if(0===n.indexOf("w")){var f=n.split(":");e("<work></work>").attr("name",f[1]).attr("category",f[2]).attr("creator",f[3]).attr("url",f[4]).appendTo(c)}else if(0===n.indexOf("@")){var v=n.substring(1).split(":");d[v[0]]=v[1]}}else m+=n+"\n"}),m+="\n",e("choices choice",a).each(function(t,a){var i=e("text p",a).text().trim().split("@"),n=e("destination",a).text();if("999"===n)var s="[](X)\n";else{var s="[";s+=i[0],s+="](",s+=n,i[1]&&(s+=' "'+i[1]+'"'),s+=")\n"}m+=s});var u=e("<scene></scene>\n").attr("id",d.id).text(m);d.items&&u.attr("items",d.items),d.flags&&u.attr("flags",d.flags),d.enemies&&u.attr("enemies",d.enemies),d.bgm&&u.attr("bgm",d.bgm),d.se&&u.attr("se",d.se),d.allowMove&&u.attr("allowMove",d.allowMove),d.result&&u.attr("result",d.result),d.end&&u.attr("end",d.end),u.appendTo(n)}),c.prependTo(n),l.prependTo(n),o.prependTo(n),r.prependTo(n),s.prependTo(n),++i>=m.length)if(t)t(n);else{var h='<?xml version="1.0" encoding="utf-8"?>\n'+n.get(0).outerHTML,p=new Blob([h],{type:"application/octet-stream"}),f=document.createElement("a");f.href=window.URL.createObjectURL(p),f.download="scenario.xml",f.click()}else u.readAsText(m[i],"UTF-8")},m=e(this).get(0).files,u=new FileReader;e(u).on("load",d),u.readAsText(m[i],"UTF-8")})}})}(jQuery);