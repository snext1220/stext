!function(e){var t='stext/',a='common/',n='capture/',i,r,s={},o={},l={},c,d,m='sorcerian_text',g,u,h,p=!1,f,_,v={male_name:['ボブ','デュエル','ゴルカス','ジェノバン','グーラン','ジャンビエ','グログス','コル','フロニアス','グーリム','カザミィ','ソロン','ゼン','ヴォル','マルス','レイザー','ミリオン','エリック','ジロ','ソード','ディル','ガタビア','ラウア','ハルビン','グドン','ジャミル','ディカン','ダート','タットワ5世','ディカン','ホド','ゲプラー','コクマー','グレアム','ロウポー','ラッツ','ソルト','ランブル','ネイル','ルシアン','ギム','チェイサー','ルワン','ゾーク','オルム','テュモー','バロン','カメロン','トード','グンダ','フラジオレ','ファン＝フレディ','ファネッサ3世','クリフト4世','クォール','ディオン','ホゼア','ロラッド','バルナ','ティゲロ','テト','ニフト','オーサー','ゲディス','レオン','アンドリュー','キリー','トーマス','エディ','ノーマス','ギルデン','ノーネーム','ユイター','デュオン','ペトス','フェリス','スラン','アルフレッド','ソクラム','アルモス','ログレック','ラルーゴ','キッド','ドレイク','ウォルトス','レスター','テリー','グラハン','ラドール','ウェステル','フェスタ','バンブー','ゲルフス','ドン・コサック','ベオグラード','ピエール','タルフ','エヴァン','ドゥール','バルガス','アーサー','ガッシュ','エルウッド','ヘルナー','エリック','ジャグラー','アラン','ロニアス','アスタル','ボルックス','ラドナー','ギルバレス','ジャレス','ルー','スズキ','ジロサ','サントリーニ','ルルイエ','コーラル','ボマード','ナルシス','マーヴァル','クール','ヨシュア','エヴァム','ジャンク','ボイド','ヘクター','デンキブラウン','バイアス','ブロイム','ディンギル','リグ','バド','ジード','ラルザス','ガイキナ','ロッド','ケイン','ルーミス','タジート','ブレイス','ディンクス','マーク','ホホホ','テシター','J.B','ジン','マック','リラ','ジバ','バーラン','ポジティル','ネガティル','ファルカス','ファウネス','ファルカス','チェン','パズス12世','タムタム','リーク・ディオン','タウラー','ラルディ','ノーマス','アドロン','ロカルノ','ゲラン','シュヴェーリン','ローラン','ウェッジ','アントロノフ','キム','ヤン','デフ','ミケロ','クール','ティエンルン','コウ','マルク','オーエン','トート','グート','マウアー','ザンダー','バルダ','キーリエ','マルス','セム','ターバ','グロス','クルトン','ザムル','エルフィン','グラハン','ガウェイン','アドル','ゴーバン','ドギ','ルタ','ダレス','ダルク＝ファクト','クーブラ＝カーン','ガルシウス','クロノス','カイロス','ディアルド','チッタ','カズン','ルイス','セネリー','ライネル','エス','カリー','ドレイク','ダニー','ドリー','ケイリス','ノートン','クラウド','ウォーリー','レイモンド','サザール','メテオロイド','ナッシュ','ルロイ','ライトル','カディアン','ブラウン','シュナイダー','セシル','グレンザー','ゴイル','ビル','グリメルム','ガルベス','ジルドバ','アレクシウスX世','ピエール','ジェラルド','ロベルト','エティス','アル＝ファルコ','ラシーン','ロデム','J.D.マックス','パーム','シド'],female_name:['エスター','クリスティ','アイリーン','フェルディナン','リタ','トーヤ','ノルン','ウィンディーネ','プリム','ピアナ','エメラーダ','エレア','エヴァ','リム','ビナー','ティファレト','ミラドゥ','パナシェ','ミモザ','リューズ','エレーナ','リーア','キアラ','オルアラ','クオレ','セーナ','リーザ','セリナ','リリィ','ピピ','ビヌス','アンナ','リュシエル','フィレン','カレン','エリン','ローラ','マーベラ','ジョセフィーヌ','アネリーナ','リオナ','ジョアンナ','レニッサ','ジェニス','グリンダ','マティナ','ローナ','コッキー','チェルシー','ネリス','アリーナ','フェリッサ','マリエル','ベララ','ジョゼフ','ニッカ','テキーラ','ソルティ','パイン','ウィズ','カンニバル','ミント','リーン','ミル','ディアンナ','レティア','サフィス','エミス','ヴァムリー','サリア','ナイジェス','ミューリア','エミリア','シャル','バーバラ','オビア','スチュアート','ベーラ','サマリーヌ','フィアネ','レナ','ソル','ネイラ','セレーネ','アルバ','ラン','ルー・パズス','シルフィ','ミレット','レフィーナ','モスマ','チブル','鈴鈴','明明','ティキ','サリア','ミュール','ダール','ミンナ','レーシャ','エレイア','レア','フィーナ','ジャネット','ナリス','ソチ','ポーラス','ロキア','フリージ','エスメレー','エレナ','アルティ','エビオラ','フィナ'],title:['武器屋の親父','ペンタウァの長老','トラベラーズインの宿主','人と上手に話したい','ペンタウァ近衛隊長','','タリスマンの見張り','瞑想中','砂漠の飯炊き','狂戦士','エレベーターの管理人','盗賊の頭領','暗き沼の魔法使い','ロマンシア国王','アゾルバ国王','ペンタウァ国王','蚕職人','妖精王','暗黒の魔導士','クイーンマリー号船長','キタブ・アル・アジフの持ち主','メデューサハンターの弟子','ファルコムマン','戦士の亡霊','海賊の子孫','いけにえの神官','東の村の村長','麻薬中毒者','ヴァネルバの王','銀の竪琴屋','近衛隊長','復讐の呪術師','ラフォーヌの森の管理人','リドニア王国の元兵士','姫の教育係','大魔王','紫ウニの王子','ベララの家族','時計塔の番人','時計塔の魔女','ナルキッソス号船長','ディンギル王国の3神官','バドティビラ工場の指揮官','シュメール国王','サンサーラの山賊','南村の村長','アイテム屋WIZの店主','旅の吟遊詩人','古代イスマリアの王','時の神殿の書記官','闇の王','ランドル村長','魔法学校の校長','魔法学校の用務員','マリオネットの王','ペンタウァの近衛兵','陽の中の闇人','赤毛の冒険者','光の王','イリアスンの執政官','魔の下僕','メデューサハンター','邪神教徒','邪神教々祖','砂漠の王','鍵の番人','ローデシア辺境司令官','宇宙からの訪問者','黒竜仙人','猿大聖','極楽寺の僧兵','ジャグラー族','迷宮建築の第一人者','フリース村の村長','ペンタウァ一の科学者アンド予言者','暴れザル','魔法学校の校長','人魚３姉妹の長女','マリオネットの王','探求の学徒','旅芸人の一座','猛獣使い','流れの傭兵','氷の魔女','パペッテの人形遣い','バーテンダー','宮仕えのシャーマン','薬草亭の主人','水門の管理人'],pc_init:[['FIGHTER','MALE',85,55,7,3,6,4],['FIGHTER','FEMALE',80,60,6,4,6,4],['WIZARD','MALE',55,85,4,8,5,3],['WIZARD','FEMALE',50,90,3,8,5,4],['DWARF','MALE',90,50,8,2,8,2],['DWARF','FEMALE',85,55,7,3,8,2],['ELF','MALE',65,75,4,6,5,5],['ELF','FEMALE',60,80,2,7,5,6]],magic:{HEAL:[0,0,0,1,0,1,0,'HPを15回復'],PEACE:[0,0,1,0,1,0,0,'MPを10回復'],CURE:[0,0,0,0,1,0,1,'毒回復'],MELT:[0,1,0,0,1,1,1,'凍結を回復'],'STONE-FLESH':[0,0,0,1,1,1,1,'石化を回復'],'UN-CURCE':[2,0,1,0,0,1,0,'呪いを回復'],'AIR-HAND':[1,0,1,0,1,0,1,'見えない拳の衝撃で、忘却を回復'],RESURRECT:[0,0,0,1,3,0,1,'HP/MP半分で復活（但し、冒険に一度だけ）'],'REDUCE-LIFE':[0,1,1,0,1,1,0,'体力を犠牲に（HP-25）、すべての状態異常を回復'],REJUVENATE:[0,2,0,1,0,0,1,'時の流れを巻き戻し（現在の判定をやり直し）'],PROTECT:[1,0,0,1,1,0,1,'HPダメージを半減'],'HOLY-WATER':[0,0,2,2,0,0,0,'MPダメージを半減'],'CHANGE-AIR':[1,0,0,1,1,1,0,'戦闘を回避（アイテムは得られない）'],'GIVE-VIGOR':[1,1,1,0,0,1,0,'敵の攻撃力が2倍＆取得アイテム2倍'],EXPLOSION:[0,1,0,1,0,1,2,'地属性の敵を全滅'],DELUGE:[4,0,0,0,0,1,0,'火属性の敵を全滅'],FREEZE:[0,2,0,0,0,1,2,'水属性の敵を全滅'],'DESTROY-A':[1,0,4,0,0,0,0,'風属性の敵を全滅'],'LIGHT-CROSS':[0,2,0,2,0,1,0,'霊属性の敵を全滅'],'NOILA-TEM':[1,1,1,1,1,1,1,'すべての属性の敵を全滅']},global_items:{happy:{gi01:{name:'金の卵',desc:'月の欠片を5個所有した状態で冒険を開始'},gi02:{name:'ガラティーン',desc:'火星の欠片を5個所有した状態で冒険を開始'},gi03:{name:'五元素のマント',desc:'水星の欠片を5個所有した状態で冒険を開始'},gi04:{name:'アマゾンの剣',desc:'木星の欠片を5個所有した状態で冒険を開始'},gi05:{name:'幸福のコイン',desc:'金星の欠片を5個所有した状態で冒険を開始'},gi06:{name:'ムラサメブレード',desc:'土星の欠片を5個所有した状態で冒険を開始'},gi07:{name:'G・スレイヤー',desc:'太陽の欠片を5個所有した状態で冒険を開始'},gi08:{name:'水晶の剣',desc:'左サイコロが5以上の時、そのシーンでHPを1回復'},gi09:{name:'王様の杖',desc:'左サイコロが5以上の時、そのシーンでMPを1回復'},gi10:{name:'ブルーリボン',desc:'戦闘ダメージを1減算'},gi11:{name:'王家のダイヤモンド',desc:'罠ダメージを1減算'},gi12:{name:'不老長寿の水',desc:'冒険中に一度だけHPを半分回復できる'},gi13:{name:'タリスマン',desc:'冒険中に一度だけMPを半分回復できる'},gi14:{name:'鏡の盾',desc:'HPダメージを1減算'},gi15:{name:'銀の竪琴',desc:'MPダメージを1減算'},gi16:{name:'パンドラの箱',desc:'右サイコロが4以上の時、戦闘回避が可能'},gi17:{name:'魔法の絨毯',desc:'右サイコロが5以上の時、罠回避'},gi18:{name:'中和剤',desc:'毒耐性'},gi19:{name:'聖水',desc:'呪い耐性'},gi20:{name:'チルドの実',desc:'凍結耐性'},gi21:{name:'銀のハーモニカ',desc:'石化耐性'},gi22:{name:'真実の鏡',desc:'忘却耐性'},gi23:{name:'D・スレイヤー',desc:'すべての星を1個所有した状態で冒険を開始'}},bad:{bgi01:{name:'塩酸',desc:'シーン毎にダイス合計が5未満でHPを1減算、5以上でMPを1回復'},bgi02:{name:'紅玉',desc:'シーン毎にダイス合計が5未満でMPを1減算、5以上でHPを1回復'},bgi03:{name:'血まみれの斧',desc:'冒険開始時に呪い。解除で3回まで星消費せず魔法発動可'},bgi04:{name:'トリカブト',desc:'冒険開始時に毒。但し、解除までシーン毎にMPを1回復'},bgi05:{name:'ギャルのパンティー',desc:'冒険開始時に忘却。但し、解除までSTR/INT0でない方を10'}}}},b={random:function(e,t){return Math.floor(Math.random()*(t-e+1))+e},minMaxGuard:function(e){return e<0?0:e>10?10:e},randomArray:function(e){return e[Math.floor(Math.random()*e.length)]},pushUnique:function(e,t){return-1===e.indexOf(t)&&e.push(t),e},shiftUnique:function(e,t){return e.filter(function(e){return e!==t})},ltrim:function(e){return e.substr(1)},saveStorage:function(){localStorage[i]=JSON.stringify(c)},loadStorage:function(){c=JSON.parse(localStorage[i])},saveStorageGlobal:function(){localStorage.sorcerian_text=JSON.stringify(d)},loadStorageGlobal:function(){d=JSON.parse(localStorage.sorcerian_text)},initSavedata:function(){var e=this.randomArray(v.pc_init),t=this.random(e[2],e[2]+10),a=this.random(e[3],e[3]+10),n=this.minMaxGuard(this.random(e[4],e[4]+2)),r=this.minMaxGuard(this.random(e[5],e[5]+2)),s=this.minMaxGuard(this.random(e[6],e[6]+2)),o=this.minMaxGuard(this.random(e[7],e[7]+2)),l=localStorage[i],m='';l&&(m=(l=JSON.parse(l)).memos),c={chara:{name:'MALE'===e[1]?this.randomArray(v.male_name):this.randomArray(v.female_name),title:this.randomArray(v.title),race:e[0],sex:e[1],age:this.randomArray(['YOUNG','ADULT','OLD']),state:'',hp_m:t,hp:t,mp_m:a,mp:a,str_i:n,str:n,int_i:r,int:r,dex_i:s,dex:s,krm_i:o,krm:o,free1:0,free2:0},stars:[0,0,0,0,0,0,0],items:[],flags:[],memos:m,scene:0,ellapsed_scene:0,bgm:'',bonus:this.randomArray(d.items),isEnded:!1},this.saveStorage()},initGlobalSaveData:function(){d={items:[],bgm:!0,panel:!0},this.saveStorageGlobal('sorcerian_text')},validateScenario:function(){var t=[],a=[],n=function(e,a,n){if(void 0!==a&&''!==a){var i=a.trim().replace('-','').split(','),r=Object.keys(e);i.forEach(function(e){-1===r.indexOf(e)&&t.push({scene_id:n,message:e.startsWith('i')?'アイテムコード'+e+'が未登録です。':e.startsWith('f')?'フラグコード'+e+'が未登録です。':'敵コード'+e+'が未登録です。'})})}};return e('scene',r).each(function(i,r){var c=e(r);-1===a.indexOf(c.attr('id'))?a.push(c.attr('id')):t.push({scene_id:c.attr('id'),message:'scene－idが重複しています。'}),n(l,c.attr('items'),c.attr('id')),n(s,c.attr('flags'),c.attr('id')),n(o,c.attr('enemies'),c.attr('id'))}),t},canUseMagic:function(e){return!(c.stars[0]<e[0]||c.stars[1]<e[1]||c.stars[2]<e[2]||c.stars[3]<e[3]||c.stars[4]<e[4]||c.stars[5]<e[5]||c.stars[6]<e[6])},updateItems:function(e){if(e){for(var t=c.items,e=e.split(','),a=0;a<e.length;a++){var n=e[a].trim();0===n.indexOf('-')?(n=this.ltrim(n),t=this.shiftUnique(t,n)):this.pushUnique(t,n)}c.items=t}},updateFlags:function(e){if(e)for(var t=c.flags,e=e.split(','),a=0;a<e.length;a++){var n=e[a].trim();this.pushUnique(t,n)}},cube:function(e){void 0===e&&(e=1);for(var t='',a=0;a<e;a++)t+='<img src="stext/common/cube'+this.random(1,6)+'.png" class="dice" />';return t},dropItem:function(e){if(!e)return'';var t={'地':['木星','火星','土星','－','－'],'火':['火星','太陽','火星','－','－'],'水':['水星','月','金星','－','－'],'風':['金星','水星','月','－','－'],'霊':['土星','太陽','月','－','－']};return this.randomArray(t[e])},selectFunc:function(e){return b.randomArray(e.split(',')).trim()},deltaStatus:function(e){switch(e){case'frozen':var t='すべてのステータスを-2',a=-2,n=-2,i=-2,r=-2;break;case'stone':var t='すべてのステータスを-1（30scene経過で死亡）',a=-1,n=-1,i=-1,r=-1;break;case'forget':var t='STR／INTのうち、高い方が0に（20scene経過で解除）';if(c.chara.str<c.chara.int)var a=0,n=-1*c.chara.int;else var a=-1*c.chara.str,n=0;var i=0,r=0;break;case'poison':var t='シーン経過ごとにHPを-1',a=0,n=0,i=0,r=0;break;case'curse':var t='魔法の利用が不可（UN-CURSEを除く）',a=0,n=0,i=0,r=0;break;default:var t='－',a=0,n=0,i=0,r=0}return[a,n,i,r,t]},getBonusItem:function(e){return 0===e.indexOf('bgi')?v.global_items.bad[e]:v.global_items.happy[e]},initScenario:function(){b.initSavedata(),b.initDialog(),b.createScene(0),history.pushState(0,'Scene 0')},initDialog:function(){e.get(t+a+'dialog.html').done(function(n){if(u=e(n),e('#name',u).text(c.chara.name),e('#title',u).text(c.chara.title),e('#race',u).text(c.chara.race),e('#sex',u).text(c.chara.sex),e('#hp_m',u).text(c.chara.hp_m),e('#mp_m',u).text(c.chara.mp_m),e('#str_i',u).text(c.chara.str_i),e('#int_i',u).text(c.chara.int_i),e('#dex_i',u).text(c.chara.dex_i),e('#krm_i',u).text(c.chara.krm_i),e('#age',u).text(c.chara.age),e('#chara_face',u).attr('src',t+a+String(c.chara.sex).toLowerCase()+'_'+String(c.chara.age).toLowerCase()+'_'+String(c.chara.race).toLowerCase()+'.png'),c.bonus){var i=b.getBonusItem(c.bonus);e('#bonus',u).text(i.desc+'（'+i.name+'）')}}),e.get(t+a+'dialog_list.html').done(function(n){h=e(n);for(var i=0;i<24;i++)num=i<10?'0'+i:i,num='gi'+num,-1!==e.inArray(num,d.items)?e('#'+num,h).attr('src',t+a+num+'.png').attr('class','bonus_item'):e('#'+num,h).attr('src',t+a+'gi99.png');for(var i=1;i<6;i++)num=i<10?'0'+i:i,num='bgi'+num,-1!==e.inArray(num,d.items)?e('#'+num,h).attr('src',t+a+num+'.png').attr('class','bonus_item'):e('#'+num,h).attr('src',t+a+'gi99.png')})},createDialog:function(){e('#hp',u).attr('value',c.chara.hp),e('#mp',u).attr('value',c.chara.mp),e('[name="state"]',u).each(function(){var t;e(this).attr('value')===c.chara.state?e(this).attr('checked','checked'):e(this).removeAttr('checked')}),e('#ellapsed_scene',u).text(c.ellapsed_scene+' scene'),e('#free1',u).attr('value',c.chara.free1),e('#free2',u).attr('value',c.chara.free2),e('#str',u).attr('value',c.chara.str),e('#int',u).attr('value',c.chara.int),e('#dex',u).attr('value',c.chara.dex),e('#krm',u).attr('value',c.chara.krm),e('#s_mon',u).attr('value',c.stars[0]),e('#s_tue',u).attr('value',c.stars[1]),e('#s_wed',u).attr('value',c.stars[2]),e('#s_thu',u).attr('value',c.stars[3]),e('#s_fri',u).attr('value',c.stars[4]),e('#s_sat',u).attr('value',c.stars[5]),e('#s_sun',u).attr('value',c.stars[6]);var t=this.deltaStatus(e('[name="state"][checked="checked"]',u).attr('value'));e('#str_d',u).text('（'+t[0]+'）'),e('#int_d',u).text('（'+t[1]+'）'),e('#dex_d',u).text('（'+t[2]+'）'),e('#krm_d',u).text('（'+t[3]+'）'),e('#state_desc',u).text(t[4]),e('#memos',u).text(c.memos);var a=e('#magic',u);for(var n in a.empty(),v.magic){var i=v.magic[n],r=e('<option></option>').attr('value',n).attr('title',i[8]).text(n+'（'+i[7]+'）');b.canUseMagic(i)||r.attr('disabled','disabled'),r.appendTo(a)}for(var o=[],d=0;d<c.items.length;d++){var m=l[c.items[d]];o.push('・'+m.name+'（'+m.desc+'）')}e('#items',u).text(o.join('\r'));var g=e('#flags',u);g.empty();for(var d=0;d<c.flags.length;d++){var h='<option ';d==c.flags.length-1&&(h+='selected'),h+='>・'+s[c.flags[d]]+'</option>',g.append(h)}e.zoombox.html(u.html(),{width:640,height:480})},endScenario:function(n){if(n){var r,s,o;switch(e('<p><a href="#" onclick="location.reload(true)" class="scenebtn">最初から冒険に挑戦する</a></p>').insertBefore(e('#cubes',g)),c.isEnded=!0,localStorage.removeItem(i),n){case'happy':r=b.randomArray(Object.keys(v.global_items.happy)),s=v.global_items.happy[r],o=t+i+'/bgm_happy.mp3';break;case'bad':b.random(0,100)<20&&(r=b.randomArray(Object.keys(v.global_items.bad)),s=v.global_items.bad[r]),o=t+i+'/bgm_bad.mp3'}f&&f.pause(),(f=new Audio(o)).loop=!0,d.bgm&&f.play(),r&&(b.pushUnique(d.items,r),b.saveStorageGlobal(),e.get('stext/common/dialog_bonus.html').then(function(n){var i=e(n);e('#bonus_img',i).attr('src',t+a+r+'.png'),e('#bonus_item',i).text(s.name),e('#bonus_item_desc',i).text(s.desc),setTimeout(function(){e.zoombox.html(i.html(),{width:480,height:200})},2e3)}))}},canSceneMove:function(t){var a;return 0!=e('scene[id="'+t+'"][allowMove]',r).length},playBgm:function(e){f&&f.pause(),(f=new Audio(e)).loop=!0,d.bgm&&f.play()},createScene:function(s){if(c.isEnded)location.reload(!0);else{e(window).scrollTop(0);var l=e('scene[id="'+s+'"]',r),m=l.text(),u;if(m=(m=m.replace(/%(blue|red|purple)%/gi,'&nbsp;<span style="color:$1">')).replace(/%\/%/gi,'</span>&nbsp;'),g.html(m),g.markdown(),e('<h5 id="scenario_title"><img id="ctrl_show" src="stext/common/ctrl_show.png" /></a> '+e('scenario',r).attr('title')+'【'+s+'】</span></h5><div id="control_panel"><img id="ctrl_home" src="'+t+a+'ctrl_home.png" /></a>　<img id="status_open" src="'+t+a+'ctrl_status.png" />　<img id="item_list" src="'+t+a+'ctrl_bonus.png" />　<img id="audio_onoff" src="'+t+a+'ctrl_audio_'+(d.bgm?'on':'off')+'.png" />　<img id="ctrl_reload" src="'+t+a+'ctrl_reload.png" />　<img id="ctrl_help" src="'+t+a+'ctrl_help.png" /></div>').prependTo(g),d.panel||e('#control_panel').hide(),console.log('debug:'+p),p&&(e('<div id="debug_panel"><form><label>Scene：<input id="debug_id" type="text" size="5" /></label>　<label>Items：<input id="debug_items" type="text" size="7" /></label>　<label>Flags：<input id="debug_flags" type="text" size="7" /></label>　<input id="debug_reload" type="button" value="Reload" /></form></div>').prependTo(g),e('#debug_panel #debug_id').val(s),e('#debug_panel #debug_items').val(c.items.join(',')),e('#debug_panel #debug_flags').val(c.flags.join(',')),e('#debug_panel #debug_reload').click(function(t){var a=e('#debug_panel #debug_items').val().trim(),n=e('#debug_panel #debug_flags').val().trim();''!==a&&(c.items=a.split(',')),''!==n&&(c.flags=n.split(',')),b.saveStorage(),b.createScene(e('#debug_panel #debug_id').val())})),g.append('<center id="cubes">'+b.cube(2)+'</center>'),e('a',g).addClass('scenebtn'),e('a[href="X"]',g).removeClass('scenebtn').addClass('scene_move').text('移動する').before('<input type="number" id="toscene" class="scene_move" />').add('#toscene').wrapAll('<div></div>'),e('a:has(img)',g).each(function(a,r){var s=t+i+'/'+n+e(r).attr('href');e(r).attr('href',s).removeClass('scenebtn').addClass('scenepic').find('img').attr('src',s)}),e('a.scenepic').zoombox(),l.attr('enemies')){for(var h=e('<table class="enemy">'),_=l.attr('enemies').split(','),x=0;x<_.length;x++){var y=o[_[x]],S='<tr><th>'+y.name;y.element&&(S+='（'+y.element+'）'),S+='</th><td>'+y.attack+'</td><td>',y.func&&(S+=b.selectFunc(y.func)),S+='</td><td>'+this.dropItem(y.element),S+='</td><td>'+y.desc+'</td></tr>',h.append(S)}h.insertBefore('a.scenebtn:first')}var w=c.flags,E=c.items,k;e('a[title]',g).hide(),e('a[title^="-"]',g).show();for(var x=0;x<w.length;x++)e('a[title="'+w[x]+'"]',g).show(),e('a[title="-'+w[x]+'"]',g).hide();e('a[title*=","]',g).each(function(t,a){var n=e(a).attr('title');if(0!==n.indexOf('-')){for(var i=!0,r=n.split(','),s=0;s<r.length;s++)if(-1===w.indexOf(r[s].trim())){i=!1;break}i&&e(a).show()}else{for(var o=!0,r=n.substring(1).split(','),s=0;s<r.length;s++)if(-1===w.indexOf(r[s].trim())){o=!1;break}o&&e(a).hide()}});for(var x=0;x<E.length;x++)e('a[title="'+E[x]+'"]',g).show();for(var A in v.magic)b.canUseMagic(v.magic[A])&&e('a[title="m'+A+'"]',g).show();var M='',T=l.attr('bgm');M=c.bgm?'/bgm_'+c.bgm+'.mp3':'/bgm.mp3',void 0!==T&&(M=''===T?'/bgm.mp3':'/bgm_'+T+'.mp3');var O=t+i+M;if((!f||f&&void 0!==T&&T!==c.bgm)&&(b.playBgm(O),c.bgm=void 0===T?'':T),l.attr('se')){var L=new Audio(t+i+'/'+l.attr('se')+'.mp3');L.loop=!1,L.play()}b.updateItems(l.attr('items')),b.updateFlags(l.attr('flags')),c.scene=s,c.ellapsed_scene++,b.saveStorage(),b.endScenario(l.attr('end')),console.log(c)}}};e.fn.extend({startGame:function(n,m){i=n,g=this,m||(m=!1),p=m,g.on('click','a.scenebtn',function(t){var a=e(this).attr('href');history.pushState(a,'Scene '+a),b.createScene(a),t.preventDefault()}),g.on('click','a.scene_move',function(t){var a=e('#toscene').val();b.canSceneMove(a)?(history.pushState(a,'Scene '+a),b.createScene(a)):window.alert('その番号には移動できません。'),t.preventDefault()});var u=new Audio(t+a+'dice.mp3'),_,x=function(){_++,e('#cubes').html(b.cube(2)),_>20||setTimeout(x,50)};g.on('click','#cubes',function(e){u.play(),_=1,x(this)}),g.on('click','#status_open',function(e){b.createDialog(),e.preventDefault()}),g.on('contextmenu',function(e){b.createDialog(),e.preventDefault()}),g.on('click','#audio_onoff',function(n){f&&(d.bgm?(d.bgm=!1,e(this).attr('src',t+a+'ctrl_audio_off.png'),f.pause()):(d.bgm=!0,e(this).attr('src',t+a+'ctrl_audio_on.png'),f.play()),b.saveStorageGlobal())}),e(document).on('click','#dialog_body #status_save',function(t){c.chara.hp=e('#dialog_body #hp').val(),c.chara.mp=e('#dialog_body #mp').val(),c.chara.free1=e('#dialog_body #free1').val(),c.chara.free2=e('#dialog_body #free2').val(),c.chara.str=e('#dialog_body #str').val(),c.chara.int=e('#dialog_body #int').val(),c.chara.dex=e('#dialog_body #dex').val(),c.chara.krm=e('#dialog_body #krm').val(),c.chara.state=e('#dialog_body [name="state"]:checked').val(),c.stars[0]=e('#dialog_body #s_mon').val(),c.stars[1]=e('#dialog_body #s_tue').val(),c.stars[2]=e('#dialog_body #s_wed').val(),c.stars[3]=e('#dialog_body #s_thu').val(),c.stars[4]=e('#dialog_body #s_fri').val(),c.stars[5]=e('#dialog_body #s_sat').val(),c.stars[6]=e('#dialog_body #s_sun').val(),c.memos=e('#dialog_body #memos').val(),b.saveStorage(),e.zoombox.close()}),e(document).on('click','#dialog_body [name="state"]',function(t){var a=b.deltaStatus(e(this).val());e('#dialog_body #str_d').text('（'+a[0]+'）'),e('#dialog_body #int_d').text('（'+a[1]+'）'),e('#dialog_body #dex_d').text('（'+a[2]+'）'),e('#dialog_body #krm_d').text('（'+a[3]+'）'),e('#dialog_body #state_desc').text(a[4])});var y=function(t,a,n){if(t[a]>0){var i=e('#dialog_body '+n).val();e('#dialog_body '+n).val(i-t[a])}};e(document).on('click','#dialog_body #magic_run',function(t){t.preventDefault();var a=v.magic[e('#dialog_body #magic option:selected').val()];a&&(e('#dialog_body #s_mon').val()<a[0]||e('#dialog_body #s_tue').val()<a[1]||e('#dialog_body #s_wed').val()<a[2]||e('#dialog_body #s_thu').val()<a[3]||e('#dialog_body #s_fri').val()<a[4]||e('#dialog_body #s_sat').val()<a[5]||e('#dialog_body #s_sun').val()<a[6]?window.alert('星が不足しているため、魔法を発動できません！'):(y(a,0,'#s_mon'),y(a,1,'#s_tue'),y(a,2,'#s_wed'),y(a,3,'#s_thu'),y(a,4,'#s_fri'),y(a,5,'#s_sat'),y(a,6,'#s_sun')))}),g.on('click','#item_list',function(t){e.zoombox.html(h.html(),{width:650,height:450})}),e(document).on('click','#dialog_list img.bonus_item',function(t){var a=t.target.id,n;n=a.startsWith('gi')?v.global_items.happy[a]:v.global_items.bad[a],e('#dialog_list #bonus_msg').text(n.name+'（'+n.desc+'）')}),g.on('click','#ctrl_home',function(e){window.open('http://www.web-deli.com/sorcerian/next/stext.aspx')}),g.on('click','#ctrl_reload',function(e){location.reload()}),g.on('click','#ctrl_help',function(e){window.open('http://d.hatena.ne.jp/sorcerian/20171220')}),g.on('click','#scenario_title',function(t){var a;'none'===e('#control_panel').css('display')?(e('#control_panel').slideDown(),d.panel=!0):(e('#control_panel').slideUp(),d.panel=!1),b.saveStorageGlobal()}),e(window).on('popstate',function(e){b.createScene(e.originalEvent.state)}),e(document).on('touchstart','.zoombox_mask',function(){d.bgm&&f.paused&&f.play()}),localStorage.sorcerian_text?b.loadStorageGlobal():b.initGlobalSaveData(),e.zoombox.open(t+a+'title.png',{duration:400});var S=function(t){for(var a in r=t,console.log(r),v.magic){for(var n=v.magic[a],d='',m=['月','火','水','木','金','土','太'],u=0;u<7;u++)n[u]>0&&(d+=m[u]+n[u]+' ');n.push(d)}if(s={},e('flags > flag',r).each(function(){s[e(this).attr('id')]=e(this).text().trim()}),console.log(s),o={},e('enemies > enemy',r).each(function(){o[e(this).attr('id')]={name:e(this).attr('name'),element:e(this).attr('element'),attack:e(this).attr('attack'),func:e(this).attr('func'),desc:e(this).text()}}),console.log(o),l={},e('items > item',r).each(function(){l[e(this).attr('id')]={name:e(this).attr('name'),desc:e(this).text().trim()}}),console.log(l),!0===p){var h=b.validateScenario();if(console.log('検証結果'+h),0!==h.length){var f='<h3>scenario.xmlでエラーが検出されました。</h3>';return f+='<ul class="errorlist">',h.forEach(function(e){f+='<li>Scene '+e.scene_id+': '+e.message+'</li>'}),f+='</ul>',void g.html(f)}}if(localStorage[i]&&confirm('以前のデータが残っています。\r続きから開始しますか？')){b.loadStorage(),b.initDialog(),c.ellapsed_scene--;var _=c.scene;return b.createScene(_),void history.pushState(_,'Scene '+_)}b.initScenario(),window.alert('キャラが新規作成されました。\rステータスダイアログは画面右クリックで開くことができます。')};if(0===(i=i.trim()).indexOf('<')){var w=e(i);i='playground',S(w)}else e.get(t+i+'/scenario.xml').done(S).fail(function(e,t,a){throw new Error('scenario code is invalid.')})},gbat2stext:function(t){e(this).change(function(a){var n=0,i=e('<scenario xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://www.web-deli.com/sorcerian/next/stext/common/sgml.xsd">\n</scenario>'),r=e('<items>\n</items>'),s=e('<flags>\n</flags>'),o=e('<enemies>\n</enemies>'),l=e('<license>\n</license>'),c=function(a){var c=e(this.result),g=e('title',c).text().trim().split('@');if(i.attr('title')||(i.attr('title',g[0]),i.attr('author',g[1])),e('section',c).each(function(t,a){var n=!1,c={};c.id=Number(e('number',a).text()),1===c.id&&(c.id=0);var d='\n';e('> text p',a).each(function(t,a){var i=e(a).text();if('@@'===i.trim())return n=!n,!0;if(n){if(!i)return!0;if(0===i.indexOf('i')){var m=i.split(':');e('<item></item>').attr('id',m[0]).attr('name',m[1]).text(m[2]).appendTo(r)}else if(0===i.indexOf('f')){var g=i.split(':');e('<flag></flag>').attr('id',g[0]).text(g[1]).appendTo(s)}else if(0===i.indexOf('m')){var u=i.split(':');e('<enemy></enemy>').attr('id',u[0]).attr('name',u[1]).attr('element',u[2]).attr('attack',u[3]).attr('func',u[4]).text(u[5]).appendTo(o)}else if(0===i.indexOf('w')){var h=i.split(':');e('<work></work>').attr('name',h[1]).attr('category',h[2]).attr('creator',h[3]).attr('url',h[4]).appendTo(l)}else if(0===i.indexOf('@')){var p=i.substring(1).split(':');c[p[0]]=p[1]}}else d+=i+'\n'}),d+='\n',e('choices choice',a).each(function(t,a){var n=e('text p',a).text().trim().split('@'),i=e('destination',a).text();if('999'===i)var r='[](X)\n';else{var r='[';r+=n[0],r+='](',r+=i,n[1]&&(r+=' "'+n[1]+'"'),r+=')\n'}d+=r});var m=e('<scene></scene>\n').attr('id',c.id).text(d);c.items&&m.attr('items',c.items),c.flags&&m.attr('flags',c.flags),c.enemies&&m.attr('enemies',c.enemies),c.bgm&&m.attr('bgm',c.bgm),c.se&&m.attr('se',c.se),c.allowMove&&m.attr('allowMove',c.allowMove),c.end&&m.attr('end',c.end),m.appendTo(i)}),l.prependTo(i),o.prependTo(i),s.prependTo(i),r.prependTo(i),++n>=d.length)if(t)t(i);else{var u='<?xml version="1.0" encoding="utf-8"?>\n'+i.get(0).outerHTML,h=new Blob([u],{type:'application/octet-stream'}),p=document.createElement('a');p.href=window.URL.createObjectURL(h),p.download='scenario.xml',p.click()}else m.readAsText(d[n],'UTF-8')},d=e(this).get(0).files,m=new FileReader;e(m).on('load',c),m.readAsText(d[n],'UTF-8')})}})}(jQuery);