!function($){var ROOT="stext/",COMMON="common/",CAPTURE="capture/",BGM="bgm/",SE="se/",scenario_code,scenario_data,enabled_jobs,flags_map={},enemies_map={},items_map={},results_map={},bgms_map={},save_data,global_save_data,GLOBAL_SAVE_DATA_KEY="sorcerian_text",target,dialog,dialog_item,debug_mode=!1,bgm,bgm_name,storage=localStorage,dice=[1,1],tweet_message,Common={male_name:["ボブ","デュエル","ゴルカス","ジェノバン","グーラン","ジャンビエ","グログス","コル","フロニアス","グーリム","カザミィ","ソロン","ゼン","ヴォル","マルス","レイザー","ミリオン","エリック","ジロ","ソード","ディル","ガタビア","ラウア","ハルビン","グドン","ジャミル","ディカン","ダート","タットワ5世","ディカン","ホド","ゲプラー","コクマー","グレアム","ロウポー","ラッツ","ソルト","ランブル","ネイル","ルシアン","ギム","チェイサー","ルワン","ゾーク","オルム","テュモー","バロン","カメロン","トード","グンダ","フラジオレ","ファン＝フレディ","ファネッサ3世","クリフト4世","クォール","ディオン","ホゼア","ロラッド","バルナ","ティゲロ","テト","ニフト","オーサー","ゲディス","レオン","アンドリュー","キリー","トーマス","エディ","ノーマス","ギルデン","ノーネーム","ユイター","デュオン","ペトス","フェリス","スラン","アルフレッド","ソクラム","アルモス","ログレック","ラルーゴ","キッド","ドレイク","ウォルトス","レスター","テリー","グラハン","ラドール","ウェステル","フェスタ","バンブー","ゲルフス","ドン・コサック","ベオグラード","ピエール","タルフ","エヴァン","ドゥール","バルガス","アーサー","ガッシュ","エルウッド","ヘルナー","エリック","ジャグラー","アラン","ロニアス","アスタル","ボルックス","ラドナー","ギルバレス","ジャレス","ルー","スズキ","ジロサ","サントリーニ","ルルイエ","コーラル","ボマード","ナルシス","マーヴァル","クール","ヨシュア","エヴァム","ジャンク","ボイド","ヘクター","デンキブラウン","バイアス","ブロイム","ディンギル","リグ","バド","ジード","ラルザス","ガイキナ","ロッド","ケイン","ルーミス","タジート","ブレイス","ディンクス","マーク","ホホホ","テシター","J.B","ジン","マック","リラ","ジバ","バーラン","ポジティル","ネガティル","ファルカス","ファウネス","ファルカス","チェン","パズス12世","タムタム","リーク・ディオン","タウラー","ラルディ","ノーマス","アドロン","ロカルノ","ゲラン","シュヴェーリン","ローラン","ウェッジ","アントロノフ","キム","ヤン","デフ","ミケロ","クール","ティエンルン","コウ","マルク","オーエン","トート","グート","マウアー","ザンダー","バルダ","キーリエ","マルス","セム","ターバ","グロス","クルトン","ザムル","エルフィン","グラハン","ガウェイン","アドル","ゴーバン","ドギ","ルタ","ダレス","ダルク＝ファクト","クーブラ＝カーン","ガルシウス","クロノス","カイロス","ディアルド","チッタ","カズン","ルイス","セネリー","ライネル","エス","カリー","ドレイク","ダニー","ドリー","ケイリス","ノートン","クラウド","ウォーリー","レイモンド","サザール","メテオロイド","ナッシュ","ルロイ","ライトル","カディアン","ブラウン","シュナイダー","セシル","グレンザー","ゴイル","ビル","グリメルム","ガルベス","ジルドバ","アレクシウスX世","ピエール","ジェラルド","ロベルト","エティス","アル＝ファルコ","ラシーン","ロデム","J.D.マックス","パーム","シド"],female_name:["エスター","クリスティ","アイリーン","フェルディナン","リタ","トーヤ","ノルン","ウィンディーネ","プリム","ピアナ","エメラーダ","エレア","エヴァ","リム","ビナー","ティファレト","ミラドゥ","パナシェ","ミモザ","リューズ","エレーナ","リーア","キアラ","オルアラ","クオレ","セーナ","リーザ","セリナ","リリィ","ピピ","ビヌス","アンナ","リュシエル","フィレン","カレン","エリン","ローラ","マーベラ","ジョセフィーヌ","アネリーナ","リオナ","ジョアンナ","レニッサ","ジェニス","グリンダ","マティナ","ローナ","コッキー","チェルシー","ネリス","アリーナ","フェリッサ","マリエル","ベララ","ジョゼフ","ニッカ","テキーラ","ソルティ","パイン","ウィズ","カンニバル","ミント","リーン","ミル","ディアンナ","レティア","サフィス","エミス","ヴァムリー","サリア","ナイジェス","ミューリア","エミリア","シャル","バーバラ","オビア","スチュアート","ベーラ","サマリーヌ","フィアネ","レナ","ソル","ネイラ","セレーネ","アルバ","ラン","ルー・パズス","シルフィ","ミレット","レフィーナ","モスマ","チブル","鈴鈴","明明","ティキ","サリア","ミュール","ダール","ミンナ","レーシャ","エレイア","レア","フィーナ","ジャネット","ナリス","ソチ","ポーラス","ロキア","フリージ","エスメレー","エレナ","アルティ","エビオラ","フィナ"],title:["武器屋の親父","ペンタウァの長老","トラベラーズインの宿主","人と上手に話したい","ペンタウァ近衛隊長","タリスマンの見張り","瞑想中","砂漠の飯炊き","狂戦士","エレベーターの管理人","盗賊の頭領","暗き沼の魔法使い","ロマンシア国王","アゾルバ国王","ペンタウァ国王","蚕職人","妖精王","暗黒の魔導士","クイーンマリー号船長","キタブ・アル・アジフの持ち主","メデューサハンターの弟子","ファルコムマン","戦士の亡霊","海賊の子孫","いけにえの神官","東の村の村長","麻薬中毒者","ヴァネルバの王","銀の竪琴屋","近衛隊長","復讐の呪術師","ラフォーヌの森の管理人","リドニア王国の元兵士","姫の教育係","大魔王","紫ウニの王子","ベララの家族","時計塔の番人","時計塔の魔女","ナルキッソス号船長","ディンギル王国の3神官","バドティビラ工場の指揮官","シュメール国王","サンサーラの山賊","南村の村長","アイテム屋WIZの店主","旅の吟遊詩人","古代イスマリアの王","時の神殿の書記官","闇の王","ランドル村長","魔法学校の校長","魔法学校の用務員","マリオネットの王","ペンタウァの近衛兵","陽の中の闇人","赤毛の冒険者","光の王","イリアスンの執政官","魔の下僕","メデューサハンター","邪神教徒","邪神教々祖","砂漠の王","鍵の番人","ローデシア辺境司令官","宇宙からの訪問者","黒竜仙人","猿大聖","極楽寺の僧兵","ジャグラー族","迷宮建築の第一人者","フリース村の村長","ペンタウァ一の科学者アンド予言者","暴れザル","魔法学校の校長","人魚３姉妹の長女","マリオネットの王","探求の学徒","旅芸人の一座","猛獣使い","流れの傭兵","氷の魔女","パペッテの人形遣い","バーテンダー","宮仕えのシャーマン","薬草亭の主人","水門の管理人"],pc_init:[["FIGHTER","MALE",85,55,7,3,6,4],["FIGHTER","FEMALE",80,60,6,4,6,4],["WIZARD","MALE",55,85,4,8,5,3],["WIZARD","FEMALE",50,90,3,8,5,4],["DWARF","MALE",90,50,8,2,8,2],["DWARF","FEMALE",85,55,7,3,8,2],["ELF","MALE",65,75,4,6,5,5],["ELF","FEMALE",60,80,2,7,5,6]],magic:{HEAL:[0,0,0,1,0,1,0,"HPを15回復"],PEACE:[0,0,1,0,1,0,0,"MPを10回復"],CURE:[0,0,0,0,1,0,1,"毒回復"],MELT:[0,1,0,0,1,1,1,"凍結を回復"],"STONE-FLESH":[0,0,0,1,1,1,1,"石化を回復"],"UN-CURCE":[2,0,1,0,0,1,0,"呪いを回復"],"AIR-HAND":[1,0,1,0,1,0,1,"見えない拳の衝撃で、忘却を回復"],RESURRECT:[0,0,0,1,3,0,1,"HP/MP半分で復活（但し、冒険に一度だけ）"],"REDUCE-LIFE":[0,1,1,0,1,1,0,"体力を犠牲に（HP-25）、すべての状態異常を回復"],REJUVENATE:[0,2,0,1,0,0,1,"時の流れを巻き戻し（現在の判定をやり直し）"],PROTECT:[1,0,0,1,1,0,1,"HPダメージを半減"],"HOLY-WATER":[0,0,2,2,0,0,0,"MPダメージを半減"],"CHANGE-AIR":[1,0,0,1,1,1,0,"戦闘を回避（アイテムは得られない）"],"GIVE-VIGOR":[1,1,1,0,0,1,0,"敵の攻撃力が2倍＆取得アイテム2倍"],EXPLOSION:[0,1,0,1,0,1,2,"地属性の敵を全滅"],DELUGE:[4,0,0,0,0,1,0,"火属性の敵を全滅"],FREEZE:[0,2,0,0,0,1,2,"水属性の敵を全滅"],"DESTROY-A":[1,0,4,0,0,0,0,"風属性の敵を全滅"],"LIGHT-CROSS":[0,2,0,2,0,1,0,"霊属性の敵を全滅"],"NOILA-TEM":[1,1,1,1,1,1,1,"すべての属性の敵を全滅"]},jobs:{"のうふ":["FWDE","MF","YAO"],"れんきんじゅつ":["W","M","YAO"],"ようへい":["FDE","M","YA"],"うらないし":["WE","MF","YAO"],"こうふ":["FD","M","YA"],"どろぼう":["FWDE","MF","YAO"],"そうりょ":["W","MF","YAO"],"しょうにん":["FWE","MF","YAO"],"せんいん":["FD","M","YA"],"とうし":["FDE","MF","Y"],"どうけし":["WE","MF","YAO"],"かじや":["FD","M","YAO"],"きこり":["FD","M","YA"],"かりうど":["FDE","M","YAO"],"きとうし":["WE","M","YAO"],"あくまばらい":["W","M","YAO"],"せんきょうし":["W","MF","YAO"],"いしゃ":["WE","M","AO"],"かんごふ":["FWE","F","YAO"],"ぱんや":["FWE","MF","YAO"],"りょうし":["FD","MF","YA"],"だいく":["FD","M","YAO"],"ちょうこくか":["FWDE","MF","O"],"おりこ":["WDE","F","YAO"],"すみやき":["FD","MF","YAO"],"コック":["WE","MF","YAO"],"スパイ":["FWE","M","YA"],"ぼくどう":["FWDE","MF","Y"],"ようじんぼう":["FDE","M","Y"],"ぎんゆうしじん":["WE","M","YAO"],"ぎょしゃ":["FD","MF","YAO"],"はかもり":["FWDE","M","O"],"しゃほん":["WE","M","O"],"こなひき":["FD","MF","YA"],"かせいふ":["FWDE","F","YAO"],"おどりこ":["E","F","Y"],"はなや":["FWE","F","YAO"],"いしく":["D","MF","YA"],"かみゆい":["FWDE","F","AO"],"したてや":["WDE","F","YAO"],"いとつむぎ":["D","F","YAO"],"うたうたい":["FWE","F","YA"],"かみすき":["WD","MF","O"],"つうやく":["DE","MF","YAO"],"やくざいし":["FWE","MF","AO"],"ほねさいくし":["D","MF","O"],"わたしもり":["FW","M","YA"],"やくそうとり":["WE","MF","YAO"],"そうぎや":["FW","M","O"],"ワインづくり":["FWDE","MF","YA"],"こじき":["FWDE","MF","YAO"],"ちょうきょうし":["DE","MF","A"],"ほうせきさいくし":["D","MF","O"],"かごづくり":["FD","MF","O"],"かぎや":["D","MF","AO"],"くつし":["FDE","MF","O"],"はくせいづくり":["FD","MF","O"],"ゆみし":["FE","MF","O"],"チーズづくり":["FD","F","YAO"],"さんば":["FW","F","AO"]},global_items:{happy:{gi01:{name:"金の卵",desc:"月の欠片を5個所有した状態で冒険を開始"},gi02:{name:"ガラティーン",desc:"火星の欠片を5個所有した状態で冒険を開始"},gi03:{name:"五元素のマント",desc:"水星の欠片を5個所有した状態で冒険を開始"},gi04:{name:"アマゾンの剣",desc:"木星の欠片を5個所有した状態で冒険を開始"},gi05:{name:"幸福のコイン",desc:"金星の欠片を5個所有した状態で冒険を開始"},gi06:{name:"ムラサメブレード",desc:"土星の欠片を5個所有した状態で冒険を開始"},gi07:{name:"G・スレイヤー",desc:"太陽の欠片を5個所有した状態で冒険を開始"},gi08:{name:"水晶の剣",desc:"左サイコロが5以上の時、そのシーンでHPを1回復"},gi09:{name:"王様の杖",desc:"左サイコロが5以上の時、そのシーンでMPを1回復"},gi10:{name:"ブルーリボン",desc:"戦闘ダメージを1減算"},gi11:{name:"王家のダイヤモンド",desc:"罠ダメージを1減算"},gi12:{name:"不老長寿の水",desc:"冒険中に一度だけHPを半分回復できる"},gi13:{name:"タリスマン",desc:"冒険中に一度だけMPを半分回復できる"},gi14:{name:"鏡の盾",desc:"HPダメージを1減算"},gi15:{name:"銀の竪琴",desc:"MPダメージを1減算"},gi16:{name:"パンドラの箱",desc:"右サイコロが4以上の時、戦闘回避が可能"},gi17:{name:"魔法の絨毯",desc:"右サイコロが5以上の時、罠回避"},gi18:{name:"中和剤",desc:"毒耐性"},gi19:{name:"聖水",desc:"呪い耐性"},gi20:{name:"チルドの実",desc:"凍結耐性"},gi21:{name:"銀のハーモニカ",desc:"石化耐性"},gi22:{name:"真実の鏡",desc:"忘却耐性"},gi23:{name:"D・スレイヤー",desc:"すべての星を1個所有した状態で冒険を開始"}},bad:{bgi01:{name:"塩酸",desc:"シーン毎にダイス合計が5未満でHPを1減算、5以上でMPを1回復"},bgi02:{name:"紅玉",desc:"シーン毎にダイス合計が5未満でMPを1減算、5以上でHPを1回復"},bgi03:{name:"血まみれの斧",desc:"冒険開始時に呪い。解除で3回まで星消費せず魔法発動可"},bgi04:{name:"トリカブト",desc:"冒険開始時に毒。但し、解除までシーン毎にMPを1回復"},bgi05:{name:"ギャルのパンティー",desc:"冒険開始時に忘却。解除までSTR/INT0でない方を10"}}},star_names:{mon:"月",tue:"火星",wed:"水星",thu:"木星",fri:"金星",sat:"土星",sun:"太陽","":null},state_names:{"":"正常",poison:"毒",frozen:"凍結",stone:"石化",curse:"呪い",forget:"忘却",physics:"物理",magic:"魔法"},element_names:{earth:"地",fire:"火",water:"水",wind:"風",spirit:"霊"}};toastr.options.closeButton=!0,toastr.options.positionClass="toast-bottom-left",toastr.options.showDuration=300,toastr.options.hideDuration=1e3,toastr.options.timeOut=5e3;var Util={random:function(min,max){return Math.floor(Math.random()*(max-min+1))+min},minMaxGuard:function(num){return num<0?0:num>10?10:num},randomArray:function(data){return data[Math.floor(Math.random()*data.length)]},pushUnique:function(data,value){return-1===data.indexOf(value)&&(data.push(value),!0)},shiftUnique:function(data,value){return data.filter(function(elem){return elem!==value})},ltrim:function(str){return str.substr(1)},saveStorage:function(){storage[scenario_code]=JSON.stringify(save_data)},loadStorage:function(){save_data=JSON.parse(storage[scenario_code])},saveStorageGlobal:function(){storage.sorcerian_text=JSON.stringify(global_save_data)},loadStorageGlobal:function(){global_save_data=JSON.parse(storage.sorcerian_text)},initSavedata:function(){var constraint=$("init > constraint",scenario_data),init_races,init_sex,init_ages;if(constraint){var init_races;(init_races=constraint.attr("race"))&&(init_races=init_races.split(","));var init_sex=constraint.attr("sex"),init_ages;(init_ages=constraint.attr("age"))&&(init_ages=init_ages.split(","))}var pc_base=this.randomArray(Common.pc_init.filter(function(value){return!init_races||init_races.includes(value[0])}).filter(function(value){return!init_sex||init_sex===value[1]})),hp_m=this.random(pc_base[2],pc_base[2]+10),mp_m=this.random(pc_base[3],pc_base[3]+10),str_i=this.minMaxGuard(this.random(pc_base[4],pc_base[4]+2)),int_i=this.minMaxGuard(this.random(pc_base[5],pc_base[5]+2)),dex_i=this.minMaxGuard(this.random(pc_base[6],pc_base[6]+2)),krm_i=this.minMaxGuard(this.random(pc_base[7],pc_base[7]+2)),old_data=storage[scenario_code],old_memo="";old_data&&(old_memo=(old_data=JSON.parse(old_data)).memos),save_data={chara:{name:"MALE"===pc_base[1]?this.randomArray(Common.male_name):this.randomArray(Common.female_name),title:this.randomArray(Common.title),race:pc_base[0],sex:pc_base[1],age:this.randomArray(["YOUNG","ADULT","OLD"].filter(function(value){return!init_ages||init_ages.includes(value)})),job:"",state:"",stone_scene:0,forget_scene:0,hp_m:hp_m,hp:hp_m,mp_m:mp_m,mp:mp_m,str_i:str_i,str:str_i,int_i:int_i,int:int_i,dex_i:dex_i,dex:dex_i,krm_i:krm_i,krm:krm_i,free1:0,free2:0,free3:0},stars:[0,0,0,0,0,0,0],items:[],flags:[],memos:old_memo,scene:0,ellapsed_scene:0,bgm:"",bonus:this.randomArray(global_save_data.items),isEnded:!1},this.initJobs(),save_data.chara.job=this.randomArray(enabled_jobs),this.saveStorage()},initGlobalSaveData:function(){global_save_data={items:[],results:{},bgm:!0,panel:!0},this.saveStorageGlobal("sorcerian_text")},initJobs:function(){enabled_jobs=Object.keys(Common.jobs).filter(function(name){var cond=Common.jobs[name];return-1!==cond[0].indexOf(save_data.chara.race.charAt(0))&&-1!==cond[1].indexOf(save_data.chara.sex.charAt(0))&&-1!==cond[2].indexOf(save_data.chara.age.charAt(0))})},buildBgmPath:function(base){return 0===base.indexOf("@")?ROOT+COMMON+BGM+base.substring(1)+".mp3":ROOT+scenario_code+"/"+BGM+base+".mp3"},validateScenario:function(){var error_messages=[],tmp_scenes=[],checkId=function(org,value,scene_id){if(void 0!==value&&""!==value){var ids=value.trim().split(","),keys=Object.keys(org);ids.forEach(function(id){id=id.replace("-",""),-1===keys.indexOf(id)&&error_messages.push({scene_id:scene_id,message:id.startsWith("i")?"アイテムコード"+id+"が未登録です。":id.startsWith("f")?"フラグコード"+id+"が未登録です。":id.startsWith("m")?"敵コード"+id+"が未登録です。":"実績コード"+id+"が未登録です。"})})}};return $("scene",scenario_data).each(function(index,scene){var tmp_s=$(scene);-1===tmp_scenes.indexOf(tmp_s.attr("id"))?tmp_scenes.push(tmp_s.attr("id")):error_messages.push({scene_id:tmp_s.attr("id"),message:"scene－idが重複しています。"}),checkId(items_map,tmp_s.attr("items"),tmp_s.attr("id")),checkId(flags_map,tmp_s.attr("flags"),tmp_s.attr("id")),checkId(enemies_map,tmp_s.attr("enemies"),tmp_s.attr("id")),checkId(results_map,tmp_s.attr("result"),tmp_s.attr("id"))}),error_messages},showSplash(){$.zoombox.open(ROOT+COMMON+"title.png",{duration:400})},canUseMagic:function(magic){return!(save_data.stars[0]<magic[0]||save_data.stars[1]<magic[1]||save_data.stars[2]<magic[2]||save_data.stars[3]<magic[3]||save_data.stars[4]<magic[4]||save_data.stars[5]<magic[5]||save_data.stars[6]<magic[6])},canUseMagicByName:function(name){return 0===name.indexOf("m")&&Util.canUseMagic(Common.magic[name.substring(1)])},ifStatus:function(cond){if(0===cond.indexOf("o")){var cond_set=cond.match(/o(hp|mp|str|int|dex|krm|freei|freeii|freeiii)\s*(\d{1,})(\+|-)\s*/i);cond_set[1]=cond_set[1].toLowerCase(),cond_set[1]=cond_set[1].replace("freeiii","free3"),cond_set[1]=cond_set[1].replace("freeii","free2"),cond_set[1]=cond_set[1].replace("freei","free1");var current_value=save_data.chara[cond_set[1]];return"-"===cond_set[3]?current_value<Number(cond_set[2]):current_value>Number(cond_set[2])}return!1},isCharaState:function(state){var tmp_state;return 0===state.indexOf("x")&&-1!==[save_data.chara.race,save_data.chara.sex,save_data.chara.age,save_data.chara.state.toUpperCase(),save_data.chara.job].indexOf(state.substring(1).toUpperCase())},hasStars:function(at_stars){if(0===at_stars.indexOf("s")){var stars=save_data.stars;if(-1!==at_stars.indexOf(":")){at_stars=at_stars.substring(1).split(":");for(var i=0;i<at_stars.length;i++)if(Number(stars[i])<at_stars[i])return!1}else{at_stars=Number(at_stars.substring(1));for(var star_sum=0,i=0;i<7;i++)star_sum+=Number(stars[i]);if(star_sum<at_stars)return!1}return!0}return!1},hasResult:function(result){if(0===result.indexOf("r")){var results=result.split(":"),info=global_save_data.results[results[1].trim()];if(void 0!==info)return-1!==info.indexOf(results[0].trim())}return!1},updateItems:function(at_items){if(at_items){for(var items=save_data.items,at_items=at_items.split(","),i=0;i<at_items.length;i++){var item=at_items[i].trim();0===item.indexOf("-")?(item=this.ltrim(item),items=this.shiftUnique(items,item)):this.pushUnique(items,item)}save_data.items=items}},updateFlags:function(at_flags){if(at_flags){for(var flags=save_data.flags,at_flags=at_flags.split(","),i=0;i<at_flags.length;i++){var flag=at_flags[i].trim();0===flag.indexOf("-")?(flag=this.ltrim(flag),0===flags_map[flag].indexOf("*")?flags=this.shiftUnique(flags,flag):console.log(flag+"：隠しフラグ以外は削除できません。")):this.pushUnique(flags,flag)}save_data.flags=flags}},updateStates:function(){"poison"===save_data.chara.state?(save_data.chara.hp-=1,save_data.chara.stone_scene=0,save_data.chara.poison_scene=0):"stone"===save_data.chara.state?(save_data.chara.stone_scene+=1,save_data.chara.forget_scene=0):"forget"===save_data.chara.state?(save_data.chara.forget_scene+=1,save_data.chara.stone_scene=0):(save_data.chara.stone_scene=0,save_data.chara.forget_scene=0)},updateStars:function(at_stars){if(at_stars){var stars=save_data.stars;if(-1!==at_stars.indexOf(",")){at_stars=at_stars.split(",");for(var i=0;i<at_stars.length;i++)stars[i]=Number(stars[i])+Number(at_stars[i].trim()),stars[i]<0&&(stars[i]=0)}else if(0===at_stars.indexOf("div")){at_stars=at_stars.substring(3);for(var i=0;i<7;i++)stars[i]=Math.floor(Number(stars[i])/Number(at_stars))}save_data.stars=stars}},updateStarsByMagic:function(cond){if(void 0===cond||0===cond.indexOf("-"))return!0;for(var stars=save_data.stars.concat(),useStar=function(magic){for(var i=0;i<stars.length;i++)if(stars[i]-=magic[i],stars[i]<0)return!1;return!0},conds=cond.split(",").filter(function(value){return 0===value.indexOf("m")}),i=0;i<conds.length;i++){var magic=Common.magic[conds[i].substring(1)];if(!magic)return;if(!Util.canUseMagic(magic))return!1;if(!useStar(magic))return!1}return save_data.stars=stars,Util.saveStorage(),!0},updateStarById:function(star,value){var num=Object.keys(Common.star_names).indexOf(star);save_data.stars[num]=Number(save_data.stars[num])+Number(value)},updateHpMp:function(at_hp,at_mp){if(at_hp)if("full"===at_hp)save_data.chara.hp=save_data.chara.hp_m;else{var hp=at_hp.split("..");hp[1]&&(hp[0]=Util.random(Number(hp[0]),Number(hp[1]))),save_data.chara.hp=Number(save_data.chara.hp)+Number(hp[0])}if(at_mp)if("full"===at_mp)save_data.chara.mp=save_data.chara.mp_m;else{var mp=at_mp.split("..");mp[1]&&(mp[0]=Util.random(Number(mp[0]),Number(mp[1]))),save_data.chara.mp=Number(save_data.chara.mp)+Number(mp[0])}},updateFrees:function(at_free1,at_free2,at_free3){at_free1&&(save_data.chara.free1=Number(save_data.chara.free1)+Number(at_free1)),at_free2&&(save_data.chara.free2=Number(save_data.chara.free2)+Number(at_free2)),at_free3&&(save_data.chara.free3=Number(save_data.chara.free3)+Number(at_free3))},updateResults:function(at_result){if(at_result){void 0===global_save_data.results&&(global_save_data.results={});var results=global_save_data.results;void 0===results[scenario_code]&&0!==scenario_code.indexOf("<")&&(results[scenario_code]=[]),!0===this.pushUnique(results[scenario_code],at_result)&&(toastr.options.timeOut=5e3,toastr.success(results_map[at_result].name,"実績獲得")),this.saveStorageGlobal()}},toast:function(msg){$(".toast").remove(),$("body").append('<div class="toast">'+msg+"</div>");var leftpos=$("body").width()/2-$(".toast").outerWidth()/2;$(".toast").css("left",leftpos).hide().fadeIn("fast"),setTimeout(function(){$(".toast").fadeOut("slow",function(){$(this).remove()})},4e3)},cube:function(num){void 0===num&&(num=1);for(var html="",i=0;i<num;i++)dice[i]=this.random(1,6),html+='<img src="stext/common/cube'+dice[i]+'.png" class="dice" />';return html},dropItem:function(enemy){if(enemy.drop){var drops=enemy.drop.split("/"),star_name=Common.star_names[drops[0]];if(star_name){var num="1"===drops[1]?"":"×"+drops[1];return{drop:enemy.drop,name:star_name+num}}return{drop:enemy.drop,name:drops[2]}}if(!enemy.element)return{name:null};var drop={earth:["thu","tue","sat","",""],fire:["tue","sun","tue","",""],water:["wed","mon","fri","",""],wind:["fri","wed","mon","",""],spirit:["sat","sun","mon","",""]},tmp_d=Util.randomArray(drop[enemy.element]);return{drop:tmp_d?tmp_d+"/1":"",name:Common.star_names[tmp_d]}},computeDamage:function(func){for(var damage=0,func_re=/([\+\-]?)(\d*)(R|L|STR|INT|DEX|KRM|FREE1|FREE2|FREE3)?]?/gi,result;null!=(result=func_re.exec(func));){var sign=1,num=1,param=1;if(""===result[0])break;"-"===result[1]&&(sign=-1),result[2]&&(num=Number(result[2]));var tmp_status={str:Number(save_data.chara.str),int:Number(save_data.chara.int),dex:Number(save_data.chara.dex),krm:Number(save_data.chara.krm)};switch(save_data.chara.state){case"frozen":tmp_status.str-=2,tmp_status.int-=2,tmp_status.dex-=2,tmp_status.krm-=2;break;case"stone":tmp_status.str-=1,tmp_status.int-=1,tmp_status.dex-=1,tmp_status.krm-=1;break;case"forget":tmp_status.str<tmp_status.int?tmp_status.int=0:tmp_status.str=0}switch(result[3]){case"L":param=dice[0];break;case"R":param=dice[1];break;case"STR":case"INT":case"DEX":case"KRM":param=tmp_status[result[3].toLowerCase()];break;case"FREE1":case"FREE2":case"FREE3":param=save_data.chara[result[3].toLowerCase()];break;default:param=1}damage+=sign*num*param,console.log("ダメージ："+damage)}return damage},selectFunc:function(func){return Util.randomArray(func.split(",")).trim()},deltaStatus:function(state){switch(state){case"frozen":var state_desc="すべてのステータスを-2",str_d=-2,int_d=-2,dex_d=-2,krm_d=-2;break;case"stone":var state_desc="すべてのステータスを-1（30scene経過で死亡）",str_d=-1,int_d=-1,dex_d=-1,krm_d=-1;break;case"forget":var state_desc="STR／INTのうち、高い方が0に（20scene経過で解除）";if(save_data.chara.str<save_data.chara.int)var str_d=0,int_d=-1*save_data.chara.int;else var str_d=-1*save_data.chara.str,int_d=0;var dex_d=0,krm_d=0;break;case"poison":var state_desc="シーン経過ごとにHPを-1",str_d=0,int_d=0,dex_d=0,krm_d=0;break;case"curse":var state_desc="魔法の利用が不可（UN-CURSEを除く）",str_d=0,int_d=0,dex_d=0,krm_d=0;break;default:var state_desc="－",str_d=0,int_d=0,dex_d=0,krm_d=0}return[str_d,int_d,dex_d,krm_d,state_desc]},getBonusItem:function(bonus){return 0===bonus.indexOf("bgi")?Common.global_items.bad[bonus]:Common.global_items.happy[bonus]},initScenario:function(){Util.initSavedata(),Util.initDialog(),Util.createCommonTweet(),Util.createScene(0),window.alert("キャラが新規作成されました。\rステータスダイアログは画面右クリックで開くことができます。")},initDialog:function(){$("#dialog_body").remove(),$.get(ROOT+COMMON+"dialog.html").done(function(data){dialog=$(data),$("#name",dialog).text(save_data.chara.name),$("#title",dialog).text(save_data.chara.title),$("#race",dialog).text(save_data.chara.race),$("#sex",dialog).text(save_data.chara.sex),$("#hp_m",dialog).text(save_data.chara.hp_m),$("#mp_m",dialog).text(save_data.chara.mp_m),$("#str_i",dialog).text(save_data.chara.str_i),$("#int_i",dialog).text(save_data.chara.int_i),$("#dex_i",dialog).text(save_data.chara.dex_i),$("#krm_i",dialog).text(save_data.chara.krm_i),$("#age",dialog).text(save_data.chara.age),$("#chara_face",dialog).attr("src",ROOT+COMMON+String(save_data.chara.sex).toLowerCase()+"_"+String(save_data.chara.age).toLowerCase()+"_"+String(save_data.chara.race).toLowerCase()+".png");var job_box=$("#job",dialog);job_box.empty();for(var i=0;i<enabled_jobs.length;i++)$("<option></option>").attr("value",enabled_jobs[i]).text(enabled_jobs[i]).appendTo(job_box);if(save_data.bonus){var b=Util.getBonusItem(save_data.bonus);$("#bonus",dialog).text(b.desc+"（"+b.name+"）")}dialog.insertBefore(target).hide()}),$.get(ROOT+COMMON+"dialog_list.html").done(function(data){dialog_item=$(data);for(var i=0;i<24;i++)num=i<10?"0"+i:i,num="gi"+num,-1!==$.inArray(num,global_save_data.items)?$("#"+num,dialog_item).attr("src",ROOT+COMMON+num+".png").attr("class","bonus_item"):$("#"+num,dialog_item).attr("src",ROOT+COMMON+"gi99.png");for(var i=1;i<6;i++)num=i<10?"0"+i:i,num="bgi"+num,-1!==$.inArray(num,global_save_data.items)?$("#"+num,dialog_item).attr("src",ROOT+COMMON+num+".png").attr("class","bonus_item"):$("#"+num,dialog_item).attr("src",ROOT+COMMON+"gi99.png")})},createDialog:function(){$("#job",dialog).val(save_data.chara.job),$("#hp",dialog).val(save_data.chara.hp),$("#mp",dialog).val(save_data.chara.mp),$('[name="state"]',dialog).each(function(){var state;$(this).attr("value")===save_data.chara.state?$(this).prop("checked",!0):$(this).prop("checked",!1)}),$("#stone_scene",dialog).text(save_data.chara.stone_scene),$("#forget_scene",dialog).text(save_data.chara.forget_scene),Util.setStateStyle(),$("#ellapsed_scene",dialog).text(save_data.ellapsed_scene+" scene"),$("#free1",dialog).val(save_data.chara.free1),$("#free2",dialog).val(save_data.chara.free2),$("#free3",dialog).val(save_data.chara.free3),$("#str",dialog).val(save_data.chara.str),$("#int",dialog).val(save_data.chara.int),$("#dex",dialog).val(save_data.chara.dex),$("#krm",dialog).val(save_data.chara.krm),$("#s_mon",dialog).val(save_data.stars[0]),$("#s_tue",dialog).val(save_data.stars[1]),$("#s_wed",dialog).val(save_data.stars[2]),$("#s_thu",dialog).val(save_data.stars[3]),$("#s_fri",dialog).val(save_data.stars[4]),$("#s_sat",dialog).val(save_data.stars[5]),$("#s_sun",dialog).val(save_data.stars[6]);var delta=this.deltaStatus($('[name="state"]:checked',dialog).val());$("#state_desc",dialog).text(delta[4]),$("#memos",dialog).val(save_data.memos);var magic_box=$("#magic",dialog);for(var key in magic_box.empty(),Common.magic){var magic=Common.magic[key],option=$("<option></option>").attr("value",key).attr("title",magic[8]).text(key+"（"+magic[7]+"）");Util.canUseMagic(magic)||option.attr("disabled","disabled"),option.appendTo(magic_box)}for(var items=[],i=0;i<save_data.items.length;i++){var item=items_map[save_data.items[i]];items.push("・"+item.name+"（"+item.desc+"）")}$("#items",dialog).text(items.join("\r"));var flags=$("#flags",dialog);flags.empty();for(var i=0;i<save_data.flags.length;i++){var flag_text;if(0!==flags_map[save_data.flags[i]].indexOf("*")){var tmp="<option ";tmp+=">・"+flags_map[save_data.flags[i]]+"</option>",flags.append(tmp)}}$("#flags > option:last",dialog).attr("selected","selected"),dialog.slideDown(500),$("#status_change").val("Equipment"),$("#status_basic").show(),$("#status_equip").hide(),target.slideUp(500)},endScenario:function(result,changeBgm){if(result){console.log("***********Licence Info.***********");var tmp_licence={bgm:"音楽",picture:"画像"},bonus_item,o_bonus_item,audio_path;switch($("licence > work",scenario_data).each(function(){var licence_url=$(this).attr("url");console.log($(this).attr("name")+"("+tmp_licence[$(this).attr("category")]+"): "+$(this).attr("creator")+" "+(void 0!==licence_url?licence_url:""))}),console.log("***********Licence Info.***********"),$('<p><a href="#" onclick="location.reload(true)" class="scenebtn">最初から冒険に挑戦する</a></p>').insertBefore($("#cubes",target)),save_data.isEnded=!0,Util.saveStorage(),result){case"happy":bonus_item=Util.randomArray(Object.keys(Common.global_items.happy)),o_bonus_item=Common.global_items.happy[bonus_item],audio_path=Util.buildBgmPath(bgms_map.happy);break;case"bad":Util.random(0,100)<20&&(bonus_item=Util.randomArray(Object.keys(Common.global_items.bad)),o_bonus_item=Common.global_items.bad[bonus_item]),audio_path=Util.buildBgmPath(bgms_map.bad)}changeBgm&&(bgm&&bgm.pause(),(bgm=new Audio(audio_path)).loop=!0,global_save_data.bgm&&bgm.play()),bonus_item&&(Util.pushUnique(global_save_data.items,bonus_item),Util.saveStorageGlobal(),$.get("stext/common/dialog_bonus.html").then(function(data){var bonus_dialog=$(data);$("#bonus_img",bonus_dialog).attr("src",ROOT+COMMON+bonus_item+".png"),$("#bonus_item",bonus_dialog).text(o_bonus_item.name),$("#bonus_item_desc",bonus_dialog).text(o_bonus_item.desc),setTimeout(function(){$.zoombox.html(bonus_dialog.html(),{width:480,height:200})},2e3)}))}},canSceneMove:function(scene_num,allow_num){return-1!==allow_num.split(",").indexOf(scene_num)},playBgm:function(path){bgm&&bgm.pause(),(bgm=new Audio(path)).loop=!0,global_save_data.bgm&&bgm.play()},showSimpleStatus:function(){$("#simple_status").html('HP:<span class="status_v">'+save_data.chara.hp+'</span>　MP:<span class="status_v">'+save_data.chara.mp+'</span>　|　STR:<span class="status_v">'+save_data.chara.str+'</span>　INT:<span class="status_v">'+save_data.chara.int+'</span>　DEX:<span class="status_v">'+save_data.chara.dex+'</span>　KRM:<span class="status_v">'+save_data.chara.krm+'</span>　｜　<span id="status_state" class="status_v">'+Common.state_names[save_data.chara.state]+"</span>　"),$("#status_state").removeClass("status_poison status_frozen status_stone status_curse status_forget"),save_data.chara.state?($("#status_state").addClass("status_"+save_data.chara.state),target.addClass("main_bad")):target.removeClass("main_bad")},setStateStyle:function(){var hp=$("#hp",dialog),str=$("#str",dialog),int=$("#int",dialog),dex=$("#dex",dialog),krm=$("#krm",dialog),magic=$("#magic",dialog),poison=$('[name="state"][value="poison"]').prop("checked"),frozen=$('[name="state"][value="frozen"]').prop("checked"),stone=$('[name="state"][value="stone"]').prop("checked"),curse=$('[name="state"][value="curse"]').prop("checked"),forget=$('[name="state"][value="forget"]').prop("checked"),clazz="dialog_poison dialog_frozen dialog_stone dialog_curse dialog_forget";hp.removeClass(clazz),str.removeClass(clazz),int.removeClass(clazz),dex.removeClass(clazz),krm.removeClass(clazz),magic.removeClass(clazz),poison?hp.addClass("dialog_poison"):frozen?(str.addClass("dialog_frozen"),int.addClass("dialog_frozen"),dex.addClass("dialog_frozen"),krm.addClass("dialog_frozen")):stone?(str.addClass("dialog_stone"),int.addClass("dialog_stone"),dex.addClass("dialog_stone"),krm.addClass("dialog_stone")):curse?magic.addClass("dialog_curse"):forget&&(save_data.chara.str<save_data.chara.int?int.addClass("dialog_forget"):str.addClass("dialog_forget"))},interpolation:function(match,sub){var tmp_sub=sub.split("?"),m_var=tmp_sub[0];if(tmp_sub[1])var m_params=tmp_sub[1].split(":");switch(m_var){case"name":return save_data.chara.name;case"title":return save_data.chara.title;case"race":switch(save_data.chara.race){case"FIGHTER":return m_params[0];case"WIZARD":return m_params[1];case"DWARF":return m_params[2];case"ELF":return m_params[3];default:return"Unknown Race"}case"sex":switch(save_data.chara.sex){case"MALE":return m_params[0];case"FEMALE":return m_params[1];default:return"Unknown Sex"}case"age":switch(save_data.chara.age){case"YOUNG":return m_params[0];case"ADULT":return m_params[1];case"OLD":return m_params[2];default:return"Unknown Age"}case"state":switch(save_data.chara.state){case"":return m_params[0];case"poison":return m_params[1];case"frozen":return m_params[2];case"stone":return m_params[3];case"curse":return m_params[4];case"forget":return m_params[5];default:return"Unknown State"}case"rand":return Util.random(Number(m_params[0]),Number(m_params[1]));case"msg":return Util.randomArray(m_params);default:return sub}},ifCondition:function(match,cond,body){return-1!==save_data.flags.indexOf(cond)||-1!==save_data.items.indexOf(cond)?body:""},parseTweet:function(match,body){return tweet_message=body,body},createTweet:function(type,msg,cache){if(msg||(msg="原作30周年記念企画「SORCERIAN Text」ユーザー参加型のゲームブック版ソーサリアン"),"custom"===type)var show=$(".socialbtn.twitter_custom"),hide=$(".socialbtn.twitter");else var show=$(".socialbtn.twitter"),hide=$(".socialbtn.twitter_custom");cache||(show.empty(),show.append($('<a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-lang="ja" data-url="https://www.web-deli.com/sorcerian/next/stext.aspx" data-via="snext1220" data-related="snext1220" data-hashtags="falcom,stext">Tweet</a>').attr("data-text",msg)).append('<script src="https://platform.twitter.com/widgets.js" charset="UTF-8"><\/script>')),show.show(),hide.hide()},createCommonTweet:function(){Util.createTweet("common",$("init > intro",scenario_data).attr("description"))},createEnemyList:function(at_enemies){if(at_enemies){var e_table=$('<table class="enemy">'),enemies=at_enemies.split(",");e_table.append('<tr class="enemy_title">'+(enemies.length>1?"<th></th>":"")+'<th>名前／属性</th><th>攻撃</th><th title="現在のダイス値に従って、ダメージを反映させます。ただし、状態異常は反映するのみで判定は手動です。">ダメージ</th><th title="記載されたドロップアイテムをステータスに反映させます。">戦利品</th></tr>');for(var i=0;i<enemies.length;i++){var enemy=enemies_map[enemies[i]],atk=Common.state_names[enemy.attack],row='<tr class="enemy_row" data-enemy="'+enemies[i]+'">',tmp_func;if(enemies.length>1&&(row+='<td><input type="checkbox" class="enemy_check" /></td>'),row+="<th>",enemy.element?row+='<img src="stext/common/attr_'+enemy.element+'.png" title="'+Common.element_names[enemy.element]+'" /></a>　':row+='<img src="stext/common/attr_none.png" title="無" /></a>　',row+=enemy.name+"</th><td>",row+=atk?'<img src="stext/common/atk_'+enemy.attack+'.png" title="'+Common.state_names[enemy.attack]+'" /></a>　':enemy.attack,row+="</td><td>",enemy.func)if(0===enemy.func.indexOf("*"))row+=Util.selectFunc(enemy.func.substring(1));else row+='<input type="button" class="enemy_func" value="'+Util.selectFunc(enemy.func)+'" data-attack="'+enemy.attack+'"/>';row+="</td><td>";var tmp_d=Util.dropItem(enemy);tmp_d.name?row+='<input type="button" class="enemy_drop" value="'+tmp_d.name+'" data-drop="'+tmp_d.drop+'"/>':row+="－",row+="</td></tr>",e_table.append(row)}e_table.insertBefore("a.scenebtn:first")}},createScene:function(scene_num,options){if(void 0===options&&(options={}),tweet_message=null,save_data.isEnded)location.reload(!0);else{if(!Util.updateStarsByMagic(options.conditions))return toastr.options.timeOut=4e3,void toastr.warning("星が不足しているようだ。");$(window).scrollTop(0);var scene=$('scene[id="'+scene_num+'"]',scenario_data);options.reverse?options.restore&&history.pushState(save_data,"Scene "+scene_num):(Util.updateItems(scene.attr("items")),Util.updateFlags(scene.attr("flags")),Util.updateStates(),Util.updateStars(scene.attr("stars")),Util.updateHpMp(scene.attr("hp"),scene.attr("mp")),Util.updateFrees(scene.attr("free1"),scene.attr("free2"),scene.attr("free3")),Util.updateResults(scene.attr("result")),save_data.scene=scene_num,save_data.ellapsed_scene++,Util.saveStorage(),history.pushState(save_data,"Scene "+scene_num));var tmp_scene=scene.text();tmp_scene=(tmp_scene=(tmp_scene=(tmp_scene=(tmp_scene=(tmp_scene=(tmp_scene=tmp_scene.replace(/%(blue|red|purple|white)%/gi,'&nbsp;<span style="color:$1">')).replace(/%\/%/gi,"</span>&nbsp;")).replace(/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?/gi,'<a href="$&" data-link="auto" target="_blank">$&</a>')).replace(/\${(.+?)\|(.+?)}/gi,"<ruby>$1<rp>（</rp><rt>$2</rt><rp>）</rp></ruby>")).replace(/\${if[\s]+(.+?)}([\s\S]+?)\${\/if}/gi,this.ifCondition)).replace(/\${tweet}([\s\S]+?)\${\/tweet}/gi,this.parseTweet)).replace(/\${(.+?)}/gi,this.interpolation),target.html(tmp_scene),target.markdown(),tweet_message?Util.createTweet("custom",tweet_message):Util.createTweet("common",null,!0),$('<h5 id="scenario_title"><img id="ctrl_show" src="stext/common/ctrl_show.png" /></a> '+$("scenario",scenario_data).attr("title")+"【"+scene_num+'】</span></h5><div id="control_panel"><img id="ctrl_home" src="'+ROOT+COMMON+'ctrl_home.png" /></a>　<img id="status_open" src="'+ROOT+COMMON+'ctrl_status.png" />　<img id="item_list" src="'+ROOT+COMMON+'ctrl_bonus.png" />　<img id="audio_onoff" src="'+ROOT+COMMON+"ctrl_audio_"+(global_save_data.bgm?"on":"off")+'.png" />　<img id="ctrl_reload" src="'+ROOT+COMMON+'ctrl_results.png" />　<img id="ctrl_help" src="'+ROOT+COMMON+'ctrl_help.png" /></div>').prependTo(target),global_save_data.panel||$("#control_panel").hide(),debug_mode&&($('<div id="debug_panel"><form><label>Scene：<input id="debug_id" type="text" size="5" /></label>　<label>Items：<input id="debug_items" type="text" size="7" /></label>　<label>Flags：<input id="debug_flags" type="text" size="7" /></label>　<input id="debug_reload" type="button" value="Reload" /></form></div>').prependTo(target),$("#debug_panel #debug_id").val(scene_num),$("#debug_panel #debug_items").val(save_data.items.join(",")),$("#debug_panel #debug_flags").val(save_data.flags.join(",")),$("#debug_panel #debug_reload").click(function(e){var debug_items=$("#debug_panel #debug_items").val().trim(),debug_flags=$("#debug_panel #debug_flags").val().trim();save_data.items=""!==debug_items?debug_items.split(","):[],save_data.flags=""!==debug_flags?debug_flags.split(","):[],Util.saveStorage(),Util.createScene($("#debug_panel #debug_id").val())})),target.append('<center id="cubes">'+Util.cube(2)+"</center>"),$('<div id="simple_status"></div>').insertBefore("#cubes"),this.showSimpleStatus(),$("a",target).addClass("scenebtn"),$('a[data-link="auto"]',target).removeClass("scenebtn");var tmp_move=$('a[href="X"]',target);tmp_move.removeClass("scenebtn").addClass("scene_move").attr("data-allow",tmp_move.text()).text("移動する").before('<input type="number" id="toscene" class="scene_move" />').add("#toscene").wrapAll("<div></div>");var tmp_strinput=$('a[href="Q"]',target),a_img;tmp_strinput.removeClass("scenebtn").addClass("quest_str").attr("data-yesno",tmp_strinput.text()).text("回答する").before('<input type="text" id="stranswer" class="quest_str" />').add("#stranswer").wrapAll("<div></div>"),$("a:has(img)",target).each(function(index,elem){var img_path=ROOT+scenario_code+"/"+CAPTURE+$(elem).attr("href");$(elem).attr("href",img_path).removeClass("scenebtn").addClass("scenepic").find("img").attr("src",img_path)}),$("a.scenepic").zoombox(),Util.createEnemyList(scene.attr("enemies"));var flags=save_data.flags,items=save_data.items,multi_flags;$("a[title]",target).hide(),$('a[title^="-"]',target).show(),$("a[title]",target).each(function(index,elem){var multi_ids=$(elem).attr("title");if(0!==multi_ids.indexOf("-")){for(var show_flag=!0,multi_ids_values=multi_ids.split(","),i=0;i<multi_ids_values.length;i++)if(!(-1!==flags.indexOf(multi_ids_values[i].trim())||-1!==items.indexOf(multi_ids_values[i].trim())||Util.canUseMagicByName(multi_ids_values[i].trim())||Util.ifStatus(multi_ids_values[i].trim())||Util.isCharaState(multi_ids_values[i].trim())||Util.hasStars(multi_ids_values[i].trim())||Util.hasResult(multi_ids_values[i].trim()))){show_flag=!1;break}show_flag&&$(elem).show()}else{for(var hide_flag=!0,multi_ids_values=multi_ids.substring(1).split(","),i=0;i<multi_ids_values.length;i++)if(!(-1!==flags.indexOf(multi_ids_values[i].trim())||-1!==items.indexOf(multi_ids_values[i].trim())||Util.canUseMagicByName(multi_ids_values[i].trim())||Util.ifStatus(multi_ids_values[i].trim())||Util.isCharaState(multi_ids_values[i].trim())||Util.hasStars(multi_ids_values[i].trim())||Util.hasResult(multi_ids_values[i].trim()))){hide_flag=!1;break}hide_flag&&$(elem).hide()}}),$(".scenebtn:hidden + br",target).remove(),$("a[title]:hidden",target).remove();var tmp_path="",new_bgm=scene.attr("bgm");tmp_path=save_data.bgm?save_data.bgm:bgms_map.main,void 0!==new_bgm&&(tmp_path=""===new_bgm?bgms_map.main:new_bgm);var audio_path=Util.buildBgmPath(tmp_path);if((!bgm||bgm&&void 0!==new_bgm&&new_bgm!==save_data.bgm)&&(Util.playBgm(audio_path),void 0!==new_bgm&&(save_data.bgm=new_bgm)),scene.attr("se")){var se=new Audio(ROOT+scenario_code+"/"+BGM+SE+scene.attr("se")+".mp3");se.loop=!1,se.play()}Util.endScenario(scene.attr("end"),void 0===scene.attr("bgm"))}}};$.fn.extend({startGame:function(code,debug){scenario_code=code,debug||(debug=!1),debug_mode=debug,(target=this).addClass("main_back"),target.off(),target.parent().off(),$(document).off("click","#dialog_list img.bonus_item"),$(window).off("popstate"),target.on("click","a.scenebtn",function(e){var num=$(this).attr("href"),cond=$(this).attr("title");-1!==num.indexOf(",")&&(num=Util.randomArray(num.split(",")).trim()),Util.createScene(num,{conditions:cond}),bgm&&bgm.paused&&global_save_data.bgm&&bgm.play(),e.preventDefault()}),target.on("click","a.scene_move",function(e){var num=$("#toscene").val(),allow_num=$(this).attr("data-allow");Util.canSceneMove(num,allow_num)?Util.createScene(num):(toastr.options.timeOut=4e3,toastr.warning("指定された番号には移動できないようだ")),e.preventDefault()}),target.on("click","a.quest_str",function(e){var answer=$("#stranswer").val(),yn=$(this).attr("data-yesno").split(",");if(answer===yn[0])var to_move=yn[1];else var to_move=yn[2];Util.createScene(to_move),e.preventDefault()}),target.on("click","tr.enemy_row",function(e){var enemy=enemies_map[$(this).attr("data-enemy")];toastr.options.timeOut=5e3,toastr.info(enemy.desc,enemy.name)}),target.on("click","input.enemy_check",function(e){e.stopImmediatePropagation()}),target.on("click","input.enemy_func",function(e){e.stopImmediatePropagation(),toastr.options.timeOut=5e3;var func=$(this).val(),attack=$(this).attr("data-attack");if(-1!==["poison","frozen","stone","curse","forget"].indexOf(attack)){var cond=func.split(/([<>])/),l_damage=Util.computeDamage(cond[0]),r_damage=Util.computeDamage(cond[2]);if("<"===cond[1])var canEscape=l_damage<r_damage;else var canEscape=l_damage>r_damage;canEscape?toastr.info("回避に成功した。","状態異常"):(save_data.chara.state=attack,toastr.error("「"+Common.state_names[attack]+"」を受けた！","状態異常"))}else{var damage=Util.computeDamage(func);if(damage<0&&(damage=0),"physics"===attack){save_data.chara.hp=Number(save_data.chara.hp)-damage;var t_msg="HPに"+damage+"のダメージ！（現在値："+save_data.chara.hp+"）"}else{save_data.chara.mp=Number(save_data.chara.mp)-damage;var t_msg="MPに"+damage+"のダメージ！（現在値："+save_data.chara.mp+"）"}0===damage?(t_msg="敵の攻撃を防ぎきった！",toastr.info(t_msg,"被ダメージ")):toastr.error(t_msg,"被ダメージ")}Util.saveStorage(),Util.showSimpleStatus()}),target.on("click","input.enemy_drop",function(e){e.stopImmediatePropagation();var drops=$(this).attr("data-drop").split("/");if(2===drops.length)Util.updateStarById(drops[0],drops[1]),toastr.options.timeOut=5e3,toastr.info(Common.star_names[drops[0]]+"の欠片を"+drops[1]+"個取得しました。","アイテム獲得");else{var at_free1="free1"===drops[0]?drops[1]:0,at_free2="free2"===drops[0]?drops[1]:0,at_free3="free3"===drops[0]?drops[1]:0;Util.updateFrees(at_free1,at_free2,at_free3),toastr.options.timeOut=5e3,toastr.info(drops[2]+"を取得しました。","アイテム獲得")}Util.saveStorage()});var ad=new Audio(ROOT+COMMON+"dice.mp3"),rotate_count,rotateCube=function(){rotate_count++,$("#cubes").html(Util.cube(2)),rotate_count>20||setTimeout(rotateCube,50)};target.on("click","#cubes",function(e){ad.play(),rotate_count=1,rotateCube(this)}),target.on("click","#status_open",function(e){Util.createDialog(),e.preventDefault()}),target.on("contextmenu",function(e){Util.createDialog(),e.preventDefault()}),target.on("click","#audio_onoff",function(e){bgm&&(global_save_data.bgm?(global_save_data.bgm=!1,$(this).attr("src",ROOT+COMMON+"ctrl_audio_off.png"),bgm.pause()):(global_save_data.bgm=!0,$(this).attr("src",ROOT+COMMON+"ctrl_audio_on.png"),bgm.play()),Util.saveStorageGlobal())}),target.parent().on("click","#dialog_body #status_save",function(e){save_data.chara.job=$("#dialog_body #job").val(),save_data.chara.hp=$("#dialog_body #hp").val(),save_data.chara.mp=$("#dialog_body #mp").val(),save_data.chara.free1=$("#dialog_body #free1").val(),save_data.chara.free2=$("#dialog_body #free2").val(),save_data.chara.free3=$("#dialog_body #free3").val(),save_data.chara.str=$("#dialog_body #str").val(),save_data.chara.int=$("#dialog_body #int").val(),save_data.chara.dex=$("#dialog_body #dex").val(),save_data.chara.krm=$("#dialog_body #krm").val(),save_data.chara.state=$('#dialog_body [name="state"]:checked').val(),save_data.stars[0]=$("#dialog_body #s_mon").val(),save_data.stars[1]=$("#dialog_body #s_tue").val(),save_data.stars[2]=$("#dialog_body #s_wed").val(),save_data.stars[3]=$("#dialog_body #s_thu").val(),save_data.stars[4]=$("#dialog_body #s_fri").val(),save_data.stars[5]=$("#dialog_body #s_sat").val(),save_data.stars[6]=$("#dialog_body #s_sun").val(),save_data.memos=$("#dialog_body #memos").val(),Util.saveStorage(),Util.showSimpleStatus(),dialog.slideUp(500),target.slideDown(500)}),target.parent().on("click","#dialog_body #status_close",function(e){dialog.slideUp(500),target.slideDown(500)}),target.parent().on("click",'#dialog_body [name="state"]',function(e){var delta=Util.deltaStatus($(this).val());$("#dialog_body #state_desc").text(delta[4]),Util.setStateStyle()});var useStar=function(magic,index,name){if(magic[index]>0){var num=$("#dialog_body "+name).val();$("#dialog_body "+name).val(num-magic[index])}};target.parent().on("click","#dialog_body #magic_run",function(e){e.preventDefault();var magic=Common.magic[$("#dialog_body #magic option:selected").val()];magic&&($("#dialog_body #s_mon").val()<magic[0]||$("#dialog_body #s_tue").val()<magic[1]||$("#dialog_body #s_wed").val()<magic[2]||$("#dialog_body #s_thu").val()<magic[3]||$("#dialog_body #s_fri").val()<magic[4]||$("#dialog_body #s_sat").val()<magic[5]||$("#dialog_body #s_sun").val()<magic[6]?window.alert("星が不足しているため、魔法を発動できません！"):(useStar(magic,0,"#s_mon"),useStar(magic,1,"#s_tue"),useStar(magic,2,"#s_wed"),useStar(magic,3,"#s_thu"),useStar(magic,4,"#s_fri"),useStar(magic,5,"#s_sat"),useStar(magic,6,"#s_sun")))}),target.parent().on("click","#dialog_body #status_change",function(e){var b;"none"===$("#status_basic").css("display")?($("#status_change").val("Equipment"),$("#status_basic").show(),$("#status_equip").hide()):($("#status_change").val("Basic Status"),$("#status_basic").hide(),$("#status_equip").show())}),target.parent().on("click","#dialog_body .spinner_up",function(e){var prev=$(this).prev();prev.val(Number(prev.val())+1)}),target.parent().on("click","#dialog_body .spinner_down",function(e){var next=$(this).next();next.val(Number(next.val())-1)}),target.on("click","#item_list",function(e){$.zoombox.html(dialog_item.html(),{width:650,height:450})}),$(document).on("click","#dialog_list img.bonus_item",function(e){var id=e.target.id,o_bonus_item;o_bonus_item=id.startsWith("gi")?Common.global_items.happy[id]:Common.global_items.bad[id],$("#dialog_list #bonus_msg").text(o_bonus_item.name+"（"+o_bonus_item.desc+"）")}),target.on("click","#ctrl_home",function(e){location.href="http://www.web-deli.com/sorcerian/next/stext.aspx"}),target.on("click","#ctrl_reload",function(e){$.get(ROOT+COMMON+"dialog_result.html").done(function(data){var result_count=0,get_result=0,trophy=["","ノーマル","ブロンズ","シルバー","ゴールド","プラチナ"],dialog_results=$(data);Object.keys(results_map).forEach(function(key){if(result_count++,void 0!==global_save_data.results[scenario_code]&&-1!==global_save_data.results[scenario_code].indexOf(key)){get_result++;var row='<tr><td><img src="stext/common/trophy'+results_map[key].level+'.png" title="'+trophy[results_map[key].level]+'" /></td><td><h3>'+results_map[key].name+"（Lv."+results_map[key].level+"）</h3><p>"+results_map[key].desc+"</p></td></tr>"}else var row='<tr><td><img src="stext/common/trophy0.png" title="実績未達" /></td><td><h3>???????????????</h3><p>???????????????</p></td></tr>';$(".result_list",dialog_results).append(row)});var result_rate=(get_result/result_count*100).toFixed(1);$("#result_rate",dialog_results).text("Rate:"+result_rate+"%"),$.zoombox.html(dialog_results.html(),{width:480,height:200})})}),target.on("click","#ctrl_help",function(e){window.open("http://d.hatena.ne.jp/sorcerian/20171220")}),target.on("click","#scenario_title",function(e){var ctrl;"none"===$("#control_panel").css("display")?($("#control_panel").slideDown(),global_save_data.panel=!0):($("#control_panel").slideUp(),global_save_data.panel=!1),Util.saveStorageGlobal()}),$(window).on("popstate",function(e){null!=e.originalEvent.state&&(save_data=e.originalEvent.state,Util.saveStorage(),Util.createScene(e.originalEvent.state.scene,{reverse:!0}))}),target.on("click","#restart #tmp_init",function(e){Util.initScenario()}),target.on("click","#restart #tmp_continue",function(e){Util.initJobs(),Util.initDialog(),Util.createCommonTweet();var num=save_data.scene;Util.createScene(num,{reverse:!0,restore:!0})}),storage.sorcerian_text?Util.loadStorageGlobal():Util.initGlobalSaveData();var done_read=function(result){for(var key in scenario_data=result,Common.magic){for(var magic=Common.magic[key],stars="",star_names=["月","火","水","木","金","土","太"],i=0;i<7;i++)magic[i]>0&&(stars+=star_names[i]+magic[i]+" ");magic.push(stars)}flags_map={},$("flags > flag",scenario_data).each(function(){flags_map[$(this).attr("id")]=$(this).text().trim()}),enemies_map={},$("enemies > enemy",scenario_data).each(function(){enemies_map[$(this).attr("id")]={name:$(this).attr("name"),element:$(this).attr("element"),attack:$(this).attr("attack"),func:$(this).attr("func"),drop:$(this).attr("drop"),desc:$(this).text()}}),console.log(enemies_map),items_map={},$("items > item",scenario_data).each(function(){items_map[$(this).attr("id")]={name:$(this).attr("name"),desc:$(this).text().trim()}}),results_map={},$("results > result",scenario_data).each(function(){results_map[$(this).attr("id")]={name:$(this).attr("name"),level:$(this).attr("level"),desc:$(this).text().trim()}});var init_bgms=$("init > bgm",scenario_data),i_main=init_bgms.attr("main"),i_happy=init_bgms.attr("happy"),i_bad=init_bgms.attr("bad");if(bgms_map={main:void 0===i_main?"main":i_main,happy:void 0===i_happy?"happy":i_happy,bad:void 0===i_bad?"bad":i_bad},console.log(bgms_map),!0===debug_mode){var errors=Util.validateScenario();if(0!==errors.length){var msgs="<h3>scenario.xmlでエラーが検出されました。</h3>";return msgs+='<ul class="errorlist">',errors.forEach(function(err){msgs+="<li>Scene "+err.scene_id+": "+err.message+"</li>"}),msgs+="</ul>",void target.html(msgs)}}if(!storage[scenario_code]||(Util.loadStorage(),save_data.isEnded))Util.initScenario();else{var msg='<div id="restart"><h3>Welcome to SORCERIAN Text!!</h3><p>以前のデータが残っています。<br />続きから開始しますか？</p><button id="tmp_continue">続きから</button> <button id="tmp_init">最初から</button></div>';target.html(msg)}};if(0===(scenario_code=scenario_code.trim()).indexOf("<")){var parser,tmp_data=(new DOMParser).parseFromString(scenario_code,"text/xml");scenario_code="playground",global_save_data.results.playground=[],Util.saveStorageGlobal(),done_read(tmp_data)}else $.get(ROOT+scenario_code+"/scenario.xml").done(done_read).fail(function(xhr,status,error){throw new Error("scenario code is invalid.")})},gbat2stext:function(callback){$(this).change(function(e){var file_num=0,result=$('<scenario xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://www.web-deli.com/sorcerian/next/stext/common/sgml.xsd">\n</scenario>'),inits=$("<init>\n</init>"),items=$("<items>\n</items>"),flags=$("<flags>\n</flags>"),enemies=$("<enemies>\n</enemies>"),results=$("<results>\n</results>"),license=$("<licence>\n</licence>"),readFile=function(e){var gbat=$(this.result),title_author=$("title",gbat).text().trim().split("@");if(result.attr("title")||(result.attr("title",title_author[0]),result.attr("author",title_author[1])),$("section",gbat).each(function(i,section){var header_on=!1,attrs={};if(attrs.id=Number($("number",section).text()),1===attrs.id&&(attrs.id=0),"link"===$("> summary",section).text().toLowerCase())return!0;var body="\n";$("> text p",section).each(function(j,para){var tmp_para=$(para).text();if("@@"===tmp_para.trim())return header_on=!header_on,!0;if(header_on){if(!tmp_para)return!0;if(0===tmp_para.indexOf("pc")){var pc=tmp_para.split(":"),cons=$("<constraint></constraint>");pc[1]&&cons.attr("race",pc[1]),pc[2]&&cons.attr("sex",pc[2]),pc[3]&&cons.attr("age",pc[3]),cons.appendTo(inits)}else if(0===tmp_para.indexOf("bgm")){var bgm=tmp_para.split(":"),initBgm=$("<bgm></bgm>");bgm[1]&&initBgm.attr("main",bgm[1]),bgm[2]&&initBgm.attr("happy",bgm[2]),bgm[3]&&initBgm.attr("bad",bgm[3]),initBgm.appendTo(inits)}else if(0===tmp_para.indexOf("intro")){var intro=tmp_para.split(":"),initIntro=$("<intro></intro>");intro[1]&&initIntro.attr("description",intro[1]),initIntro.appendTo(inits)}else if(0===tmp_para.indexOf("i")){var item=tmp_para.split(":");$("<item></item>").attr("id",item[0]).attr("name",item[1]).text(item[2]).appendTo(items)}else if(0===tmp_para.indexOf("f")){var flag=tmp_para.split(":");$("<flag></flag>").attr("id",flag[0]).text(flag[1]).appendTo(flags)}else if(0===tmp_para.indexOf("m")){var enemy=tmp_para.split(":");$("<enemy></enemy>").attr("id",enemy[0]).attr("name",enemy[1]).attr("element",enemy[2]).attr("attack",enemy[3]).attr("func",enemy[4]).attr("drop",enemy[5]).text(enemy[6]).appendTo(enemies)}else if(0===tmp_para.indexOf("r")){var result=tmp_para.split(":");$("<result></result>").attr("id",result[0]).attr("name",result[1]).attr("level",result[2]).text(result[3]).appendTo(results)}else if(0===tmp_para.indexOf("w")){var work=tmp_para.split(":");$("<work></work>").attr("name",work[1]).attr("category",work[2]).attr("creator",work[3]).attr("url",work[4]?"//"+work[4]:"").appendTo(license)}else if(0===tmp_para.indexOf("@")){var attr=tmp_para.substring(1).split(":");void 0===attr[1]&&(attr[1]=""),attrs[attr[0]]=attr[1]}}else body+=tmp_para+"\n"}),body+="\n",$("choices choice",section).each(function(k,cho){var caption=$("text p",cho).text().trim().split("@"),dest=$("destination",cho).text();if("999"===dest){var tmp="[";tmp+=caption[0],tmp+="](X)\n"}else if("998"===dest){var tmp="[";tmp+=caption[0],tmp+="](Q)\n"}else{var tmp="[";tmp+=caption[0],tmp+="](",tmp+=dest,caption[2]&&(tmp+=","+caption[2]),caption[1]&&(tmp+=' "'+caption[1]+'"'),tmp+=")\n"}body+=tmp});var scene=$("<scene></scene>\n").attr("id",attrs.id).text(body);void 0!==attrs.items&&scene.attr("items",attrs.items),void 0!==attrs.flags&&scene.attr("flags",attrs.flags),void 0!==attrs.enemies&&scene.attr("enemies",attrs.enemies),void 0!==attrs.stars&&scene.attr("stars",attrs.stars),void 0!==attrs.free1&&scene.attr("free1",attrs.free1),void 0!==attrs.free2&&scene.attr("free2",attrs.free2),void 0!==attrs.free3&&scene.attr("free3",attrs.free3),void 0!==attrs.bgm&&scene.attr("bgm",attrs.bgm),void 0!==attrs.se&&scene.attr("se",attrs.se),void 0!==attrs.allowMove&&scene.attr("allowMove",attrs.allowMove),void 0!==attrs.result&&scene.attr("result",attrs.result),void 0!==attrs.end&&scene.attr("end",attrs.end),scene.appendTo(result)}),license.prependTo(result),results.prependTo(result),enemies.prependTo(result),flags.prependTo(result),items.prependTo(result),inits.prependTo(result),++file_num>=inputs.length)if(callback)callback(result);else{var content=vkbeautify.xml('<?xml version="1.0" encoding="utf-8"?>\n'+result.get(0).outerHTML),blob=new Blob([content],{type:"application/octet-stream"}),anchor=document.createElement("a");anchor.href=window.URL.createObjectURL(blob),anchor.download="scenario.xml",anchor.click()}else reader.readAsText(inputs[file_num],"UTF-8")},inputs=$(this).get(0).files,reader=new FileReader;$(reader).on("load",readFile),reader.readAsText(inputs[file_num],"UTF-8")})},backupData:function(selector){var dl=function(scena_id,data){var blob=new Blob([data],{type:"application/octet-stream"}),anchor=document.createElement("a");anchor.href=window.URL.createObjectURL(blob);var today=new Date;anchor.download=scena_id+"-"+(new Date).getTime()+".stext",document.body.appendChild(anchor),anchor.click(),document.body.removeChild(anchor)};$(this).click(function(){var content="",storage=localStorage,scenario=$(selector).val();if("all"===scenario)$.get(ROOT+"stext.xml").done(function(data){var ids=["sorcerian_text"];$("work[id]:not([unpublished])",data).each(function(i,elm){ids.push($(elm).attr("id"))});for(var i=0;i<ids.length;i++){var tmp_data=storage[ids[i]];tmp_data&&(content+=ids[i]+"\n",content+=tmp_data+"\n")}dl(scenario,content)});else{if(!(content=storage[scenario]))return void window.alert("データが存在しません！");dl(scenario,content)}})},restoreData:function(){$(this).change(function(){var input=this.files[0],fname=input.name.split("-")[0],reader=new FileReader;$(reader).on("load",function(){var data=reader.result.split("\n"),storage=localStorage;if("all"===fname)for(var key="",value="",i=0;i<data.length;i++)i%2==0?key=data[i]:(value=data[i])&&(storage[key]=value);else storage[fname]=reader.result}),reader.readAsText(input,"UTF-8"),window.alert("リストアが完了しました。\r（起動している場合は）ゲーム画面をリロードしてください。")})}})}(jQuery);