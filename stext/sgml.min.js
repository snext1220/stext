!function($){var ROOT="stext/",COMMON="common/",CAPTURE="capture/",scenario_code,scenario_data,flags_map={},enemies_map={},items_map={},results_map={},save_data,global_save_data,GLOBAL_SAVE_DATA_KEY="sorcerian_text",target,dialog,dialog_item,debug_mode=!1,bgm,bgm_name,Common={male_name:["ボブ","デュエル","ゴルカス","ジェノバン","グーラン","ジャンビエ","グログス","コル","フロニアス","グーリム","カザミィ","ソロン","ゼン","ヴォル","マルス","レイザー","ミリオン","エリック","ジロ","ソード","ディル","ガタビア","ラウア","ハルビン","グドン","ジャミル","ディカン","ダート","タットワ5世","ディカン","ホド","ゲプラー","コクマー","グレアム","ロウポー","ラッツ","ソルト","ランブル","ネイル","ルシアン","ギム","チェイサー","ルワン","ゾーク","オルム","テュモー","バロン","カメロン","トード","グンダ","フラジオレ","ファン＝フレディ","ファネッサ3世","クリフト4世","クォール","ディオン","ホゼア","ロラッド","バルナ","ティゲロ","テト","ニフト","オーサー","ゲディス","レオン","アンドリュー","キリー","トーマス","エディ","ノーマス","ギルデン","ノーネーム","ユイター","デュオン","ペトス","フェリス","スラン","アルフレッド","ソクラム","アルモス","ログレック","ラルーゴ","キッド","ドレイク","ウォルトス","レスター","テリー","グラハン","ラドール","ウェステル","フェスタ","バンブー","ゲルフス","ドン・コサック","ベオグラード","ピエール","タルフ","エヴァン","ドゥール","バルガス","アーサー","ガッシュ","エルウッド","ヘルナー","エリック","ジャグラー","アラン","ロニアス","アスタル","ボルックス","ラドナー","ギルバレス","ジャレス","ルー","スズキ","ジロサ","サントリーニ","ルルイエ","コーラル","ボマード","ナルシス","マーヴァル","クール","ヨシュア","エヴァム","ジャンク","ボイド","ヘクター","デンキブラウン","バイアス","ブロイム","ディンギル","リグ","バド","ジード","ラルザス","ガイキナ","ロッド","ケイン","ルーミス","タジート","ブレイス","ディンクス","マーク","ホホホ","テシター","J.B","ジン","マック","リラ","ジバ","バーラン","ポジティル","ネガティル","ファルカス","ファウネス","ファルカス","チェン","パズス12世","タムタム","リーク・ディオン","タウラー","ラルディ","ノーマス","アドロン","ロカルノ","ゲラン","シュヴェーリン","ローラン","ウェッジ","アントロノフ","キム","ヤン","デフ","ミケロ","クール","ティエンルン","コウ","マルク","オーエン","トート","グート","マウアー","ザンダー","バルダ","キーリエ","マルス","セム","ターバ","グロス","クルトン","ザムル","エルフィン","グラハン","ガウェイン","アドル","ゴーバン","ドギ","ルタ","ダレス","ダルク＝ファクト","クーブラ＝カーン","ガルシウス","クロノス","カイロス","ディアルド","チッタ","カズン","ルイス","セネリー","ライネル","エス","カリー","ドレイク","ダニー","ドリー","ケイリス","ノートン","クラウド","ウォーリー","レイモンド","サザール","メテオロイド","ナッシュ","ルロイ","ライトル","カディアン","ブラウン","シュナイダー","セシル","グレンザー","ゴイル","ビル","グリメルム","ガルベス","ジルドバ","アレクシウスX世","ピエール","ジェラルド","ロベルト","エティス","アル＝ファルコ","ラシーン","ロデム","J.D.マックス","パーム","シド"],female_name:["エスター","クリスティ","アイリーン","フェルディナン","リタ","トーヤ","ノルン","ウィンディーネ","プリム","ピアナ","エメラーダ","エレア","エヴァ","リム","ビナー","ティファレト","ミラドゥ","パナシェ","ミモザ","リューズ","エレーナ","リーア","キアラ","オルアラ","クオレ","セーナ","リーザ","セリナ","リリィ","ピピ","ビヌス","アンナ","リュシエル","フィレン","カレン","エリン","ローラ","マーベラ","ジョセフィーヌ","アネリーナ","リオナ","ジョアンナ","レニッサ","ジェニス","グリンダ","マティナ","ローナ","コッキー","チェルシー","ネリス","アリーナ","フェリッサ","マリエル","ベララ","ジョゼフ","ニッカ","テキーラ","ソルティ","パイン","ウィズ","カンニバル","ミント","リーン","ミル","ディアンナ","レティア","サフィス","エミス","ヴァムリー","サリア","ナイジェス","ミューリア","エミリア","シャル","バーバラ","オビア","スチュアート","ベーラ","サマリーヌ","フィアネ","レナ","ソル","ネイラ","セレーネ","アルバ","ラン","ルー・パズス","シルフィ","ミレット","レフィーナ","モスマ","チブル","鈴鈴","明明","ティキ","サリア","ミュール","ダール","ミンナ","レーシャ","エレイア","レア","フィーナ","ジャネット","ナリス","ソチ","ポーラス","ロキア","フリージ","エスメレー","エレナ","アルティ","エビオラ","フィナ"],title:["武器屋の親父","ペンタウァの長老","トラベラーズインの宿主","人と上手に話したい","ペンタウァ近衛隊長","","タリスマンの見張り","瞑想中","砂漠の飯炊き","狂戦士","エレベーターの管理人","盗賊の頭領","暗き沼の魔法使い","ロマンシア国王","アゾルバ国王","ペンタウァ国王","蚕職人","妖精王","暗黒の魔導士","クイーンマリー号船長","キタブ・アル・アジフの持ち主","メデューサハンターの弟子","ファルコムマン","戦士の亡霊","海賊の子孫","いけにえの神官","東の村の村長","麻薬中毒者","ヴァネルバの王","銀の竪琴屋","近衛隊長","復讐の呪術師","ラフォーヌの森の管理人","リドニア王国の元兵士","姫の教育係","大魔王","紫ウニの王子","ベララの家族","時計塔の番人","時計塔の魔女","ナルキッソス号船長","ディンギル王国の3神官","バドティビラ工場の指揮官","シュメール国王","サンサーラの山賊","南村の村長","アイテム屋WIZの店主","旅の吟遊詩人","古代イスマリアの王","時の神殿の書記官","闇の王","ランドル村長","魔法学校の校長","魔法学校の用務員","マリオネットの王","ペンタウァの近衛兵","陽の中の闇人","赤毛の冒険者","光の王","イリアスンの執政官","魔の下僕","メデューサハンター","邪神教徒","邪神教々祖","砂漠の王","鍵の番人","ローデシア辺境司令官","宇宙からの訪問者","黒竜仙人","猿大聖","極楽寺の僧兵","ジャグラー族","迷宮建築の第一人者","フリース村の村長","ペンタウァ一の科学者アンド予言者","暴れザル","魔法学校の校長","人魚３姉妹の長女","マリオネットの王","探求の学徒","旅芸人の一座","猛獣使い","流れの傭兵","氷の魔女","パペッテの人形遣い","バーテンダー","宮仕えのシャーマン","薬草亭の主人","水門の管理人"],pc_init:[["FIGHTER","MALE",85,55,7,3,6,4],["FIGHTER","FEMALE",80,60,6,4,6,4],["WIZARD","MALE",55,85,4,8,5,3],["WIZARD","FEMALE",50,90,3,8,5,4],["DWARF","MALE",90,50,8,2,8,2],["DWARF","FEMALE",85,55,7,3,8,2],["ELF","MALE",65,75,4,6,5,5],["ELF","FEMALE",60,80,2,7,5,6]],magic:{HEAL:[0,0,0,1,0,1,0,"HPを15回復"],PEACE:[0,0,1,0,1,0,0,"MPを10回復"],CURE:[0,0,0,0,1,0,1,"毒回復"],MELT:[0,1,0,0,1,1,1,"凍結を回復"],"STONE-FLESH":[0,0,0,1,1,1,1,"石化を回復"],"UN-CURCE":[2,0,1,0,0,1,0,"呪いを回復"],"AIR-HAND":[1,0,1,0,1,0,1,"見えない拳の衝撃で、忘却を回復"],RESURRECT:[0,0,0,1,3,0,1,"HP/MP半分で復活（但し、冒険に一度だけ）"],"REDUCE-LIFE":[0,1,1,0,1,1,0,"体力を犠牲に（HP-25）、すべての状態異常を回復"],REJUVENATE:[0,2,0,1,0,0,1,"時の流れを巻き戻し（現在の判定をやり直し）"],PROTECT:[1,0,0,1,1,0,1,"HPダメージを半減"],"HOLY-WATER":[0,0,2,2,0,0,0,"MPダメージを半減"],"CHANGE-AIR":[1,0,0,1,1,1,0,"戦闘を回避（アイテムは得られない）"],"GIVE-VIGOR":[1,1,1,0,0,1,0,"敵の攻撃力が2倍＆取得アイテム2倍"],EXPLOSION:[0,1,0,1,0,1,2,"地属性の敵を全滅"],DELUGE:[4,0,0,0,0,1,0,"火属性の敵を全滅"],FREEZE:[0,2,0,0,0,1,2,"水属性の敵を全滅"],"DESTROY-A":[1,0,4,0,0,0,0,"風属性の敵を全滅"],"LIGHT-CROSS":[0,2,0,2,0,1,0,"霊属性の敵を全滅"],"NOILA-TEM":[1,1,1,1,1,1,1,"すべての属性の敵を全滅"]},global_items:{happy:{gi01:{name:"金の卵",desc:"月の欠片を5個所有した状態で冒険を開始"},gi02:{name:"ガラティーン",desc:"火星の欠片を5個所有した状態で冒険を開始"},gi03:{name:"五元素のマント",desc:"水星の欠片を5個所有した状態で冒険を開始"},gi04:{name:"アマゾンの剣",desc:"木星の欠片を5個所有した状態で冒険を開始"},gi05:{name:"幸福のコイン",desc:"金星の欠片を5個所有した状態で冒険を開始"},gi06:{name:"ムラサメブレード",desc:"土星の欠片を5個所有した状態で冒険を開始"},gi07:{name:"G・スレイヤー",desc:"太陽の欠片を5個所有した状態で冒険を開始"},gi08:{name:"水晶の剣",desc:"左サイコロが5以上の時、そのシーンでHPを1回復"},gi09:{name:"王様の杖",desc:"左サイコロが5以上の時、そのシーンでMPを1回復"},gi10:{name:"ブルーリボン",desc:"戦闘ダメージを1減算"},gi11:{name:"王家のダイヤモンド",desc:"罠ダメージを1減算"},gi12:{name:"不老長寿の水",desc:"冒険中に一度だけHPを半分回復できる"},gi13:{name:"タリスマン",desc:"冒険中に一度だけMPを半分回復できる"},gi14:{name:"鏡の盾",desc:"HPダメージを1減算"},gi15:{name:"銀の竪琴",desc:"MPダメージを1減算"},gi16:{name:"パンドラの箱",desc:"右サイコロが4以上の時、戦闘回避が可能"},gi17:{name:"魔法の絨毯",desc:"右サイコロが5以上の時、罠回避"},gi18:{name:"中和剤",desc:"毒耐性"},gi19:{name:"聖水",desc:"呪い耐性"},gi20:{name:"チルドの実",desc:"凍結耐性"},gi21:{name:"銀のハーモニカ",desc:"石化耐性"},gi22:{name:"真実の鏡",desc:"忘却耐性"},gi23:{name:"D・スレイヤー",desc:"すべての星を1個所有した状態で冒険を開始"}},bad:{bgi01:{name:"塩酸",desc:"シーン毎にダイス合計が5未満でHPを1減算、5以上でMPを1回復"},bgi02:{name:"紅玉",desc:"シーン毎にダイス合計が5未満でMPを1減算、5以上でHPを1回復"},bgi03:{name:"血まみれの斧",desc:"冒険開始時に呪い。解除で3回まで星消費せず魔法発動可"},bgi04:{name:"トリカブト",desc:"冒険開始時に毒。但し、解除までシーン毎にMPを1回復"},bgi05:{name:"ギャルのパンティー",desc:"冒険開始時に忘却。但し、解除までSTR/INT0でない方を10"}}}},Util={random:function(min,max){return Math.floor(Math.random()*(max-min+1))+min},minMaxGuard:function(num){return num<0?0:num>10?10:num},randomArray:function(data){return data[Math.floor(Math.random()*data.length)]},pushUnique:function(data,value){return-1===data.indexOf(value)&&(data.push(value),!0)},shiftUnique:function(data,value){return data.filter(function(elem){return elem!==value})},ltrim:function(str){return str.substr(1)},saveStorage:function(){localStorage[scenario_code]=JSON.stringify(save_data)},loadStorage:function(){save_data=JSON.parse(localStorage[scenario_code])},saveStorageGlobal:function(){localStorage.sorcerian_text=JSON.stringify(global_save_data)},loadStorageGlobal:function(){global_save_data=JSON.parse(localStorage.sorcerian_text)},initSavedata:function(){var pc_base=this.randomArray(Common.pc_init),hp_m=this.random(pc_base[2],pc_base[2]+10),mp_m=this.random(pc_base[3],pc_base[3]+10),str_i=this.minMaxGuard(this.random(pc_base[4],pc_base[4]+2)),int_i=this.minMaxGuard(this.random(pc_base[5],pc_base[5]+2)),dex_i=this.minMaxGuard(this.random(pc_base[6],pc_base[6]+2)),krm_i=this.minMaxGuard(this.random(pc_base[7],pc_base[7]+2)),old_data=localStorage[scenario_code],old_memo="";old_data&&(old_memo=(old_data=JSON.parse(old_data)).memos),save_data={chara:{name:"MALE"===pc_base[1]?this.randomArray(Common.male_name):this.randomArray(Common.female_name),title:this.randomArray(Common.title),race:pc_base[0],sex:pc_base[1],age:this.randomArray(["YOUNG","ADULT","OLD"]),state:"",hp_m:hp_m,hp:hp_m,mp_m:mp_m,mp:mp_m,str_i:str_i,str:str_i,int_i:int_i,int:int_i,dex_i:dex_i,dex:dex_i,krm_i:krm_i,krm:krm_i,free1:0,free2:0},stars:[0,0,0,0,0,0,0],items:[],flags:[],memos:old_memo,scene:0,ellapsed_scene:0,bgm:"",bonus:this.randomArray(global_save_data.items),isEnded:!1},this.saveStorage()},initGlobalSaveData:function(){global_save_data={items:[],results:{},bgm:!0,panel:!0},this.saveStorageGlobal("sorcerian_text")},validateScenario:function(){var error_messages=[],tmp_scenes=[],checkId=function(org,value,scene_id){if(void 0!==value&&""!==value){var ids=value.trim().split(","),keys=Object.keys(org);ids.forEach(function(id){id=id.replace("-",""),-1===keys.indexOf(id)&&error_messages.push({scene_id:scene_id,message:id.startsWith("i")?"アイテムコード"+id+"が未登録です。":id.startsWith("f")?"フラグコード"+id+"が未登録です。":id.startsWith("m")?"敵コード"+id+"が未登録です。":"実績コード"+id+"が未登録です。"})})}};return $("scene",scenario_data).each(function(index,scene){var tmp_s=$(scene);-1===tmp_scenes.indexOf(tmp_s.attr("id"))?tmp_scenes.push(tmp_s.attr("id")):error_messages.push({scene_id:tmp_s.attr("id"),message:"scene－idが重複しています。"}),checkId(items_map,tmp_s.attr("items"),tmp_s.attr("id")),checkId(flags_map,tmp_s.attr("flags"),tmp_s.attr("id")),checkId(enemies_map,tmp_s.attr("enemies"),tmp_s.attr("id")),checkId(results_map,tmp_s.attr("result"),tmp_s.attr("id"))}),error_messages},canUseMagic:function(magic){return!(save_data.stars[0]<magic[0]||save_data.stars[1]<magic[1]||save_data.stars[2]<magic[2]||save_data.stars[3]<magic[3]||save_data.stars[4]<magic[4]||save_data.stars[5]<magic[5]||save_data.stars[6]<magic[6])},updateItems:function(at_items){if(at_items){for(var items=save_data.items,at_items=at_items.split(","),i=0;i<at_items.length;i++){var item=at_items[i].trim();0===item.indexOf("-")?(item=this.ltrim(item),items=this.shiftUnique(items,item)):this.pushUnique(items,item)}save_data.items=items}},updateFlags:function(at_flags){if(at_flags)for(var flags=save_data.flags,at_flags=at_flags.split(","),i=0;i<at_flags.length;i++){var flag=at_flags[i].trim();this.pushUnique(flags,flag)}},updateResults:function(at_result){if(at_result){void 0===global_save_data.results&&(global_save_data.results={});var results=global_save_data.results;void 0===results[scenario_code]&&0!==scenario_code.indexOf("<")&&(results[scenario_code]=[]),!0===this.pushUnique(results[scenario_code],at_result)&&this.toast("実績「"+results_map[at_result].name+"」を獲得"),this.saveStorageGlobal()}},toast:function(msg){$(".toast").remove(),$("body").append('<div class="toast">'+msg+"</div>");var leftpos=$("body").width()/2-$(".toast").outerWidth()/2;$(".toast").css("left",leftpos).hide().fadeIn("fast"),setTimeout(function(){$(".toast").fadeOut("slow",function(){$(this).remove()})},4e3)},cube:function(num){void 0===num&&(num=1);for(var html="",i=0;i<num;i++)html+='<img src="stext/common/cube'+this.random(1,6)+'.png" class="dice" />';return html},dropItem:function(element){if(!element)return"";var drop={"地":["木星","火星","土星","－","－"],"火":["火星","太陽","火星","－","－"],"水":["水星","月","金星","－","－"],"風":["金星","水星","月","－","－"],"霊":["土星","太陽","月","－","－"]};return this.randomArray(drop[element])},selectFunc:function(func){return Util.randomArray(func.split(",")).trim()},deltaStatus:function(state){switch(state){case"frozen":var state_desc="すべてのステータスを-2",str_d=-2,int_d=-2,dex_d=-2,krm_d=-2;break;case"stone":var state_desc="すべてのステータスを-1（30scene経過で死亡）",str_d=-1,int_d=-1,dex_d=-1,krm_d=-1;break;case"forget":var state_desc="STR／INTのうち、高い方が0に（20scene経過で解除）";if(save_data.chara.str<save_data.chara.int)var str_d=0,int_d=-1*save_data.chara.int;else var str_d=-1*save_data.chara.str,int_d=0;var dex_d=0,krm_d=0;break;case"poison":var state_desc="シーン経過ごとにHPを-1",str_d=0,int_d=0,dex_d=0,krm_d=0;break;case"curse":var state_desc="魔法の利用が不可（UN-CURSEを除く）",str_d=0,int_d=0,dex_d=0,krm_d=0;break;default:var state_desc="－",str_d=0,int_d=0,dex_d=0,krm_d=0}return[str_d,int_d,dex_d,krm_d,state_desc]},getBonusItem:function(bonus){return 0===bonus.indexOf("bgi")?Common.global_items.bad[bonus]:Common.global_items.happy[bonus]},initScenario:function(){Util.initSavedata(),Util.initDialog(),Util.createScene(0),history.pushState(0,"Scene 0")},initDialog:function(){$.get(ROOT+COMMON+"dialog.html").done(function(data){if(dialog=$(data),$("#name",dialog).text(save_data.chara.name),$("#title",dialog).text(save_data.chara.title),$("#race",dialog).text(save_data.chara.race),$("#sex",dialog).text(save_data.chara.sex),$("#hp_m",dialog).text(save_data.chara.hp_m),$("#mp_m",dialog).text(save_data.chara.mp_m),$("#str_i",dialog).text(save_data.chara.str_i),$("#int_i",dialog).text(save_data.chara.int_i),$("#dex_i",dialog).text(save_data.chara.dex_i),$("#krm_i",dialog).text(save_data.chara.krm_i),$("#age",dialog).text(save_data.chara.age),$("#chara_face",dialog).attr("src",ROOT+COMMON+String(save_data.chara.sex).toLowerCase()+"_"+String(save_data.chara.age).toLowerCase()+"_"+String(save_data.chara.race).toLowerCase()+".png"),save_data.bonus){var b=Util.getBonusItem(save_data.bonus);$("#bonus",dialog).text(b.desc+"（"+b.name+"）")}dialog.insertBefore(target).hide()}),$.get(ROOT+COMMON+"dialog_list.html").done(function(data){dialog_item=$(data);for(var i=0;i<24;i++)num=i<10?"0"+i:i,num="gi"+num,-1!==$.inArray(num,global_save_data.items)?$("#"+num,dialog_item).attr("src",ROOT+COMMON+num+".png").attr("class","bonus_item"):$("#"+num,dialog_item).attr("src",ROOT+COMMON+"gi99.png");for(var i=1;i<6;i++)num=i<10?"0"+i:i,num="bgi"+num,-1!==$.inArray(num,global_save_data.items)?$("#"+num,dialog_item).attr("src",ROOT+COMMON+num+".png").attr("class","bonus_item"):$("#"+num,dialog_item).attr("src",ROOT+COMMON+"gi99.png")})},createDialog:function(){$("#hp",dialog).attr("value",save_data.chara.hp),$("#mp",dialog).attr("value",save_data.chara.mp),$('[name="state"]',dialog).each(function(){var state;$(this).attr("value")===save_data.chara.state?$(this).attr("checked","checked"):$(this).removeAttr("checked")}),$("#ellapsed_scene",dialog).text(save_data.ellapsed_scene+" scene"),$("#free1",dialog).attr("value",save_data.chara.free1),$("#free2",dialog).attr("value",save_data.chara.free2),$("#str",dialog).attr("value",save_data.chara.str),$("#int",dialog).attr("value",save_data.chara.int),$("#dex",dialog).attr("value",save_data.chara.dex),$("#krm",dialog).attr("value",save_data.chara.krm),$("#s_mon",dialog).attr("value",save_data.stars[0]),$("#s_tue",dialog).attr("value",save_data.stars[1]),$("#s_wed",dialog).attr("value",save_data.stars[2]),$("#s_thu",dialog).attr("value",save_data.stars[3]),$("#s_fri",dialog).attr("value",save_data.stars[4]),$("#s_sat",dialog).attr("value",save_data.stars[5]),$("#s_sun",dialog).attr("value",save_data.stars[6]);var delta=this.deltaStatus($('[name="state"][checked="checked"]',dialog).attr("value"));$("#str_d",dialog).text("（"+delta[0]+"）"),$("#int_d",dialog).text("（"+delta[1]+"）"),$("#dex_d",dialog).text("（"+delta[2]+"）"),$("#krm_d",dialog).text("（"+delta[3]+"）"),$("#state_desc",dialog).text(delta[4]),$("#memos",dialog).text(save_data.memos);var magic_box=$("#magic",dialog);for(var key in magic_box.empty(),Common.magic){var magic=Common.magic[key],option=$("<option></option>").attr("value",key).attr("title",magic[8]).text(key+"（"+magic[7]+"）");Util.canUseMagic(magic)||option.attr("disabled","disabled"),option.appendTo(magic_box)}for(var items=[],i=0;i<save_data.items.length;i++){var item=items_map[save_data.items[i]];items.push("・"+item.name+"（"+item.desc+"）")}$("#items",dialog).text(items.join("\r"));var flags=$("#flags",dialog);flags.empty();for(var i=0;i<save_data.flags.length;i++){var tmp="<option ";i==save_data.flags.length-1&&(tmp+="selected"),tmp+=">・"+flags_map[save_data.flags[i]]+"</option>",flags.append(tmp)}dialog.slideDown(500),$("#status_change").val("Equipment"),$("#status_basic").show(),$("#status_equip").hide(),target.slideUp(500)},endScenario:function(result){if(result){var bonus_item,o_bonus_item,audio_path;switch($('<p><a href="#" onclick="location.reload(true)" class="scenebtn">最初から冒険に挑戦する</a></p>').insertBefore($("#cubes",target)),save_data.isEnded=!0,localStorage.removeItem(scenario_code),result){case"happy":bonus_item=Util.randomArray(Object.keys(Common.global_items.happy)),o_bonus_item=Common.global_items.happy[bonus_item],audio_path=ROOT+scenario_code+"/bgm_happy.mp3";break;case"bad":Util.random(0,100)<20&&(bonus_item=Util.randomArray(Object.keys(Common.global_items.bad)),o_bonus_item=Common.global_items.bad[bonus_item]),audio_path=ROOT+scenario_code+"/bgm_bad.mp3"}bgm&&bgm.pause(),(bgm=new Audio(audio_path)).loop=!0,global_save_data.bgm&&bgm.play(),bonus_item&&(Util.pushUnique(global_save_data.items,bonus_item),Util.saveStorageGlobal(),$.get("stext/common/dialog_bonus.html").then(function(data){var bonus_dialog=$(data);$("#bonus_img",bonus_dialog).attr("src",ROOT+COMMON+bonus_item+".png"),$("#bonus_item",bonus_dialog).text(o_bonus_item.name),$("#bonus_item_desc",bonus_dialog).text(o_bonus_item.desc),setTimeout(function(){$.zoombox.html(bonus_dialog.html(),{width:480,height:200})},2e3)}))}},canSceneMove:function(scene_num,allow_num){return-1!==allow_num.split(",").indexOf(scene_num)},playBgm:function(path){bgm&&bgm.pause(),(bgm=new Audio(path)).loop=!0,global_save_data.bgm&&bgm.play()},createScene:function(scene_num){if(save_data.isEnded)location.reload(!0);else{$(window).scrollTop(0);var scene=$('scene[id="'+scene_num+'"]',scenario_data),tmp_scene=scene.text();tmp_scene=(tmp_scene=(tmp_scene=tmp_scene.replace(/%(blue|red|purple)%/gi,'&nbsp;<span style="color:$1">')).replace(/%\/%/gi,"</span>&nbsp;")).replace(/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?/gi,'<a href="$&" target="_blank">$&</a>'),target.html(tmp_scene),target.markdown(),$('<h5 id="scenario_title"><img id="ctrl_show" src="stext/common/ctrl_show.png" /></a> '+$("scenario",scenario_data).attr("title")+"【"+scene_num+'】</span></h5><div id="control_panel"><img id="ctrl_home" src="'+ROOT+COMMON+'ctrl_home.png" /></a>　<img id="status_open" src="'+ROOT+COMMON+'ctrl_status.png" />　<img id="item_list" src="'+ROOT+COMMON+'ctrl_bonus.png" />　<img id="audio_onoff" src="'+ROOT+COMMON+"ctrl_audio_"+(global_save_data.bgm?"on":"off")+'.png" />　<img id="ctrl_reload" src="'+ROOT+COMMON+'ctrl_results.png" />　<img id="ctrl_help" src="'+ROOT+COMMON+'ctrl_help.png" /></div>').prependTo(target),global_save_data.panel||$("#control_panel").hide(),console.log("debug:"+debug_mode),debug_mode&&($('<div id="debug_panel"><form><label>Scene：<input id="debug_id" type="text" size="5" /></label>　<label>Items：<input id="debug_items" type="text" size="7" /></label>　<label>Flags：<input id="debug_flags" type="text" size="7" /></label>　<input id="debug_reload" type="button" value="Reload" /></form></div>').prependTo(target),$("#debug_panel #debug_id").val(scene_num),$("#debug_panel #debug_items").val(save_data.items.join(",")),$("#debug_panel #debug_flags").val(save_data.flags.join(",")),$("#debug_panel #debug_reload").click(function(e){var debug_items=$("#debug_panel #debug_items").val().trim(),debug_flags=$("#debug_panel #debug_flags").val().trim();""!==debug_items&&(save_data.items=debug_items.split(",")),""!==debug_flags&&(save_data.flags=debug_flags.split(",")),Util.saveStorage(),Util.createScene($("#debug_panel #debug_id").val())})),target.append('<center id="cubes">'+Util.cube(2)+"</center>"),$("a",target).addClass("scenebtn"),$('a[target="_blank"]',target).removeClass("scenebtn");var tmp_move=$('a[href="X"]',target),a_img;if(tmp_move.removeClass("scenebtn").addClass("scene_move").attr("data-allow",tmp_move.text()).text("移動する").before('<input type="number" id="toscene" class="scene_move" />').add("#toscene").wrapAll("<div></div>"),$("a:has(img)",target).each(function(index,elem){var img_path=ROOT+scenario_code+"/"+CAPTURE+$(elem).attr("href");$(elem).attr("href",img_path).removeClass("scenebtn").addClass("scenepic").find("img").attr("src",img_path)}),$("a.scenepic").zoombox(),scene.attr("enemies")){for(var e_table=$('<table class="enemy">'),enemies=scene.attr("enemies").split(","),i=0;i<enemies.length;i++){var enemy=enemies_map[enemies[i]],row="<tr><th>"+enemy.name;enemy.element&&(row+="（"+enemy.element+"）"),row+="</th><td>"+enemy.attack+"</td><td>",enemy.func&&(row+=Util.selectFunc(enemy.func)),row+="</td><td>"+this.dropItem(enemy.element),row+="</td><td>"+enemy.desc+"</td></tr>",e_table.append(row)}e_table.insertBefore("a.scenebtn:first")}var flags=save_data.flags,items=save_data.items,multi_flags;$("a[title]",target).hide(),$('a[title^="-"]',target).show();for(var i=0;i<flags.length;i++)$('a[title="'+flags[i]+'"]',target).show(),$('a[title="-'+flags[i]+'"]',target).hide();$('a[title*=","]',target).each(function(index,elem){var multi_ids=$(elem).attr("title");if(0!==multi_ids.indexOf("-")){for(var show_flag=!0,multi_ids_values=multi_ids.split(","),i=0;i<multi_ids_values.length;i++)if(-1===flags.indexOf(multi_ids_values[i].trim())&&-1===items.indexOf(multi_ids_values[i].trim())){show_flag=!1;break}show_flag&&$(elem).show()}else{for(var hide_flag=!0,multi_ids_values=multi_ids.substring(1).split(","),i=0;i<multi_ids_values.length;i++)if(-1===flags.indexOf(multi_ids_values[i].trim())&&-1===items.indexOf(multi_ids_values[i].trim())){hide_flag=!1;break}hide_flag&&$(elem).hide()}});for(var i=0;i<items.length;i++)$('a[title="'+items[i]+'"]',target).show(),$('a[title="-'+items[i]+'"]',target).hide();for(var key in Common.magic)Util.canUseMagic(Common.magic[key])&&$('a[title="m'+key+'"]',target).show();var tmp_path="",new_bgm=scene.attr("bgm");tmp_path=save_data.bgm?"/bgm_"+save_data.bgm+".mp3":"/bgm.mp3",void 0!==new_bgm&&(tmp_path=""===new_bgm?"/bgm.mp3":"/bgm_"+new_bgm+".mp3");var audio_path=ROOT+scenario_code+tmp_path;if((!bgm||bgm&&void 0!==new_bgm&&new_bgm!==save_data.bgm)&&(Util.playBgm(audio_path),save_data.bgm=void 0===new_bgm?"":new_bgm),scene.attr("se")){var se=new Audio(ROOT+scenario_code+"/"+scene.attr("se")+".mp3");se.loop=!1,se.play()}Util.updateItems(scene.attr("items")),Util.updateFlags(scene.attr("flags")),Util.updateResults(scene.attr("result")),save_data.scene=scene_num,save_data.ellapsed_scene++,Util.saveStorage(),Util.endScenario(scene.attr("end")),console.log(save_data)}}};$.fn.extend({startGame:function(code,debug){scenario_code=code,debug||(debug=!1),debug_mode=debug,(target=this).on("click","a.scenebtn",function(e){var num=$(this).attr("href");-1!==num.indexOf(",")&&(num=Util.randomArray(num.split(",")).trim()),history.pushState(num,"Scene "+num),Util.createScene(num),e.preventDefault()}),target.on("click","a.scene_move",function(e){var num=$("#toscene").val(),allow_num=$(this).attr("data-allow");Util.canSceneMove(num,allow_num)?(history.pushState(num,"Scene "+num),Util.createScene(num)):Util.toast("指定された番号には移動できないようだ"),e.preventDefault()});var ad=new Audio(ROOT+COMMON+"dice.mp3"),rotate_count,rotateCube=function(){rotate_count++,$("#cubes").html(Util.cube(2)),rotate_count>20||setTimeout(rotateCube,50)};target.on("click","#cubes",function(e){ad.play(),rotate_count=1,rotateCube(this)}),target.on("click","#status_open",function(e){Util.createDialog(),e.preventDefault()}),target.on("contextmenu",function(e){Util.createDialog(),e.preventDefault()}),target.on("click","#audio_onoff",function(e){bgm&&(global_save_data.bgm?(global_save_data.bgm=!1,$(this).attr("src",ROOT+COMMON+"ctrl_audio_off.png"),bgm.pause()):(global_save_data.bgm=!0,$(this).attr("src",ROOT+COMMON+"ctrl_audio_on.png"),bgm.play()),Util.saveStorageGlobal())}),$(document).on("click","#dialog_body #status_save",function(e){save_data.chara.hp=$("#dialog_body #hp").val(),save_data.chara.mp=$("#dialog_body #mp").val(),save_data.chara.free1=$("#dialog_body #free1").val(),save_data.chara.free2=$("#dialog_body #free2").val(),save_data.chara.str=$("#dialog_body #str").val(),save_data.chara.int=$("#dialog_body #int").val(),save_data.chara.dex=$("#dialog_body #dex").val(),save_data.chara.krm=$("#dialog_body #krm").val(),save_data.chara.state=$('#dialog_body [name="state"]:checked').val(),save_data.stars[0]=$("#dialog_body #s_mon").val(),save_data.stars[1]=$("#dialog_body #s_tue").val(),save_data.stars[2]=$("#dialog_body #s_wed").val(),save_data.stars[3]=$("#dialog_body #s_thu").val(),save_data.stars[4]=$("#dialog_body #s_fri").val(),save_data.stars[5]=$("#dialog_body #s_sat").val(),save_data.stars[6]=$("#dialog_body #s_sun").val(),save_data.memos=$("#dialog_body #memos").val(),Util.saveStorage(),dialog.slideUp(500),target.slideDown(500)}),$(document).on("click","#dialog_body #status_close",function(e){dialog.slideUp(500),target.slideDown(500)}),$(document).on("click",'#dialog_body [name="state"]',function(e){var delta=Util.deltaStatus($(this).val());$("#dialog_body #str_d").text("（"+delta[0]+"）"),$("#dialog_body #int_d").text("（"+delta[1]+"）"),$("#dialog_body #dex_d").text("（"+delta[2]+"）"),$("#dialog_body #krm_d").text("（"+delta[3]+"）"),$("#dialog_body #state_desc").text(delta[4])});var useStar=function(magic,index,name){if(magic[index]>0){var num=$("#dialog_body "+name).val();$("#dialog_body "+name).val(num-magic[index])}};$(document).on("click","#dialog_body #magic_run",function(e){e.preventDefault();var magic=Common.magic[$("#dialog_body #magic option:selected").val()];magic&&($("#dialog_body #s_mon").val()<magic[0]||$("#dialog_body #s_tue").val()<magic[1]||$("#dialog_body #s_wed").val()<magic[2]||$("#dialog_body #s_thu").val()<magic[3]||$("#dialog_body #s_fri").val()<magic[4]||$("#dialog_body #s_sat").val()<magic[5]||$("#dialog_body #s_sun").val()<magic[6]?window.alert("星が不足しているため、魔法を発動できません！"):(useStar(magic,0,"#s_mon"),useStar(magic,1,"#s_tue"),useStar(magic,2,"#s_wed"),useStar(magic,3,"#s_thu"),useStar(magic,4,"#s_fri"),useStar(magic,5,"#s_sat"),useStar(magic,6,"#s_sun")))}),$(document).on("click","#dialog_body #status_change",function(e){var b;"none"===$("#status_basic").css("display")?($("#status_change").val("Equipment"),$("#status_basic").show(),$("#status_equip").hide()):($("#status_change").val("Basic Status"),$("#status_basic").hide(),$("#status_equip").show())}),$(document).on("click","#dialog_body .spinner_up",function(e){var prev=$(this).prev();prev.val(Number(prev.val())+1)}),$(document).on("click","#dialog_body .spinner_down",function(e){var next=$(this).next();next.val(Number(next.val())-1)}),target.on("click","#item_list",function(e){$.zoombox.html(dialog_item.html(),{width:650,height:450})}),$(document).on("click","#dialog_list img.bonus_item",function(e){var id=e.target.id,o_bonus_item;o_bonus_item=id.startsWith("gi")?Common.global_items.happy[id]:Common.global_items.bad[id],$("#dialog_list #bonus_msg").text(o_bonus_item.name+"（"+o_bonus_item.desc+"）")}),target.on("click","#ctrl_home",function(e){location.href="http://www.web-deli.com/sorcerian/next/stext.aspx"}),target.on("click","#ctrl_reload",function(e){$.get(ROOT+COMMON+"dialog_result.html").done(function(data){var result_count=0,get_result=0,trophy=["","ノーマル","ブロンズ","シルバー","ゴールド","プラチナ"],dialog_results=$(data);Object.keys(results_map).forEach(function(key){if(result_count++,void 0!==global_save_data.results[scenario_code]&&-1!==global_save_data.results[scenario_code].indexOf(key)){get_result++;var row='<tr><td><img src="stext/common/trophy'+results_map[key].level+'.png" title="'+trophy[results_map[key].level]+'" /></td><td><h3>'+results_map[key].name+"（Lv."+results_map[key].level+"）</h3><p>"+results_map[key].desc+"</p></td></tr>"}else var row='<tr><td><img src="stext/common/trophy0.png" title="実績未達" /></td><td><h3>???????????????</h3><p>???????????????</p></td></tr>';$(".result_list",dialog_results).append(row)});var result_rate=(get_result/result_count*100).toFixed(1);$("#result_rate",dialog_results).text("Rate:"+result_rate+"%"),$.zoombox.html(dialog_results.html(),{width:480,height:200})})}),target.on("click","#ctrl_help",function(e){window.open("http://d.hatena.ne.jp/sorcerian/20171220")}),target.on("click","#scenario_title",function(e){var ctrl;"none"===$("#control_panel").css("display")?($("#control_panel").slideDown(),global_save_data.panel=!0):($("#control_panel").slideUp(),global_save_data.panel=!1),Util.saveStorageGlobal()}),$(window).on("popstate",function(e){Util.createScene(e.originalEvent.state)}),$(document).on("touchstart",".zoombox_mask",function(){global_save_data.bgm&&bgm.paused&&bgm.play()}),localStorage.sorcerian_text?Util.loadStorageGlobal():Util.initGlobalSaveData(),$.zoombox.open(ROOT+COMMON+"title.png",{duration:400});var done_read=function(result){for(var key in scenario_data=result,Common.magic){for(var magic=Common.magic[key],stars="",star_names=["月","火","水","木","金","土","太"],i=0;i<7;i++)magic[i]>0&&(stars+=star_names[i]+magic[i]+" ");magic.push(stars)}if(flags_map={},$("flags > flag",scenario_data).each(function(){flags_map[$(this).attr("id")]=$(this).text().trim()}),enemies_map={},$("enemies > enemy",scenario_data).each(function(){enemies_map[$(this).attr("id")]={name:$(this).attr("name"),element:$(this).attr("element"),attack:$(this).attr("attack"),func:$(this).attr("func"),desc:$(this).text()}}),items_map={},$("items > item",scenario_data).each(function(){items_map[$(this).attr("id")]={name:$(this).attr("name"),desc:$(this).text().trim()}}),results_map={},$("results > result",scenario_data).each(function(){results_map[$(this).attr("id")]={name:$(this).attr("name"),level:$(this).attr("level"),desc:$(this).text().trim()}}),!0===debug_mode){var errors=Util.validateScenario();if(console.log("検証結果"+errors),0!==errors.length){var msgs="<h3>scenario.xmlでエラーが検出されました。</h3>";return msgs+='<ul class="errorlist">',errors.forEach(function(err){msgs+="<li>Scene "+err.scene_id+": "+err.message+"</li>"}),msgs+="</ul>",void target.html(msgs)}}if(localStorage[scenario_code]&&confirm("以前のデータが残っています。\r続きから開始しますか？")){Util.loadStorage(),Util.initDialog(),save_data.ellapsed_scene--;var num=save_data.scene;return Util.createScene(num),void history.pushState(num,"Scene "+num)}Util.initScenario(),window.alert("キャラが新規作成されました。\rステータスダイアログは画面右クリックで開くことができます。")};if(0===(scenario_code=scenario_code.trim()).indexOf("<")){var tmp_data=$(scenario_code);scenario_code="playground",global_save_data.results.playground=[],Util.saveStorageGlobal(),done_read(tmp_data)}else $.get(ROOT+scenario_code+"/scenario.xml").done(done_read).fail(function(xhr,status,error){throw new Error("scenario code is invalid.")})},gbat2stext:function(callback){$(this).change(function(e){var file_num=0,result=$('<scenario xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://www.web-deli.com/sorcerian/next/stext/common/sgml.xsd">\n</scenario>'),items=$("<items>\n</items>"),flags=$("<flags>\n</flags>"),enemies=$("<enemies>\n</enemies>"),results=$("<results>\n</results>"),license=$("<license>\n</license>"),readFile=function(e){var gbat=$(this.result),title_author=$("title",gbat).text().trim().split("@");if(result.attr("title")||(result.attr("title",title_author[0]),result.attr("author",title_author[1])),$("section",gbat).each(function(i,section){var header_on=!1,attrs={};attrs.id=Number($("number",section).text()),1===attrs.id&&(attrs.id=0);var body="\n";$("> text p",section).each(function(j,para){var tmp_para=$(para).text();if("@@"===tmp_para.trim())return header_on=!header_on,!0;if(header_on){if(!tmp_para)return!0;if(0===tmp_para.indexOf("i")){var item=tmp_para.split(":");$("<item></item>").attr("id",item[0]).attr("name",item[1]).text(item[2]).appendTo(items)}else if(0===tmp_para.indexOf("f")){var flag=tmp_para.split(":");$("<flag></flag>").attr("id",flag[0]).text(flag[1]).appendTo(flags)}else if(0===tmp_para.indexOf("m")){var enemy=tmp_para.split(":");$("<enemy></enemy>").attr("id",enemy[0]).attr("name",enemy[1]).attr("element",enemy[2]).attr("attack",enemy[3]).attr("func",enemy[4]).text(enemy[5]).appendTo(enemies)}else if(0===tmp_para.indexOf("r")){var result=tmp_para.split(":");$("<result></result>").attr("id",result[0]).attr("name",result[1]).attr("level",result[2]).text(result[3]).appendTo(results)}else if(0===tmp_para.indexOf("w")){var work=tmp_para.split(":");$("<work></work>").attr("name",work[1]).attr("category",work[2]).attr("creator",work[3]).attr("url",work[4]).appendTo(license)}else if(0===tmp_para.indexOf("@")){var attr=tmp_para.substring(1).split(":");void 0===attr[1]&&(attr[1]=""),attrs[attr[0]]=attr[1]}}else body+=tmp_para+"\n"}),body+="\n",$("choices choice",section).each(function(k,cho){var caption=$("text p",cho).text().trim().split("@"),dest=$("destination",cho).text();if("999"===dest){var tmp="[";tmp+=caption[0],tmp+="](X)\n"}else{var tmp="[";tmp+=caption[0],tmp+="](",tmp+=dest,caption[2]&&(tmp+=","+caption[2]),caption[1]&&(tmp+=' "'+caption[1]+'"'),tmp+=")\n"}body+=tmp});var scene=$("<scene></scene>\n").attr("id",attrs.id).text(body);void 0!==attrs.items&&scene.attr("items",attrs.items),void 0!==attrs.flags&&scene.attr("flags",attrs.flags),void 0!==attrs.enemies&&scene.attr("enemies",attrs.enemies),void 0!==attrs.bgm&&scene.attr("bgm",attrs.bgm),void 0!==attrs.se&&scene.attr("se",attrs.se),void 0!==attrs.allowMove&&scene.attr("allowMove",attrs.allowMove),void 0!==attrs.result&&scene.attr("result",attrs.result),void 0!==attrs.end&&scene.attr("end",attrs.end),scene.appendTo(result)}),license.prependTo(result),results.prependTo(result),enemies.prependTo(result),flags.prependTo(result),items.prependTo(result),++file_num>=inputs.length)if(callback)callback(result);else{var content='<?xml version="1.0" encoding="utf-8"?>\n'+result.get(0).outerHTML,blob=new Blob([content],{type:"application/octet-stream"}),anchor=document.createElement("a");anchor.href=window.URL.createObjectURL(blob),anchor.download="scenario.xml",anchor.click()}else reader.readAsText(inputs[file_num],"UTF-8")},inputs=$(this).get(0).files,reader=new FileReader;$(reader).on("load",readFile),reader.readAsText(inputs[file_num],"UTF-8")})}})}(jQuery);