(function($){var ROOT="stext/",COMMON="common/",DIALOG="dialog/",CAPTURE="capture/",BGM="bgm/",SE="se/",scenario_code,scenario_data,enabled_jobs,flags_map={},enemies_map={},items_map={},results_map={},bgms_map={},save_data,global_save_data,GLOBAL_SAVE_DATA_KEY="sorcerian_text",target,dialog,dialog_item,dialog_elem={},debug_mode=!1,bgm,bgm_name,storage=localStorage,dice=[1,1],tweet_message,Common={male_name:["ボブ","デュエル","ゴルカス","ジェノバン","グーラン","ジャンビエ","グログス","コル","フロニアス","グーリム","カザミィ","ソロン","ゼン","ヴォル","マルス","レイザー","ミリオン","エリック","ジロ","ソード","ディル","ガタビア","ラウア","ハルビン","グドン","ジャミル","ディカン","ダート","タットワ5世","ディカン","ホド","ゲプラー","コクマー","グレアム","ロウポー","ラッツ","ソルト","ランブル","ネイル","ルシアン","ギム","チェイサー","ルワン","ゾーク","オルム","テュモー","バロン","カメロン","トード","グンダ","フラジオレ","ファン＝フレディ","ファネッサ3世","クリフト4世","クォール","ディオン","ホゼア","ロラッド","バルナ","ティゲロ","テト","ニフト","オーサー","ゲディス","レオン","アンドリュー","キリー","トーマス","エディ","ノーマス","ギルデン","ノーネーム","ユイター","デュオン","ペトス","フェリス","スラン","アルフレッド","ソクラム","アルモス","ログレック","ラルーゴ","キッド","ドレイク","ウォルトス","レスター","テリー","グラハン","ラドール","ウェステル","フェスタ","バンブー","ゲルフス","ドン・コサック","ベオグラード","ピエール","タルフ","エヴァン","ドゥール","バルガス","アーサー","ガッシュ","エルウッド","ヘルナー","エリック","ジャグラー","アラン","ロニアス","アスタル","ボルックス","ラドナー","ギルバレス","ジャレス","ルー","スズキ","ジロサ","サントリーニ","ルルイエ","コーラル","ボマード","ナルシス","マーヴァル","クール","ヨシュア","エヴァム","ジャンク","ボイド","ヘクター","デンキブラウン","バイアス","ブロイム","ディンギル","リグ","バド","ジード","ラルザス","ガイキナ","ロッド","ケイン","ルーミス","タジート","ブレイス","ディンクス","マーク","ホホホ","テシター","J.B","ジン","マック","リラ","ジバ","バーラン","ポジティル","ネガティル","ファルカス","ファウネス","ファルカス","チェン","パズス12世","タムタム","リーク・ディオン","タウラー","ラルディ","ノーマス","アドロン","ロカルノ","ゲラン","シュヴェーリン","ローラン","ウェッジ","アントロノフ","キム","ヤン","デフ","ミケロ","クール","ティエンルン","コウ","マルク","オーエン","トート","グート","マウアー","ザンダー","バルダ","キーリエ","マルス","セム","ターバ","グロス","クルトン","ザムル","エルフィン","グラハン","ガウェイン","アドル","ゴーバン","ドギ","ルタ","ダレス","ダルク＝ファクト","クーブラ＝カーン","ガルシウス","クロノス","カイロス","ディアルド","チッタ","カズン","ルイス","セネリー","ライネル","エス","カリー","ドレイク","ダニー","ドリー","ケイリス","ノートン","クラウド","ウォーリー","レイモンド","サザール","メテオロイド","ナッシュ","ルロイ","ライトル","カディアン","ブラウン","シュナイダー","セシル","グレンザー","ゴイル","ビル","グリメルム","ガルベス","ジルドバ","アレクシウスX世","ピエール","ジェラルド","ロベルト","エティス","アル＝ファルコ","ラシーン","ロデム","J.D.マックス","パーム","シド"],female_name:["エスター","クリスティ","アイリーン","フェルディナン","リタ","トーヤ","ノルン","ウィンディーネ","プリム","ピアナ","エメラーダ","エレア","エヴァ","リム","ビナー","ティファレト","ミラドゥ","パナシェ","ミモザ","リューズ","エレーナ","リーア","キアラ","オルアラ","クオレ","セーナ","リーザ","セリナ","リリィ","ピピ","ビヌス","アンナ","リュシエル","フィレン","カレン","エリン","ローラ","マーベラ","ジョセフィーヌ","アネリーナ","リオナ","ジョアンナ","レニッサ","ジェニス","グリンダ","マティナ","ローナ","コッキー","チェルシー","ネリス","アリーナ","フェリッサ","マリエル","ベララ","ジョゼフ","ニッカ","テキーラ","ソルティ","パイン","ウィズ","カンニバル","ミント","リーン","ミル","ディアンナ","レティア","サフィス","エミス","ヴァムリー","サリア","ナイジェス","ミューリア","エミリア","シャル","バーバラ","オビア","スチュアート","ベーラ","サマリーヌ","フィアネ","レナ","ソル","ネイラ","セレーネ","アルバ","ラン","ルー・パズス","シルフィ","ミレット","レフィーナ","モスマ","チブル","鈴鈴","明明","ティキ","サリア","ミュール","ダール","ミンナ","レーシャ","エレイア","レア","フィーナ","ジャネット","ナリス","ソチ","ポーラス","ロキア","フリージ","エスメレー","エレナ","アルティ","エビオラ","フィナ"],title:["武器屋の親父","ペンタウァの長老","トラベラーズインの宿主","人と上手に話したい","ペンタウァ近衛隊長","タリスマンの見張り","瞑想中","砂漠の飯炊き","狂戦士","エレベーターの管理人","盗賊の頭領","暗き沼の魔法使い","ロマンシア国王","アゾルバ国王","ペンタウァ国王","蚕職人","妖精王","暗黒の魔導士","クイーンマリー号船長","キタブ・アル・アジフの持ち主","メデューサハンターの弟子","ファルコムマン","戦士の亡霊","海賊の子孫","いけにえの神官","東の村の村長","麻薬中毒者","ヴァネルバの王","銀の竪琴屋","近衛隊長","復讐の呪術師","ラフォーヌの森の管理人","リドニア王国の元兵士","姫の教育係","大魔王","紫ウニの王子","ベララの家族","時計塔の番人","時計塔の魔女","ナルキッソス号船長","ディンギル王国の3神官","バドティビラ工場の指揮官","シュメール国王","サンサーラの山賊","南村の村長","アイテム屋WIZの店主","旅の吟遊詩人","古代イスマリアの王","時の神殿の書記官","闇の王","ランドル村長","魔法学校の校長","魔法学校の用務員","マリオネットの王","ペンタウァの近衛兵","陽の中の闇人","赤毛の冒険者","光の王","イリアスンの執政官","魔の下僕","メデューサハンター","邪神教徒","邪神教々祖","砂漠の王","鍵の番人","ローデシア辺境司令官","宇宙からの訪問者","黒竜仙人","猿大聖","極楽寺の僧兵","ジャグラー族","迷宮建築の第一人者","フリース村の村長","ペンタウァ一の科学者アンド予言者","暴れザル","魔法学校の校長","人魚３姉妹の長女","マリオネットの王","探求の学徒","旅芸人の一座","猛獣使い","流れの傭兵","氷の魔女","パペッテの人形遣い","バーテンダー","宮仕えのシャーマン","薬草亭の主人","水門の管理人"],pc_init:[["FIGHTER","MALE",85,55,7,3,6,4],["FIGHTER","FEMALE",80,60,6,4,6,4],["WIZARD","MALE",55,85,4,8,5,3],["WIZARD","FEMALE",50,90,3,8,5,4],["DWARF","MALE",90,50,8,2,8,2],["DWARF","FEMALE",85,55,7,3,8,2],["ELF","MALE",65,75,4,6,5,5],["ELF","FEMALE",60,80,2,7,5,6]],magic:{HEAL:[0,0,0,1,0,1,0,"HPを15回復"],PEACE:[0,0,1,0,1,0,0,"MPを10回復"],CURE:[0,0,0,0,1,0,1,"毒回復"],MELT:[0,1,0,0,1,1,1,"凍結を回復"],"STONE-FLESH":[0,0,0,1,1,1,1,"石化を回復"],"UN-CURCE":[2,0,1,0,0,1,0,"呪いを回復"],"AIR-HAND":[1,0,1,0,1,0,1,"見えない拳の衝撃で、忘却を回復"],RESURRECT:[0,0,0,1,3,0,1,"HP/MP半分で復活（但し、冒険に一度だけ）"],"REDUCE-LIFE":[0,1,1,0,1,1,0,"体力を犠牲に（HP-25）、すべての状態異常を回復"],REJUVENATE:[0,2,0,1,0,0,1,"時の流れを巻き戻し（現在の判定をやり直し）"],PROTECT:[1,0,0,1,1,0,1,"HPダメージを半減（1ターンのみ）"],"HOLY-WATER":[0,0,2,2,0,0,0,"MPダメージを半減（1ターンのみ）"],"CHANGE-AIR":[1,0,0,1,1,1,0,"戦闘を回避（アイテムは得られない）"],"GIVE-VIGOR":[1,1,1,0,0,1,0,"敵の攻撃力が2倍＆取得アイテム2倍"],EXPLOSION:[0,1,0,1,0,1,2,"地属性の敵を全滅"],DELUGE:[4,0,0,0,0,1,0,"火属性の敵を全滅"],FREEZE:[0,2,0,0,0,1,2,"水属性の敵を全滅"],"DESTROY-A":[1,0,4,0,0,0,0,"風属性の敵を全滅"],"LIGHT-CROSS":[0,2,0,2,0,1,0,"霊属性の敵を全滅"],"NOILA-TEM":[1,1,1,1,1,1,1,"すべての属性の敵を全滅"]},jobs:{"のうふ":["FWDE","MF","YAO"],"れんきんじゅつ":["W","M","YAO"],"ようへい":["FDE","M","YA"],"うらないし":["WE","MF","YAO"],"こうふ":["FD","M","YA"],"どろぼう":["FWDE","MF","YAO"],"そうりょ":["W","MF","YAO"],"しょうにん":["FWE","MF","YAO"],"せんいん":["FD","M","YA"],"とうし":["FDE","MF","Y"],"どうけし":["WE","MF","YAO"],"かじや":["FD","M","YAO"],"きこり":["FD","M","YA"],"かりうど":["FDE","M","YAO"],"きとうし":["WE","M","YAO"],"あくまばらい":["W","M","YAO"],"せんきょうし":["W","MF","YAO"],"いしゃ":["WE","M","AO"],"かんごふ":["FWE","F","YAO"],"ぱんや":["FWE","MF","YAO"],"りょうし":["FD","MF","YA"],"だいく":["FD","M","YAO"],"ちょうこくか":["FWDE","MF","O"],"おりこ":["WDE","F","YAO"],"すみやき":["FD","MF","YAO"],"コック":["WE","MF","YAO"],"スパイ":["FWE","M","YA"],"ぼくどう":["FWDE","MF","Y"],"ようじんぼう":["FDE","M","Y"],"ぎんゆうしじん":["WE","M","YAO"],"ぎょしゃ":["FD","MF","YAO"],"はかもり":["FWDE","M","O"],"しゃほん":["WE","M","O"],"こなひき":["FD","MF","YA"],"かせいふ":["FWDE","F","YAO"],"おどりこ":["E","F","Y"],"はなや":["FWE","F","YAO"],"いしく":["D","MF","YA"],"かみゆい":["FWDE","F","AO"],"したてや":["WDE","F","YAO"],"いとつむぎ":["D","F","YAO"],"うたうたい":["FWE","F","YA"],"かみすき":["WD","MF","O"],"つうやく":["DE","MF","YAO"],"やくざいし":["FWE","MF","AO"],"ほねさいくし":["D","MF","O"],"わたしもり":["FW","M","YA"],"やくそうとり":["WE","MF","YAO"],"そうぎや":["FW","M","O"],"ワインづくり":["FWDE","MF","YA"],"こじき":["FWDE","MF","YAO"],"ちょうきょうし":["DE","MF","A"],"ほうせきさいくし":["D","MF","O"],"かごづくり":["FD","MF","O"],"かぎや":["D","MF","AO"],"くつし":["FDE","MF","O"],"はくせいづくり":["FD","MF","O"],"ゆみし":["FE","MF","O"],"チーズづくり":["FD","F","YAO"],"さんば":["FW","F","AO"]},global_items:{happy:{gi01:{name:"金の卵",desc:"月の欠片を5個所有した状態で冒険を開始"},gi02:{name:"ガラティーン",desc:"火星の欠片を5個所有した状態で冒険を開始"},gi03:{name:"五元素のマント",desc:"水星の欠片を5個所有した状態で冒険を開始"},gi04:{name:"アマゾンの剣",desc:"木星の欠片を5個所有した状態で冒険を開始"},gi05:{name:"幸福のコイン",desc:"金星の欠片を5個所有した状態で冒険を開始"},gi06:{name:"ムラサメブレード",desc:"土星の欠片を5個所有した状態で冒険を開始"},gi07:{name:"G・スレイヤー",desc:"太陽の欠片を5個所有した状態で冒険を開始"},gi08:{name:"水晶の剣",desc:"左サイコロが5以上の時、そのシーンでHPを1回復"},gi09:{name:"王様の杖",desc:"左サイコロが5以上の時、そのシーンでMPを1回復"},gi10:{name:"ブルーリボン",desc:"戦闘ダメージを1減算"},gi11:{name:"王家のダイヤモンド",desc:"罠ダメージを1減算"},gi12:{name:"不老長寿の水",desc:"冒険中に一度だけHPを半分回復できる"},gi13:{name:"タリスマン",desc:"冒険中に一度だけMPを半分回復できる"},gi14:{name:"鏡の盾",desc:"HPダメージを1減算"},gi15:{name:"銀の竪琴",desc:"MPダメージを1減算"},gi16:{name:"パンドラの箱",desc:"右サイコロが4以上の時、戦闘回避が可能"},gi17:{name:"魔法の絨毯",desc:"右サイコロが5以上の時、罠回避"},gi18:{name:"中和剤",desc:"毒耐性"},gi19:{name:"聖水",desc:"呪い耐性"},gi20:{name:"チルドの実",desc:"凍結耐性"},gi21:{name:"銀のハーモニカ",desc:"石化耐性"},gi22:{name:"真実の鏡",desc:"忘却耐性"},gi23:{name:"D・スレイヤー",desc:"すべての星を1個所有した状態で冒険を開始"}},bad:{bgi01:{name:"塩酸",desc:"シーン毎にダイス合計が5未満でHPを1減算、5以上でMPを1回復"},bgi02:{name:"紅玉",desc:"シーン毎にダイス合計が5未満でMPを1減算、5以上でHPを1回復"},bgi03:{name:"血まみれの斧",desc:"冒険開始時に呪い。解除で3回まで星消費せず魔法発動可"},bgi04:{name:"トリカブト",desc:"冒険開始時に毒。但し、解除までシーン毎にMPを1回復"},bgi05:{name:"ギャルのパンティー",desc:"冒険開始時に忘却。解除までSTR/INT0でない方を10"}}},star_names:{mon:"月",tue:"火星",wed:"水星",thu:"木星",fri:"金星",sat:"土星",sun:"太陽","":null},state_names:{"":"正常",poison:"毒",frozen:"凍結",stone:"石化",curse:"呪い",forget:"忘却",physics:"物理",magic:"魔法",both:"物理／魔法",free1:"FREE1",free2:"FREE2",free3:"FREE3"},element_names:{earth:"地",fire:"火",water:"水",wind:"風",spirit:"霊"}};toastr.options.closeButton=!0,toastr.options.positionClass="toast-bottom-left",toastr.options.showDuration=300,toastr.options.hideDuration=1e3,toastr.options.timeOut=5e3;var Util={random:function(a,e){return Math.floor(Math.random()*(e-a+1))+a},minMaxGuard:function(a){return a<0?0:a>10?10:a},randomArray:function(a){return a[Math.floor(Math.random()*a.length)]},pushUnique:function(a,e){return-1===a.indexOf(e)&&(a.push(e),!0)},shiftUnique:function(a,e){return a.filter(function(a){return a!==e})},ltrim:function(a){return a.substr(1)},deepCopyObject:function(a){var e=JSON.stringify(a);return JSON.parse(e)},saveStorage:function(){storage[scenario_code]=JSON.stringify(save_data)},loadStorage:function(){save_data=JSON.parse(storage[scenario_code])},saveStorageGlobal:function(){storage[GLOBAL_SAVE_DATA_KEY]=JSON.stringify(global_save_data)},loadStorageGlobal:function(){global_save_data=JSON.parse(storage[GLOBAL_SAVE_DATA_KEY])},initSavedata:function(){var a=$("init > constraint",scenario_data);if(a){var e=a.nsAttr("race");e&&(e=e.split(","));var t=a.nsAttr("sex"),s=a.nsAttr("age");s&&(s=s.split(","))}var r=this.randomArray(Common.pc_init.filter(function(a){return!e||e.includes(a[0])}).filter(function(a){return!t||t===a[1]})),i=this.random(r[2],r[2]+10),n=this.random(r[3],r[3]+10),o=this.minMaxGuard(this.random(r[4],r[4]+2)),d=this.minMaxGuard(this.random(r[5],r[5]+2)),l=this.minMaxGuard(this.random(r[6],r[6]+2)),c=this.minMaxGuard(this.random(r[7],r[7]+2)),m=storage[scenario_code],u="";m&&(m=JSON.parse(m),u=m.memos),save_data={chara:{name:"MALE"===r[1]?this.randomArray(Common.male_name):this.randomArray(Common.female_name),title:this.randomArray(Common.title),race:r[0],sex:r[1],age:this.randomArray(["YOUNG","ADULT","OLD"].filter(function(a){return!s||s.includes(a)})),job:"",state:"",stone_scene:0,forget_scene:0,hp_m:i,hp:i,mp_m:n,mp:n,str_i:o,str:o,int_i:d,int:d,dex_i:l,dex:l,krm_i:c,krm:c,free1:0,free2:0,free3:0},stars:[0,0,0,0,0,0,0],items:[],flags:[],memos:u,scene:0,ellapsed_scene:0,bgm:"",bonus:this.randomArray(global_save_data.items),isEnded:!1},this.initJobs(),save_data.chara.job=this.randomArray(enabled_jobs),this.saveStorage()},initGlobalSaveData:function(){global_save_data={items:[],results:{},bgm:!0,panel:!0},this.saveStorageGlobal(GLOBAL_SAVE_DATA_KEY)},initJobs:function(){enabled_jobs=Object.keys(Common.jobs).filter(function(a){var e=Common.jobs[a];return-1!==e[0].indexOf(save_data.chara.race.charAt(0))&&-1!==e[1].indexOf(save_data.chara.sex.charAt(0))&&-1!==e[2].indexOf(save_data.chara.age.charAt(0))})},downloadSavedata:function(a,e){var t=navigator.userAgent.toLowerCase();if(-1!==t.indexOf("safari")&&-1===t.indexOf("chrome")&&-1===t.indexOf("edge"))window.open("./stext/download.php?id="+a+"&data="+e);else{var s=new Blob([e],{type:"application/octet-stream"}),r=document.createElement("a");r.href=window.URL.createObjectURL(s),r.download=a+"-"+(new Date).getTime()+".stext",document.body.appendChild(r),r.click(),document.body.removeChild(r)}},restoreSaveData:function(a,e){var t=a.files[0],s=t.name.split("-")[0],r=new FileReader;$(r).on("load",function(){if("all"===s)for(var a=r.result.split("\n"),t="",i="",n=0;n<a.length;n++)n%2==0?t=a[n]:(i=a[n],i&&(storage[t]=i));else storage[s]=r.result;e()}),r.readAsText(t,"UTF-8")},buildBgmPath:function(a){return""===a&&(a=bgms_map.main),0===a.indexOf("@")?ROOT+COMMON+BGM+a.substring(1)+".mp3":ROOT+scenario_code+"/"+BGM+a+".mp3"},validateScenario:function(){var a=[],e=[],t=function(e,t,s){if(void 0!==t&&""!==t){var r=t.trim().split(","),i=Object.keys(e);r.forEach(function(e){e=e.replace("-",""),-1===i.indexOf(e)&&a.push({scene_id:s,message:e.startsWith("i")?"アイテムコード"+e+"が未登録です。":e.startsWith("f")?"フラグコード"+e+"が未登録です。":e.startsWith("m")?"敵コード"+e+"が未登録です。":"実績コード"+e+"が未登録です。"})})}};return $("scene",scenario_data).each(function(s,r){var i=$(r);-1===e.indexOf(i.nsAttr("id"))?e.push(i.nsAttr("id")):a.push({scene_id:i.nsAttr("id"),message:"scene－idが重複しています。"}),t(items_map,i.nsAttr("items"),i.nsAttr("id")),t(flags_map,i.nsAttr("flags"),i.nsAttr("id")),t(enemies_map,i.nsAttr("enemies"),i.nsAttr("id")),t(results_map,i.nsAttr("result"),i.nsAttr("id"))}),a},showSplash(){$.zoombox.open(ROOT+COMMON+"title.png",{duration:400})},canUseMagic:function(a){return!(save_data.stars[0]<a[0]||save_data.stars[1]<a[1]||save_data.stars[2]<a[2]||save_data.stars[3]<a[3]||save_data.stars[4]<a[4]||save_data.stars[5]<a[5]||save_data.stars[6]<a[6])},canUseMagicByName:function(a){return 0===a.indexOf("m")&&Util.canUseMagic(Common.magic[a.substring(1)])},ifStatus:function(a){if(0===a.indexOf("o")){var e=a.match(/o(hp|mp|str|int|dex|krm|freei|freeii|freeiii)\s*(\d{1,})(\+|-)\s*/i);e[1]=e[1].toLowerCase(),e[1]=e[1].replace("freeiii","free3"),e[1]=e[1].replace("freeii","free2"),e[1]=e[1].replace("freei","free1");var t=save_data.chara[e[1]];return"-"===e[3]?t<Number(e[2]):t>Number(e[2])}return!1},isCharaState:function(a){if(0===a.indexOf("x")){var e=[save_data.chara.race,save_data.chara.sex,save_data.chara.age,save_data.chara.state.toUpperCase(),save_data.chara.job];return-1!==e.indexOf(a.substring(1).toUpperCase())}return!1},hasStars:function(a){if(0===a.indexOf("s")){var e=save_data.stars;if(-1!==a.indexOf(":")){a=a.substring(1).split(":");for(var t=0;t<a.length;t++)if(Number(e[t])<a[t])return!1}else{a=Number(a.substring(1));var s=0;for(t=0;t<7;t++)s+=Number(e[t]);if(s<a)return!1}return!0}return!1},hasResult:function(a){if(0===a.indexOf("r")){var e=a.split(":"),t=global_save_data.results[e[1].trim()];if(void 0!==t)return-1!==t.indexOf(e[0].trim())}return!1},updateItems:function(a){if(a){for(var e=save_data.items,t=(a=a.split(","),0);t<a.length;t++){var s=a[t].trim();0===s.indexOf("-")?(s=this.ltrim(s),e=this.shiftUnique(e,s)):this.pushUnique(e,s)}save_data.items=e}},updateFlags:function(a){if(a){for(var e=save_data.flags,t=(a=a.split(","),0);t<a.length;t++){var s=a[t].trim();0===s.indexOf("-")?(s=this.ltrim(s),0===flags_map[s].indexOf("*")?e=this.shiftUnique(e,s):console.log(s+"：隠しフラグ以外は削除できません。")):this.pushUnique(e,s)}save_data.flags=e}},updateStates:function(){"poison"===save_data.chara.state?(save_data.chara.hp-=1,save_data.chara.stone_scene=0,save_data.chara.poison_scene=0):"stone"===save_data.chara.state?(save_data.chara.stone_scene+=1,save_data.chara.forget_scene=0):"forget"===save_data.chara.state?(save_data.chara.forget_scene+=1,save_data.chara.stone_scene=0):(save_data.chara.stone_scene=0,save_data.chara.forget_scene=0)},updateStars:function(a){if(a){var e=save_data.stars;if(-1!==a.indexOf(",")){a=a.split(",");for(var t=0;t<a.length;t++)e[t]=Number(e[t])+Number(a[t].trim()),e[t]<0&&(e[t]=0)}else if(0===a.indexOf("div")){a=a.substring(3);for(t=0;t<7;t++)e[t]=Math.floor(Number(e[t])/Number(a))}save_data.stars=e}},updateStarsByMagic:function(a){if(void 0===a||0===a.indexOf("-"))return!0;for(var e=save_data.stars.concat(),t=function(a){for(var t=0;t<e.length;t++)if(e[t]-=a[t],e[t]<0)return!1;return!0},s=a.split(",").filter(function(a){return 0===a.indexOf("m")}),r=0;r<s.length;r++){var i=Common.magic[s[r].substring(1)];if(!i)return;if(!Util.canUseMagic(i))return!1;if(!t(i))return!1}return save_data.stars=e,Util.saveStorage(),!0},updateStarById:function(a,e){var t=Object.keys(Common.star_names).indexOf(a);save_data.stars[t]=Number(save_data.stars[t])+Number(e)},updateHpMp:function(a,e){if(a)if("full"===a)save_data.chara.hp=save_data.chara.hp_m;else{var t=a.split("..");t[1]&&(t[0]=Util.random(Number(t[0]),Number(t[1]))),save_data.chara.hp=Number(save_data.chara.hp)+Number(t[0]),save_data.chara.hp>save_data.chara.hp_m&&(save_data.chara.hp=save_data.chara.hp_m)}if(e)if("full"===e)save_data.chara.mp=save_data.chara.mp_m;else{var s=e.split("..");s[1]&&(s[0]=Util.random(Number(s[0]),Number(s[1]))),save_data.chara.mp=Number(save_data.chara.mp)+Number(s[0]),save_data.chara.mp>save_data.chara.mp_m&&(save_data.chara.mp=save_data.chara.mp_m)}},updateStr2Krm:function(a,e,t,s){a&&("full"===a?save_data.chara.str=save_data.chara.str_i:0===a.indexOf("@")?save_data.chara.str=Number(a.substring(1)):save_data.chara.str=Number(save_data.chara.str)+Number(a)),e&&("full"===e?save_data.chara.int=save_data.chara.int_i:0===a.indexOf("@")?save_data.chara.int=Number(e.substring(1)):save_data.chara.int=Number(save_data.chara.int)+Number(e)),t&&("full"===t?save_data.chara.dex=save_data.chara.dex_i:0===t.indexOf("@")?save_data.chara.dex=Number(t.substring(1)):save_data.chara.dex=Number(save_data.chara.dex)+Number(t)),s&&("full"===s?save_data.chara.krm=save_data.chara.krm_i:0===s.indexOf("@")?save_data.chara.krm=Number(s.substring(1)):save_data.chara.krm=Number(save_data.chara.krm)+Number(s))},updateFrees:function(a,e,t){a&&(0===a.indexOf("@")?save_data.chara.free1=Number(a.substring(1)):save_data.chara.free1=Number(save_data.chara.free1)+Number(a)),e&&(0===e.indexOf("@")?save_data.chara.free2=Number(e.substring(1)):save_data.chara.free2=Number(save_data.chara.free2)+Number(e)),t&&(0===t.indexOf("@")?save_data.chara.free3=Number(t.substring(1)):save_data.chara.free3=Number(save_data.chara.free3)+Number(t))},updateResults:function(a){if(a){void 0===global_save_data.results&&(global_save_data.results={});var e=global_save_data.results;void 0===e[scenario_code]&&0!==scenario_code.indexOf("<")&&(e[scenario_code]=[]),!0===this.pushUnique(e[scenario_code],a)&&(toastr.options.timeOut=5e3,toastr.success(results_map[a].name,"実績獲得")),this.saveStorageGlobal()}},toast:function(a){$(".toast").remove(),$("body").append('<div class="toast">'+a+"</div>");var e=$("body").width()/2-$(".toast").outerWidth()/2;$(".toast").css("left",e).hide().fadeIn("fast"),setTimeout(function(){$(".toast").fadeOut("slow",function(){$(this).remove()})},4e3)},cube:function(a){void 0===a&&(a=1);for(var e="",t=0;t<a;t++)dice[t]=this.random(1,6),e+='<img src="'+ROOT+COMMON+"cube"+dice[t]+'.png" class="dice" />';return e},dropItem:function(a){if(a.drop){var e=a.drop.split("/"),t=Common.star_names[e[0]];if(t){var s="1"===e[1]?"":"×"+e[1];return{drop:a.drop,name:t+s}}return{drop:a.drop,name:e[2]}}if(!a.element)return{name:null};var r={earth:["thu","tue","sat","",""],fire:["tue","sun","tue","",""],water:["wed","mon","fri","",""],wind:["fri","wed","mon","",""],spirit:["sat","sun","mon","",""]},i=Util.randomArray(r[a.element]);return{drop:i?i+"/1":"",name:Common.star_names[i]}},computeDamage:function(a){for(var e,t=0,s=/([\+\-]?)(\d*)(R|L|STR|INT|DEX|KRM|FREE1|FREE2|FREE3)?]?/gi;null!=(e=s.exec(a));){var r=1,i=1,n=1;if(""===e[0])break;"-"===e[1]&&(r=-1),e[2]&&(i=Number(e[2]));var o={str:Number(save_data.chara.str),int:Number(save_data.chara.int),dex:Number(save_data.chara.dex),krm:Number(save_data.chara.krm)};switch(save_data.chara.state){case"frozen":o.str-=2,o.int-=2,o.dex-=2,o.krm-=2;break;case"stone":o.str-=1,o.int-=1,o.dex-=1,o.krm-=1;break;case"forget":o.str<o.int?o.int=0:o.str=0}switch(e[3]){case"L":n=dice[0];break;case"R":n=dice[1];break;case"STR":case"INT":case"DEX":case"KRM":n=o[e[3].toLowerCase()];break;case"FREE1":case"FREE2":case"FREE3":n=save_data.chara[e[3].toLowerCase()];break;default:n=1}t+=r*i*n}return t*=Number($("#damage_delta").val()),Math.floor(t)},selectFunc:function(a){return Util.randomArray(a.split(",")).trim()},deltaStatus:function(a){switch(a){case"frozen":var e="すべてのステータスを-2",t=-2,s=-2,r=-2,i=-2;break;case"stone":e="すべてのステータスを-1（30scene経過で死亡）",t=-1,s=-1,r=-1,i=-1;break;case"forget":e="STR／INTのうち、高い方が0に（20scene経過で解除）";if(save_data.chara.str<save_data.chara.int)t=0,s=-1*save_data.chara.int;else t=-1*save_data.chara.str,s=0;r=0,i=0;break;case"poison":e="シーン経過ごとにHPを-1",t=0,s=0,r=0,i=0;break;case"curse":e="魔法の利用が不可（UN-CURSEを除く）",t=0,s=0,r=0,i=0;break;default:e="－",t=0,s=0,r=0,i=0}return[t,s,r,i,e]},getBonusItem:function(a){return 0===a.indexOf("bgi")?Common.global_items.bad[a]:Common.global_items.happy[a]},initScenario:function(){Util.initSavedata(),Util.initDialog(),Util.createCommonTweet(),Util.createScene(0),window.alert("キャラが新規作成されました。\rステータスダイアログは画面右クリックで開くことができます。")},loadDialog:function(a,e){$.get(ROOT+COMMON+DIALOG+a+".html").done(function(t){var s=$(t);e(s),dialog_elem[a]=s,dialog_elem[a].insertBefore(target).hide()})},openDialogById:function(a,e){for(key in dialog_elem)a===key?e?$.sidr("open",key):dialog_elem[key].fadeIn(500):dialog_elem[key].hide()},initDialog:function(){$("#dialog_body").remove(),$.get(ROOT+COMMON+"dialog.html").done(function(a){dialog=$(a),$("#name",dialog).text(save_data.chara.name),$("#title",dialog).text(save_data.chara.title),$("#race",dialog).text(save_data.chara.race),$("#sex",dialog).text(save_data.chara.sex),$("#hp_m",dialog).text(save_data.chara.hp_m),$("#mp_m",dialog).text(save_data.chara.mp_m),$("#str_i",dialog).text(save_data.chara.str_i),$("#int_i",dialog).text(save_data.chara.int_i),$("#dex_i",dialog).text(save_data.chara.dex_i),$("#krm_i",dialog).text(save_data.chara.krm_i),$("#age",dialog).text(save_data.chara.age),$("#chara_face",dialog).attr("src",ROOT+COMMON+String(save_data.chara.sex).toLowerCase()+"_"+String(save_data.chara.age).toLowerCase()+"_"+String(save_data.chara.race).toLowerCase()+".png");var e=$("init > label",scenario_data);e&&($("#free-label1",dialog).text(e.nsAttr("free1")),$("#free-label2",dialog).text(e.nsAttr("free2")),$("#free-label3",dialog).text(e.nsAttr("free3")));var t=$("#job",dialog);t.empty();for(var s=0;s<enabled_jobs.length;s++)$("<option></option>").attr("value",enabled_jobs[s]).text(enabled_jobs[s]).appendTo(t);if(save_data.bonus){var r=Util.getBonusItem(save_data.bonus);$("#bonus",dialog).text(r.desc+"（"+r.name+"）")}dialog.insertBefore(target).hide()}),Util.loadDialog("bonus_list",function(a){for(var e=0;e<24;e++)num=e<10?"0"+e:e,num="gi"+num,-1!==$.inArray(num,global_save_data.items)?$("#"+num,a).attr("src",ROOT+COMMON+num+".png").attr("class","bonus_item"):$("#"+num,a).attr("src",ROOT+COMMON+"gi99.png");for(e=1;e<6;e++)num=e<10?"0"+e:e,num="bgi"+num,-1!==$.inArray(num,global_save_data.items)?$("#"+num,a).attr("src",ROOT+COMMON+num+".png").attr("class","bonus_item"):$("#"+num,a).attr("src",ROOT+COMMON+"gi99.png")}),Util.loadDialog("result_list",function(a){})},createDialog:function(){$("#job",dialog).val(save_data.chara.job),$("#hp",dialog).val(save_data.chara.hp),$("#mp",dialog).val(save_data.chara.mp),$('[name="state"]',dialog).each(function(){var a=$(this).nsAttr("value");a===save_data.chara.state?$(this).prop("checked",!0):$(this).prop("checked",!1)}),$("#stone_scene",dialog).text(save_data.chara.stone_scene),$("#forget_scene",dialog).text(save_data.chara.forget_scene),Util.setStateStyle(),$("#ellapsed_scene",dialog).text(save_data.ellapsed_scene+" scene"),$("#free1",dialog).val(save_data.chara.free1),$("#free2",dialog).val(save_data.chara.free2),$("#free3",dialog).val(save_data.chara.free3),$("#str",dialog).val(save_data.chara.str),$("#int",dialog).val(save_data.chara.int),$("#dex",dialog).val(save_data.chara.dex),$("#krm",dialog).val(save_data.chara.krm),$("#s_mon",dialog).val(save_data.stars[0]),$("#s_tue",dialog).val(save_data.stars[1]),$("#s_wed",dialog).val(save_data.stars[2]),$("#s_thu",dialog).val(save_data.stars[3]),$("#s_fri",dialog).val(save_data.stars[4]),$("#s_sat",dialog).val(save_data.stars[5]),$("#s_sun",dialog).val(save_data.stars[6]);var a=this.deltaStatus($('[name="state"]:checked',dialog).val());$("#state_desc",dialog).text(a[4]),$("#memos",dialog).val(save_data.memos);var e=$("#magic",dialog);for(var t in e.empty(),Common.magic){var s=Common.magic[t],r=$("<option></option>").attr("value",t).attr("title",s[8]).text(t+"（"+s[7]+"）");Util.canUseMagic(s)||r.attr("disabled","disabled"),r.appendTo(e)}for(var i=[],n=0;n<save_data.items.length;n++){var o=items_map[save_data.items[n]];i.push("・"+o.name+"（"+o.desc+"）")}$("#items",dialog).text(i.join("\r"));var d=$("#flags",dialog);d.empty();for(n=0;n<save_data.flags.length;n++){var l=flags_map[save_data.flags[n]];if(0!==l.indexOf("*")){var c="<option ";c+=">・"+flags_map[save_data.flags[n]]+"</option>",d.append(c)}}$("#flags > option:last",dialog).attr("selected","selected"),dialog.slideDown(500),$("#status_change").val("Equipment"),$("#status_basic").show(),$("#status_equip").hide(),target.slideUp(500)},copyNextScenario:function(a){var e=Util.deepCopyObject(save_data);e.chara.state="",e.chara.stone_scene=0,e.chara.forget_scene=0,e.chara.free1=0,e.chara.free2=0,e.chara.free3=0,e.items=e.items.filter(function(a){return void 0!==items_map[a].shared}),e.flags=[],e.scene=0,e.ellapsed_scene=0,e.bgm="",e.isEnded=!1;for(var t=0;t<a.length;t++)localStorage[a[t].trim()]=JSON.stringify(e)},endScenario:function(a,e,t){if(a){e&&Util.copyNextScenario(e.split(",")),console.log("***********Licence Info.***********");var s,r,i,n={bgm:"音楽",picture:"画像"};switch($("licence > work",scenario_data).each(function(){var a=$(this).nsAttr("url");console.log($(this).nsAttr("name")+"("+n[$(this).nsAttr("category")]+"): "+$(this).nsAttr("creator")+" "+(void 0!==a?a:""))}),console.log("***********Licence Info.***********"),"bad"===a?$('<p><a href="#" id="end_reload" class="scenebtn">最初から冒険に挑戦する</a></p>').appendTo(target):"happy"===a&&$('<p><a href="#" id="end_exit" class="scenebtn">ペンタウァに帰還する</a></p>').appendTo(target),save_data.isEnded=!0,Util.saveStorage(),a){case"happy":s=Util.randomArray(Object.keys(Common.global_items.happy)),r=Common.global_items.happy[s],i=Util.buildBgmPath(bgms_map.happy);break;case"bad":Util.random(0,100)<20&&(s=Util.randomArray(Object.keys(Common.global_items.bad)),r=Common.global_items.bad[s]),i=Util.buildBgmPath(bgms_map.bad)}t&&(bgm&&bgm.pause(),bgm=new Audio(i),bgm.loop=!0,global_save_data.bgm&&bgm.play()),s&&(Util.pushUnique(global_save_data.items,s),Util.saveStorageGlobal(),$.get("stext/common/dialog_bonus.html").then(function(a){var e=$(a);$("#bonus_img",e).attr("src",ROOT+COMMON+s+".png"),$("#bonus_item",e).text(r.name),$("#bonus_item_desc",e).text(r.desc),setTimeout(function(){$.zoombox.html(e.html(),{width:480,height:200})},2e3)}))}},canSceneMove:function(a,e){return-1!==e.split(",").indexOf(a)},playBgm:function(a){bgm&&bgm.pause(),bgm=new Audio(a),bgm.loop=!0,global_save_data.bgm&&bgm.play()},showSimpleStatus:function(){$("#simple_status").html('HP:<span class="status_v">'+save_data.chara.hp+'</span>　MP:<span class="status_v">'+save_data.chara.mp+'</span>　|　STR:<span class="status_v">'+save_data.chara.str+'</span>　INT:<span class="status_v">'+save_data.chara.int+'</span>　DEX:<span class="status_v">'+save_data.chara.dex+'</span>　KRM:<span class="status_v">'+save_data.chara.krm+"</span>　｜　"+(0!==$("init > label",scenario_data).length?'<br />F1:<span class="status_v">'+save_data.chara.free1+'</span>　F2:<span class="status_v">'+save_data.chara.free2+'</span>　F3:<span class="status_v">'+save_data.chara.free3+"</span>　｜　":"")+'<span id="status_state" class="status_v">'+Common.state_names[save_data.chara.state]+"</span>　"),$("#status_state").removeClass("status_poison status_frozen status_stone status_curse status_forget"),save_data.chara.state?($("#status_state").addClass("status_"+save_data.chara.state),target.addClass("main_bad")):target.removeClass("main_bad"),Util.createSidebar()},setStateStyle:function(){var a=$("#hp",dialog),e=$("#str",dialog),t=$("#int",dialog),s=$("#dex",dialog),r=$("#krm",dialog),i=$("#magic",dialog),n=$('[name="state"][value="poison"]').prop("checked"),o=$('[name="state"][value="frozen"]').prop("checked"),d=$('[name="state"][value="stone"]').prop("checked"),l=$('[name="state"][value="curse"]').prop("checked"),c=$('[name="state"][value="forget"]').prop("checked"),m="dialog_poison dialog_frozen dialog_stone dialog_curse dialog_forget";a.removeClass(m),e.removeClass(m),t.removeClass(m),s.removeClass(m),r.removeClass(m),i.removeClass(m),n?a.addClass("dialog_poison"):o?(e.addClass("dialog_frozen"),t.addClass("dialog_frozen"),s.addClass("dialog_frozen"),r.addClass("dialog_frozen")):d?(e.addClass("dialog_stone"),t.addClass("dialog_stone"),s.addClass("dialog_stone"),r.addClass("dialog_stone")):l?i.addClass("dialog_curse"):c&&(save_data.chara.str<save_data.chara.int?t.addClass("dialog_forget"):e.addClass("dialog_forget"))},interpolation:function(a,e){var t=e.split("?"),s=t[0];if(t[1])var r=t[1].split(":");switch(s){case"name":return save_data.chara.name;case"title":return save_data.chara.title;case"race":switch(save_data.chara.race){case"FIGHTER":return r[0];case"WIZARD":return r[1];case"DWARF":return r[2];case"ELF":return r[3];default:return"Unknown Race"}case"sex":switch(save_data.chara.sex){case"MALE":return r[0];case"FEMALE":return r[1];default:return"Unknown Sex"}case"age":switch(save_data.chara.age){case"YOUNG":return r[0];case"ADULT":return r[1];case"OLD":return r[2];default:return"Unknown Age"}case"state":switch(save_data.chara.state){case"":return r[0];case"poison":return r[1];case"frozen":return r[2];case"stone":return r[3];case"curse":return r[4];case"forget":return r[5];default:return"Unknown State"}case"rand":return Util.random(Number(r[0]),Number(r[1]));case"msg":return Util.randomArray(r);case"input":return'<input type="button" class="spinner_down sgml" value="-" /><input type="number" class="sgml" value="'+r[0]+'" /><input type="button" class="spinner_up sgml" value="+" />';default:return e}},conditionSingle:function(a){return a=a.trim(),-1!==save_data.flags.indexOf(a)||-1!==save_data.items.indexOf(a)||Util.canUseMagicByName(a)||Util.ifStatus(a)||Util.isCharaState(a)||Util.hasStars(a)||Util.hasResult(a)},conditionAllTrue:function(a){for(var e=!0,t=a.split(","),s=0;s<t.length;s++)if(!Util.conditionSingle(t[s])){e=!1;break}return e},conditionFull:function(org_cond){var eval_str="",ope=/([\&\|\!\(\)]{1,2})/,conds=org_cond.split(ope);console.log(conds);for(var i=0;i<conds.length;i++){var c=conds[i];c&&(ope.test(c)?eval_str+=c:0!==c.indexOf("-")?eval_str+=Util.conditionSingle(c):eval_str+=!Util.conditionSingle(c.substring(1)))}return console.log(eval_str),eval(eval_str)},judgeMultiCondition:function(a){return a=a.replace("#NOT#","!"),a=a.replace("#AND#","&"),a=a.replace("#OR#","|"),a=a.replace("#L#","("),a=a.replace("#R#",")"),/([\&\|\!\(\)]{1})/.test(a)?Util.conditionFull(a):0!==a.indexOf("-")?Util.conditionAllTrue(a):!Util.conditionAllTrue(a.substring(1))},showSceneButton:function(){$("a[title]",target).hide();var a=$("a[title]",target);a.each(function(a,e){Util.judgeMultiCondition($(e).nsAttr("title"))&&$(e).show()})},ifCondition:function(a,e,t){return Util.judgeMultiCondition(e)?t:""},parseTweet:function(a,e){return tweet_message=e,e},createTweet:function(a,e,t){if(e||(e="原作30周年記念企画「SORCERIAN Text」ユーザー参加型のゲームブック版ソーサリアン"),"custom"===a)var s=$(".socialbtn.twitter_custom"),r=$(".socialbtn.twitter");else s=$(".socialbtn.twitter"),r=$(".socialbtn.twitter_custom");t||(s.empty(),s.append($('<a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-lang="ja" data-url="https://www.web-deli.com/sorcerian/text/" data-via="snext1220" data-related="snext1220" data-hashtags="falcom,stext">Tweet</a>').attr("data-text",e)).append('<script src="https://platform.twitter.com/widgets.js" charset="UTF-8"></script>')),s.show(),r.hide()},createCommonTweet:function(){Util.createTweet("common",$("init > intro",scenario_data).nsAttr("description"))},createEnemyList:function(a){var e=$('<table class="enemy">');if(a){var t=a.split(",");e.append('<tr class="enemy_title">'+(t.length>1?"<th></th>":"")+'<th>名前／属性</th><th>攻撃</th><th title="現在のダイス値に従って、ダメージを反映させます。">ダメージ <select id="damage_delta"><option value="2">x2</option><option value="1" selected>x1</option><option value="0.5">x1/2</option><option value="0.25">x1/4</option></select></th><th title="記載されたドロップアイテムをステータスに反映させます。">戦利品</th></tr>');for(var s=0;s<t.length;s++){var r=enemies_map[t[s]],i=Common.state_names[r.attack],n='<tr class="enemy_row" data-enemy="'+t[s]+'">';if(t.length>1&&(n+='<td><input type="checkbox" class="enemy_check" /></td>'),n+="<th>",r.element?n+='<img src="'+ROOT+COMMON+"attr_"+r.element+'.png" title="'+Common.element_names[r.element]+'" /></a>　':n+='<img src="'+ROOT+COMMON+'attr_none.png" title="無" /></a>　',n+=r.name+"</th><td>",
n+=i?'<img src="'+ROOT+COMMON+"atk_"+r.attack+'.png" title="'+i+'" /></a>　':r.attack,n+="</td><td>",r.func)if(0===r.func.indexOf("*"))n+=Util.selectFunc(r.func.substring(1));else{var o=Util.selectFunc(r.func);n+='<div class="enemy_func" data-func="'+o+'" data-attack="'+r.attack+'">'+o+"</div>"}n+="</td><td>";var d=Util.dropItem(r);d.name?n+='<input type="button" class="enemy_drop" value="'+d.name+'" data-drop="'+d.drop+'"/>':n+="－",n+="</td></tr>",e.append(n)}}else e.append("<p>ここには、モンスターの気配はないようだ。</p>");e.prependTo("#sidr"),e.wrap('<div id="enemy_table"></div>'),Util.createSidebar()},createSidebar:function(){$("#side_show").sidr({displace:!1,renaming:!1})},createScene:function(a,e){if(void 0===e&&(e={}),tweet_message=null,save_data.isEnded)location.reload(!0);else{if(!Util.updateStarsByMagic(e.conditions))return toastr.options.timeOut=4e3,void toastr.warning("星が不足しているようだ。");$(window).scrollTop(0);var t=$('scene[id="'+a+'"]',scenario_data);e.reverse?e.restore&&history.pushState(save_data,"Scene "+a):(Util.updateItems(t.nsAttr("items")),Util.updateFlags(t.nsAttr("flags")),Util.updateStates(),Util.updateStars(t.nsAttr("stars")),Util.updateHpMp(t.nsAttr("hp"),t.nsAttr("mp")),Util.updateStr2Krm(t.nsAttr("str"),t.nsAttr("int"),t.nsAttr("dex"),t.nsAttr("krm")),Util.updateFrees(t.nsAttr("free1"),t.nsAttr("free2"),t.nsAttr("free3")),Util.updateResults(t.nsAttr("result")),save_data.scene=a,save_data.ellapsed_scene++,Util.saveStorage(),history.pushState(save_data,"Scene "+a));var s=t.text();s=s.replace(/(\[.+?\]\([\d,]{1,} ")(.+?)("\))/gi,function(a,e,t,s){return console.log(e),console.log(t),console.log(s),t=t.split("!").join("#NOT#"),t=t.split("&").join("#AND#"),t=t.split("|").join("#OR#"),t=t.split("(").join("#L#"),t=t.split(")").join("#R#"),console.log(e+t+s),e+t+s}),s=s.replace(/%(blue|red|purple|white)%/gi,'&nbsp;<span style="color:$1">'),s=s.replace(/%\/%/gi,"</span>&nbsp;"),s=s.replace(/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?/gi,'<a href="$&" data-link="auto" target="_blank">$&</a>'),s=s.replace(/\${if[\s]+(.+?)}([\s\S]+?)\${\/if}/gi,this.ifCondition),s=s.replace(/\${(.+?)\|(.+?)}/gi,"<ruby>$1<rp>（</rp><rt>$2</rt><rp>）</rp></ruby>"),s=s.replace(/\${tweet}([\s\S]+?)\${\/tweet}/gi,this.parseTweet),s=s.replace(/\${(.+?)}/gi,this.interpolation),target.html(s),target.markdown(),tweet_message?Util.createTweet("custom",tweet_message):Util.createTweet("common",null,!0),$('<h5 id="scenario_title"><img id="ctrl_show" src="'+ROOT+COMMON+'ctrl_show.png" /></a> '+$("scenario",scenario_data).nsAttr("title")+"【"+a+'】</span></h5><div id="control_panel"><img id="ctrl_home" src="'+ROOT+COMMON+'ctrl_home.png" /></a>　<img id="status_open" src="'+ROOT+COMMON+'ctrl_status.png" />　<img id="ctrl_bonus" src="'+ROOT+COMMON+'ctrl_bonus.png" />　<img id="audio_onoff" src="'+ROOT+COMMON+"ctrl_audio_"+(global_save_data.bgm?"on":"off")+'.png" />　<img id="ctrl_reload" src="'+ROOT+COMMON+'ctrl_results.png" />　<img id="ctrl_back_res" src="'+ROOT+COMMON+'ctrl_backup.png" />　<input id="ctrl_input_restore" type="file" accept=".stext" /><img id="ctrl_help" src="'+ROOT+COMMON+'ctrl_help.png" /><ul id="ctrl_backup_menu" class="cxt"><li data-command="backup">Backup</li><li data-command="restore">Restore</li></ul></div>').prependTo(target);var r=$('<div id="side_show">Battle Sheet</div>');t.nsAttr("enemies")&&r.css("background-color","Red"),r.insertBefore("#scenario_title"),$('<div id="sidr"></div>').insertBefore("#scenario_title"),Util.createEnemyList(t.nsAttr("enemies")),$('<div id="sidr_close">閉じる</div>').appendTo("#sidr"),$('<div id="simple_status"></div>').insertBefore("#sidr_close"),this.showSimpleStatus(),$('<center id="cubes">'+Util.cube(2)+"</center>").insertBefore("#simple_status"),global_save_data.panel||$("#control_panel").hide(),debug_mode&&($('<div id="debug_panel"><form><label>Scene：<input id="debug_id" type="text" size="5" /></label>　<label>Items：<input id="debug_items" type="text" size="7" /></label>　<label>Flags：<input id="debug_flags" type="text" size="7" /></label>　<input id="debug_reload" type="button" value="Reload" /></form></div>').prependTo(target),$("#debug_panel #debug_id").val(a),$("#debug_panel #debug_items").val(save_data.items.join(",")),$("#debug_panel #debug_flags").val(save_data.flags.join(",")),$("#debug_panel #debug_reload").click(function(a){var e=$("#debug_panel #debug_items").val().trim(),t=$("#debug_panel #debug_flags").val().trim();save_data.items=""!==e?e.split(","):[],save_data.flags=""!==t?t.split(","):[],Util.saveStorage(),Util.createScene($("#debug_panel #debug_id").val())})),$("a",target).addClass("scenebtn"),$('a[data-link="auto"]',target).removeClass("scenebtn");var i=$('a[href="X"]',target);i.removeClass("scenebtn").addClass("scene_move").attr("data-allow",i.text()).text("移動する").before('<input type="number" id="toscene" class="scene_move" />').add("#toscene").wrapAll('<div class="xbtn"></div>');var n=$('a[href="Q"]',target);n.removeClass("scenebtn").addClass("quest_str").attr("data-yesno",n.text()).text("回答する").before('<input type="text" id="stranswer" class="quest_str" />').add("#stranswer").wrapAll('<div class="xbtn"></div>');var o=$("a:has(img)",target);o.each(function(a,e){var t=ROOT+scenario_code+"/"+CAPTURE+$(e).attr("href");$(e).attr("href",t).removeClass("scenebtn").addClass("scenepic").find("img").attr("src",t)}),$("a.scenepic").zoombox(),Util.showSceneButton(),$(".scenebtn:hidden + br",target).remove(),$("a[title]:hidden",target).remove();var d=t.nsAttr("bgm"),l=save_data.bgm;if(void 0!==d&&(l=d),l!==bgm_name&&(Util.playBgm(Util.buildBgmPath(l)),bgm_name=l,save_data.bgm=l,Util.saveStorage(),history.replaceState(save_data,"Scene "+a)),t.nsAttr("se")){var c=new Audio(ROOT+scenario_code+"/"+BGM+SE+t.nsAttr("se")+".mp3");c.loop=!1,c.play()}Util.endScenario(t.nsAttr("end"),t.nsAttr("nexts"),void 0===t.nsAttr("bgm"))}}};$.fn.extend({startGame:function(a,e){scenario_code=a,dialog_elem.main=target=this,e||(e=!1),debug_mode=e,target.addClass("main_back"),target.off(),target.parent().off(),$(document).off("click","#dialog_list img.bonus_item"),$(window).off("popstate"),target.on("click","a.scenebtn",function(a){if("end_reload"!==a.target.id)if("end_exit"!==a.target.id){var e=$(this).nsAttr("href"),t=$(this).nsAttr("title");-1!==e.indexOf(",")&&(e=Util.randomArray(e.split(",")).trim()),Util.createScene(e,{conditions:t}),bgm&&bgm.paused&&global_save_data.bgm&&bgm.play(),a.preventDefault()}else location.href="https://www.web-deli.com/sorcerian/text/"}),target.on("click","#end_reload",function(a){a.preventDefault(),a.stopImmediatePropagation(),("playground"!==scenario_code||confirm("ページをリロードしても宜しいですか？\nリロード時には、エディター上の編集内容も削除されます。シナリオ編集中の場合は、内容を保存してください。"))&&location.reload(!0)}),target.on("click","a.scene_move",function(a){var e=$("#toscene").val(),t=$(this).nsAttr("data-allow");Util.canSceneMove(e,t)?Util.createScene(e):(toastr.options.timeOut=4e3,toastr.warning("指定された番号には移動できないようだ")),a.preventDefault()}),target.on("click","a.quest_str",function(a){var e=$("#stranswer").val(),t=$(this).nsAttr("data-yesno").split(",");if(e===t[0])var s=t[1];else s=t[2];Util.createScene(s),a.preventDefault()}),$(document).on("click","tr.enemy_row",function(a){var e=enemies_map[$(this).nsAttr("data-enemy")];toastr.options.timeOut=5e3,toastr.info(e.desc,e.name)}),$(document).on("click","input.enemy_check",function(a){a.stopImmediatePropagation()}),$(document).on("click","div.enemy_func",function(a){a.stopImmediatePropagation(),toastr.options.timeOut=5e3;var e=$(this).nsAttr("data-func"),t=$(this).nsAttr("data-attack");if(-1!==["poison","frozen","stone","curse","forget"].indexOf(t)){var s=e.split(/([<>])/),r=Util.computeDamage(s[0]),i=Util.computeDamage(s[2]);if("<"===s[1])var n=r<i;else n=r>i;n?toastr.info("回避に成功した。","状態異常"):(save_data.chara.state=t,toastr.error("「"+Common.state_names[t]+"」を受けた！","状態異常"))}else{var o=Util.computeDamage(e);switch(o<0&&(o=0),t){case"physics":save_data.chara.hp=Number(save_data.chara.hp)-o;var d="HPに"+o+"のダメージ！（現在値："+save_data.chara.hp+"）";break;case"magic":save_data.chara.mp=Number(save_data.chara.mp)-o;d="MPに"+o+"のダメージ！（現在値："+save_data.chara.mp+"）";break;case"both":save_data.chara.hp=Number(save_data.chara.hp)-o,save_data.chara.mp=Number(save_data.chara.mp)-o;d="HP/MPに"+o+"のダブルダメージ！（現在値hp/mp："+save_data.chara.hp+"/"+save_data.chara.mp+"）";break;case"free1":save_data.chara.free1=Number(save_data.chara.free1)-o;d="FREE1に"+o+"のダメージ！（現在値："+save_data.chara.free1+"）";break;case"free2":save_data.chara.free2=Number(save_data.chara.free2)-o;d="FREE2に"+o+"のダメージ！（現在値："+save_data.chara.free2+"）";break;case"free3":save_data.chara.free3=Number(save_data.chara.free3)-o;d="FREE3に"+o+"のダメージ！（現在値："+save_data.chara.free3+"）"}0===o?(d="敵の攻撃を防ぎきった！",toastr.info(d,"被ダメージ")):toastr.error(d,"被ダメージ")}Util.saveStorage(),Util.showSimpleStatus()}),$(document).on("click","input.enemy_drop",function(a){a.stopImmediatePropagation();var e=$(this).nsAttr("data-drop").split("/");if(2===e.length)Util.updateStarById(e[0],e[1]),toastr.options.timeOut=5e3,toastr.info(Common.star_names[e[0]]+"の欠片を"+e[1]+"個取得しました。","アイテム獲得");else{var t="free1"===e[0]?e[1]:0,s="free2"===e[0]?e[1]:0,r="free3"===e[0]?e[1]:0;Util.updateFrees(t,s,r),toastr.options.timeOut=5e3,toastr.info(e[2]+"を取得しました。","アイテム獲得")}Util.saveStorage()});var t,s=new Audio(ROOT+COMMON+"dice.mp3"),r=function(){t++,$("#cubes").html(Util.cube(2)),t>20||setTimeout(r,50)};$(document).on("click","#cubes",function(a){console.log("cube"),s.play(),t=1,r(this)}),target.on("click","#status_open",function(a){Util.createDialog(),a.preventDefault()}),target.on("contextmenu",function(a){Util.createDialog(),a.preventDefault()}),target.on("click","#audio_onoff",function(a){bgm&&(global_save_data.bgm?(global_save_data.bgm=!1,$(this).attr("src",ROOT+COMMON+"ctrl_audio_off.png"),bgm.pause()):(global_save_data.bgm=!0,$(this).attr("src",ROOT+COMMON+"ctrl_audio_on.png"),bgm.play()),Util.saveStorageGlobal())}),target.parent().on("click","#dialog_body #status_save",function(a){save_data.chara.job=$("#dialog_body #job").val(),save_data.chara.hp=$("#dialog_body #hp").val(),save_data.chara.mp=$("#dialog_body #mp").val(),save_data.chara.free1=$("#dialog_body #free1").val(),save_data.chara.free2=$("#dialog_body #free2").val(),save_data.chara.free3=$("#dialog_body #free3").val(),save_data.chara.str=$("#dialog_body #str").val(),save_data.chara.int=$("#dialog_body #int").val(),save_data.chara.dex=$("#dialog_body #dex").val(),save_data.chara.krm=$("#dialog_body #krm").val(),save_data.chara.state=$('#dialog_body [name="state"]:checked').val(),save_data.stars[0]=$("#dialog_body #s_mon").val(),save_data.stars[1]=$("#dialog_body #s_tue").val(),save_data.stars[2]=$("#dialog_body #s_wed").val(),save_data.stars[3]=$("#dialog_body #s_thu").val(),save_data.stars[4]=$("#dialog_body #s_fri").val(),save_data.stars[5]=$("#dialog_body #s_sat").val(),save_data.stars[6]=$("#dialog_body #s_sun").val(),save_data.memos=$("#dialog_body #memos").val(),Util.saveStorage(),Util.showSimpleStatus(),dialog.slideUp(500),target.slideDown(500)}),target.parent().on("click","#dialog_body #status_close",function(a){dialog.slideUp(500),target.slideDown(500)}),target.on("click","#sidr_close",function(a){$.sidr("close")}),target.parent().on("click",'#dialog_body [name="state"]',function(a){var e=Util.deltaStatus($(this).val());$("#dialog_body #state_desc").text(e[4]),Util.setStateStyle()});var i=function(a,e,t){if(a[e]>0){var s=$("#dialog_body "+t).val();$("#dialog_body "+t).val(s-a[e])}};target.parent().on("click","#dialog_body #magic_run",function(a){a.preventDefault();var e=Common.magic[$("#dialog_body #magic option:selected").val()];e&&($("#dialog_body #s_mon").val()<e[0]||$("#dialog_body #s_tue").val()<e[1]||$("#dialog_body #s_wed").val()<e[2]||$("#dialog_body #s_thu").val()<e[3]||$("#dialog_body #s_fri").val()<e[4]||$("#dialog_body #s_sat").val()<e[5]||$("#dialog_body #s_sun").val()<e[6]?window.alert("星が不足しているため、魔法を発動できません！"):(i(e,0,"#s_mon"),i(e,1,"#s_tue"),i(e,2,"#s_wed"),i(e,3,"#s_thu"),i(e,4,"#s_fri"),i(e,5,"#s_sat"),i(e,6,"#s_sun")))}),target.parent().on("click","#dialog_body #status_change",function(a){var e=$("#status_basic");"none"===e.css("display")?($("#status_change").val("Equipment"),$("#status_basic").show(),$("#status_equip").hide()):($("#status_change").val("Basic Status"),$("#status_basic").hide(),$("#status_equip").show())}),target.parent().on("click","#dialog_body .spinner_up, .spinner_up",function(a){var e=$(this).prev();e.val(Number(e.val())+1)}),target.parent().on("click","#dialog_body .spinner_down, .spinner_down",function(a){var e=$(this).next();e.val(Number(e.val())-1)}),target.parent().on("click",".dialog_back",function(a){$(this).parents(".dialog_root").fadeOut(500),target.fadeIn(500)}),target.on("click","#ctrl_bonus",function(a){Util.openDialogById("bonus_list")}),$(document).on("click","#bonus_list .item_list img.bonus_item",function(a){var e,t=a.target.id;e=t.startsWith("gi")?Common.global_items.happy[t]:Common.global_items.bad[t],toastr.success(e.desc,e.name)}),target.on("click","#ctrl_home",function(a){location.href="https://www.web-deli.com/sorcerian/text/"}),target.on("click","#ctrl_reload",function(a){var e=0,t=0,s=["","ノーマル","ブロンズ","シルバー","ゴールド","プラチナ"],r=dialog_elem.result_list;$(".result_list",r).empty(),Object.keys(results_map).forEach(function(a){if(e++,void 0!==global_save_data.results[scenario_code]&&-1!==global_save_data.results[scenario_code].indexOf(a)){t++;var i='<tr><td><img src="'+ROOT+COMMON+"trophy"+results_map[a].level+'.png" title="'+s[results_map[a].level]+'" /></td><td><h3>'+results_map[a].name+"（Lv."+results_map[a].level+"）</h3><p>"+results_map[a].desc+"</p></td></tr>"}else i='<tr><td><img src="'+ROOT+COMMON+'trophy0.png" title="実績未達" /></td><td><h3>???????????????</h3><p>???????????????</p></td></tr>';$(".result_list",r).append(i)});var i=(t/e*100).toFixed(1);$("#result_rate",r).text("Rate:"+i+"%"),Util.openDialogById("result_list")}),target.on("click","#ctrl_back_res",function(a){$("#ctrl_backup_menu").css({display:"block",top:a.pageY,left:a.pageX})}),target.on("click","#ctrl_backup_menu li",function(a){var e=$(this).attr("data-command");switch(e){case"backup":Util.downloadSavedata(scenario_code,storage[scenario_code]);break;case"restore":$("#ctrl_input_restore").click();break;default:console.log("Backup/Restore Error!!")}}),target.on("change","#ctrl_input_restore",function(){scenario_code===this.files[0].name.split("-")[0]?Util.restoreSaveData(this,function(){window.alert("リストアに成功しました。\nゲームを再起動します。"),location.reload()}):window.alert("失敗：現在のシナリオ以外のバックアップはUtilityページからリストアしてください。")}),$(":not(#ctrl_backup_menu)").click(function(a){"ctrl_back_res"!==a.target.id&&$("#ctrl_backup_menu").css("display","none")}),target.on("click","#ctrl_help",function(a){window.open("http://d.hatena.ne.jp/sorcerian/20171220")}),target.on("click","#scenario_title",function(a){var e=$("#control_panel");"none"===e.css("display")?($("#control_panel").slideDown(),global_save_data.panel=!0):($("#control_panel").slideUp(),global_save_data.panel=!1),Util.saveStorageGlobal()}),$(window).on("popstate",function(a){save_data.isEnded||null!=a.originalEvent.state&&(save_data=a.originalEvent.state,Util.saveStorage(),Util.createScene(a.originalEvent.state.scene,{reverse:!0}))}),target.on("click","#restart #tmp_init",function(a){Util.initScenario()}),target.on("click","#restart #tmp_continue",function(a){Util.initJobs(),Util.initDialog(),Util.createCommonTweet();var e=save_data.scene;Util.createScene(e,{reverse:!0,restore:!0})}),storage[GLOBAL_SAVE_DATA_KEY]?Util.loadStorageGlobal():Util.initGlobalSaveData();var n=function(a){for(var e in scenario_data=a,Common.magic){for(var t=Common.magic[e],s="",r=["月","火","水","木","金","土","太"],i=0;i<7;i++)t[i]>0&&(s+=r[i]+t[i]+" ");t.push(s)}flags_map={},$("flags > flag",scenario_data).each(function(){flags_map[$(this).nsAttr("id")]=$(this).text().trim()}),enemies_map={},$("enemies > enemy",scenario_data).each(function(){enemies_map[$(this).nsAttr("id")]={name:$(this).nsAttr("name"),element:$(this).nsAttr("element"),attack:$(this).nsAttr("attack"),func:$(this).nsAttr("func"),drop:$(this).nsAttr("drop"),desc:$(this).text().trim()}}),items_map={},$("items > item",scenario_data).each(function(){items_map[$(this).nsAttr("id")]={name:$(this).nsAttr("name"),shared:$(this).nsAttr("shared"),desc:$(this).text().trim()}}),results_map={},$("results > result",scenario_data).each(function(){results_map[$(this).nsAttr("id")]={name:$(this).attr("name"),level:$(this).nsAttr("level"),desc:$(this).text().trim()}});var n=$("init > bgm",scenario_data),o=n.nsAttr("main"),d=n.nsAttr("happy"),l=n.nsAttr("bad");if(bgms_map={main:void 0===o?"main":o,happy:void 0===d?"happy":d,bad:void 0===l?"bad":l},!0===debug_mode){var c=Util.validateScenario();if(0!==c.length){var m="<h3>scenario.xmlでエラーが検出されました。</h3>";return m+='<ul class="errorlist">',c.forEach(function(a){m+="<li>Scene "+a.scene_id+": "+a.message+"</li>"}),m+="</ul>",void target.html(m)}}if(!storage[scenario_code]||(Util.loadStorage(),save_data.isEnded))Util.initScenario();else{var u='<div id="restart"><h3>Welcome to SORCERIAN Text!!</h3><p>以前のデータが残っています。<br />続きから開始しますか？</p><button id="tmp_continue">続きから</button> <button id="tmp_init">最初から</button></div>';target.html(u)}};if(scenario_code=scenario_code.trim(),0===scenario_code.indexOf("<")){var o=new DOMParser,d=o.parseFromString(scenario_code,"text/xml");scenario_code="playground",global_save_data.results.playground=[],Util.saveStorageGlobal(),n(d)}else $.get(ROOT+scenario_code+"/scenario.xml").done(n).fail(function(a,e,t){throw new Error("scenario code is invalid.")})},gbat2stext:function(a){$(this).change(function(e){var t=0,s=$('<scenario xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://www.web-deli.com/sorcerian/next/stext/common/sgml.xsd">\n</scenario>'),r=$("<init>\n</init>"),i=$("<items>\n</items>"),n=$("<flags>\n</flags>"),o=$("<enemies>\n</enemies>"),d=$("<results>\n</results>"),l=$("<licence>\n</licence>"),c=function(e){var c=$(this.result),_=$("title",c).text().trim().split("@");if(s.attr("title")||(s.attr("title",_[0]),s.attr("author",_[1])),$("section",c).each(function(a,e){var t=!1,c={};if(c.id=Number($("number",e).text()),1===c.id&&(c.id=0),"link"===$("> summary",e).text().toLowerCase())return!0;var m="\n";$("> text p",e).each(function(a,e){var s=$(e).text();if("@@"===s.trim())return t=!t,!0;if(t){if(!s)return!0;if(0===s.indexOf("pc")){var u=s.split(":"),_=$("<constraint></constraint>");u[1]&&_.attr("race",u[1]),u[2]&&_.attr("sex",u[2]),u[3]&&_.attr("age",u[3]),_.appendTo(r)}else if(0===s.indexOf("bgm")){var p=s.split(":"),g=$("<bgm></bgm>");p[1]&&g.attr("main",p[1]),p[2]&&g.attr("happy",p[2]),p[3]&&g.attr("bad",p[3]),g.appendTo(r)}else if(0===s.indexOf("label")){var v=s.split(":"),f=$("<label></label>");v[1]&&f.attr("free1",v[1]),v[2]&&f.attr("free2",v[2]),v[3]&&f.attr("free3",v[3]),f.appendTo(r)}else if(0===s.indexOf("intro")){var h=s.split(":"),b=$("<intro></intro>");h[1]&&b.attr("description",h[1]),b.appendTo(r)}else if(0===s.indexOf("i")){var O=s.split(":");$("<item></item>").attr("id",O[0]).attr("name",O[1]).text(O[2]).appendTo(i)}else if(0===s.indexOf("f")){var A=s.split(":");$("<flag></flag>").attr("id",A[0]).text(A[1]).appendTo(n)}else if(0===s.indexOf("m")){var x=s.split(":");$("<enemy></enemy>").attr("id",x[0]).attr("name",x[1]).attr("element",x[2]).attr("attack",x[3]).attr("func",x[4]).attr("drop",x[5]).text(x[6]).appendTo(o)}else if(0===s.indexOf("r")){var w=s.split(":");$("<result></result>").attr("id",w[0]).attr("name",w[1]).attr("level",w[2]).text(w[3]).appendTo(d)}else if(0===s.indexOf("w")){var y=s.split(":");$("<work></work>").attr("name",y[1]).attr("category",y[2]).attr("creator",y[3]).attr("url",y[4]?"//"+y[4]:"").appendTo(l)}else if(0===s.indexOf("@")){var M=s.substring(1).split(":");void 0===M[1]&&(M[1]=""),c[M[0]]=M[1]}}else m+=s+"\n"}),m+="\n",$("choices choice",e).each(function(a,e){var t=$("text p",e).text().trim().split("@"),s=$("destination",e).text();if("999"===s){var r="[";r+=t[0],r+="](X)\n"}else if("998"===s){r="[";r+=t[0],r+="](Q)\n"}else{r="[";r+=t[0],r+="](",r+=s,t[2]&&(r+=","+t[2]),t[1]&&(r+=' "'+t[1]+'"'),r+=")\n"}m+=r});var u=$("<scene></scene>\n").attr("id",c.id).text(m);void 0!==c.items&&u.attr("items",c.items),void 0!==c.flags&&u.attr("flags",c.flags),void 0!==c.enemies&&u.attr("enemies",c.enemies),void 0!==c.stars&&u.attr("stars",c.stars),void 0!==c.hp&&u.attr("hp",c.hp),void 0!==c.mp&&u.attr("mp",c.mp),void 0!==c.free1&&u.attr("free1",c.free1),void 0!==c.free2&&u.attr("free2",c.free2),void 0!==c.free3&&u.attr("free3",c.free3),void 0!==c.bgm&&u.attr("bgm",c.bgm),void 0!==c.se&&u.attr("se",c.se),void 0!==c.result&&u.attr("result",c.result),void 0!==c.end&&u.attr("end",c.end),u.appendTo(s)}),l.prependTo(s),d.prependTo(s),o.prependTo(s),n.prependTo(s),i.prependTo(s),r.prependTo(s),t++,t>=m.length)if(a)a(s);else{var p=vkbeautify.xml('<?xml version="1.0" encoding="utf-8"?>\n'+s.get(0).outerHTML),g=new Blob([p],{type:"application/octet-stream"}),v=document.createElement("a");v.href=window.URL.createObjectURL(g),v.download="scenario.xml",v.click()}else u.readAsText(m[t],"UTF-8")},m=$(this).get(0).files,u=new FileReader;$(u).on("load",c),u.readAsText(m[t],"UTF-8")})},backupData:function(a){$(this).click(function(){var e="",t=localStorage,s=$(a).val();if("all"===s)$.get(ROOT+"stext.xml").done(function(a){var r=[GLOBAL_SAVE_DATA_KEY];$("work[id]:not([unpublished])",a).each(function(a,e){r.push($(e).attr("id"))});for(var i=0;i<r.length;i++){var n=t[r[i]];n&&(e+=r[i]+"\n",e+=n+"\n")}Util.downloadSavedata(s,e)});else{if(e=t[s],!e)return void window.alert("データが存在しません！");Util.downloadSavedata(s,e)}})},restoreData:function(){$(this).change(function(){Util.restoreSaveData(this,function(){window.alert("リストアが完了しました。\r（起動している場合は）ゲーム画面をリロードしてください。")})})},nsAttr:function(a){var e=$(this).attr(a);if(void 0!==e)return e.replace(/\s+/g,"")}})})(jQuery);