(function($){var ROOT="stext/",COMMON="common/",DIALOG="dialog/",CAPTURE="capture/",BGM="bgm/",SE="se/",scenario_code,scenario_data,enabled_jobs,flags_map={},enemies_map={},items_map={},results_map={},bgms_map={},save_data,global_save_data,GLOBAL_SAVE_DATA_KEY="sorcerian_text",target,dialog,dialog_item,dialog_elem={},debug_mode=!1,bgm,bgm_name,storage=localStorage,dice=[1,1],tweet_message,Common={male_name:["ボブ","デュエル","ゴルカス","ジェノバン","グーラン","ジャンビエ","グログス","コル","フロニアス","グーリム","カザミィ","ソロン","ゼン","ヴォル","マルス","レイザー","ミリオン","エリック","ジロ","ソード","ディル","ガタビア","ラウア","ハルビン","グドン","ジャミル","ディカン","ダート","タットワ5世","ディカン","ホド","ゲプラー","コクマー","グレアム","ロウポー","ラッツ","ソルト","ランブル","ネイル","ルシアン","ギム","チェイサー","ルワン","ゾーク","オルム","テュモー","バロン","カメロン","トード","グンダ","フラジオレ","ファン＝フレディ","ファネッサ3世","クリフト4世","クォール","ディオン","ホゼア","ロラッド","バルナ","ティゲロ","テト","ニフト","オーサー","ゲディス","レオン","アンドリュー","キリー","トーマス","エディ","ノーマス","ギルデン","ノーネーム","ユイター","デュオン","ペトス","フェリス","スラン","アルフレッド","ソクラム","アルモス","ログレック","ラルーゴ","キッド","ドレイク","ウォルトス","レスター","テリー","グラハン","ラドール","ウェステル","フェスタ","バンブー","ゲルフス","ドン・コサック","ベオグラード","ピエール","タルフ","エヴァン","ドゥール","バルガス","アーサー","ガッシュ","エルウッド","ヘルナー","エリック","ジャグラー","アラン","ロニアス","アスタル","ボルックス","ラドナー","ギルバレス","ジャレス","ルー","スズキ","ジロサ","サントリーニ","ルルイエ","コーラル","ボマード","ナルシス","マーヴァル","クール","ヨシュア","エヴァム","ジャンク","ボイド","ヘクター","デンキブラウン","バイアス","ブロイム","ディンギル","リグ","バド","ジード","ラルザス","ガイキナ","ロッド","ケイン","ルーミス","タジート","ブレイス","ディンクス","マーク","ホホホ","テシター","J.B","ジン","マック","リラ","ジバ","バーラン","ポジティル","ネガティル","ファルカス","ファウネス","ファルカス","チェン","パズス12世","タムタム","リーク・ディオン","タウラー","ラルディ","ノーマス","アドロン","ロカルノ","ゲラン","シュヴェーリン","ローラン","ウェッジ","アントロノフ","キム","ヤン","デフ","ミケロ","クール","ティエンルン","コウ","マルク","オーエン","トート","グート","マウアー","ザンダー","バルダ","キーリエ","マルス","セム","ターバ","グロス","クルトン","ザムル","エルフィン","グラハン","ガウェイン","アドル","ゴーバン","ドギ","ルタ","ダレス","ダルク＝ファクト","クーブラ＝カーン","ガルシウス","クロノス","カイロス","ディアルド","チッタ","カズン","ルイス","セネリー","ライネル","エス","カリー","ドレイク","ダニー","ドリー","ケイリス","ノートン","クラウド","ウォーリー","レイモンド","サザール","メテオロイド","ナッシュ","ルロイ","ライトル","カディアン","ブラウン","シュナイダー","セシル","グレンザー","ゴイル","ビル","グリメルム","ガルベス","ジルドバ","アレクシウスX世","ピエール","ジェラルド","ロベルト","エティス","アル＝ファルコ","ラシーン","ロデム","J.D.マックス","パーム","シド"],female_name:["エスター","クリスティ","アイリーン","フェルディナン","リタ","トーヤ","ノルン","ウィンディーネ","プリム","ピアナ","エメラーダ","エレア","エヴァ","リム","ビナー","ティファレト","ミラドゥ","パナシェ","ミモザ","リューズ","エレーナ","リーア","キアラ","オルアラ","クオレ","セーナ","リーザ","セリナ","リリィ","ピピ","ビヌス","アンナ","リュシエル","フィレン","カレン","エリン","ローラ","マーベラ","ジョセフィーヌ","アネリーナ","リオナ","ジョアンナ","レニッサ","ジェニス","グリンダ","マティナ","ローナ","コッキー","チェルシー","ネリス","アリーナ","フェリッサ","マリエル","ベララ","ジョゼフ","ニッカ","テキーラ","ソルティ","パイン","ウィズ","カンニバル","ミント","リーン","ミル","ディアンナ","レティア","サフィス","エミス","ヴァムリー","サリア","ナイジェス","ミューリア","エミリア","シャル","バーバラ","オビア","スチュアート","ベーラ","サマリーヌ","フィアネ","レナ","ソル","ネイラ","セレーネ","アルバ","ラン","ルー・パズス","シルフィ","ミレット","レフィーナ","モスマ","チブル","鈴鈴","明明","ティキ","サリア","ミュール","ダール","ミンナ","レーシャ","エレイア","レア","フィーナ","ジャネット","ナリス","ソチ","ポーラス","ロキア","フリージ","エスメレー","エレナ","アルティ","エビオラ","フィナ"],title:["武器屋の親父","ペンタウァの長老","トラベラーズインの宿主","人と上手に話したい","ペンタウァ近衛隊長","タリスマンの見張り","瞑想中","砂漠の飯炊き","狂戦士","エレベーターの管理人","盗賊の頭領","暗き沼の魔法使い","ロマンシア国王","アゾルバ国王","ペンタウァ国王","蚕職人","妖精王","暗黒の魔導士","クイーンマリー号船長","キタブ・アル・アジフの持ち主","メデューサハンターの弟子","ファルコムマン","戦士の亡霊","海賊の子孫","いけにえの神官","東の村の村長","麻薬中毒者","ヴァネルバの王","銀の竪琴屋","近衛隊長","復讐の呪術師","ラフォーヌの森の管理人","リドニア王国の元兵士","姫の教育係","大魔王","紫ウニの王子","ベララの家族","時計塔の番人","時計塔の魔女","ナルキッソス号船長","ディンギル王国の3神官","バドティビラ工場の指揮官","シュメール国王","サンサーラの山賊","南村の村長","アイテム屋WIZの店主","旅の吟遊詩人","古代イスマリアの王","時の神殿の書記官","闇の王","ランドル村長","魔法学校の校長","魔法学校の用務員","マリオネットの王","ペンタウァの近衛兵","陽の中の闇人","赤毛の冒険者","光の王","イリアスンの執政官","魔の下僕","メデューサハンター","邪神教徒","邪神教々祖","砂漠の王","鍵の番人","ローデシア辺境司令官","宇宙からの訪問者","黒竜仙人","猿大聖","極楽寺の僧兵","ジャグラー族","迷宮建築の第一人者","フリース村の村長","ペンタウァ一の科学者アンド予言者","暴れザル","魔法学校の校長","人魚３姉妹の長女","マリオネットの王","探求の学徒","旅芸人の一座","猛獣使い","流れの傭兵","氷の魔女","パペッテの人形遣い","バーテンダー","宮仕えのシャーマン","薬草亭の主人","水門の管理人"],pc_init:[["FIGHTER","MALE",85,55,7,3,6,4],["FIGHTER","FEMALE",80,60,6,4,6,4],["WIZARD","MALE",55,85,4,8,5,3],["WIZARD","FEMALE",50,90,3,8,5,4],["DWARF","MALE",90,50,8,2,8,2],["DWARF","FEMALE",85,55,7,3,8,2],["ELF","MALE",65,75,4,6,5,5],["ELF","FEMALE",60,80,2,7,5,6]],magic:{HEAL:[0,0,0,1,0,1,0,"HPを15回復"],PEACE:[0,0,1,0,1,0,0,"MPを10回復"],CURE:[0,0,0,0,1,0,1,"毒回復"],MELT:[0,1,0,0,1,1,1,"凍結を回復"],"STONE-FLESH":[0,0,0,1,1,1,1,"石化を回復"],"UN-CURCE":[2,0,1,0,0,1,0,"呪いを回復"],"AIR-HAND":[1,0,1,0,1,0,1,"見えない拳の衝撃で、忘却を回復"],RESURRECT:[0,0,0,1,3,0,1,"HP/MP半分で復活（但し、冒険に一度だけ）"],"REDUCE-LIFE":[0,1,1,0,1,1,0,"体力を犠牲に（HP-25）、すべての状態異常を回復"],REJUVENATE:[0,2,0,1,0,0,1,"時の流れを巻き戻し（現在の判定をやり直し）"],PROTECT:[1,0,0,1,1,0,1,"HPダメージを半減（1ターンのみ）"],"HOLY-WATER":[0,0,2,2,0,0,0,"MPダメージを半減（1ターンのみ）"],"CHANGE-AIR":[1,0,0,1,1,1,0,"戦闘を回避（アイテムは得られない）"],"GIVE-VIGOR":[1,1,1,0,0,1,0,"敵の攻撃力が2倍＆取得アイテム2倍"],EXPLOSION:[0,1,0,1,0,1,2,"地属性の敵を全滅"],DELUGE:[4,0,0,0,0,1,0,"火属性の敵を全滅"],FREEZE:[0,2,0,0,0,1,2,"水属性の敵を全滅"],"DESTROY-A":[1,0,4,0,0,0,0,"風属性の敵を全滅"],"LIGHT-CROSS":[0,2,0,2,0,1,0,"霊属性の敵を全滅"],"NOILA-TEM":[1,1,1,1,1,1,1,"すべての属性の敵を全滅"]},jobs:{"のうふ":["FWDE","MF","YAO"],"れんきんじゅつ":["W","M","YAO"],"ようへい":["FDE","M","YA"],"うらないし":["WE","MF","YAO"],"こうふ":["FD","M","YA"],"どろぼう":["FWDE","MF","YAO"],"そうりょ":["W","MF","YAO"],"しょうにん":["FWE","MF","YAO"],"せんいん":["FD","M","YA"],"とうし":["FDE","MF","Y"],"どうけし":["WE","MF","YAO"],"かじや":["FD","M","YAO"],"きこり":["FD","M","YA"],"かりうど":["FDE","M","YAO"],"きとうし":["WE","M","YAO"],"あくまばらい":["W","M","YAO"],"せんきょうし":["W","MF","YAO"],"いしゃ":["WE","M","AO"],"かんごふ":["FWE","F","YAO"],"ぱんや":["FWE","MF","YAO"],"りょうし":["FD","MF","YA"],"だいく":["FD","M","YAO"],"ちょうこくか":["FWDE","MF","O"],"おりこ":["WDE","F","YAO"],"すみやき":["FD","MF","YAO"],"コック":["WE","MF","YAO"],"スパイ":["FWE","M","YA"],"ぼくどう":["FWDE","MF","Y"],"ようじんぼう":["FDE","M","Y"],"ぎんゆうしじん":["WE","M","YAO"],"ぎょしゃ":["FD","MF","YAO"],"はかもり":["FWDE","M","O"],"しゃほん":["WE","M","O"],"こなひき":["FD","MF","YA"],"かせいふ":["FWDE","F","YAO"],"おどりこ":["E","F","Y"],"はなや":["FWE","F","YAO"],"いしく":["D","MF","YA"],"かみゆい":["FWDE","F","AO"],"したてや":["WDE","F","YAO"],"いとつむぎ":["D","F","YAO"],"うたうたい":["FWE","F","YA"],"かみすき":["WD","MF","O"],"つうやく":["DE","MF","YAO"],"やくざいし":["FWE","MF","AO"],"ほねさいくし":["D","MF","O"],"わたしもり":["FW","M","YA"],"やくそうとり":["WE","MF","YAO"],"そうぎや":["FW","M","O"],"ワインづくり":["FWDE","MF","YA"],"こじき":["FWDE","MF","YAO"],"ちょうきょうし":["DE","MF","A"],"ほうせきさいくし":["D","MF","O"],"かごづくり":["FD","MF","O"],"かぎや":["D","MF","AO"],"くつし":["FDE","MF","O"],"はくせいづくり":["FD","MF","O"],"ゆみし":["FE","MF","O"],"チーズづくり":["FD","F","YAO"],"さんば":["FW","F","AO"]},global_items:{happy:{gi01:{name:"金の卵",desc:"月の欠片を5個所有した状態で冒険を開始"},gi02:{name:"ガラティーン",desc:"火星の欠片を5個所有した状態で冒険を開始"},gi03:{name:"五元素のマント",desc:"水星の欠片を5個所有した状態で冒険を開始"},gi04:{name:"アマゾンの剣",desc:"木星の欠片を5個所有した状態で冒険を開始"},gi05:{name:"幸福のコイン",desc:"金星の欠片を5個所有した状態で冒険を開始"},gi06:{name:"ムラサメブレード",desc:"土星の欠片を5個所有した状態で冒険を開始"},gi07:{name:"G・スレイヤー",desc:"太陽の欠片を5個所有した状態で冒険を開始"},gi08:{name:"水晶の剣",desc:"左サイコロが5以上の時、そのシーンでHPを1回復"},gi09:{name:"王様の杖",desc:"左サイコロが5以上の時、そのシーンでMPを1回復"},gi10:{name:"ブルーリボン",desc:"戦闘ダメージを1減算"},gi11:{name:"王家のダイヤモンド",desc:"罠ダメージを1減算"},gi12:{name:"不老長寿の水",desc:"冒険中に一度だけHPを半分回復できる"},gi13:{name:"タリスマン",desc:"冒険中に一度だけMPを半分回復できる"},gi14:{name:"鏡の盾",desc:"HPダメージを1減算"},gi15:{name:"銀の竪琴",desc:"MPダメージを1減算"},gi16:{name:"パンドラの箱",desc:"右サイコロが4以上の時、戦闘回避が可能"},gi17:{name:"魔法の絨毯",desc:"右サイコロが5以上の時、罠回避"},gi18:{name:"中和剤",desc:"毒耐性"},gi19:{name:"聖水",desc:"呪い耐性"},gi20:{name:"チルドの実",desc:"凍結耐性"},gi21:{name:"銀のハーモニカ",desc:"石化耐性"},gi22:{name:"真実の鏡",desc:"忘却耐性"},gi23:{name:"D・スレイヤー",desc:"すべての星を1個所有した状態で冒険を開始"}},bad:{bgi01:{name:"塩酸",desc:"シーン毎にダイス合計が5未満でHPを1減算、5以上でMPを1回復"},bgi02:{name:"紅玉",desc:"シーン毎にダイス合計が5未満でMPを1減算、5以上でHPを1回復"},bgi03:{name:"血まみれの斧",desc:"冒険開始時に呪い。解除で3回まで星消費せず魔法発動可"},bgi04:{name:"トリカブト",desc:"冒険開始時に毒。但し、解除までシーン毎にMPを1回復"},bgi05:{name:"ギャルのパンティー",desc:"冒険開始時に忘却。解除までSTR/INT0でない方を10"}}},star_names:{mon:"月",tue:"火星",wed:"水星",thu:"木星",fri:"金星",sat:"土星",sun:"太陽","":null},state_names:{"":"正常",poison:"毒",frozen:"凍結",stone:"石化",curse:"呪い",forget:"忘却",physics:"物理",magic:"魔法",both:"物理／魔法",free1:"FREE1",free2:"FREE2",free3:"FREE3"},element_names:{earth:"地",fire:"火",water:"水",wind:"風",spirit:"霊"}};toastr.options.closeButton=!0,toastr.options.positionClass="toast-bottom-left",toastr.options.showDuration=300,toastr.options.hideDuration=1e3,toastr.options.timeOut=5e3;let PlayerRank={LEVEL_POINTS:[100,150,170,180,200],RANK_INFO:[{pt:50,en:"Novice Adventurer",jp:"駆け出し"},{pt:100,en:"Initiate",jp:"新参者"},{pt:200,en:"Aspirant",jp:"大志を抱く者"},{pt:300,en:"Battler",jp:"戦人（いくさびと）"},{pt:500,en:"Adept",jp:"熟練者"},{pt:700,en:"Chevalier",jp:"義侠の者"},{pt:1e3,en:"Conjurer",jp:"奇術師"},{pt:1300,en:"Theurgist",jp:"神々に祈る者"},{pt:1600,en:"Warrior",jp:"古つわもの"},{pt:2e3,en:"Enchanter",jp:"魅了する者"},{pt:2500,en:"Warlock",jp:"七つの塔の魔術師"},{pt:3e3,en:"Sorcerer",jp:"ソーサリアン"},{pt:3500,en:"Necromancer",jp:"死者と語る者"},{pt:4e3,en:"Illusionist",jp:"幻惑を魅せる者"},{pt:5e3,en:"Master Load",jp:"偉大なる領主"},{pt:99999,en:"Dragon Slayer",jp:"ドラゴンスレイヤー"}],scena_count:0,scena_all:0,bonus_count:0,bonus_all:0,scena_infos:{},scena_results_count:0,scena_results_all:0,exp_count:0,exp_all:0,init(){let a,t=this;localStorage.sorcerian_text&&(a=JSON.parse(localStorage.sorcerian_text),this.bonus_count=a.items.length),this.bonus_all=Object.keys(Common.global_items.happy).length+Object.keys(Common.global_items.bad).length,$.get(ROOT+"stext.xml").done(function(e){let s=$("scenario > work",e);t.scena_all=s.length,$("scenario > work",e).each(function(e){let s=$(this).attr("id"),i=0,n=!1;if(a){let e=a.results[s];if(e){i=e.length;let a=$(this).attr("clears");if(a){a=a.split(",");for(var r=0;r<a.length;r++)if(-1!==e.indexOf(a[r])){t.scena_count++,n=!0;break}}}}t.scena_infos[s]={level:Number($(this).attr("level")),title:$(this).attr("title"),is_cleared:n,results_count:i,results_all:Number($(this).attr("results"))},t.scena_results_all+=Number($(this).attr("results"))}),t.calculateExp(),console.log(t)})},calculateExp(){this.exp_count=10*this.bonus_count,this.exp_all=10*this.bonus_all;let a=0;for(let t of Object.keys(this.scena_infos)){let e=this.scena_infos[t];e.is_cleared&&(this.exp_count+=this.LEVEL_POINTS[Number(e.level)-1]),this.exp_all+=this.LEVEL_POINTS[Number(e.level)-1],a+=e.results_count}this.exp_count+=2*a,this.scena_results_count=a},incrementResult(a){this.scena_infos[a].results_count++,this.calculateExp()},getRank(){for(let a=0;a<this.RANK_INFO.length;a++){let t=this.RANK_INFO[a];if(this.exp_count<t.pt)return{level:a,en:t.en,jp:t.jp}}}},SideBar={incrementValue(a){let t=$(this).prev();t.val(Number(t.val())+1)},decrementValue(a){let t=$(this).next();t.val(Number(t.val())-1)},setStateStyle(){let a=$("#sidr_status_hp"),t=$("#sidr_status_str"),e=$("#sidr_status_int"),s=$("#sidr_status_dex"),i=$("#sidr_status_krm"),n=$("#sidr_magic_magic"),r=$('[name="sidr_status_state"][value="poison"]').prop("checked");var d=$('[name="sidr_status_state"][value="frozen"]').prop("checked"),l=$('[name="sidr_status_state"][value="stone"]').prop("checked"),o=$('[name="sidr_status_state"][value="curse"]').prop("checked"),c=$('[name="sidr_status_state"][value="forget"]').prop("checked"),_="dialog_poison dialog_frozen dialog_stone dialog_curse dialog_forget";a.removeClass(_),t.removeClass(_),e.removeClass(_),s.removeClass(_),i.removeClass(_),n.removeClass(_),r?a.addClass("dialog_poison"):d?(t.addClass("dialog_frozen"),e.addClass("dialog_frozen"),s.addClass("dialog_frozen"),i.addClass("dialog_frozen")):l?(t.addClass("dialog_stone"),e.addClass("dialog_stone"),s.addClass("dialog_stone"),i.addClass("dialog_stone")):o?n.addClass("dialog_curse"):c&&(save_data.chara.str<save_data.chara.int?e.addClass("dialog_forget"):t.addClass("dialog_forget"))},deltaStatus:function(a){let t;switch(a){case"frozen":t={state_desc:"すべてのステータスを-2",str_d:-2,int_d:-2,dex_d:-2,krm_d:-2};break;case"stone":t={state_desc:"すべてのステータスを-1（30scene経過で死亡）",str_d:-1,int_d:-1,dex_d:-1,krm_d:-1};break;case"forget":t={state_desc:"STR／INTのうち、高い方が0に（20scene経過で解除）",dex_d:0,krm_d:0},save_data.chara.str<save_data.chara.int?(t.str_d=0,t.int_d=-1*save_data.chara.int):(t.str_d=-1*save_data.chara.str,t.int_d=0);break;case"poison":t={state_desc:"シーン経過ごとにHPを-1",str_d:0,int_d:0,dex_d:0,krm_d:0};break;case"curse":t={state_desc:"魔法の利用が不可（UN-CURSEを除く）",str_d:0,int_d:0,dex_d:0,krm_d:0};break;default:t={state_desc:"－",str_d:0,int_d:0,dex_d:0,krm_d:0}}return t},createSideBar(a,t,e,s){let i=`sidr_${a}`;$(t).insertBefore(target),$(`#menu_${a}`).sidr({name:i,displace:!1,onOpen:e}),$(`#${i}_submit`).click(function(){s(),$.sidr("close",i)}),$(`#${i}_close`).click(function(){$.sidr("close",i)})},createPlayerRankInfo(){this.createSideBar("rank",'<div id="sidr_rank" class="sidr_info">\n          <table id="sidr_rank_summary" class="sidr_list_noline">\n            <tr>\n            <td colspan="4">\n              <img id="rank_pic" src="" align="left" />\n              <div>\n                PLAYER LV. <span id="rank_lv"></span>\n                <h3>\n                <span id="rank_en"></span>\n                <span id="rank_jp"></span>\n                </h3>\n              </div>\n            </td>\n            </tr>\n            <tr>\n              <th>CLEAR</th>\n              <td id="rank_clear"></td>\n              <th>RESULT</th>\n              <td id="rank_result"></td>\n            </tr>\n            <tr>\n              <th>BONUS</th>\n              <td id="rank_bonus"></td>\n              <th>EXP.</th>\n              <td id="rank_exp"></td>\n            </tr>\n          </table>\n          <table id="sidr_rank_list" class="sidr_list">\n            <thead>\n            <tr>\n              <th>No.</th>\n              <th>Title</th>\n              <th>Clear</th>\n              <th>Result Rate</th>\n            </tr>\n            <thead>\n            <tbody></tbody>\n          </table>\n          <div id="sidr_rank_close" class="sidr_close">閉じる</div>\n        </div>',function(){let a=PlayerRank.getRank();$("#sidr_rank #rank_pic").attr("src",`${ROOT}${COMMON}/rank/rank${a.level}.png`),$("#sidr_rank #rank_jp").text(a.jp),$("#sidr_rank #rank_en").text(`"${a.en}"`),$("#sidr_rank #rank_lv").text(a.level),$("#sidr_rank #rank_clear").text(`${PlayerRank.scena_count}/${PlayerRank.scena_all}`),$("#sidr_rank #rank_result").text(`${PlayerRank.scena_results_count}/${PlayerRank.scena_results_all}`),$("#sidr_rank #rank_bonus").text(`${PlayerRank.bonus_count}/${PlayerRank.bonus_all}`),$("#sidr_rank #rank_exp").text(`${PlayerRank.exp_count}/${PlayerRank.exp_all}`);let t=$("#sidr_rank #sidr_rank_list tbody");t.empty();let e=1;for(let a in PlayerRank.scena_infos){let s=PlayerRank.scena_infos[a];t.append(`<tr>\n              <td>${e++}</td>\n              <td>${s.title}</td>\n              <td>${s.is_cleared?"○":""}</td>\n              <td>${Math.floor(s.results_count/s.results_all*100)}%（${s.results_count}/${s.results_all}）</td>\n            </tr>`)}},function(){})},createBasicInfo(){let a=$('<div id="sidr_basic" class="sidr_info">\n        <table class="sidr_list_noline">\n        <tr>\n          <td colspan="4">\n            <img id="sidr_basic_chara_face" align="right" />\n            <div>\n              <h3>"<span id="sidr_basic_title"></span>"\n                <span id="sidr_basic_name"></span></h3>\n              <i><span id="sidr_basic_ellapsed_scene"></span></i>\n            </div>\n          </td>\n        </tr>\n        <tr>\n          <th>CLASS：</th>\n          <td>\n            <span id="sidr_basic_race"></span>　\n            <span id="sidr_basic_sex"></span>\n          </td>\n          <th>AGE：</th>\n          <td><span id="sidr_basic_age"></span></td>\n        </tr>\n        <tr>\n          <th>JOB：</th>\n          <td><select id="sidr_basic_job"></select></td>\n        </tr>\n        </table>\n        <p>MEMO：</p>\n        <textarea id="sidr_basic_memos"></textarea>\n        <div id="sidr_basic_submit" class="sidr_submit">確定</div>\n        <div id="sidr_basic_close" class="sidr_close">閉じる</div>\n      </div>');$("#sidr_basic_chara_face",a).attr("src",ROOT+COMMON+String(save_data.chara.sex).toLowerCase()+"_"+String(save_data.chara.age).toLowerCase()+"_"+String(save_data.chara.race).toLowerCase()+".png"),$("#sidr_basic_name",a).text(save_data.chara.name),$("#sidr_basic_title",a).text(save_data.chara.title),$("#sidr_basic_ellapsed_scene",a).text(`${save_data.ellapsed_scene} scene`),$("#sidr_basic_race",a).text(save_data.chara.race),$("#sidr_basic_sex",a).text(save_data.chara.sex),$("#sidr_basic_age",a).text(save_data.chara.age);let t=$("#sidr_basic_job",a);t.empty();for(let a of enabled_jobs)$("<option></option>").attr("value",a).text(a).appendTo(t);this.createSideBar("basic",a,function(){$("#sidr_basic #sidr_basic_job").val(save_data.chara.job),$("#sidr_basic #sidr_basic_memos").val(save_data.memos)},function(){save_data.chara.job=$("#sidr_basic #sidr_basic_job").val(),save_data.memos=$("#sidr_basic #sidr_basic_memos").val(),Util.saveStorage()})},createItemFlagInfo(){this.createSideBar("item",'<div id="sidr_item" class="sidr_info">\n          <p>ITEMS：</p>\n          <textarea id="sidr_item_item"></textarea>\n          <p>FLAGS：</p>\n          <textarea id="sidr_item_flag"></textarea>\n         <div id="sidr_item_close" class="sidr_close">閉じる</div>\n       </div>',function(){let a=[];for(let t of save_data.items){let e=items_map[t];a.push(`・${e.name}（${e.desc}）`)}$("#sidr_item #sidr_item_item").text(a.join("\r"));let t=[];for(let a of save_data.flags)t.push(`・${flags_map[a]}`);$("#sidr_item #sidr_item_flag").text(t.join("\r"))},function(){})},createStatusSheet(){let a=this,t=$('<div id="sidr_status" class="sidr_info">\n        <table id="sidr_status_list">\n          <tr>\n          <td>\n            <div>\n            HP：<br />\n            <input type="button" class="spinner_down" value="-" />\n            <input id="sidr_status_hp" type="number" />\n            <input type="button" class="spinner_up" value="+" />\n            ／<span id="sidr_status_hp_m"></span>\n            </div>\n            <div>\n            MP：<br />\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_status_mp" />\n            <input type="button" class="spinner_up" value="+" />\n            ／<span id="sidr_status_mp_m"></span>\n            <div>\n            STATE：<br />\n            <label><input type="radio" name="sidr_status_state" value="" />正常</label>\n            <label><input type="radio" name="sidr_status_state" value="poison" />毒</label>\n            <label><input type="radio" name="sidr_status_state" value="frozen" />凍結</label>\n            <label><input type="radio" name="sidr_status_state" value="stone" />石化\n            (<span id="sidr_status_stone_scene">0</span>)</label>\n            <label><input type="radio" name="sidr_status_state" value="curse" />呪い</label>\n            <label><input type="radio" name="sidr_status_state" value="forget" />忘却\n            (<span id="sidr_status_forget_scene">0</span>)</label>\n            <div id="sidr_status_state_desc">－－－</div>\n            </div>\n          </td>\n          <td>\n            <div>\n            STR<br />\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_status_str" />\n            <input type="button" class="spinner_up" value="+" />\n            ／<span id="sidr_status_str_i"></span>\n            </div>\n            <div>\n            INT<br />\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_status_int" />\n            <input type="button" class="spinner_up" value="+" />\n            ／<span id="sidr_status_int_i"></span>\n            </div>\n            <div>\n            DEX<br />\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_status_dex" />\n            <input type="button" class="spinner_up" value="+" />\n            ／<span id="sidr_status_dex_i"></span>\n            </div>\n            <div>\n            KRM<br />\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_status_krm" />\n            <input type="button" class="spinner_up" value="+" />\n            ／<span id="sidr_status_krm_i"></span>\n            </div>\n          </td>\n          </tr>\n        </table>\n        <div>\n          FREE：<br />\n          <table id="sidr_status_free_list">\n          <tr>\n          <td>\n          <input type="button" class="spinner_down" value="-" />\n          <input type="number" id="sidr_status_free1" />\n          <input type="button" class="spinner_up" value="+" />・\n          <span class="free-label">\n          <br />\n          <span id="sidr_status_free_label1"></span>\n          </span>\n          </td>\n          <td>\n          <input type="button" class="spinner_down" value="-" />\n          <input type="number" id="sidr_status_free2" />\n          <input type="button" class="spinner_up" value="+" />・\n          <span class="free-label">\n            <br />\n            <span id="sidr_status_free_label2"></span>\n          </span>\n          </td>\n          <td>\n          <input type="button" class="spinner_down" value="-" />\n          <input type="number" id="sidr_status_free3" />\n          <input type="button" class="spinner_up" value="+" />\n          <span class="free-label">\n            <br />\n            <span id="sidr_status_free_label3"></span>\n          </span>\n          </td>\n          </tr>\n          </table>\n        </div>\n        <div id="sidr_status_submit" class="sidr_submit">確定</div>\n        <div id="sidr_status_close" class="sidr_close">閉じる</div>\n      </div>');$("#sidr_status_hp_m",t).text(save_data.chara.hp_m),$("#sidr_status_mp_m",t).text(save_data.chara.mp_m),$("#sidr_status_str_i",t).text(save_data.chara.str_i),$("#sidr_status_int_i",t).text(save_data.chara.int_i),$("#sidr_status_dex_i",t).text(save_data.chara.dex_i),$("#sidr_status_krm_i",t).text(save_data.chara.krm_i),$('[name="sidr_status_state"]',t).click(function(t){let e=a.deltaStatus($(this).val());$("#sidr_status #sidr_status_state_desc").text(e.state_desc),a.setStateStyle()}),$(".spinner_up",t).click(this.incrementValue()),$(".spinner_down",t).click(this.decrementValue()),this.createSideBar("status",t,function(){$("#sidr_status #sidr_status_hp").val(save_data.chara.hp),$("#sidr_status #sidr_status_mp").val(save_data.chara.mp),$('#sidr_status [name="sidr_status_state"]').each(function(){var a=$(this).nsAttr("value");a===save_data.chara.state?$(this).prop("checked",!0):$(this).prop("checked",!1)}),$("#sidr_status #sidr_status_stone_scene").text(save_data.chara.stone_scene),$("#sidr_status #sidr_status_forget_scene").text(save_data.chara.forget_scene),a.setStateStyle();let t=a.deltaStatus($('[name="sidr_status_state"]:checked').val());$("#sidr_status #sidr_status_state_desc").text(t.state_desc),$("#sidr_status #sidr_status_free1").val(save_data.chara.free1),$("#sidr_status #sidr_status_free2").val(save_data.chara.free2),$("#sidr_status #sidr_status_free3").val(save_data.chara.free3);let e=$("init > label",scenario_data);e&&($("#sidr_status #sidr_status_free_label1").text(e.nsAttr("free1")),$("#sidr_status #sidr_status_free_label2").text(e.nsAttr("free2")),$("#sidr_status #sidr_status_free_label3").text(e.nsAttr("free3"))),$("#sidr_status #sidr_status_str").val(save_data.chara.str),$("#sidr_status #sidr_status_int").val(save_data.chara.int),$("#sidr_status #sidr_status_dex").val(save_data.chara.dex),$("#sidr_status #sidr_status_krm").val(save_data.chara.krm)},function(){save_data.chara.hp=$("#sidr_status #sidr_status_hp").val(),save_data.chara.mp=$("#sidr_status #sidr_status_mp").val(),save_data.chara.free1=$("#sidr_status #sidr_status_free1").val(),save_data.chara.free2=$("#sidr_status #sidr_status_free2").val(),save_data.chara.free3=$("#sidr_status #sidr_status_free3").val(),save_data.chara.str=$("#sidr_status #sidr_status_str").val(),save_data.chara.int=$("#sidr_status #sidr_status_int").val(),save_data.chara.dex=$("#sidr_status #sidr_status_dex").val(),save_data.chara.krm=$("#sidr_status #sidr_status_krm").val(),save_data.chara.state=$('#sidr_status [name="sidr_status_state"]:checked').val(),Util.saveStorage()})},createMagicSheet(){let a=function(a,t,e){if(a[t]>0){let s=$(`#sidr_magic #sidr_magic_${e}`),i=Number(s.val());s.val(i-a[t])}},t=$('<div id="sidr_magic" class="sidr_info">\n      <div>\n      MAGIC：<br />\n      <select id="sidr_magic_magic"></select>\n      <input type="button" id="sidr_magic_run" value="Shoot" />\n      </div>\n      <table id="sidr_magic_list">\n        <tr>\n          <td>\n            <div>\n            月\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_magic_mon" />\n            <input type="button" class="spinner_up" value="+" />\n            </div>\n            <div>\n            火\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_magic_tue" />\n            <input type="button" class="spinner_up" value="+" />\n            </div>\n            <div>\n            水\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_magic_wed" />\n            <input type="button" class="spinner_up" value="+" />\n            </div>\n            <div>\n            木\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_magic_thu" />\n            <input type="button" class="spinner_up" value="+" />  \n            </div>  \n          </td>\n          <td>\n            <div>\n            金\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_magic_fri" />\n            <input type="button" class="spinner_up" value="+" />\n            </div>\n            <div>\n            土\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_magic_sat" />\n            <input type="button" class="spinner_up" value="+" />\n            </div>\n            <div>\n            太\n            <input type="button" class="spinner_down" value="-" />\n            <input type="number" id="sidr_magic_sun" />\n            <input type="button" class="spinner_up" value="+" />\n            </div>\n          </td>\n        </tr>\n      </table>\n      <div id="sidr_magic_submit" class="sidr_submit">確定</div>\n      <div id="sidr_magic_close" class="sidr_close">閉じる</div>\n      </div>');$(".spinner_up",t).click(this.incrementValue()),$("#sidr_magic_run",t).click(function(t){t.preventDefault();let e=Common.magic[$("#sidr_magic #sidr_magic_magic").val()];e&&($("#sidr_magic #sidr_magic_mon").val()<e[0]||$("#sidr_magic #sidr_magic_tue").val()<e[1]||$("#sidr_magic #sidr_magic_wed").val()<e[2]||$("#sidr_magic #sidr_magic_thu").val()<e[3]||$("#sidr_magic #sidr_magic_fri").val()<e[4]||$("#sidr_magic #sidr_magic_sat").val()<e[5]||$("#sidr_magic #sidr_magic_sun").val()<e[6]?window.alert("星が不足しているため、魔法を発動できません！"):(a(e,0,"mon"),a(e,1,"tue"),a(e,2,"wed"),a(e,3,"thu"),a(e,4,"fri"),a(e,5,"sat"),a(e,6,"sun")))}),$(".spinner_up",t).click(this.incrementValue()),this.createSideBar("magic",t,function(){let a=$("#sidr_magic #sidr_magic_magic");a.empty();for(let t in Common.magic){let e=Common.magic[t],s=$("<option></option>").attr("value",t).attr("title",e[8]).text(`${t}（${e[7]}）`);Util.canUseMagic(e)||s.attr("disabled","disabled"),s.appendTo(a)}$("#sidr_magic #sidr_magic_mon").val(save_data.stars[0]),$("#sidr_magic #sidr_magic_tue").val(save_data.stars[1]),$("#sidr_magic #sidr_magic_wed").val(save_data.stars[2]),$("#sidr_magic #sidr_magic_thu").val(save_data.stars[3]),$("#sidr_magic #sidr_magic_fri").val(save_data.stars[4]),$("#sidr_magic #sidr_magic_sat").val(save_data.stars[5]),$("#sidr_magic #sidr_magic_sun").val(save_data.stars[6])},function(){save_data.stars[0]=$("#sidr_magic #sidr_magic_mon").val(),save_data.stars[1]=$("#sidr_magic #sidr_magic_tue").val(),save_data.stars[2]=$("#sidr_magic #sidr_magic_wed").val(),save_data.stars[3]=$("#sidr_magic #sidr_magic_thu").val(),save_data.stars[4]=$("#sidr_magic #sidr_magic_fri").val(),save_data.stars[5]=$("#sidr_magic #sidr_magic_sat").val(),save_data.stars[6]=$("#sidr_magic #sidr_magic_sun").val(),Util.saveStorage()})},createBonusInfo(){let a=$('<div id="sidr_bonus" class="sidr_info">\n        <ul id="sidr_bonus_list">\n          <li><img id="gi01" /></li>\n          <li><img id="gi02" /></li>\n          <li><img id="gi03" /></li>\n          <li><img id="gi04" /></li>\n          <li><img id="gi05" /></li>\n          <li><img id="gi06" /></li>\n          <li><img id="gi07" /></li>\n          <li><img id="gi08" /></li>\n          <li><img id="gi09" /></li>\n          <li><img id="gi10" /></li>\n          <li><img id="gi11" /></li>\n          <li><img id="gi12" /></li>\n          <li><img id="gi13" /></li>\n          <li><img id="gi14" /></li>\n          <li><img id="gi15" /></li>\n          <li><img id="gi16" /></li>\n          <li><img id="gi17" /></li>\n          <li><img id="gi18" /></li>\n          <li><img id="gi19" /></li>\n          <li><img id="gi20" /></li>\n          <li><img id="gi21" /></li>\n          <li><img id="gi22" /></li>\n          <li><img id="gi23" /></li>\n          <li><img id="bgi01" /></li>\n          <li><img id="bgi02" /></li>\n          <li><img id="bgi03" /></li>\n          <li><img id="bgi04" /></li>\n          <li><img id="bgi05" /></li>\n        </ul>\n        <div id="sidr_bonus_close" class="sidr_close">閉じる</div>\n      </div>'),t=function(t,e){let s;for(let i=1;i<=t;i++){s=i<10?`0${i}`:i,s=`${e}${s}`;let t=$(`#${s}`,a);-1!==$.inArray(s,global_save_data.items)?t.attr("src",`${ROOT}${COMMON}${s}.png`).attr("class","bonus_item"):t.attr("src",`${ROOT}${COMMON}gi99.png`),save_data.bonus===s&&t.parent().css("background-color","#7fffd4")}};t(Object.keys(Common.global_items.happy).length,"gi"),t(Object.keys(Common.global_items.bad).length,"bgi"),target.parent().on("click","#sidr_bonus_list img.bonus_item",function(a){let t,e=a.target.id;t=e.startsWith("gi")?Common.global_items.happy[e]:Common.global_items.bad[e],toastr.success(t.desc,t.name)}),this.createSideBar("bonus",a,function(){},function(){})},createResultInfo(){this.createSideBar("result",'<div id="sidr_result" class="sidr_info">\n          <div id="sidr_result_rate">Rate: 0.0%</div>\n          <table id="sidr_result_list">\n          </table>\n          <div id="sidr_result_close" class="sidr_close">閉じる</div>\n        </div>',function(){let a=0,t=0,e=["","ノーマル","ブロンズ","シルバー","ゴールド","プラチナ"],s=$("#sidr_result #sidr_result_list");s.empty(),Object.keys(results_map).forEach(function(i){let n;a++,void 0!==global_save_data.results[scenario_code]&&-1!==global_save_data.results[scenario_code].indexOf(i)?(t++,n=`<tr>\n                <td>\n                  <img src="${ROOT}${COMMON}trophy${results_map[i].level}.png"\n                    title="${e[results_map[i].level]}" />\n                </td>\n                <td>\n                  <h3>${results_map[i].name}\n                  （Lv.${results_map[i].level}）</h3>\n                  <p>${results_map[i].desc}</p>\n                </td>\n              </tr>`):n=`<tr>\n                <td>\n                  <img src="${ROOT}${COMMON}trophy0.png"\n                    title="実績未達" />\n                </td>\n                <td>\n                  <h3>???????????????</h3>\n                  <p>???????????????</p>\n                </td>\n              </tr>`,s.append(n)});let i=(t/a*100).toFixed(1);$("#sidr_result #sidr_result_rate").text(`Rate:${i}%`)},function(){})},createAll(){this.createBasicInfo(),this.createStatusSheet(),this.createMagicSheet(),this.createItemFlagInfo(),this.createResultInfo(),this.createBonusInfo(),this.createPlayerRankInfo()},closeAll(){let a=["basic","status","magic","item","result","bonus","rank"];for(let t of a)$.sidr("close",`sidr_${t}`);$.sidr("close","sidr")}},ControlPanel={init(){
$('<nav class="main-nav" role="navigation">\n        <!-- Mobile menu toggle button (hamburger/x icon) -->\n        <input id="main-menu-state" type="checkbox" />\n        <label class="main-menu-btn" for="main-menu-state">\n          <span class="main-menu-btn-icon"></span> Toggle main menu visibility\n        </label>\n        \n        <h2 class="nav-brand"><a href="./">\n          <img src="./stext/common/renewal/gamebook_header_text.png"/>\n          <span class="pconly" style="vertical-align: top;">SORCERIAN Text</span>\n        </a></h2>\n        \n        <!-- Sample menu definition -->\n        <ul id="main-menu" class="sm sm-blue">\n          <li><a id="menu_status" href="#">Status</a></li>\n          <li><a id="menu_magic" href="#">Magic</a></li>\n          <li><a href="#">Info</a>\n            <ul>\n              <li><a id="menu_basic">Basic</a></li>\n              <li><a id="menu_item">Item & Flag</a></li>\n              <li><a id="menu_result">Result</a></li>\n              <li><a id="menu_bonus">Bonus</a></li>\n              <li><a id="menu_rank">Player Rank</a></li>\n            </ul>\n          </li>\n          <li><a href="#">System</a>\n            <ul>\n              <li><a id="menu_backup">Backup</a></li>\n              <li><a id="menu_restore">Restore</a><input id="menu_restore_select" type="file" accept=".stext" /></li>\n              <li><a id="menu_audio">Sound</a></li>\n              <li><a href="https://sorcerian.hateblo.jp/entries/2017/12/20">Help</a></li>\n              <li><a href="./">Exit</a></li>\n            </ul>\n          </li>\n        </ul>\n      </nav>').insertBefore(target);let a=$("#main-menu");a.smartmenus({subMenusSubOffsetX:1,subMenusSubOffsetY:-8});let t=$("#main-menu-state");t.length&&(t.change(function(a){let t=$("#main-menu");this.checked?t.hide().slideDown(250,function(){t.css("display","")}):t.show().slideUp(250,function(){t.css("display","")})}),$(window).bind("beforeunload unload",function(){t[0].checked&&t[0].click()})),target.parent().on("click","#menu_backup",function(){Util.downloadSavedata(scenario_code,storage[scenario_code])}),target.parent().on("click","#menu_restore",function(){$("#menu_restore_select").click()}),target.parent().on("change","#menu_restore_select",function(){scenario_code===this.files[0].name.split("-")[0]?Util.restoreSaveData(this,function(){window.alert("リストアに成功しました。\nゲームを再起動します。"),location.reload()}):window.alert("失敗：現在のシナリオ以外のバックアップはUtilityページからリストアしてください。")}),$("#menu_audio").text(`Sound（${global_save_data.bgm?"On":"Off"}）`),target.parent().on("click","#menu_audio",function(a){bgm&&(global_save_data.bgm?(global_save_data.bgm=!1,$(this).text("Sound（Off）"),bgm.pause()):(global_save_data.bgm=!0,$(this).text("Sound（On）"),bgm.play()),Util.saveStorageGlobal())})}};var Util={random:function(a,t){return Math.floor(Math.random()*(t-a+1))+a},minMaxGuard:function(a){return a<0?0:a>10?10:a},randomArray:function(a){return a[Math.floor(Math.random()*a.length)]},pushUnique:function(a,t){return-1===a.indexOf(t)&&(a.push(t),!0)},shiftUnique:function(a,t){return a.filter(function(a){return a!==t})},ltrim:function(a){return a.substr(1)},deepCopyObject:function(a){var t=JSON.stringify(a);return JSON.parse(t)},saveStorage:function(){storage[scenario_code]=JSON.stringify(save_data)},loadStorage:function(){save_data=JSON.parse(storage[scenario_code])},saveStorageGlobal:function(){storage[GLOBAL_SAVE_DATA_KEY]=JSON.stringify(global_save_data)},loadStorageGlobal:function(){global_save_data=JSON.parse(storage[GLOBAL_SAVE_DATA_KEY])},initSavedata:function(){var a=$("init > constraint",scenario_data);if(a){var t=a.nsAttr("race");t&&(t=t.split(","));var e=a.nsAttr("sex"),s=a.nsAttr("age");s&&(s=s.split(","))}var i=this.randomArray(Common.pc_init.filter(function(a){return!t||t.includes(a[0])}).filter(function(a){return!e||e===a[1]})),n=this.random(i[2],i[2]+10),r=this.random(i[3],i[3]+10),d=this.minMaxGuard(this.random(i[4],i[4]+2)),l=this.minMaxGuard(this.random(i[5],i[5]+2)),o=this.minMaxGuard(this.random(i[6],i[6]+2)),c=this.minMaxGuard(this.random(i[7],i[7]+2)),_=storage[scenario_code],u="";_&&(_=JSON.parse(_),u=_.memos),save_data={chara:{name:"MALE"===i[1]?this.randomArray(Common.male_name):this.randomArray(Common.female_name),title:this.randomArray(Common.title),race:i[0],sex:i[1],age:this.randomArray(["YOUNG","ADULT","OLD"].filter(function(a){return!s||s.includes(a)})),job:"",state:"",stone_scene:0,forget_scene:0,hp_m:n,hp:n,mp_m:r,mp:r,str_i:d,str:d,int_i:l,int:l,dex_i:o,dex:o,krm_i:c,krm:c,free1:0,free2:0,free3:0},stars:[0,0,0,0,0,0,0],items:[],flags:[],memos:u,scene:0,ellapsed_scene:0,bgm:"",bonus:this.randomArray(global_save_data.items),isEnded:!1},this.initJobs(),save_data.chara.job=this.randomArray(enabled_jobs),this.saveStorage()},initGlobalSaveData:function(){global_save_data={items:[],results:{},bgm:!0,panel:!0},this.saveStorageGlobal(GLOBAL_SAVE_DATA_KEY)},initJobs:function(){enabled_jobs=Object.keys(Common.jobs).filter(function(a){var t=Common.jobs[a];return-1!==t[0].indexOf(save_data.chara.race.charAt(0))&&-1!==t[1].indexOf(save_data.chara.sex.charAt(0))&&-1!==t[2].indexOf(save_data.chara.age.charAt(0))})},downloadSavedata:function(a,t){var e=navigator.userAgent.toLowerCase();if(-1!==e.indexOf("safari")&&-1===e.indexOf("chrome")&&-1===e.indexOf("edge"))window.open("./stext/download.php?id="+a+"&data="+t);else{var s=new Blob([t],{type:"application/octet-stream"}),i=document.createElement("a");i.href=window.URL.createObjectURL(s),i.download=a+"-"+(new Date).getTime()+".stext",document.body.appendChild(i),i.click(),document.body.removeChild(i)}},restoreSaveData:function(a,t){var e=a.files[0],s=e.name.split("-")[0],i=new FileReader;$(i).on("load",function(){if("all"===s)for(var a=i.result.split("\n"),e="",n="",r=0;r<a.length;r++)r%2==0?e=a[r]:(n=a[r],n&&(storage[e]=n));else storage[s]=i.result;t()}),i.readAsText(e,"UTF-8")},buildBgmPath:function(a){return""===a&&(a=bgms_map.main),0===a.indexOf("@")?ROOT+COMMON+BGM+a.substring(1)+".mp3":ROOT+scenario_code+"/"+BGM+a+".mp3"},validateScenario:function(){var a=[],t=[],e=function(t,e,s){if(void 0!==e&&""!==e){var i=e.trim().split(","),n=Object.keys(t);i.forEach(function(t){t=t.replace("-",""),-1===n.indexOf(t)&&a.push({scene_id:s,message:t.startsWith("i")?"アイテムコード"+t+"が未登録です。":t.startsWith("f")?"フラグコード"+t+"が未登録です。":t.startsWith("m")?"敵コード"+t+"が未登録です。":"実績コード"+t+"が未登録です。"})})}};return $("scene",scenario_data).each(function(s,i){var n=$(i);-1===t.indexOf(n.nsAttr("id"))?t.push(n.nsAttr("id")):a.push({scene_id:n.nsAttr("id"),message:"scene－idが重複しています。"}),e(items_map,n.nsAttr("items"),n.nsAttr("id")),e(flags_map,n.nsAttr("flags"),n.nsAttr("id")),e(enemies_map,n.nsAttr("enemies"),n.nsAttr("id")),e(results_map,n.nsAttr("result"),n.nsAttr("id"))}),a},showSplash(){$.zoombox.open(ROOT+COMMON+"title.png",{duration:400})},canUseMagic:function(a){return!(save_data.stars[0]<a[0]||save_data.stars[1]<a[1]||save_data.stars[2]<a[2]||save_data.stars[3]<a[3]||save_data.stars[4]<a[4]||save_data.stars[5]<a[5]||save_data.stars[6]<a[6])},canUseMagicByName:function(a){return 0===a.indexOf("m")&&Util.canUseMagic(Common.magic[a.substring(1)])},ifStatus:function(a){if(0===a.indexOf("o")){var t=a.match(/o(hp|mp|str|int|dex|krm|freei|freeii|freeiii)\s*(\d{1,})(\+|-)\s*/i);t[1]=t[1].toLowerCase(),t[1]=t[1].replace("freeiii","free3"),t[1]=t[1].replace("freeii","free2"),t[1]=t[1].replace("freei","free1");var e=save_data.chara[t[1]];return"-"===t[3]?e<Number(t[2]):e>Number(t[2])}return!1},isCharaState:function(a){if(0===a.indexOf("x")){var t=[save_data.chara.race,save_data.chara.sex,save_data.chara.age,save_data.chara.state.toUpperCase(),save_data.chara.job];return-1!==t.indexOf(a.substring(1).toUpperCase())}return!1},hasStars:function(a){if(0===a.indexOf("s")){var t=save_data.stars;if(-1!==a.indexOf(":")){a=a.substring(1).split(":");for(var e=0;e<a.length;e++)if(Number(t[e])<a[e])return!1}else{a=Number(a.substring(1));var s=0;for(e=0;e<7;e++)s+=Number(t[e]);if(s<a)return!1}return!0}return!1},hasResult:function(a){if(0===a.indexOf("r")){var t=a.split(":"),e=global_save_data.results[t[1].trim()];if(void 0!==e)return-1!==e.indexOf(t[0].trim())}return!1},updateItems:function(a){if(a){for(var t=save_data.items,e=(a=a.split(","),0);e<a.length;e++){var s=a[e].trim();0===s.indexOf("-")?(s=this.ltrim(s),t=this.shiftUnique(t,s)):this.pushUnique(t,s)}save_data.items=t}},updateFlags:function(a){if(a){for(var t=save_data.flags,e=(a=a.split(","),0);e<a.length;e++){var s=a[e].trim();0===s.indexOf("-")?(s=this.ltrim(s),0===flags_map[s].indexOf("*")?t=this.shiftUnique(t,s):console.log(s+"：隠しフラグ以外は削除できません。")):this.pushUnique(t,s)}save_data.flags=t}},updateStates:function(){"poison"===save_data.chara.state?(save_data.chara.hp-=1,save_data.chara.stone_scene=0,save_data.chara.poison_scene=0):"stone"===save_data.chara.state?(save_data.chara.stone_scene+=1,save_data.chara.forget_scene=0):"forget"===save_data.chara.state?(save_data.chara.forget_scene+=1,save_data.chara.stone_scene=0):(save_data.chara.stone_scene=0,save_data.chara.forget_scene=0)},updateStars:function(a){if(a){var t=save_data.stars;if(-1!==a.indexOf(",")){a=a.split(",");for(var e=0;e<a.length;e++)t[e]=Number(t[e])+Number(a[e].trim()),t[e]<0&&(t[e]=0)}else if(0===a.indexOf("div")){a=a.substring(3);for(e=0;e<7;e++)t[e]=Math.floor(Number(t[e])/Number(a))}save_data.stars=t}},updateStarsByMagic:function(a){if(void 0===a||0===a.indexOf("-"))return!0;for(var t=save_data.stars.concat(),e=function(a){for(var e=0;e<t.length;e++)if(t[e]-=a[e],t[e]<0)return!1;return!0},s=a.split(",").filter(function(a){return 0===a.indexOf("m")}),i=0;i<s.length;i++){var n=Common.magic[s[i].substring(1)];if(!n)return;if(!Util.canUseMagic(n))return!1;if(!e(n))return!1}return save_data.stars=t,Util.saveStorage(),!0},updateStarById:function(a,t){var e=Object.keys(Common.star_names).indexOf(a);save_data.stars[e]=Number(save_data.stars[e])+Number(t)},updateHpMp:function(a,t){if(a)if("full"===a)save_data.chara.hp=save_data.chara.hp_m;else{var e=a.split("..");e[1]&&(e[0]=Util.random(Number(e[0]),Number(e[1]))),save_data.chara.hp=Number(save_data.chara.hp)+Number(e[0]),save_data.chara.hp>save_data.chara.hp_m&&(save_data.chara.hp=save_data.chara.hp_m)}if(t)if("full"===t)save_data.chara.mp=save_data.chara.mp_m;else{var s=t.split("..");s[1]&&(s[0]=Util.random(Number(s[0]),Number(s[1]))),save_data.chara.mp=Number(save_data.chara.mp)+Number(s[0]),save_data.chara.mp>save_data.chara.mp_m&&(save_data.chara.mp=save_data.chara.mp_m)}},updateStr2Krm:function(a,t,e,s){a&&("full"===a?save_data.chara.str=save_data.chara.str_i:0===a.indexOf("@")?save_data.chara.str=Number(a.substring(1)):save_data.chara.str=Number(save_data.chara.str)+Number(a)),t&&("full"===t?save_data.chara.int=save_data.chara.int_i:0===a.indexOf("@")?save_data.chara.int=Number(t.substring(1)):save_data.chara.int=Number(save_data.chara.int)+Number(t)),e&&("full"===e?save_data.chara.dex=save_data.chara.dex_i:0===e.indexOf("@")?save_data.chara.dex=Number(e.substring(1)):save_data.chara.dex=Number(save_data.chara.dex)+Number(e)),s&&("full"===s?save_data.chara.krm=save_data.chara.krm_i:0===s.indexOf("@")?save_data.chara.krm=Number(s.substring(1)):save_data.chara.krm=Number(save_data.chara.krm)+Number(s))},updateFrees:function(a,t,e){a&&(0===a.indexOf("@")?save_data.chara.free1=Number(a.substring(1)):save_data.chara.free1=Number(save_data.chara.free1)+Number(a)),t&&(0===t.indexOf("@")?save_data.chara.free2=Number(t.substring(1)):save_data.chara.free2=Number(save_data.chara.free2)+Number(t)),e&&(0===e.indexOf("@")?save_data.chara.free3=Number(e.substring(1)):save_data.chara.free3=Number(save_data.chara.free3)+Number(e))},updateResults:function(a){if(a){void 0===global_save_data.results&&(global_save_data.results={});var t=global_save_data.results;void 0===t[scenario_code]&&0!==scenario_code.indexOf("<")&&(t[scenario_code]=[]),!0===this.pushUnique(t[scenario_code],a)&&(toastr.options.timeOut=5e3,toastr.success(results_map[a].name,"実績獲得")),this.saveStorageGlobal()}},toast:function(a){$(".toast").remove(),$("body").append('<div class="toast">'+a+"</div>");var t=$("body").width()/2-$(".toast").outerWidth()/2;$(".toast").css("left",t).hide().fadeIn("fast"),setTimeout(function(){$(".toast").fadeOut("slow",function(){$(this).remove()})},4e3)},cube:function(a){void 0===a&&(a=1);for(var t="",e=0;e<a;e++)dice[e]=this.random(1,6),t+='<img src="'+ROOT+COMMON+"cube"+dice[e]+'.png" class="dice" />';return t},dropItem:function(a){if(a.drop){var t=a.drop.split("/"),e=Common.star_names[t[0]];if(e){var s="1"===t[1]?"":"×"+t[1];return{drop:a.drop,name:e+s}}return{drop:a.drop,name:t[2]}}if(!a.element)return{name:null};var i={earth:["thu","tue","sat","",""],fire:["tue","sun","tue","",""],water:["wed","mon","fri","",""],wind:["fri","wed","mon","",""],spirit:["sat","sun","mon","",""]},n=Util.randomArray(i[a.element]);return{drop:n?n+"/1":"",name:Common.star_names[n]}},computeDamage:function(a){for(var t,e=0,s=/([\+\-]?)(\d*)(R|L|STR|INT|DEX|KRM|FREE1|FREE2|FREE3)?]?/gi;null!=(t=s.exec(a));){var i=1,n=1,r=1;if(""===t[0])break;"-"===t[1]&&(i=-1),t[2]&&(n=Number(t[2]));var d={str:Number(save_data.chara.str),int:Number(save_data.chara.int),dex:Number(save_data.chara.dex),krm:Number(save_data.chara.krm)};switch(save_data.chara.state){case"frozen":d.str-=2,d.int-=2,d.dex-=2,d.krm-=2;break;case"stone":d.str-=1,d.int-=1,d.dex-=1,d.krm-=1;break;case"forget":d.str<d.int?d.int=0:d.str=0}switch(t[3]){case"L":r=dice[0];break;case"R":r=dice[1];break;case"STR":case"INT":case"DEX":case"KRM":r=d[t[3].toLowerCase()];break;case"FREE1":case"FREE2":case"FREE3":r=save_data.chara[t[3].toLowerCase()];break;default:r=1}e+=i*n*r}return e*=Number($("#damage_delta").val()),Math.floor(e)},selectFunc:function(a){return Util.randomArray(a.split(",")).trim()},deltaStatus:function(a){switch(a){case"frozen":var t="すべてのステータスを-2",e=-2,s=-2,i=-2,n=-2;break;case"stone":t="すべてのステータスを-1（30scene経過で死亡）",e=-1,s=-1,i=-1,n=-1;break;case"forget":t="STR／INTのうち、高い方が0に（20scene経過で解除）";if(save_data.chara.str<save_data.chara.int)e=0,s=-1*save_data.chara.int;else e=-1*save_data.chara.str,s=0;i=0,n=0;break;case"poison":t="シーン経過ごとにHPを-1",e=0,s=0,i=0,n=0;break;case"curse":t="魔法の利用が不可（UN-CURSEを除く）",e=0,s=0,i=0,n=0;break;default:t="－",e=0,s=0,i=0,n=0}return[e,s,i,n,t]},getBonusItem:function(a){return 0===a.indexOf("bgi")?Common.global_items.bad[a]:Common.global_items.happy[a]},initView(){ControlPanel.init(),Util.initDialog(),Util.createCommonTweet(),PlayerRank.init(),SideBar.createAll()},initScenario:function(){Util.initSavedata(),Util.initView(),Util.createScene(0),window.alert("キャラが新規作成されました。\rステータスダイアログは画面右クリックで開くことができます。")},loadDialog:function(a,t){$.get(ROOT+COMMON+DIALOG+a+".html").done(function(e){var s=$(e);t(s),dialog_elem[a]=s,dialog_elem[a].insertBefore(target).hide()})},openDialogById:function(a,t){for(key in dialog_elem)a===key?t?$.sidr("open",key):dialog_elem[key].fadeIn(500):dialog_elem[key].hide()},initDialog:function(){$("#dialog_body").remove(),$.get(ROOT+COMMON+"dialog.html").done(function(a){dialog=$(a),$("#name",dialog).text(save_data.chara.name),$("#title",dialog).text(save_data.chara.title),$("#race",dialog).text(save_data.chara.race),$("#sex",dialog).text(save_data.chara.sex),$("#hp_m",dialog).text(save_data.chara.hp_m),$("#mp_m",dialog).text(save_data.chara.mp_m),$("#str_i",dialog).text(save_data.chara.str_i),$("#int_i",dialog).text(save_data.chara.int_i),$("#dex_i",dialog).text(save_data.chara.dex_i),$("#krm_i",dialog).text(save_data.chara.krm_i),$("#age",dialog).text(save_data.chara.age),$("#chara_face",dialog).attr("src",ROOT+COMMON+String(save_data.chara.sex).toLowerCase()+"_"+String(save_data.chara.age).toLowerCase()+"_"+String(save_data.chara.race).toLowerCase()+".png");var t=$("init > label",scenario_data);t&&($("#free-label1",dialog).text(t.nsAttr("free1")),$("#free-label2",dialog).text(t.nsAttr("free2")),$("#free-label3",dialog).text(t.nsAttr("free3")));var e=$("#job",dialog);e.empty();for(var s=0;s<enabled_jobs.length;s++)$("<option></option>").attr("value",enabled_jobs[s]).text(enabled_jobs[s]).appendTo(e);if(save_data.bonus){var i=Util.getBonusItem(save_data.bonus);$("#bonus",dialog).text(i.desc+"（"+i.name+"）")}dialog.insertBefore(target).hide()}),Util.loadDialog("bonus_list",function(a){for(var t=0;t<24;t++)num=t<10?"0"+t:t,num="gi"+num,-1!==$.inArray(num,global_save_data.items)?$("#"+num,a).attr("src",ROOT+COMMON+num+".png").attr("class","bonus_item"):$("#"+num,a).attr("src",ROOT+COMMON+"gi99.png");for(t=1;t<6;t++)num=t<10?"0"+t:t,num="bgi"+num,-1!==$.inArray(num,global_save_data.items)?$("#"+num,a).attr("src",ROOT+COMMON+num+".png").attr("class","bonus_item"):$("#"+num,a).attr("src",ROOT+COMMON+"gi99.png")}),Util.loadDialog("result_list",function(a){})},createDialog:function(){$("#job",dialog).val(save_data.chara.job),$("#hp",dialog).val(save_data.chara.hp),$("#mp",dialog).val(save_data.chara.mp),$('[name="state"]',dialog).each(function(){var a=$(this).nsAttr("value");a===save_data.chara.state?$(this).prop("checked",!0):$(this).prop("checked",!1)}),$("#stone_scene",dialog).text(save_data.chara.stone_scene),$("#forget_scene",dialog).text(save_data.chara.forget_scene),Util.setStateStyle(),$("#ellapsed_scene",dialog).text(save_data.ellapsed_scene+" scene"),$("#free1",dialog).val(save_data.chara.free1),$("#free2",dialog).val(save_data.chara.free2),$("#free3",dialog).val(save_data.chara.free3),$("#str",dialog).val(save_data.chara.str),$("#int",dialog).val(save_data.chara.int),$("#dex",dialog).val(save_data.chara.dex),$("#krm",dialog).val(save_data.chara.krm),$("#s_mon",dialog).val(save_data.stars[0]),$("#s_tue",dialog).val(save_data.stars[1]),$("#s_wed",dialog).val(save_data.stars[2]),$("#s_thu",dialog).val(save_data.stars[3]),$("#s_fri",dialog).val(save_data.stars[4]),$("#s_sat",dialog).val(save_data.stars[5]),$("#s_sun",dialog).val(save_data.stars[6]);var a=this.deltaStatus($('[name="state"]:checked',dialog).val());$("#state_desc",dialog).text(a[4]),$("#memos",dialog).val(save_data.memos);var t=$("#magic",dialog);for(var e in t.empty(),Common.magic){var s=Common.magic[e],i=$("<option></option>").attr("value",e).attr("title",s[8]).text(e+"（"+s[7]+"）");Util.canUseMagic(s)||i.attr("disabled","disabled"),i.appendTo(t)}for(var n=[],r=0;r<save_data.items.length;r++){var d=items_map[save_data.items[r]];n.push("・"+d.name+"（"+d.desc+"）")}$("#items",dialog).text(n.join("\r"));var l=$("#flags",dialog);l.empty();for(r=0;r<save_data.flags.length;r++){var o=flags_map[save_data.flags[r]];if(0!==o.indexOf("*")){var c="<option ";c+=">・"+flags_map[save_data.flags[r]]+"</option>",l.append(c)}}$("#flags > option:last",dialog).attr("selected","selected"),dialog.slideDown(500),$("#status_change").val("Equipment"),$("#status_basic").show(),$("#status_equip").hide(),target.slideUp(500)},copyNextScenario:function(a){var t=Util.deepCopyObject(save_data);t.chara.state="",t.chara.stone_scene=0,t.chara.forget_scene=0,t.chara.free1=0,t.chara.free2=0,t.chara.free3=0,t.items=t.items.filter(function(a){return void 0!==items_map[a].shared}),t.flags=[],t.scene=0,t.ellapsed_scene=0,t.bgm="",t.isEnded=!1;for(var e=0;e<a.length;e++)localStorage[a[e].trim()]=JSON.stringify(t)},endScenario:function(a,t,e){if(a){t&&Util.copyNextScenario(t.split(",")),console.log("***********Licence Info.***********");var s,i,n,r={bgm:"音楽",picture:"画像"};switch($("licence > work",scenario_data).each(function(){var a=$(this).nsAttr("url");console.log($(this).nsAttr("name")+"("+r[$(this).nsAttr("category")]+"): "+$(this).nsAttr("creator")+" "+(void 0!==a?a:""))}),console.log("***********Licence Info.***********"),"bad"===a?$('<p><a href="#" id="end_reload" class="scenebtn">最初から冒険に挑戦する</a></p>').appendTo(target):"happy"===a&&$('<p><a href="#" id="end_exit" class="scenebtn">ペンタウァに帰還する</a></p>').appendTo(target),save_data.isEnded=!0,Util.saveStorage(),a){case"happy":s=Util.randomArray(Object.keys(Common.global_items.happy)),i=Common.global_items.happy[s],n=Util.buildBgmPath(bgms_map.happy);break;case"bad":Util.random(0,100)<20&&(s=Util.randomArray(Object.keys(Common.global_items.bad)),i=Common.global_items.bad[s]),n=Util.buildBgmPath(bgms_map.bad)}e&&(bgm&&bgm.pause(),bgm=new Audio(n),bgm.loop=!0,global_save_data.bgm&&bgm.play()),s&&(Util.pushUnique(global_save_data.items,s),Util.saveStorageGlobal(),$.get("stext/common/dialog_bonus.html").then(function(a){var t=$(a);$("#bonus_img",t).attr("src",ROOT+COMMON+s+".png"),$("#bonus_item",t).text(i.name),$("#bonus_item_desc",t).text(i.desc),setTimeout(function(){$.zoombox.html(t.html(),{width:480,height:200})},2e3)}))}},canSceneMove:function(a,t){return-1!==t.split(",").indexOf(a)},playBgm:function(a){bgm&&bgm.pause(),bgm=new Audio(a),bgm.loop=!0,global_save_data.bgm&&bgm.play()},showSimpleStatus:function(){$("#simple_status").html('HP:<span class="status_v">'+save_data.chara.hp+'</span>　MP:<span class="status_v">'+save_data.chara.mp+'</span>　|　STR:<span class="status_v">'+save_data.chara.str+'</span>　INT:<span class="status_v">'+save_data.chara.int+'</span>　DEX:<span class="status_v">'+save_data.chara.dex+'</span>　KRM:<span class="status_v">'+save_data.chara.krm+"</span>　｜　"+(0!==$("init > label",scenario_data).length?'<br />F1:<span class="status_v">'+save_data.chara.free1+'</span>　F2:<span class="status_v">'+save_data.chara.free2+'</span>　F3:<span class="status_v">'+save_data.chara.free3+"</span>　｜　":"")+'<span id="status_state" class="status_v">'+Common.state_names[save_data.chara.state]+"</span>　"),$("#status_state").removeClass("status_poison status_frozen status_stone status_curse status_forget"),save_data.chara.state?($("#status_state").addClass("status_"+save_data.chara.state),target.addClass("main_bad")):target.removeClass("main_bad"),Util.createSidebar()},showRuleText:function(a){void 0===a&&(a="99999"),$("#common_rule").html(Util.decorateText($("scene#"+a,scenario_data).text())).markdown()},setStateStyle:function(){var a=$("#hp",dialog),t=$("#str",dialog),e=$("#int",dialog),s=$("#dex",dialog),i=$("#krm",dialog),n=$("#magic",dialog),r=$('[name="state"][value="poison"]').prop("checked"),d=$('[name="state"][value="frozen"]').prop("checked"),l=$('[name="state"][value="stone"]').prop("checked"),o=$('[name="state"][value="curse"]').prop("checked"),c=$('[name="state"][value="forget"]').prop("checked"),_="dialog_poison dialog_frozen dialog_stone dialog_curse dialog_forget";a.removeClass(_),t.removeClass(_),e.removeClass(_),s.removeClass(_),i.removeClass(_),n.removeClass(_),r?a.addClass("dialog_poison"):d?(t.addClass("dialog_frozen"),e.addClass("dialog_frozen"),s.addClass("dialog_frozen"),i.addClass("dialog_frozen")):l?(t.addClass("dialog_stone"),e.addClass("dialog_stone"),s.addClass("dialog_stone"),i.addClass("dialog_stone")):o?n.addClass("dialog_curse"):c&&(save_data.chara.str<save_data.chara.int?e.addClass("dialog_forget"):t.addClass("dialog_forget"))},interpolation:function(a,t){var e=t.split("?"),s=e[0];if(e[1])var i=e[1].split(":");switch(s){case"name":return save_data.chara.name;case"title":return save_data.chara.title;case"race":switch(save_data.chara.race){case"FIGHTER":return i[0];case"WIZARD":return i[1];case"DWARF":return i[2];case"ELF":return i[3];default:return"Unknown Race"}case"sex":switch(save_data.chara.sex){case"MALE":return i[0];case"FEMALE":return i[1];default:return"Unknown Sex"}case"age":switch(save_data.chara.age){case"YOUNG":return i[0];case"ADULT":return i[1];case"OLD":return i[2];default:return"Unknown Age"}case"state":switch(save_data.chara.state){case"":return i[0];case"poison":return i[1];case"frozen":return i[2];case"stone":return i[3];case"curse":return i[4];case"forget":return i[5];default:return"Unknown State"}case"rand":return Util.random(Number(i[0]),Number(i[1]));case"msg":return Util.randomArray(i);case"input":return'<input type="button" class="spinner_down sgml" value="-" /><input type="number" class="sgml" value="'+i[0]+'" /><input type="button" class="spinner_up sgml" value="+" />';default:return t}},conditionSingle:function(a){return a=a.trim(),-1!==save_data.flags.indexOf(a)||-1!==save_data.items.indexOf(a)||Util.canUseMagicByName(a)||Util.ifStatus(a)||Util.isCharaState(a)||Util.hasStars(a)||Util.hasResult(a)},conditionAllTrue:function(a){for(var t=!0,e=a.split(","),s=0;s<e.length;s++)if(!Util.conditionSingle(e[s])){t=!1;break}return t},conditionFull:function(org_cond){var eval_str="",ope=/([\&\|\!\(\)]{1,2})/,conds=org_cond.split(ope);console.log(conds);for(var i=0;i<conds.length;i++){var c=conds[i];c&&(ope.test(c)?eval_str+=c:0!==c.indexOf("-")?eval_str+=Util.conditionSingle(c):eval_str+=!Util.conditionSingle(c.substring(1)))}return console.log(eval_str),eval(eval_str)},judgeMultiCondition:function(a){return a=a.replace("#NOT#","!"),a=a.replace("#AND#","&"),a=a.replace("#OR#","|"),a=a.replace("#L#","("),a=a.replace("#R#",")"),/([\&\|\!\(\)]{1})/.test(a)?Util.conditionFull(a):0!==a.indexOf("-")?Util.conditionAllTrue(a):!Util.conditionAllTrue(a.substring(1))},showSceneButton:function(){$("a[title]",target).hide();var a=$("a[title]",target);a.each(function(a,t){Util.judgeMultiCondition($(t).nsAttr("title"))&&$(t).show()})},importText:function(a,t){return $("scene#"+t,scenario_data).text()},ifCondition:function(a,t,e){return Util.judgeMultiCondition(t)?e:""},parseTweet:function(a,t){return tweet_message=t,t},createTweet:function(a,t,e){if(t||(t="原作30周年記念企画「SORCERIAN Text」ユーザー参加型のゲームブック版ソーサリアン"),"custom"===a)var s=$(".socialbtn.twitter_custom"),i=$(".socialbtn.twitter");else s=$(".socialbtn.twitter"),i=$(".socialbtn.twitter_custom");e||(s.empty(),s.append($('<a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-lang="ja" data-url="https://www.web-deli.com/sorcerian/text/" data-via="snext1220" data-related="snext1220" data-hashtags="falcom,stext">Tweet</a>').attr("data-text",t)).append('<script src="https://platform.twitter.com/widgets.js" charset="UTF-8"></script>')),s.show(),i.hide()},createCommonTweet:function(){Util.createTweet("common",$("init > intro",scenario_data).nsAttr("description"))},createEnemyList:function(a){var t=$('<table class="enemy">');if(a){var e=a.split(",");t.append('<tr class="enemy_title">'+(e.length>1?"<th></th>":"")+'<th>名前／属性</th><th>攻撃</th><th title="現在のダイス値に従って、ダメージを反映させます。">ダメージ <select id="damage_delta"><option value="2">x2</option><option value="1" selected>x1</option><option value="0.5">x1/2</option><option value="0.25">x1/4</option></select></th><th title="記載されたドロップアイテムをステータスに反映させます。">戦利品</th></tr>');for(var s=0;s<e.length;s++){var i=enemies_map[e[s]],n=Common.state_names[i.attack],r='<tr class="enemy_row" data-enemy="'+e[s]+'">';if(e.length>1&&(r+='<td><input type="checkbox" class="enemy_check" /></td>'),r+="<th>",i.element?r+='<img src="'+ROOT+COMMON+"attr_"+i.element+'.png" title="'+Common.element_names[i.element]+'" /></a>　':r+='<img src="'+ROOT+COMMON+'attr_none.png" title="無" /></a>　',r+=i.name+"</th><td>",r+=n?'<img src="'+ROOT+COMMON+"atk_"+i.attack+'.png" title="'+n+'" /></a>　':i.attack,r+="</td><td>",i.func)if(0===i.func.indexOf("*"))r+=Util.selectFunc(i.func.substring(1));else{var d=Util.selectFunc(i.func);r+='<div class="enemy_func" data-func="'+d+'" data-attack="'+i.attack+'">'+d+"</div>"}r+="</td><td>";var l=Util.dropItem(i);l.name?r+='<input type="button" class="enemy_drop" value="'+l.name+'" data-drop="'+l.drop+'"/>':r+="－",r+="</td></tr>",t.append(r)}}t.prependTo("#sidr"),t.wrap('<div id="enemy_table"></div>'),Util.createSidebar()},createSidebar:function(){$("#side_show").sidr({displace:!1,renaming:!1})},decorateText:function(a){return a=a.replace(/\${import[\s]+(.+?)}/gi,this.importText),a=a.replace(/(\[.+?\]\([\d,]{1,} ")(.+?)("\))/gi,function(a,t,e,s){return e=e.split("!").join("#NOT#"),e=e.split("&").join("#AND#"),e=e.split("|").join("#OR#"),e=e.split("(").join("#L#"),e=e.split(")").join("#R#"),t+e+s}),a=a.replace(/%(blue|red|purple|white)%/gi,'&nbsp;<span style="color:$1">'),a=a.replace(/%\/%/gi,"</span>&nbsp;"),a=a.replace(/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?/gi,'<a href="$&" data-link="auto" target="_blank">$&</a>'),a=a.replace(/\${if[\s]+(.+?)}([\s\S]+?)\${\/if}/gi,this.ifCondition),a=a.replace(/\${(.+?)\|(.+?)}/gi,"<ruby>$1<rp>（</rp><rt>$2</rt><rp>）</rp></ruby>"),a=a.replace(/\${tweet}([\s\S]+?)\${\/tweet}/gi,this.parseTweet),a=a.replace(/\${(.+?)}/gi,this.interpolation),a},createScene:function(a,t){if(void 0===t&&(t={}),tweet_message=null,SideBar.closeAll(),save_data.isEnded)location.reload(!0);else{if(!Util.updateStarsByMagic(t.conditions))return toastr.options.timeOut=4e3,void toastr.warning("星が不足しているようだ。");$(window).scrollTop(0);var e=$('scene[id="'+a+'"]',scenario_data);t.reverse?t.restore&&history.pushState(save_data,"Scene "+a):(Util.updateItems(e.nsAttr("items")),Util.updateFlags(e.nsAttr("flags")),Util.updateStates(),Util.updateStars(e.nsAttr("stars")),Util.updateHpMp(e.nsAttr("hp"),e.nsAttr("mp")),Util.updateStr2Krm(e.nsAttr("str"),e.nsAttr("int"),e.nsAttr("dex"),e.nsAttr("krm")),Util.updateFrees(e.nsAttr("free1"),e.nsAttr("free2"),e.nsAttr("free3")),Util.updateResults(e.nsAttr("result")),save_data.scene=a,save_data.ellapsed_scene++,Util.saveStorage(),history.pushState(save_data,"Scene "+a)),target.html(Util.decorateText(e.text())),target.markdown(),tweet_message?Util.createTweet("custom",tweet_message):Util.createTweet("common",null,!0),$('<h5 id="scenario_title"><img id="ctrl_show" src="'+ROOT+COMMON+'ctrl_show.png" /></a> '+$("scenario",scenario_data).nsAttr("title")+"【"+a+'】</span></h5><div id="control_panel"><img id="ctrl_home" src="'+ROOT+COMMON+'ctrl_home.png" /></a>　<img id="status_open" src="'+ROOT+COMMON+'ctrl_status.png" />　<img id="ctrl_bonus" src="'+ROOT+COMMON+'ctrl_bonus.png" />　<img id="audio_onoff" src="'+ROOT+COMMON+"ctrl_audio_"+(global_save_data.bgm?"on":"off")+'.png" />　<img id="ctrl_reload" src="'+ROOT+COMMON+'ctrl_results.png" />　<img id="ctrl_back_res" src="'+ROOT+COMMON+'ctrl_backup.png" />　<input id="ctrl_input_restore" type="file" accept=".stext" /><img id="ctrl_help" src="'+ROOT+COMMON+'ctrl_help.png" /><ul id="ctrl_backup_menu" class="cxt"><li data-command="backup">Backup</li><li data-command="restore">Restore</li></ul></div>').prependTo(target),global_save_data.panel||$("#control_panel").hide();var s=$('<div id="side_show">Battle Sheet</div>');e.nsAttr("enemies")&&s.css("background-color","Red"),s.insertBefore("#scenario_title"),$('<div id="sidr"></div>').insertBefore("#scenario_title"),Util.createEnemyList(e.nsAttr("enemies")),$('<div id="sidr_close">閉じる</div>').appendTo("#sidr"),$('<div id="simple_status"></div>').insertBefore("#sidr_close"),this.showSimpleStatus(),$('<center id="cubes">'+Util.cube(2)+"</center>").insertBefore("#simple_status"),$('<div id="common_rule"></div>').appendTo("#sidr"),Util.showRuleText(e.nsAttr("rule")),debug_mode&&($('<div id="debug_panel"><form><label>Scene：<input id="debug_id" type="text" size="5" /></label>　<label>Items：<input id="debug_items" type="text" size="7" /></label>　<label>Flags：<input id="debug_flags" type="text" size="7" /></label>　<input id="debug_reload" type="button" value="Reload" /></form></div>').prependTo(target),$("#debug_panel #debug_id").val(a),$("#debug_panel #debug_items").val(save_data.items.join(",")),$("#debug_panel #debug_flags").val(save_data.flags.join(",")),$("#debug_panel #debug_reload").click(function(a){var t=$("#debug_panel #debug_items").val().trim(),e=$("#debug_panel #debug_flags").val().trim();save_data.items=""!==t?t.split(","):[],save_data.flags=""!==e?e.split(","):[],Util.saveStorage(),Util.createScene($("#debug_panel #debug_id").val())})),$("a",target).addClass("scenebtn"),$('a[data-link="auto"]',target).removeClass("scenebtn");var i=$('a[href="X"]',target);i.removeClass("scenebtn").addClass("scene_move").attr("data-allow",i.text()).text("移動する").before('<input type="number" id="toscene" class="scene_move" />').add("#toscene").wrapAll('<div class="xbtn"></div>');var n=$('a[href="Q"]',target)
;n.removeClass("scenebtn").addClass("quest_str").attr("data-yesno",n.text()).text("回答する").before('<input type="text" id="stranswer" class="quest_str" />').add("#stranswer").wrapAll('<div class="xbtn"></div>');var r=$("a:has(img)",target);r.each(function(a,t){var e=ROOT+scenario_code+"/"+CAPTURE+$(t).attr("href");$(t).attr("href",e).removeClass("scenebtn").addClass("scenepic").find("img").attr("src",e)}),$("a.scenepic").zoombox(),Util.showSceneButton(),$(".scenebtn:hidden + br",target).remove(),$("a[title]:hidden",target).remove();var d=e.nsAttr("bgm"),l=save_data.bgm;if(void 0!==d&&(l=d),l!==bgm_name&&(Util.playBgm(Util.buildBgmPath(l)),bgm_name=l,save_data.bgm=l,Util.saveStorage(),history.replaceState(save_data,"Scene "+a)),e.nsAttr("se")){var o=new Audio(ROOT+scenario_code+"/"+BGM+SE+e.nsAttr("se")+".mp3");o.loop=!1,o.play()}Util.endScenario(e.nsAttr("end"),e.nsAttr("nexts"),void 0===e.nsAttr("bgm"))}}};$.fn.extend({startGame:function(a,t){scenario_code=a,dialog_elem.main=target=this,t||(t=!1),debug_mode=t,target.addClass("main_back"),target.off(),target.parent().off(),$(document).off("click","#dialog_list img.bonus_item"),$(window).off("popstate"),target.on("click","a.scenebtn",function(a){if("end_reload"!==a.target.id)if("end_exit"!==a.target.id){var t=$(this).nsAttr("href"),e=$(this).nsAttr("title");-1!==t.indexOf(",")&&(t=Util.randomArray(t.split(",")).trim()),Util.createScene(t,{conditions:e}),bgm&&bgm.paused&&global_save_data.bgm&&bgm.play(),a.preventDefault()}else location.href="https://www.web-deli.com/sorcerian/text/"}),target.on("click","#end_reload",function(a){a.preventDefault(),a.stopImmediatePropagation(),("playground"!==scenario_code||confirm("ページをリロードしても宜しいですか？\nリロード時には、エディター上の編集内容も削除されます。シナリオ編集中の場合は、内容を保存してください。"))&&location.reload(!0)}),target.on("click","a.scene_move",function(a){var t=$("#toscene").val(),e=$(this).nsAttr("data-allow");Util.canSceneMove(t,e)?Util.createScene(t):(toastr.options.timeOut=4e3,toastr.warning("指定された番号には移動できないようだ")),a.preventDefault()}),target.on("click","a.quest_str",function(a){var t=$("#stranswer").val(),e=$(this).nsAttr("data-yesno").split(",");if(t===e[0])var s=e[1];else s=e[2];Util.createScene(s),a.preventDefault()}),$(document).on("click","tr.enemy_row",function(a){var t=enemies_map[$(this).nsAttr("data-enemy")];toastr.options.timeOut=5e3,toastr.info(t.desc,t.name)}),$(document).on("click","input.enemy_check",function(a){a.stopImmediatePropagation()}),$(document).on("click","div.enemy_func",function(a){a.stopImmediatePropagation(),toastr.options.timeOut=5e3;var t=$(this).nsAttr("data-func"),e=$(this).nsAttr("data-attack");if(-1!==["poison","frozen","stone","curse","forget"].indexOf(e)){var s=t.split(/([<>])/),i=Util.computeDamage(s[0]),n=Util.computeDamage(s[2]);if("<"===s[1])var r=i<n;else r=i>n;r?toastr.info("回避に成功した。","状態異常"):(save_data.chara.state=e,toastr.error("「"+Common.state_names[e]+"」を受けた！","状態異常"))}else{var d=Util.computeDamage(t);switch(d<0&&(d=0),e){case"physics":save_data.chara.hp=Number(save_data.chara.hp)-d;var l="HPに"+d+"のダメージ！（現在値："+save_data.chara.hp+"）";break;case"magic":save_data.chara.mp=Number(save_data.chara.mp)-d;l="MPに"+d+"のダメージ！（現在値："+save_data.chara.mp+"）";break;case"both":save_data.chara.hp=Number(save_data.chara.hp)-d,save_data.chara.mp=Number(save_data.chara.mp)-d;l="HP/MPに"+d+"のダブルダメージ！（現在値hp/mp："+save_data.chara.hp+"/"+save_data.chara.mp+"）";break;case"free1":save_data.chara.free1=Number(save_data.chara.free1)-d;l="FREE1に"+d+"のダメージ！（現在値："+save_data.chara.free1+"）";break;case"free2":save_data.chara.free2=Number(save_data.chara.free2)-d;l="FREE2に"+d+"のダメージ！（現在値："+save_data.chara.free2+"）";break;case"free3":save_data.chara.free3=Number(save_data.chara.free3)-d;l="FREE3に"+d+"のダメージ！（現在値："+save_data.chara.free3+"）"}0===d?(l="敵の攻撃を防ぎきった！",toastr.info(l,"被ダメージ")):toastr.error(l,"被ダメージ")}Util.saveStorage(),Util.showSimpleStatus()}),$(document).on("click","input.enemy_drop",function(a){a.stopImmediatePropagation();var t=$(this).nsAttr("data-drop").split("/");if(2===t.length)Util.updateStarById(t[0],t[1]),toastr.options.timeOut=5e3,toastr.info(Common.star_names[t[0]]+"の欠片を"+t[1]+"個取得しました。","アイテム獲得");else{var e="free1"===t[0]?t[1]:0,s="free2"===t[0]?t[1]:0,i="free3"===t[0]?t[1]:0;Util.updateFrees(e,s,i),toastr.options.timeOut=5e3,toastr.info(t[2]+"を取得しました。","アイテム獲得")}Util.saveStorage()});var e,s=new Audio(ROOT+COMMON+"dice.mp3"),i=function(){e++,$("#cubes").html(Util.cube(2)),e>20||setTimeout(i,50)};$(document).on("click","#cubes",function(a){console.log("cube"),s.play(),e=1,i(this)}),target.on("click","#status_open",function(a){Util.createDialog(),a.preventDefault()}),target.on("contextmenu",function(a){Util.createDialog(),a.preventDefault()}),target.on("click","#audio_onoff",function(a){bgm&&(global_save_data.bgm?(global_save_data.bgm=!1,$(this).attr("src",ROOT+COMMON+"ctrl_audio_off.png"),bgm.pause()):(global_save_data.bgm=!0,$(this).attr("src",ROOT+COMMON+"ctrl_audio_on.png"),bgm.play()),Util.saveStorageGlobal())}),target.parent().on("click","#dialog_body #status_save",function(a){save_data.chara.job=$("#dialog_body #job").val(),save_data.chara.hp=$("#dialog_body #hp").val(),save_data.chara.mp=$("#dialog_body #mp").val(),save_data.chara.free1=$("#dialog_body #free1").val(),save_data.chara.free2=$("#dialog_body #free2").val(),save_data.chara.free3=$("#dialog_body #free3").val(),save_data.chara.str=$("#dialog_body #str").val(),save_data.chara.int=$("#dialog_body #int").val(),save_data.chara.dex=$("#dialog_body #dex").val(),save_data.chara.krm=$("#dialog_body #krm").val(),save_data.chara.state=$('#dialog_body [name="state"]:checked').val(),save_data.stars[0]=$("#dialog_body #s_mon").val(),save_data.stars[1]=$("#dialog_body #s_tue").val(),save_data.stars[2]=$("#dialog_body #s_wed").val(),save_data.stars[3]=$("#dialog_body #s_thu").val(),save_data.stars[4]=$("#dialog_body #s_fri").val(),save_data.stars[5]=$("#dialog_body #s_sat").val(),save_data.stars[6]=$("#dialog_body #s_sun").val(),save_data.memos=$("#dialog_body #memos").val(),Util.saveStorage(),Util.showSimpleStatus(),dialog.slideUp(500),target.slideDown(500)}),target.parent().on("click","#dialog_body #status_close",function(a){dialog.slideUp(500),target.slideDown(500)}),target.on("click","#sidr_close",function(a){$.sidr("close")}),target.parent().on("click",'#dialog_body [name="state"]',function(a){var t=Util.deltaStatus($(this).val());$("#dialog_body #state_desc").text(t[4]),Util.setStateStyle()});var n=function(a,t,e){if(a[t]>0){var s=$("#dialog_body "+e).val();$("#dialog_body "+e).val(s-a[t])}};target.parent().on("click","#dialog_body #magic_run",function(a){a.preventDefault();var t=Common.magic[$("#dialog_body #magic option:selected").val()];t&&($("#dialog_body #s_mon").val()<t[0]||$("#dialog_body #s_tue").val()<t[1]||$("#dialog_body #s_wed").val()<t[2]||$("#dialog_body #s_thu").val()<t[3]||$("#dialog_body #s_fri").val()<t[4]||$("#dialog_body #s_sat").val()<t[5]||$("#dialog_body #s_sun").val()<t[6]?window.alert("星が不足しているため、魔法を発動できません！"):(n(t,0,"#s_mon"),n(t,1,"#s_tue"),n(t,2,"#s_wed"),n(t,3,"#s_thu"),n(t,4,"#s_fri"),n(t,5,"#s_sat"),n(t,6,"#s_sun")))}),target.parent().on("click","#dialog_body #status_change",function(a){var t=$("#status_basic");"none"===t.css("display")?($("#status_change").val("Equipment"),$("#status_basic").show(),$("#status_equip").hide()):($("#status_change").val("Basic Status"),$("#status_basic").hide(),$("#status_equip").show())}),target.parent().on("click","#dialog_body .spinner_up, .spinner_up",function(a){var t=$(this).prev();t.val(Number(t.val())+1)}),target.parent().on("click","#dialog_body .spinner_down, .spinner_down",function(a){var t=$(this).next();t.val(Number(t.val())-1)}),target.parent().on("click",".dialog_back",function(a){$(this).parents(".dialog_root").fadeOut(500),target.fadeIn(500)}),target.on("click","#ctrl_bonus",function(a){Util.openDialogById("bonus_list")}),$(document).on("click","#bonus_list .item_list img.bonus_item",function(a){var t,e=a.target.id;t=e.startsWith("gi")?Common.global_items.happy[e]:Common.global_items.bad[e],toastr.success(t.desc,t.name)}),target.on("click","#ctrl_home",function(a){location.href="https://www.web-deli.com/sorcerian/text/"}),target.on("click","#ctrl_reload",function(a){var t=0,e=0,s=["","ノーマル","ブロンズ","シルバー","ゴールド","プラチナ"],i=dialog_elem.result_list;$(".result_list",i).empty(),Object.keys(results_map).forEach(function(a){if(t++,void 0!==global_save_data.results[scenario_code]&&-1!==global_save_data.results[scenario_code].indexOf(a)){e++;var n='<tr><td><img src="'+ROOT+COMMON+"trophy"+results_map[a].level+'.png" title="'+s[results_map[a].level]+'" /></td><td><h3>'+results_map[a].name+"（Lv."+results_map[a].level+"）</h3><p>"+results_map[a].desc+"</p></td></tr>"}else n='<tr><td><img src="'+ROOT+COMMON+'trophy0.png" title="実績未達" /></td><td><h3>???????????????</h3><p>???????????????</p></td></tr>';$(".result_list",i).append(n)});var n=(e/t*100).toFixed(1);$("#result_rate",i).text("Rate:"+n+"%"),Util.openDialogById("result_list")}),target.on("click","#ctrl_back_res",function(a){$("#ctrl_backup_menu").css({display:"block",top:a.pageY,left:a.pageX})}),target.on("click","#ctrl_backup_menu li",function(a){var t=$(this).attr("data-command");switch(t){case"backup":Util.downloadSavedata(scenario_code,storage[scenario_code]);break;case"restore":$("#ctrl_input_restore").click();break;default:console.log("Backup/Restore Error!!")}}),target.on("change","#ctrl_input_restore",function(){scenario_code===this.files[0].name.split("-")[0]?Util.restoreSaveData(this,function(){window.alert("リストアに成功しました。\nゲームを再起動します。"),location.reload()}):window.alert("失敗：現在のシナリオ以外のバックアップはUtilityページからリストアしてください。")}),$(":not(#ctrl_backup_menu)").click(function(a){"ctrl_back_res"!==a.target.id&&$("#ctrl_backup_menu").css("display","none")}),target.on("click","#ctrl_help",function(a){window.open("http://d.hatena.ne.jp/sorcerian/20171220")}),target.on("click","#scenario_title",function(a){var t=$("#control_panel");"none"===t.css("display")?($("#control_panel").slideDown(),global_save_data.panel=!0):($("#control_panel").slideUp(),global_save_data.panel=!1),Util.saveStorageGlobal()}),$(window).on("popstate",function(a){save_data.isEnded||null!=a.originalEvent.state&&(save_data=a.originalEvent.state,Util.saveStorage(),Util.createScene(a.originalEvent.state.scene,{reverse:!0}))}),target.on("click","#restart #tmp_init",function(a){Util.initScenario()}),target.on("click","#restart #tmp_continue",function(a){Util.initJobs(),Util.initView();var t=save_data.scene;Util.createScene(t,{reverse:!0,restore:!0})}),storage[GLOBAL_SAVE_DATA_KEY]?Util.loadStorageGlobal():Util.initGlobalSaveData();var r=function(a){for(var t in scenario_data=a,Common.magic){for(var e=Common.magic[t],s="",i=["月","火","水","木","金","土","太"],n=0;n<7;n++)e[n]>0&&(s+=i[n]+e[n]+" ");e.push(s)}flags_map={},$("flags > flag",scenario_data).each(function(){flags_map[$(this).nsAttr("id")]=$(this).text().trim()}),enemies_map={},$("enemies > enemy",scenario_data).each(function(){enemies_map[$(this).nsAttr("id")]={name:$(this).nsAttr("name"),element:$(this).nsAttr("element"),attack:$(this).nsAttr("attack"),func:$(this).nsAttr("func"),drop:$(this).nsAttr("drop"),desc:$(this).text().trim()}}),items_map={},$("items > item",scenario_data).each(function(){items_map[$(this).nsAttr("id")]={name:$(this).nsAttr("name"),shared:$(this).nsAttr("shared"),desc:$(this).text().trim()}}),results_map={},$("results > result",scenario_data).each(function(){results_map[$(this).nsAttr("id")]={name:$(this).attr("name"),level:$(this).nsAttr("level"),desc:$(this).text().trim()}});var r=$("init > bgm",scenario_data),d=r.nsAttr("main"),l=r.nsAttr("happy"),o=r.nsAttr("bad");if(bgms_map={main:void 0===d?"main":d,happy:void 0===l?"happy":l,bad:void 0===o?"bad":o},!0===debug_mode){var c=Util.validateScenario();if(0!==c.length){var _="<h3>scenario.xmlでエラーが検出されました。</h3>";return _+='<ul class="errorlist">',c.forEach(function(a){_+="<li>Scene "+a.scene_id+": "+a.message+"</li>"}),_+="</ul>",void target.html(_)}}if(!storage[scenario_code]||(Util.loadStorage(),save_data.isEnded))Util.initScenario();else{var u='<div id="restart"><h3>Welcome to SORCERIAN Text!!</h3><p>以前のデータが残っています。<br />続きから開始しますか？</p><button id="tmp_continue">続きから</button> <button id="tmp_init">最初から</button></div>';target.html(u)}};if(scenario_code=scenario_code.trim(),0===scenario_code.indexOf("<")){var d=new DOMParser,l=d.parseFromString(scenario_code,"text/xml");scenario_code="playground",global_save_data.results.playground=[],Util.saveStorageGlobal(),r(l)}else $.get(ROOT+scenario_code+"/scenario.xml").done(r).fail(function(a,t,e){throw new Error("scenario code is invalid.")})},gbat2stext:function(a){$(this).change(function(t){var e=0,s=$('<scenario xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://www.web-deli.com/sorcerian/next/stext/common/sgml.xsd">\n</scenario>'),i=$("<init>\n</init>"),n=$("<items>\n</items>"),r=$("<flags>\n</flags>"),d=$("<enemies>\n</enemies>"),l=$("<results>\n</results>"),o=$("<licence>\n</licence>"),c=function(t){var c=$(this.result),m=$("title",c).text().trim().split("@");if(s.attr("title")||(s.attr("title",m[0]),s.attr("author",m[1])),$("section",c).each(function(a,t){var e=!1,c={};if(c.id=Number($("number",t).text()),1===c.id&&(c.id=0),"link"===$("> summary",t).text().toLowerCase())return!0;var _="\n";$("> text p",t).each(function(a,t){var s=$(t).text();if("@@"===s.trim())return e=!e,!0;if(e){if(!s)return!0;if(0===s.indexOf("pc")){var u=s.split(":"),m=$("<constraint></constraint>");u[1]&&m.attr("race",u[1]),u[2]&&m.attr("sex",u[2]),u[3]&&m.attr("age",u[3]),m.appendTo(i)}else if(0===s.indexOf("bgm")){var p=s.split(":"),v=$("<bgm></bgm>");p[1]&&v.attr("main",p[1]),p[2]&&v.attr("happy",p[2]),p[3]&&v.attr("bad",p[3]),v.appendTo(i)}else if(0===s.indexOf("label")){var g=s.split(":"),f=$("<label></label>");g[1]&&f.attr("free1",g[1]),g[2]&&f.attr("free2",g[2]),g[3]&&f.attr("free3",g[3]),f.appendTo(i)}else if(0===s.indexOf("intro")){var h=s.split(":"),b=$("<intro></intro>");h[1]&&b.attr("description",h[1]),b.appendTo(i)}else if(0===s.indexOf("i")){var O=s.split(":");$("<item></item>").attr("id",O[0]).attr("name",O[1]).text(O[2]).appendTo(n)}else if(0===s.indexOf("f")){var x=s.split(":");$("<flag></flag>").attr("id",x[0]).text(x[1]).appendTo(r)}else if(0===s.indexOf("m")){var y=s.split(":");$("<enemy></enemy>").attr("id",y[0]).attr("name",y[1]).attr("element",y[2]).attr("attack",y[3]).attr("func",y[4]).attr("drop",y[5]).text(y[6]).appendTo(d)}else if(0===s.indexOf("r")){var k=s.split(":");$("<result></result>").attr("id",k[0]).attr("name",k[1]).attr("level",k[2]).text(k[3]).appendTo(l)}else if(0===s.indexOf("w")){var A=s.split(":");$("<work></work>").attr("name",A[1]).attr("category",A[2]).attr("creator",A[3]).attr("url",A[4]?"//"+A[4]:"").appendTo(o)}else if(0===s.indexOf("@")){var w=s.substring(1).split(":");void 0===w[1]&&(w[1]=""),c[w[0]]=w[1]}}else _+=s+"\n"}),_+="\n",$("choices choice",t).each(function(a,t){var e=$("text p",t).text().trim().split("@"),s=$("destination",t).text();if("999"===s){var i="[";i+=e[0],i+="](X)\n"}else if("998"===s){i="[";i+=e[0],i+="](Q)\n"}else{i="[";i+=e[0],i+="](",i+=s,e[2]&&(i+=","+e[2]),e[1]&&(i+=' "'+e[1]+'"'),i+=")\n"}_+=i});var u=$("<scene></scene>\n").attr("id",c.id).text(_);void 0!==c.items&&u.attr("items",c.items),void 0!==c.flags&&u.attr("flags",c.flags),void 0!==c.enemies&&u.attr("enemies",c.enemies),void 0!==c.stars&&u.attr("stars",c.stars),void 0!==c.hp&&u.attr("hp",c.hp),void 0!==c.mp&&u.attr("mp",c.mp),void 0!==c.free1&&u.attr("free1",c.free1),void 0!==c.free2&&u.attr("free2",c.free2),void 0!==c.free3&&u.attr("free3",c.free3),void 0!==c.bgm&&u.attr("bgm",c.bgm),void 0!==c.se&&u.attr("se",c.se),void 0!==c.result&&u.attr("result",c.result),void 0!==c.end&&u.attr("end",c.end),u.appendTo(s)}),o.prependTo(s),l.prependTo(s),d.prependTo(s),r.prependTo(s),n.prependTo(s),i.prependTo(s),e++,e>=_.length)if(a)a(s);else{var p=vkbeautify.xml('<?xml version="1.0" encoding="utf-8"?>\n'+s.get(0).outerHTML),v=new Blob([p],{type:"application/octet-stream"}),g=document.createElement("a");g.href=window.URL.createObjectURL(v),g.download="scenario.xml",g.click()}else u.readAsText(_[e],"UTF-8")},_=$(this).get(0).files,u=new FileReader;$(u).on("load",c),u.readAsText(_[e],"UTF-8")})},backupData:function(a){$(this).click(function(){var t="",e=localStorage,s=$(a).val();if("all"===s)$.get(ROOT+"stext.xml").done(function(a){var i=[GLOBAL_SAVE_DATA_KEY];$("work[id]:not([unpublished])",a).each(function(a,t){i.push($(t).attr("id"))});for(var n=0;n<i.length;n++){var r=e[i[n]];r&&(t+=i[n]+"\n",t+=r+"\n")}Util.downloadSavedata(s,t)});else{if(t=e[s],!t)return void window.alert("データが存在しません！");Util.downloadSavedata(s,t)}})},restoreData:function(){$(this).change(function(){Util.restoreSaveData(this,function(){window.alert("リストアが完了しました。\r（起動している場合は）ゲーム画面をリロードしてください。")})})},nsAttr:function(a){var t=$(this).attr(a);if(void 0!==t)return t.replace(/\s+/g,"")}})})(jQuery);