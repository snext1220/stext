$((function(){class LevelResolver{constructor(scenario){this.scenario=JSON.parse(JSON.stringify(scenario)),this.level={},this.maxLevel=1}run(){let that=this,over=this.getEdgeCount();this.traceScenes(0,1),this.scenario.scenes.forEach((function(scene){let level=that.level[scene.id];scene.level=level||that.maxLevel,over.includes(scene.id)&&(scene.level=that.maxLevel+1)}))}traceScenes(id,level){let that=this,children;this.level[id]||(this.level[id]=level,this.getToScenes(id).forEach((function(scene){that.traceScenes(scene.id,level+1)})),this.maxLevel<level&&(this.maxLevel=level))}getToScenes(id){let to_ids=[];return this.scenario.edges.forEach((function(edge){String(edge.from)===String(id)&&to_ids.push(edge.to)})),this.scenario.scenes.filter((function(scene){return to_ids.includes(String(scene.id))}))}getEdgeCount(){let to_id={},from_id={};this.scenario.edges.forEach((function(edge){to_id[edge.to]?to_id[edge.to]+=1:to_id[edge.to]=1,from_id[edge.from]?from_id[edge.from]+=1:from_id[edge.from]=1}));let result=[];return Object.keys(from_id).forEach((function(id){from_id[id]>15&&result.push(id)})),Object.keys(to_id).forEach((function(id){to_id[id]>15&&result.push(id)})),result}}let network=null,filter_where=[],Common_HELP_URL="https://sorcerian.hateblo.jp/entry/2018/11/01/211745#",Common_MY_STORAGE="pg2_save",Common_LOAD_NAME="pg2_load",Common_RUN_NAME="pg2_run",Common_CONFIG_NAME="pgflow_config",Common_INIT_CONFIG={author:"Unnamed",disp:"auto",increment:10},Common_INIT_DATA_EMPTY={title:"",author:"",init:{constraint:{},bgm:{},label:{},intro:{}},groups:[],items:[],flags:[],enemies:[],results:[],licence:[],scenes:[],edges:[]},Common_INIT_DATA={title:"Untitled",author:"Unnamed",init:{constraint:{race:"",sex:"",age:""},bgm:{main:"",happy:"",bad:""},label:{free1:"",free2:"",free3:""},intro:{keywords:"",description:""}},groups:[{start:0,end:1,title:"Introduction"}],items:[{id:"i01",name:"Item-01",text:"Item description..."}],flags:[{id:"f01",text:"Flag description..."}],enemies:[{id:"m01",name:"Enemy-01",element:"earth",attack:"physics",func:"L+R-STR",drop:"mon/2",text:"Enemy description..."}],results:[{id:"r01",name:"Result-01",level:1,text:"Result description..."}],licence:[{name:"Bgm-01",category:"bgm",creator:"SText",url:"https://example.com/"}],scenes:[{id:"0",summary:"プロローグ",label:"0:\nプロローグ",text:"ここにプロローグを書きます。",group:"prologue"},{id:"1",summary:"本文",label:"1:\n本文",text:"ここからが本文です。"}],edges:[{from:"0",to:"1",label:"次へ"}]},Util={loadConfig:function(){let conf=localStorage[Common_CONFIG_NAME];try{return conf?JSON.parse(conf):Common_INIT_CONFIG}catch(e){return Common_INIT_CONFIG}},saveConfig:function(data){return!!data&&(localStorage[Common_CONFIG_NAME]=JSON.stringify(data),!0)},updateLevel(){let lr=new LevelResolver(scenario);return lr.run(),lr.scenario},sortFn:function(m,n){return Number(m.id.substring(1))-Number(n.id.substring(1))},maxSceneId:function(){return Math.max.apply(null,scenario.scenes.map((function(s){return s.id})))},sortScenario:function(){scenario.groups.sort((function(m,n){return Number(m.start)-Number(n.start)})),scenario.items.sort(Util.sortFn),scenario.flags.sort(Util.sortFn),scenario.enemies.sort(Util.sortFn),scenario.results.sort(Util.sortFn)},sortScenes:function(){scenario.scenes.sort((m,n)=>Number(m.id)-Number(n.id))},sortEdges:function(){scenario.edges.sort((m,n)=>{let m_from=Number(m.from),n_from=Number(n.from),m_order=Number(m.order),n_order=Number(n.order);return m_from!==n_from?m_from-n_from:m_order-n_order})},isDuplicateScene:function(id){return scenario.scenes.some((function(value){return value.id===id}))},existScene:function(id){return!Util.isDuplicateScene(id)},addNode:(id,summary)=>Util.isDuplicateScene(id)?(toastr.error("id値が重複しています。","不正なid"),!1):(scenario.scenes.push({id:String(id),summary:summary,label:`${id}:\n${summary}`,text:""}),Util.sortScenes(),!0),changeNodeId(old_id,new_id){scenario.scenes.forEach((function(scene){String(scene.id)===old_id&&(scene.id=new_id,scene.label=`${new_id}\n${scene.summary}`)})),scenario.edges.forEach((function(edge){String(edge.from)===old_id&&(edge.from=new_id),String(edge.to)===old_id&&(edge.to=new_id)}))},swapNodeId(old_id,new_id){scenario.scenes.forEach((function(scene){if(String(scene.id)===old_id)return scene.id=new_id,void(scene.label=`${new_id}\n${scene.summary}`);String(scene.id)===new_id&&(scene.id=old_id,scene.label=`${old_id}\n${scene.summary}`)})),scenario.edges.forEach((function(edge){let done_from=!1,done_to=!1;String(edge.from)===old_id&&(edge.from=new_id,done_from=!0),String(edge.to)===old_id&&(edge.to=new_id,done_to=!0),done_from||String(edge.from)!==new_id||(edge.from=old_id),done_to||String(edge.to)!==new_id||(edge.to=old_id)})),console.log(scenario)},generateLinkId:function(from,to){return`custom${from}-${to}-${Math.floor(1e5*Math.random())}`},addLink:function(from,to,label,kind="",add="",correct=""){if(kind)if("R"===kind||"X"===kind){let tos=[];tos.push(to),tos=tos.concat(add.split(",")),tos=[...new Set(tos)];for(let tmp_to of tos)scenario.edges.push({from:from,to:tmp_to,label:label,type:kind,order:"R"===kind?97:98,id:Util.generateLinkId(from,tmp_to)})}else"Q"===kind&&(scenario.edges.push({from:from,to:to,label:label,type:"Q",correct:correct,order:99,id:Util.generateLinkId(from,to)}),scenario.edges.push({from:from,to:add,label:label,type:"Q",order:99,id:Util.generateLinkId(from,add)}));else scenario.edges.push({from:from,to:to,label:label,id:Util.generateLinkId(from,to)})},deleteLink(id){let index=scenario.edges.findIndex((function(edge){return edge.id===id}));return scenario.edges.splice(index,1)},deleteScene(id){if(0==id)return void toastr.error("id=0のシーンは削除できません。","不正な操作");let index=scenario.scenes.findIndex((function(scene){return scene.id===id}));for(scenario.scenes.splice(index,1);;){let e_index=scenario.edges.findIndex((function(edge){return edge.from===id||edge.to===id}));if(console.log(e_index),-1===e_index)break;scenario.edges.splice(e_index,1)}return!0},getSceneById:function(id){return scenario.scenes.find((function(elem){return elem.id===id}))},createLinkList:function(id){$("#scene-select #edges-list").empty(),$("#scene-select #edges-list").append('<option value="" selected>編集するリンクを選択</option>'),Util.sortEdges(),scenario.edges.forEach((function(value){value.from===id&&$("<option></option>").attr("value",value.id).text(`${value.to}: ${value.label}`).appendTo("#scene-select #edges-list")}))},setSceneInfo:function(id){if(void 0!==id){Util.enableTab(7);let scene=Util.getSceneById(id);$("#scene-select #id").val(scene.id),$("#scene-select #summary").val(scene.summary),$("#scene-select #end").val(scene.end),$("#scene-select #items").val(scene.items),$("#scene-select #flags").val(scene.flags),$("#scene-select #enemies").val(scene.enemies),$("#scene-select #result").val(scene.result),$("#scene-select #bgm").val(scene.bgm),$("#scene-select #se").val(scene.se),$("#scene-select #hp").val(scene.hp),$("#scene-select #mp").val(scene.mp),$("#scene-select #str").val(scene.str),$("#scene-select #int").val(scene.int),$("#scene-select #dex").val(scene.dex),$("#scene-select #krm").val(scene.krm),$("#scene-select #stars").val(scene.stars),$("#scene-select #free1").val(scene.free1),$("#scene-select #free2").val(scene.free2),$("#scene-select #free3").val(scene.free3),$("#scene-select #hp_max").val(scene.hp_max),$("#scene-select #mp_max").val(scene.mp_max),$("#scene-select #str_max").val(scene.str_max),$("#scene-select #int_max").val(scene.int_max),$("#scene-select #dex_max").val(scene.dex_max),$("#scene-select #krm_max").val(scene.krm_max),$("#scene-select #fixed").prop("checked",!!scene.fixed),$("#scene-select #exclude").prop("checked",!!scene.exclude),scene.text?editor.setValue(scene.text):editor.setValue(""),editor.focus(),editor.clearSelection(),Util.createLinkList(id)}},getEdgeById:function(id){return scenario.edges.find((function(elem){return elem.id===id}))},setEdgeInfo:function(id){Util.enableTab(8);let edge=Util.getEdgeById(id);$("#edge #id").val(edge.id),$("#edge #from").val(edge.from),$("#edge #to").val(edge.to),$("#edge #order").val(edge.order),$("#edge #label").val(edge.label),$("#edge #condition").val(edge.condition),$("#edge #type").val(edge.type),$("#edge #correct").val(edge.correct),$("#edge #cache").val(edge.cache)},objToElement:function(name,data){let flag=!1,result=$(`<${name}></${name}>`);for(let key of Object.keys(data))void 0!==data[key]&&""!==data[key]&&("text"===key?result.text(data[key]):"label"===key||"X"===key||"y"===key||result.attr(key,data[key]),flag=!0);return!!flag&&result},createNetwork:function(opts={}){(opts=Object.assign({level:!0,focus_id:null,fit:!1},opts)).level&&(scenario=Util.updateLevel());let scale=1;network&&(scale=network.getScale()),Util.destroyNetwork(),0===filter_where.length&&(filter_where=[{start:0,end:99999}]),network=new vis.Network(document.getElementById("flow-area"),{autoResize:!1,nodes:new vis.DataSet(scenario.scenes.filter((function(value){let result=!1;for(let cond of filter_where)if(Number(cond.start)<=Number(value.id)&&Number(value.id)<=Number(cond.end)){result=!0;break}return result}))),edges:new vis.DataSet(scenario.edges)},{physics:!1,interaction:{hover:!0},groups:{prologue:{color:"#3f0"},happy:{color:"#ffc"},bad:{color:"#96f"}},layout:{improvedLayout:!1,hierarchical:{enabled:!0,levelSeparation:100,nodeSpacing:100,blockShifting:!0,edgeMinimization:!0,direction:"UD",sortMethod:"directed",treeSpacing:70}},manipulation:{addNode:function(data,callback){document.getElementById("node-add").onclick=function(data,callback){if(data.id=$("#node-id").val(),data.summary=$("#node-summary").val(),data.label=data.id+":\n"+data.summary,scenario.scenes.some((function(value){return value.id===data.id})))return window.alert("重複したidは登録できません。"),void callback(null);{$("#scene-dialog").dialog("close"),scenario.scenes.push(data),scenario.scenes.sort((m,n)=>Number(m.id)-Number(n.id)),callback(data);let tmp_pos=network.getViewPosition();network.moveNode(data.id,tmp_pos.x,tmp_pos.y)}}.bind(this,data,callback),document.getElementById("node-cancel").onclick=function(){$("#scene-dialog").dialog("close")},$("#scene-dialog").dialog("open")},addEdge:function(data,callback){scenario.edges.push(data),callback(data)},editEdge:function(data,callback){let edge=Util.getEdgeById(data.id);edge.from=data.from,edge.to=data.to,Util.disableTab(),callback(data)},deleteNode:function(data,callback){if(confirm("Sceneを削除しても良いですか？")){let node=Util.getSceneById(data.nodes[0]);if(0===Number(node.id))return window.alert("id=0のノードは削除できません。"),void callback(null);scenario.scenes=scenario.scenes.filter((function(value){return value.id!==node.id})),scenario.edges=scenario.edges.filter((function(value){return value.from!==node.id&&value.to!==node.id})),Util.disableTab(),callback(data)}else callback(null)},deleteEdge:function(data,callback){if(confirm("Edgeを削除しても良いですか？")){for(ed of data.edges)scenario.edges=scenario.edges.filter((function(value){return console.log(value),console.log(ed),console.log("----"),value.id!==ed}));Util.disableTab(),callback(data)}else callback(null)}},locale:"ja",locales:{ja:{edit:"Edit",del:"Delete Selected",back:"Back",addNode:"Add Scene",addEdge:"Add Link",editNode:"Edit Scene",editEdge:"Edit Link",addDescription:"Click in an empty space to place a new scene.",edgeDescription:"Click on a scene and drag the link to another scene to connect them.",editEdgeDescription:"Click on the control points and drag them to a scene to connect to it.",createEdgeError:"Cannot link edges to a cluster.",deleteClusterError:"Clusters cannot be deleted.",editClusterError:"Clusters cannot be edited."}},nodes:{shape:"box",size:20,font:{size:12},color:{background:"skyblue",highlight:{border:"#f00",background:"#f90"}}},edges:{arrows:"to",smooth:{enabled:!0,type:"curvedCCW",roundness:.1},font:{size:12,color:"rgba(0,0,0,0)",strokeWidth:0},chosen:{label:function(values){values.color="#f00",values.strokeWidth=2,values.mod="bold"}},color:{color:"skyblue",hover:"#f90",highlight:"#f00"}}}),network.moveTo({scale:scale}),opts.focus_id&&(network.focus(opts.focus_id),network.selectNodes([opts.focus_id])),opts.fit&&network.fit(),network.on("selectNode",(function(e){let id=this.getNodeAt(e.pointer.DOM);Util.setSceneInfo(id)})),network.on("selectEdge",(function(e){if(0!==e.nodes.length)return;let id=network.getEdgeAt(e.pointer.DOM);void 0!==id&&Util.setEdgeInfo(id)}))},destroyNetwork:function(){null!==network&&(network.destroy(),network=null)},createGrid:function(selector,data,cols,opts,helpName){void 0===data&&(data=[]);let grid=new Slick.Grid(selector,data,cols,opts);grid.setSelectionModel(new Slick.CellSelectionModel),grid.onClick.subscribe((function(e,args){$(e.target).hasClass("btn-delete")&&(data.splice(args.row,1),grid.invalidate())})),grid.onAddNewRow.subscribe((function(e,args){let item=args.item;grid.invalidateRow(data.length),data.push(item),grid.updateRowCount(),grid.render()})),grid.onHeaderClick.subscribe((function(e,args){window.open(Common_HELP_URL+helpName,"help")}))},validateId:function(value,prefix,name){if(null!=value&&null!=value&&""!=value.trim()&&value.startsWith(prefix))return{valid:!0,msg:null};{let msg=`${name}のidは「${prefix}～」形式で入力してください。`;return toastr.error(msg,"Id Error"),{valid:!1,msg:msg}}},createSelectSidebar:function(trigger,target,dataset,type,label,value,onSubmit){let s_name=`sidr_${target}`,s_list=`#${s_name} #${s_name}_list`,s_submit=`#${s_name} #${s_name}_submit`,s_cancel=`#${s_name} #${s_name}_close`;$(trigger).sidr({name:s_name,displace:!1,onOpen:function(){$(s_list).empty();for(let obj of dataset){let elem,v_label,v_value;switch(v_label="function"==typeof label?label(obj):obj[label],v_value="function"==typeof value?value(obj):obj[value],type){case"check":elem=`<li>\n                  <label>${v_label}<input type="checkbox"\n                    class="sidr-item" value="${v_value}" /></label>\n                </li>`;break;case"radio":elem=`<li>\n                  <label>${v_label}<input type="radio" name="${s_name}"\n                  class="sidr-item" value="${v_value}" /></label>\n                </li>`;break;case"plus_minus":elem=`<tr>\n                  <td>\n                    <label>＋<input type="checkbox"\n                      class="sidr-item ${s_name}_plus" value="${v_value}" /></label>\n                  </td>\n                  <td class="sidr-elem"><span>${v_label}</span></td>\n                  <td>\n                    <label>－<input type="checkbox"\n                      class="sidr-item ${s_name}_minus" value="${v_value}" /></label>\n                  </td>\n                </tr>`;break;default:throw new Error("type属性の値が不正です。")}$(s_list).append(elem)}$(`${s_list} .sidr-item`).checkboxradio({icon:!1})}}),$(s_submit).click((function(){let result;switch(type){case"check":result=[],$(`${s_list} .sidr-item:checked`).each((function(){result.push($(this).val())})),result=result.join(",");break;case"radio":result=$(`${s_list} .sidr-item:checked`).val();break;case"plus_minus":result=[],$(`${s_list} .sidr_${target}_plus:checked`).each((function(){result.push($(this).val())})),$(`${s_list} .sidr_${target}_minus:checked`).each((function(){result.push("-"+$(this).val())})),result=result.join(",")}onSubmit?onSubmit(result,trigger,s_list):$(trigger).val(result).trigger("input"),$.sidr("close",s_name)})),$(s_cancel).click((function(){$.sidr("close",s_name)}))},createQuestLink:function(group){let tmp_correct="",tmp_to=[];for(let value of group)value.correct?(tmp_to[0]=value.to,tmp_correct=value.correct):tmp_to[1]=value.to;return`[${tmp_correct},${tmp_to.join(",")}](Q)`},createFreeLink:function(group){let tmp_to=[];for(let value of group)tmp_to.push(value.to);return`[${tmp_to.join(",")}](X)`},createRandomLink:function(group){let tmp_label="",tmp_cache="",tmp_condition="",tmp_to=[];for(let value of group)value.cache&&(tmp_cache=value.cache),value.condition&&(tmp_condition=value.condition),value.label&&(tmp_label=value.label),tmp_to.push(value.to);let to=tmp_to.join(",");return tmp_cache&&(to+=`;${tmp_cache}`),tmp_condition?`[${tmp_label}](${to} "${tmp_condition}")`:`[${tmp_label}](${to})`},createStandardLink:function(link){return link.condition?`[${link.label}](${link.to} "${link.condition}")`:`[${link.label}](${link.to})`},createMoveButton:function(id){let result=[],output=[];scenario.edges.filter((function(value){return value.from===id})).sort((function(v1,v2){return v1.order||(v1.order=0),v2.order||(v2.order=0),Number(v1.order)-Number(v2.order)})).forEach((function(value){let last_out=output[output.length-1];last_out&&last_out[0].order===value.order?last_out.push(value):output.push([value])}));for(let group of output)switch(group[0].type){case"Q":result.push(Util.createQuestLink(group));break;case"X":result.push(Util.createFreeLink(group));break;case"R":result.push(Util.createRandomLink(group));break;default:for(let link of group)result.push(Util.createStandardLink(link))}return result.join("\n")},enableTab:function(id){$("#edit-area").tabs("enable",id).tabs("option","active",id)},disableTab:function(){$("#edit-area").tabs("option","active",0).tabs("option","disabled",[7,8])},createXml:function(){let result=$('<scenario xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://www.web-deli.com/sorcerian/next/stext/common/sgml.xsd"></scenario>'),inits=$("<init></init>"),groups=$("<groups></groups>"),items=$("<items></items>"),flags=$("<flags></flags>"),enemies=$("<enemies></enemies>"),results=$("<results></results>"),licence=$("<licence></licence>");result.attr("title",scenario.title),result.attr("author",scenario.author);let constraint=Util.objToElement("constraint",scenario.init.constraint);constraint&&inits.append(constraint);let bgm=Util.objToElement("bgm",scenario.init.bgm);bgm&&inits.append(bgm);let label=Util.objToElement("label",scenario.init.label);label&&inits.append(label);let intro=Util.objToElement("intro",scenario.init.intro);intro&&inits.append(intro),result.append(inits);for(let t_group of scenario.groups){let group=Util.objToElement("group",t_group);group&&groups.append(group)}result.append(groups);for(let t_item of scenario.items){let item=Util.objToElement("item",t_item);item&&items.append(item)}result.append(items);for(let t_flag of scenario.flags){let flag=Util.objToElement("flag",t_flag);flag&&flags.append(flag)}result.append(flags);for(let t_enemy of scenario.enemies){let enemy=Util.objToElement("enemy",t_enemy);enemy&&enemies.append(enemy)}result.append(enemies);for(let t_result of scenario.results){let result=Util.objToElement("result",t_result);result&&results.append(result)}result.append(results);for(let t_work of scenario.licence){let work=Util.objToElement("work",t_work);work&&licence.append(work)}result.append(licence);for(let t_scene of scenario.scenes){let scene=Util.objToElement("scene",t_scene);scene.text(scene.text()+"\n\n"+Util.createMoveButton(scene.attr("id"))),scene&&result.append(scene)}return vkbeautify.xml('<?xml version="1.0" encoding="utf-8"?>\n'+result.get(0).outerHTML)},elementToObj:function(obj,isLabel){let result={},t_obj=obj.get(0);if(t_obj){let attrs=t_obj.attributes;for(let attr of attrs)result[attr.name]=attr.value;t_obj.textContent&&(result.text=t_obj.textContent),isLabel&&(result.label=t_obj.id+":\n"+t_obj.getAttribute("summary"))}return result},setGroupByEnd(attr_end,obj){switch(attr_end){case"happy":obj.group="happy";break;case"bad":obj.group="bad";break;default:delete obj.group}},createJson(data){let result=$.extend(!0,{},Common_INIT_DATA_EMPTY),parser,s_data=(new DOMParser).parseFromString(data,"text/xml");result.title=$("scenario",s_data).attr("title"),result.author=$("scenario",s_data).attr("author"),result.init.constraint=Util.elementToObj($("init > constraint",s_data)),result.init.bgm=Util.elementToObj($("init > bgm",s_data)),result.init.label=Util.elementToObj($("init > label",s_data)),result.init.intro=Util.elementToObj($("init > intro",s_data)),$("groups > group",s_data).each((function(i,elem){result.groups.push(Util.elementToObj($(elem)))})),$("items > item",s_data).each((function(i,elem){result.items.push(Util.elementToObj($(elem)))})),$("flags > flag",s_data).each((function(i,elem){result.flags.push(Util.elementToObj($(elem)))})),$("enemies > enemy",s_data).each((function(i,elem){result.enemies.push(Util.elementToObj($(elem)))})),$("results > result",s_data).each((function(i,elem){result.results.push(Util.elementToObj($(elem)))})),$("licence > work",s_data).each((function(i,elem){result.licence.push(Util.elementToObj($(elem)))}));var link=/\[(.+?)\]\(([\dQX,;]{1,})(?: "(.+?)")?\)/gi;return $("scene",s_data).each((function(i,elem){let body=$(elem).text(),order=0;for(;null!==(link_result=link.exec(body));){order++;let tmp_to=link_result[2],tmp_condition=link_result[3]?link_result[3]:"",tmp_label=link_result[1];switch(tmp_to){case"Q":tmp_label=tmp_label.split(","),result.edges.push({from:elem.id,to:tmp_label[1],label:"",type:"Q",correct:tmp_label[0],order:order}),result.edges.push({from:elem.id,to:tmp_label[2],label:"",type:"Q",order:order});break;case"X":tmp_label=tmp_label.split(",");for(let tmp of tmp_label)result.edges.push({from:elem.id,to:tmp,label:"",type:"X",order:order});break;default:if(-1===tmp_to.indexOf(","))result.edges.push({from:elem.id,to:tmp_to,label:tmp_label,condition:tmp_condition,order:order});else{tmp_cache=tmp_to.split(";"),tmp_to=tmp_cache[0].split(","),tmp_cache=tmp_cache[1],is_first=!0;for(let tmp of tmp_to){let tmp_link={from:elem.id,to:tmp,label:tmp_label,type:"R",condition:tmp_condition,order:order};is_first&&(tmp_link.cache=tmp_cache,is_first=!1),result.edges.push(tmp_link)}}}}let s_obj=Util.elementToObj($(elem).text(body.replace(link,"")),!0);0===Number(s_obj.id)?s_obj.group="prologue":s_obj.end&&Util.setGroupByEnd(s_obj.end,s_obj),result.scenes.push(s_obj)})),JSON.stringify(result)},numToKanji:function(nums){let result="",tbl={1:"一",2:"二",3:"三",4:"四",5:"五",6:"六",7:"七",8:"八",9:"九",0:"〇"};for(num of String(nums))result+=tbl[num];return result},createLinkTag:function(id,edges){let result=[];return edges.forEach((function(value){value.from===id&&result.push(`<a href="#${value.to}">［${value.label} ${Util.numToKanji(value.to)}へ］</a>`)})),result.join("<br />")},createHtml(){let html=$("<html></html>").append($("<head></head>").append($("<meta></meta>").attr("charset","UTF-8")).append($("<title></title>").text(scenario.title)).append($("<style></style>").text("body {\n                writing-mode: vertical-rl;\n                text-orientation: upright;\n              }"))),body=$("<body></body>");return scenario.scenes.forEach((function(value){$('<div class="scene"></div>').attr("id",value.id).html("<h3>【"+Util.numToKanji(value.id)+"】</h3>"+marked(value.text)+"<p>"+Util.createLinkTag(value.id,scenario.edges)+"</p><hr />").appendTo(body)})),html.append(body),"<!DOCTYPE html>"+html.get(0).outerHTML},download:function(content,name){var blob=new Blob([content],{type:"application/octet-stream"}),anchor=document.createElement("a");anchor.href=window.URL.createObjectURL(blob),anchor.download=name,document.body.appendChild(anchor),anchor.click(),document.body.removeChild(anchor)}},global_config=Util.loadConfig(),scenario;localStorage.editor2flow&&(sessionStorage.setItem(Common_LOAD_NAME,Util.createJson(localStorage.editor2flow)),localStorage.removeItem("editor2flow"));try{scenario=JSON.parse(sessionStorage.getItem(Common_LOAD_NAME)),sessionStorage.removeItem(Common_LOAD_NAME)}catch(e){console.log(e)}scenario||(scenario=$.extend(!0,{},Common_INIT_DATA),scenario.author=global_config.author),$("#ctrl_incre").val(global_config.increment),Util.sortScenario(),Util.createNetwork({fit:!0}),$("#title").val(scenario.title),$("#author").val(scenario.author),$("#constraint-race").val(scenario.init.constraint.race),$("#constraint-sex").val(scenario.init.constraint.sex),$("#constraint-age").val(scenario.init.constraint.age),$("#bgm-main").val(scenario.init.bgm.main),$("#bgm-happy").val(scenario.init.bgm.happy),$("#bgm-bad").val(scenario.init.bgm.bad),$("#label-hp").val(scenario.init.label.hp),$("#label-mp").val(scenario.init.label.mp),$("#label-state").val(scenario.init.label.state),$("#label-str").val(scenario.init.label.str),$("#label-int").val(scenario.init.label.int),$("#label-dex").val(scenario.init.label.dex),$("#label-krm").val(scenario.init.label.krm),$("#label-free1").val(scenario.init.label.free1),$("#label-free2").val(scenario.init.label.free2),$("#label-free3").val(scenario.init.label.free3),$("#intro-keywords").val(scenario.init.intro.keywords),$("#intro-description").val(scenario.init.intro.description),$("#basic input").on("input",(function(e){let id=e.target.id.split("-");1===id.length?scenario[id[0]]=$(this).val():scenario.init[id[0]][id[1]]=$(this).val(),console.log("input")})),$(".sidr-race-item, .sidr-age-item, .sidr-sex-item").checkboxradio({icon:!1}),$("#basic #constraint-race").sidr({name:"sidr_races",displace:!1}),$("#sidr_races_submit").click((function(){let result=[];$(".sidr-race-item:checked").each((function(){result.push($(this).val())})),$("#basic #constraint-race").val(result.join(",")).trigger("input"),$.sidr("close","sidr_races")})),$("#sidr_races_close").click((function(){$.sidr("close","sidr_races")})),$("#basic #constraint-age").sidr({name:"sidr_ages",displace:!1}),$("#sidr_ages_submit").click((function(){let result=[];$(".sidr-age-item:checked").each((function(){result.push($(this).val())})),$("#basic #constraint-age").val(result.join(",")).trigger("input"),$.sidr("close","sidr_ages")})),$("#sidr_ages_close").click((function(){$.sidr("close","sidr_ages")})),$("#basic #constraint-sex").sidr({name:"sidr_sexes",displace:!1}),$("#sidr_sexes_submit").click((function(){let result=[];$(".sidr-sex-item:checked").each((function(){result.push($(this).val())})),$("#basic #constraint-sex").val(result.join(",")).trigger("input"),$.sidr("close","sidr_sexes")})),$("#sidr_sexes_close").click((function(){$.sidr("close","sidr_sexes")})),$("#basic #bgm-main-ref").click((function(e){$("#basic #bgm-main-file").click()})),$("#basic #bgm-main-file").change((function(e){let name=$(this).get(0).files[0].name;$("#basic #bgm-main").val(name.substring(0,name.lastIndexOf(".mp3"))).trigger("input")})),$("#basic #bgm-happy-ref").click((function(e){$("#basic #bgm-happy-file").click()})),$("#basic #bgm-happy-file").change((function(e){let name=$(this).get(0).files[0].name;$("#basic #bgm-happy").val(name.substring(0,name.lastIndexOf(".mp3"))).trigger("input")})),$("#basic #bgm-bad-ref").click((function(e){$("#basic #bgm-bad-file").click()})),$("#basic #bgm-bad-file").change((function(e){let name=$(this).get(0).files[0].name;$("#basic #bgm-bad").val(name.substring(0,name.lastIndexOf(".mp3"))).trigger("input")})),$("#basic label").dblclick((function(e){let id=$(this).find("input, select").attr("id").split("-")[1];window.open(Common_HELP_URL+id,"help")})),$("#scene label").dblclick((function(e){let id=$(this).find("input, select").attr("id");window.open(Common_HELP_URL+id,"help")})),$("#pg-config").dialog({autoOpen:!1,width:320,show:500,hide:500,modal:!0,position:{of:"#flow-area",at:"left top",my:"left top"},open:function(){$("#config-author").val(global_config.author),$("#config-disp").val(global_config.disp),$("#config-incre").val(global_config.increment)},buttons:{"確定":function(){global_config.author=$("#config-author").val(),global_config.disp=$("#config-disp").val(),global_config.increment=$("#config-incre").val(),$("#ctrl_incre").val(global_config.increment),Util.saveConfig(global_config),$(this).dialog("close")},"キャンセル":function(){$(this).dialog("close")}}}),$("#scene-dialog").dialog({autoOpen:!1,width:320,show:500,hide:500,modal:!0,position:{of:"#flow-area",at:"left top",my:"left top"},open:function(){$("#node-id").val(""),$("#node-summary").val("")}}),$("#scene-dialog-link").dialog({autoOpen:!1,width:320,show:500,hide:500,modal:!0,position:{of:"#flow-area",at:"left top",my:"left top"},open:function(){$("#node-link-id").val(""),$("#node-link-summary").val("")},buttons:{"追加":function(){let from=$("#scene-attr #id").val(),id=$("#node-link-id").val();Util.addNode(id,$("#node-link-summary").val())&&($(this).dialog("close"),console.log(`${from}->${id}`),Util.addLink(from,id,"次へ"),Util.createNetwork({focus_id:from}))},"キャンセル":function(){$(this).dialog("close")}}}),$("#scene-change-dialog").dialog({autoOpen:!1,width:320,show:500,hide:500,modal:!0,position:{of:"#flow-area",at:"left top",my:"left top"},open:function(){$("#old-id").val($("#scene-attr #id").val()),$("#new-id").val("")},buttons:{"変更":function(){let old_id=$("#old-id").val(),new_id=$("#new-id").val();Util.isDuplicateScene(new_id)?Util.swapNodeId(old_id,new_id):Util.changeNodeId(old_id,new_id),Util.createNetwork({focus_id:new_id}),Util.setSceneInfo(new_id),$(this).dialog("close")},"キャンセル":function(){$(this).dialog("close")}}}),$("#edge-dialog").dialog({autoOpen:!1,width:320,show:500,hide:500,modal:!0,position:{of:"#flow-area",at:"left top",my:"left top"},open:function(){$("#from-id").text($("#scene-select #id").val()),$("#edge-dialog #edge-caption").val("次へ"),$("#to-id").val(""),$("#edge-kind").val(""),$("#edge-add").val(""),$("#edge-correct").val("")},buttons:{"追加":function(){let from=$("#edge-dialog #from-id").text(),to=$("#edge-dialog #to-id").val(),label=$("#edge-dialog #edge-caption").val();label||(label="次へ");let kind=$("#edge-dialog #edge-kind").val(),add=$("#edge-dialog #edge-add").val(),correct=$("#edge-dialog #edge-correct").val();to?Util.existScene(to)?toastr.error("リンク先のidが存在しません。","不正な値"):!["R","X","Q"].includes(kind)||add?"Q"===kind&&add.includes(",")?toastr.error("追加情報には間違い時のリンク先を指定してください。<br>\n            正解時のリンク先はid欄に指定します。","不正な値"):"Q"!==kind||correct?(Util.addLink(from,to,label,kind,add,correct),Util.createNetwork({focus_id:from}),Util.setSceneInfo(from),$(this).dialog("close")):toastr.error("［テキスト入力］選択時には、正解文字列は必須です。","不正な値"):toastr.error("通常以外のリンクでは追加情報は必須です。","不正な値"):toastr.error("リンク先のidは必須です。","不正な値")},"キャンセル":function(){$(this).dialog("close")}}}),$("#edge-dialog #edge-kind").change((function(){let v=$(this).val();$("#edge-dialog #edge-add").attr("placeholder",(function(){return""===v?"":"R"===v||"X"===v?"他のリンク先（カンマ区切り）":"Q"===v?"間違いの時のリンク先":void 0}))})),$("#range-dialog").dialog({autoOpen:!1,width:400,show:500,hide:500,modal:!0,position:{of:"#flow-area",at:"left top",my:"left top"},buttons:{"絞り込み":function(){Util.createNetwork({fit:!0}),$(this).dialog("close")},"キャンセル":function(){$(this).dialog("close")}},open:function(){}}),$("#upload-dialog").dialog({autoOpen:!1,width:800,show:500,hide:500,modal:!0,buttons:{"投稿":function(){let key=localStorage.getItem("pgflow_key");key||(key=(new Date).getTime().toString(16),localStorage.setItem("pgflow_key",key));let p={email:$("#upload-email").val(),tag:$("#upload-tag").val(),level:$("#upload-level").val(),intro:$("#upload-intro").val(),comment:$("#upload-comment").val()};localStorage.setItem("pgflow_post",JSON.stringify(p));let data=new FormData;data.append("key",key),data.append("email",p.email),data.append("tag",p.tag),data.append("level",p.level),data.append("intro",p.intro),data.append("comment",p.comment),data.append("scenario",new Blob([Util.createXml()],{type:"text/xml"}),"scenario.xml");let bgms=$("#upload-bgms").get(0).files,ses=$("#upload-ses").get(0).files,pics=$("#upload-pics").get(0).files;for(let i=0;i<bgms.length;i++)data.append("bgms[]",bgms[i]);for(let i=0;i<ses.length;i++)data.append("ses[]",ses[i]);for(let i=0;i<pics.length;i++)data.append("pics[]",pics[i]);try{fetch("upload.php",{method:"POST",redirect:"follow",body:data}).then((function(res){res.ok?window.alert("投稿に成功しました。"):window.alert("投稿に失敗しました。\nファイルの合計サイズが上限（8mb）を超過していないかなど、ご確認ください。")}))}catch(e){console.log(e)}$(this).dialog("close")},"キャンセル":function(){$(this).dialog("close")}},open:function(){let p=JSON.parse(localStorage.getItem("pgflow_post"));p&&($("#upload-email").val(p.email),$("#upload-tag").val(p.tag),$("#upload-level").val(p.level),$("#upload-intro").val(p.intro),$("#upload-comment").val(p.comment))}}),$("#upload-dialog label").tooltip(),$("#ctrl_post").click((function(){$("#upload-dialog").dialog("open")})),$("#scene-select input:not(.no-update), #scene-select select:not(.no-update)").on("input",(function(e){let id=$("#scene-select #id").val();if(console.log(`scene_input ${id}`),id){let scene=Util.getSceneById(id);scene[e.target.id]=$(this).val(),"summary"===e.target.id?(scene.label=scene.id+":\n"+scene.summary,Util.createNetwork({focus_id:scene.id,level:!1}),network.selectNodes([scene.id])):"exclude"===e.target.id?$(this).prop("checked")||(scene[e.target.id]=void 0):"fixed"===e.target.id?$(this).prop("checked")||(scene[e.target.id]=void 0):"end"===e.target.id&&(Util.setGroupByEnd($(this).val(),scene),Util.createNetwork({focus_id:scene.id,level:!1}))}})),Util.createSelectSidebar("#scene-select #items","items",scenario.items,"plus_minus","name","id"),Util.createSelectSidebar("#scene-select #flags","flags",scenario.flags,"plus_minus","text","id"),Util.createSelectSidebar("#scene-select #enemies","enemies",scenario.enemies,"check","name","id"),Util.createSelectSidebar("#scene-select #result","results",scenario.results,"radio","name","id"),$("#scene-select #bgm-ref").click((function(e){$("#scene-select #bgm-file").click()})),$("#scene-select #bgm-file").change((function(e){let name=$(this).get(0).files[0].name;$("#scene-select #bgm").val(name.substring(0,name.lastIndexOf(".mp3"))).trigger("input")})),$("#scene-select #se-ref").click((function(e){$("#scene-select #se-file").click()})),$("#scene-select #se-file").change((function(e){let name=$(this).get(0).files[0].name;$("#scene-select #se").val(name.substring(0,name.lastIndexOf(".mp3"))).trigger("input")})),$("#scene-select #hp, #scene-select #mp").autocomplete({minLength:0,source:["1","-5..-1","full"],close:function(e,ui){$(this).trigger("input")}}),$("#scene-select #stars").autocomplete({minLength:0,source:["0,0,0,0,0,0,0","divN"],close:function(e,ui){$(this).trigger("input")}}),$("#scene-select #str, #scene-select #int, #scene-select #dex, #scene-select #krm").autocomplete({minLength:0,source:["1","@5"],close:function(e,ui){$(this).trigger("input")}}),$("#scene-select #free1, #scene-select #free2, #scene-select #free3").autocomplete({minLength:0,source:["1","-5..-1","@5"],close:function(e,ui){$(this).trigger("input")}}),$("#scene-select #hp_max, #scene-select #mp_max, #scene-select #str_max, #scene-select #int_max, #scene-select #dex_max, #scene-select #krm_max").autocomplete({minLength:0,source:["1","1..5"],close:function(e,ui){$(this).trigger("input")}}),$(".ac").attr("autocomplete","address-level4").focus((function(){$(this).autocomplete("search","")})),$("#scene-select #edges-list").on("change",(function(e){network.selectEdges([$(this).val()]),Util.setEdgeInfo($(this).val())})),Util.createSelectSidebar("#edge #from","fscene",scenario.scenes,"radio","label","id"),Util.createSelectSidebar("#edge #to","tscene",scenario.scenes,"radio","label","id"),$("#edge input, #edge select").on("input",(function(e){let id=$("#edge #id").val(),edge=Util.getEdgeById(id);id&&(edge[e.target.id]=$(this).val());let coords=network.getViewPosition();["from","to","label"].includes(e.target.id)&&("label"===e.target.id?Util.createNetwork({level:!1}):Util.createNetwork(),network.selectEdges([id]),network.moveTo({position:coords}))})),$.get("../stext/stext.xml").done((function(data){$("scenario > work",data).each((function(){$("#sidr_links_result_s").append($("<option></option>").attr("value",$(this).attr("id")).text($(this).attr("title")))}))})),$("#sidr_links_result_s").change((function(e){$.get(`../stext/${$(this).val()}/scenario.xml`).done((function(data){$("#sidr_links_result").empty().append("<option>実績を選択</option>"),$("results > result",data).each((function(){$("#sidr_links_result").append($("<option></option>").attr("value",$(this).attr("id")+":"+$("#sidr_links_result_s").val()).text($(this).attr("name")))}))}))})),$("#edge #condition").sidr({name:"sidr_links",displace:!1,onOpen:function(){$("#sidr_links_cond").val(""),$("#sidr_links_item").empty().append("<option>アイテムを選択</option>");for(let item of scenario.items)$("#sidr_links_item").append(`<option value="${item.id}">${item.name}</option>`);$("#sidr_links_flag").empty().append("<option>フラグを選択</option>");for(let flag of scenario.flags)$("#sidr_links_flag").append(`<option value="${flag.id}">${flag.text}</option>`)}}),$("#sidr_links_list select:not(.no-update)").change((function(){console.log("BG");let cond=$("#sidr_links_cond");cond.val(cond.val()+$(this).val())})),$("#sidr_links button").click((function(){let cond=$("#sidr_links_cond");cond.val(cond.val()+$(this).val())})),$("#sidr_links_submit").click((function(){$("#edge #condition").val($("#sidr_links_cond").val()).trigger("input"),$.sidr("close","sidr_links")})),$("#sidr_links_close").click((function(){$.sidr("close","sidr_links")}));let grid_opts={editable:!0,enableAddRow:!0,enableCellNavigation:!0,asyncEditorLoading:!1,autoEdit:!1};Util.createGrid("#groups_grid",scenario.groups,[{id:"start",name:"開始No.",field:"start",width:70,editor:Slick.Editors.Integer},{id:"end",name:"終了No.",field:"end",width:70,editor:Slick.Editors.Integer},{id:"title",name:"グループ名",field:"title",width:250,editor:Slick.Editors.Text},{id:"delete",name:"削除",field:"",width:35,formatter:function(){return'<input type="button" class="btn-delete" value="×" />'}}],grid_opts,"group"),Util.createGrid("#items_grid",scenario.items,[{id:"id",name:"id",field:"id",width:50,editor:Slick.Editors.Text,validator:function(value){return Util.validateId(value,"i","アイテム")}},{id:"name",name:"名前",field:"name",width:80,editor:Slick.Editors.Text},{id:"target",name:"効果対象",field:"target",width:60,editor:SelectEditor,options:["","hp","mp","state","str","int","dex","krm","free1","free2","free3","none"]},{id:"effect",name:"効果値",field:"effect",width:80,editor:Slick.Editors.Text},{id:"text",name:"説明",field:"text",width:250,editor:Slick.Editors.Text},{id:"delete",name:"削除",field:"",width:35,formatter:function(){return'<input type="button" class="btn-delete" value="×" />'}}],grid_opts,"item"),Util.createGrid("#flags_grid",scenario.flags,[{id:"id",name:"id",field:"id",width:50,editor:Slick.Editors.Text,validator:function(value){return Util.validateId(value,"f","フラグ")}},{id:"text",name:"説明",field:"text",width:300,editor:Slick.Editors.Text},{id:"delete",name:"削除",field:"",width:35,formatter:function(){return'<input type="button" class="btn-delete" value="×" />'}}],grid_opts,"flag"),Util.createGrid("#enemies_grid",scenario.enemies,[{id:"id",name:"id",field:"id",width:50,editor:Slick.Editors.Text,validator:function(value){return Util.validateId(value,"m","モンスター")}},{id:"name",name:"名前",field:"name",width:80,editor:Slick.Editors.Text},{id:"element",name:"属性",field:"element",editor:SelectEditor,options:["","earth","water","fire","wind","spirit"]},{id:"attack",name:"攻撃",field:"attack",width:80,editor:SelectEditor,options:["","physics","magic","both","free1","free2","free3","poison","frozen","stone","curse","forget","str","int","dex","krm"]},{id:"func",name:"ダメージ式",field:"func",width:80,editor:Slick.Editors.LongText},{id:"drop",name:"ドロップ",field:"drop",width:80,editor:AutoCompleteEditor,dataSource:["mon/","tue/","wed/","thu/","fri/","sat/","sun/","free1/","free2/","free3"]},{id:"text",name:"説明",field:"text",width:180,editor:Slick.Editors.LongText},{id:"hp",name:"敵HP",field:"hp",width:40,editor:Slick.Editors.Integer},{id:"func_opp",name:"敵ダメージ式",field:"func_opp",width:90,editor:Slick.Editors.LongText},{id:"delete",name:"削除",field:"",width:35,formatter:function(){return'<input type="button" class="btn-delete" value="×" />'}}],grid_opts,"enemy"),Util.createGrid("#results_grid",scenario.results,[{id:"id",name:"id",field:"id",width:50,editor:Slick.Editors.Text,validator:function(value){return Util.validateId(value,"r","実績")}},{id:"name",name:"名前",field:"name",width:100,editor:Slick.Editors.Text},{id:"level",name:"Lv.",field:"level",width:30,editor:SelectEditor,options:["1","2","3","4","5"]},{id:"text",name:"説明",field:"text",width:150,editor:Slick.Editors.Text},{id:"delete",name:"削除",field:"",width:35,formatter:function(){return'<input type="button" class="btn-delete" value="×" />'}}],grid_opts,"result"),Util.createGrid("#works_grid",scenario.licence,[{id:"name",name:"名前",field:"name",width:100,editor:Slick.Editors.Text},{id:"category",name:"分類",field:"category",width:70,editor:SelectEditor,options:["bgm","picture"]},{id:"creator",name:"作者",field:"creator",width:80,editor:Slick.Editors.Text},{id:"url",name:"URL",field:"url",width:230,editor:Slick.Editors.Text},{id:"delete",name:"削除",field:"",width:35,formatter:function(){return'<input type="button" class="btn-delete" value="×" />'}}],grid_opts,"work");let editor=ace.edit("scene-editor");editor.$blockScrolling=1/0,editor.setOptions({}),editor.getSession().setUseWrapMode(!0),editor.setTheme("ace/theme/chrome"),editor.session.setMode("ace/mode/markdown"),editor.on("input",(function(e){let id=$("#scene-select #id").val();if(id){let scene;Util.getSceneById(id).text=editor.getValue()}})),$("#scene #scene-ext").click((function(e){let sa=$("#scene-attr"),se=$("#scene-editor");se.hasClass("editor-big")?($(this).text("エディター領域を拡げる"),sa.show(),se.removeClass("editor-big").css("height","210px"),editor.resize(!0)):($(this).text("エディター領域を狭める"),sa.hide(),se.addClass("editor-big").css("height","630px"),editor.resize(!0))})),$("#scene #scene-delscene").click((function(){if(!confirm("この操作は元には戻せません！\n現在のシーンを削除しても構いませんか？"))return;let id=$("#scene-attr #id").val();Util.deleteScene(id),Util.createNetwork()})),$("#scene #edges-list").focus((function(e){let id=$("#scene-attr #id").val();Util.createLinkList(id)})),$("#scene #scene-addedge").click((function(e){$("#edge-dialog").dialog("open")})),$("#scene #scene-addscene").click((function(e){$("#scene-dialog-link").dialog("open")})),$("#scene #scene-changescene").click((function(e){"0"!==$("#scene-select #id").val()?$("#scene-change-dialog").dialog("open"):toastr.error("Scene 0は変更できません。","変更不可")})),Util.createSelectSidebar("#edge-dialog #to-id","scene",scenario.scenes,"radio","label","id"),Util.createSelectSidebar("#edge-dialog #edge-add","scenes",scenario.scenes,"check","label","id"),$("#edge #edge-deledge").click((function(){if(!confirm("この操作は元には戻せません！\n現在のリンクを削除しても構いませんか？"))return;let id=$("#edge #id").val();Util.deleteLink(id),Util.createNetwork()})),$("#edit-area").tabs(),Util.disableTab(),$("#ctrl_run").click((function(e){localStorage.setItem(Common_RUN_NAME,Util.createXml()),-1===location.host.indexOf("web-deli.com")?window.open("../index.html?id=pg2",Common_RUN_NAME):window.open("../game.aspx?id=pg2",Common_RUN_NAME)})),$("#ctrl_tag").click((function(e){$("#tag-menu").css({display:"block",top:e.pageY,left:e.pageX})})),$("#tag-menu li").click((function(e){var command;let comm={red:"%red%$0%/%",blue:"%blue%$0%/%",white:"%white%$0%/%","*ruby":"${text|ruby}",if:"${if condition}$0${/if}","*import":"${import 99999}","*input":"${input?0}","*input":"${input?0}","*title":"${title}","*race":"${race?FIG:WIZ:DWA:ELF}","*sex":"${sex?M:F}","*state":"${state?NOR:POI:FRO:STO:FOR}","*age":"${age?Y:A:O}","*random":"${rand?min:max}","*msg":"${msg?str1:str2:...}",tweet:"${tweet}%0%${/tweet}","*capture":"![caption](path)"}[$(this).data("command")];comm.startsWith("*")?editor.insert(comm):editor.insert(comm.replace("$0",editor.getCopyText())),editor.focus(),$("#tag-menu").css("display","none")})),$("#ctrl_dl").click((function(e){$("#dl-menu").css({display:"block",top:e.pageY,left:e.pageX})})),$("#dl-menu li").click((function(e){switch($(this).data("command")){case"json":scenario.scenes.forEach((function(scene){delete scene.x,delete scene.y})),Util.download(vkbeautify.json(JSON.stringify(scenario)),"stext.json");break;case"xml":Util.download(Util.createXml(),"scenario.xml");break;case"html":Util.download(Util.createHtml(),"scenario.html");break;case"storage":window.alert("データをブラウザーに保存しました。\n保存済みのデータは［マイストレージ］テンプレートからロードできます。"),localStorage.setItem(Common_MY_STORAGE,JSON.stringify(scenario));break;default:console.log("Unknown Error!!")}$("#dl-menu").css("display","none")})),$("#ctrl_help").click((function(e){$("#help-menu").css({display:"block",top:e.pageY,left:e.pageX})})),Util.createSelectSidebar("#ctrl_filter","groups",[{start:0,end:99999,title:"フィルター解除"}].concat(scenario.groups),"check",(function(obj){return`${obj.title}<br />（${obj.start}－${obj.end}）`}),(function(obj){return`${obj.start}-${obj.end}`}),(function(result){filter_where=[];for(let cond of result.split(",")){if(!cond)break;let tmp_cond=cond.split("-");filter_where.push({start:tmp_cond[0],end:tmp_cond[1]})}Util.createNetwork({fit:!0})})),$("#ctrl_shuffle").click((function(){if(!confirm("全シーンidをシャッフルします。\nこの操作は元に戻せませんが、続けますか？"))return;let s=new StextShuffle(scenario);s.run(),scenario=JSON.parse(JSON.stringify(s.scenario)),Util.createNetwork({fit:!0}),Util.disableTab()})),$("#ctrl_config").click((function(){$("#pg-config").dialog("open")})),$("#ctrl_template").change((function(e){var selected=$(this).val();if("storage"===selected){var save=localStorage.getItem(Common_MY_STORAGE);save?(sessionStorage.setItem(Common_LOAD_NAME,save),location.reload()):window.alert("セーブデータは存在しません。")}else if(selected){let path;path=selected.startsWith("@")?`../stext/${selected.substring(1)}/scenario.xml`:`./template/${selected}`,$.ajax(path,{dataType:"text"}).done((function(data){selected.startsWith("@")&&(data=Util.createJson(data)),sessionStorage.setItem(Common_LOAD_NAME,data),location.reload()}))}})),$("#ctrl_import").click((function(e){$("#ctrl_load").click()})),$("#ctrl_load").change((function(e){let inputs=$(this).get(0).files,name=inputs[0].name,reader=new FileReader;$(reader).on("load",(function(){name.endsWith(".json")?sessionStorage.setItem(Common_LOAD_NAME,reader.result):sessionStorage.setItem(Common_LOAD_NAME,Util.createJson(reader.result)),location.reload()})),reader.readAsText(inputs[0],"UTF-8")})),$("#ctrl_scene").mousedown((function(e){$("#ctrl_scene").empty(),$("<option></option>").attr("value","").text("編集するシーンを選択").appendTo("#ctrl_scene");for(let scene of scenario.scenes)label=scene.label,(0==scene.id||scene.end)&&(label="★"+label),$("<option></option>").attr("value",scene.id).text(label).appendTo("#ctrl_scene")})),$("#ctrl_scene").change((function(e){let id=$(this).val();Util.setSceneInfo(id),network.selectNodes([id])})),$("#ctrl_addscene").click((function(e){let incre=Number($("#ctrl_incre").val());(!incre||incre<1)&&(incre=1),incre=Math.floor(incre);let new_id=Number(Util.maxSceneId())+incre;scenario.scenes.push({id:String(new_id),summary:"New",label:`${new_id}:\nNew`,text:""}),Util.createNetwork()})),$(":not(.cxt)").click((function(e){"ctrl_dl"!==e.target.id&&$("#dl-menu").css("display","none"),"ctrl_help"!==e.target.id&&$("#help-menu").css("display","none"),"ctrl_tag"!==e.target.id&&$("#tag-menu").css("display","none")})),$("#ctrl_flow2editor").click((function(){localStorage.flow2editor=Util.createXml(),window.open("../playground.aspx","pgeditor")})),$(window).on("beforeunload",(function(){return"ページを閉じてもよろしいですか？"}));let tips=["フローチャート上では、プロローグ／エピローグ（happy/bad）を表すシーンが色で区別されています。目的のシーンを探す手掛かりになるでしょう。","フローチャートで目的のシーンが探しにくい場合には、右上のシーン選択ボックスを利用してみましょう。シーンid順に表示されています。","フローチャートやシーン選択ボックス上では、サマリーテキストが表示されます。シーンごとにできるだけ判りやすい名前を付けましょう。","シーン選択ボックス上では、プロローグとエピローグが★でマーキングされています。目的のシーンを探す手掛かりになるでしょう。","フローチャート上のリンクが見難い場合には、［シーン］タブからリンク選択ボックスを利用してみましょう。","Playgroundのデータは、.json形式（Playgroundの内部形式）、.xml形式（STextの実行形式）などで保存できます。","scenario.xml（STextの実行形式）を.json形式（Playgroundの内部形式）に変換することも可能です。既存のシナリオをNew Playgroundにインポートして、どんどん動作確認してみましょう。","Playgroundでは、.html形式での出力もできます。条件分岐、音楽機能などは利用できなくなりますが、Kindle配信などしている人にも利用して戴けると嬉しいです。",".json形式（Playgroundの内部形式）のファイルは、Playground上部のファイル選択ボタンからインポート＆編集できます。","Playground Flowでは、個々のシーンをNode、リンクをEdgeと呼びます。","シーンを跨ったテキスト置換を実行した場合には、PlayGround Editorに切り替えると良いでしょう。［Ctrl］＋［H］でテキストの一括置き換えが可能です（正規表現にも対応）。","［PgEditorで編集］ボタンを押すことで現在編集中のシナリオをPlayground Editorで編集できます。","［シーンを追加］ボタンを押すことで、シーンをワンクリックで手軽に追加できます。","［シーンを追加］ボタンでは、新規のidは「最大値＋指定の増分」で自動採番されます。","［シーン］タブからはもシーンを追加できます。その場合、現在のシーンからのリンクも自動生成されるので、積極的に利用していきましょう。","フォーム上のラベルをダブルクリックすることで、該当する項目のヘルプページを表示できます。","アイテム／フラグ編集のグリッドからタイトル行をダブルクリックすることで、該当する項目のヘルプページを表示できます。","フィルター機能を利用することで、フローチャートに表示するシーン範囲を限定し、大きなシナリオでも見やすく表示できます。","［シンプルサンプル］は、5Sceneの中にも、戦闘、フラグ、アイテム、実績、エンディングなどの基本機能を備えています。STextの基礎を見渡すのに便利です。","［20Sceneサンプル］は、単方向で分岐と移動の枠組みだけを備えたサンプルです。20Sceneあるので、簡単な物語ならば、テキストを追加するだけでシナリオができてしまいます。","［機能テスト］は、STextの動作確認のためのテンプレート。リンク関係など判りにくい動作例を載せています。","［セーブ］ボタンではブラウザーに一時的にデータを保存できます。保存したデータは［マイストレージ］テンプレートから取り出せますよ。","Playground Flowは現在β版です。バグかなと思ったら、Twitter（@yy7512）までお知らせください。","Playground Flowは現在β版です。こんな機能あったらいいなと思ったら、Twitter（@yy7512）までお気軽にお寄せください。","Playground Flowは現在β版です。ご利用に際しては、データのバックアップ／保存を小まめに行うようにしてください。","アイテム／フラグなどの項目はロード時にid値について昇順でソートされます。番号の大小が乱れた時は一度開き直すと良いでしょう。","シーンはフローチャートとからだけでなく、右上の選択ボックスからも選べます。プロローグ／エンディングには★が付いているので、探す時の手懸りにどうぞ。","シーンテキストを編集するエディターには様々なショートカットが用意されています。詳しくはヘルプを参照してください。","［シーン］タブから［アイテム］［フラグ］［敵］［実績］欄にフォーカスすると、サイドバーが開いて、設定済みの情報を選択できます。","［シーン］タブから［HP］～［FREE3］欄にフォーカスすると、入力可能なオプションがリスト表示されます。","［リンク］タブから［条件式］欄にフォーカスすると、サイドパネルに条件式生成エディターが開きます。","現在のシーンに紐づいたシーンを新規作成したいならば、［シーン］タブから［シーン追加］ボタンをクリックします。","［シーン］タブでidの［変更］ボタンをクリックすると、新しいidを振ったり、既存のidとスワップしたりできます。"];toastr.options.closeButton=!0,toastr.options.positionClass="toast-bottom-full-width",toastr.options.showDuration=300,toastr.options.hideDuration=1e3,toastr.options.timeOut=7e3,toastr.info(tips[Math.floor(Math.random()*tips.length)],"TIPS")}));